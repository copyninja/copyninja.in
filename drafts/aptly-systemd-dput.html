<!DOCTYPE html><html lang="en"><head><link href="https://fonts.googleapis.com/css?family=Cantarell" rel="stylesheet"><title>Aptly, Systemd and dput: Debian Repository with incoming mechanism</title><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1"><link href="https://copyninja.in/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Random Ramblings Full Atom Feed"><link href="https://copyninja.in/feeds/{slug}.atom.xml" type="application/atom+xml" rel="alternate" title="Random Ramblings Categories Atom Feed"><link rel="stylesheet" type="text/css" href="/theme/css/pygments.css"><link rel="stylesheet" type="text/css" href="/theme/css/default.css"><meta name="tags" content="debian-repo"><meta name="tags" content="aptly"><meta name="tags" content="systemd"></head><body><div id="header" class="body"><div id="navigation"> | <a href="https://copyninja.in">Home</a> | | <a href="https://copyninja.in/about">About</a> | | <a href="https://copyninja.in/contact">Contact</a> | | <a href="https://copyninja.in/categories.html">Categories</a> | | <a href="https://copyninja.in/tags.html">Tags</a> | </div><h1><a href="https://copyninja.in/drafts/aptly-systemd-dput.html">Aptly, Systemd and dput: Debian Repository with incoming mechanism</a></h1></div><div id="content"><section id="content" class="body"><footer class="post-info"><p> Posted on Jun 07, 2020 By copyninja under devops </p></abbr></footer><div class="entry-content"><p>It has been more than a year from my last blog post. Its been a busy year and life has its own ways to keep you busy. So here I'm again after a year to write something I solved a couple of days back.</p><div class="section" id="problem"><h2>Problem</h2><p>Setup a APT repository server where one can upload their packages and it gets published.</p><p>Though statement is simple it needed following things</p><ol class="arabic simple"><li>apt repository setup</li><li>process uploaded package and update published repository.</li></ol><div class="section" id="apt-repository-setup"><h3>1. APT Repository Setup</h3><p>My first selection for this was reprepro which works well but has one short coming, it does not support multiple version of same package. For my use case I need repository to have multiple versions of same package. A patch has been proposed for reprepro in <a class="reference external" href="https://bugs.debian.org/570623">#570623</a> but has not been merged and there is no activity for quite some time. I tried to build it but without success. As I did not have much time to investigate and did not want to adopt the patch before it officially got accepted by upstream I ruled it out.</p><p>I tried mini-dinstall next. mini-dinstall does support having multiple version of same package but the catch is repo can't be mirrored using debmirror. This was again a use case and there is a very old bug <a class="reference external" href="https://bugs.debian.org/360529">#360529</a> which was never fixed. So I ruled out mini-dinstall as well.</p><p>So finally without much options left I came to aptly. aptly is a great tool but is not been actively maintained by the author from December 2019. But with no other options I thought of giving it a try.</p><p>aptly stores the repository and data store locally under <em>~/.aptly/</em> folder. To allow outside word to access the repository it needs to be first published. Aptly provides 3 endpoints for publishing</p><ol class="arabic simple"><li><em>S3</em> (AWS)</li><li><em>Swift</em> (Openstack)</li><li>Filesystem: local storage on box where aptly is running</li></ol><p>These endpoints can be configured in the config file which can be either in <em>~/.aptly.conf</em> or <em>/etc/aptly.conf</em>. A JSON file. A sample file with filesystem endpoint configuration is as follows.</p><div class="highlight"><pre><span></span><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;rootDir&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;$HOME/.aptly&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;downloadConcurrency&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">4</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;downloadSpeedLimit&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;architectures&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[],</span>
<span class="w">  </span><span class="nt">&quot;dependencyFollowSuggests&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;dependencyFollowRecommends&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;dependencyFollowAllVariants&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;dependencyFollowSource&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;dependencyVerboseResolve&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;gpgDisableSign&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;gpgDisableVerify&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;gpgProvider&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;gpg&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;downloadSourcePackages&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;skipLegacyPool&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;ppaDistributorID&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;ubuntu&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;ppaCodename&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;skipContentsPublishing&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;FileSystemPublishEndpoints&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;test1&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nt">&quot;rootDir&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;/opt/srv1/aptly_public&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;linkMethod&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;symlink&quot;</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="nt">&quot;test2&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nt">&quot;rootDir&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;/opt/srv2/aptly_public&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;linkMethod&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;copy&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;verifyMethod&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;md5&quot;</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="nt">&quot;test3&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nt">&quot;rootDir&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;/opt/srv3/aptly_public&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;linkMethod&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;hardlink&quot;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</pre></div><p>Each endpoint is given a name in this case <em>test1, test2 and test3</em>. And they can export it to different location and using different methods. More details about all these can be found in <a class="reference external" href="https://www.aptly.info/doc/feature/filesystem/">aptly documentation</a>. If you decide all repository will be supporting a list of architecture that can be added to configuration file. In my case I decided to go with per repository based architecture which will be give more flexibility.</p><p>One more thing I noticed was aptly packaged in Debian does not work with gnupg2 and you need to have gnupg1 around and re-import all keys to gnupg1 as well so it is recognized. I see that 1.4 version of aptly is prepared in salsa but not yet uploaded. So I decided to download the aptly from the upstream repo and use it instead.</p><p>aptly provides various way to publish repository. Its preferred way is to take a snapshot of the repository and publish the snapshot. But in my case I simply decided to publish the repository and update the published repo whenever new package is uploaded.</p></div></div></div><div id="footer"><p><italic>Tagged as: aptly, debian-repo, systemd, </italic></p></section></div><hr><div id="footer"> Site Proudly powered by <a href="http://getpelican.com/">Pelican</a></div></body></html>