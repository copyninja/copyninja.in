<!DOCTYPE html><html lang="en"><head><link href="https://fonts.googleapis.com/css?family=Cantarell" rel="stylesheet"><title>Note to Self: Enabling Secure Boot with UKI on Debian</title><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1"><link href="https://copyninja.in/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Random Ramblings Full Atom Feed"><link href="https://copyninja.in/feeds/{slug}.atom.xml" type="application/atom+xml" rel="alternate" title="Random Ramblings Categories Atom Feed"><link rel="stylesheet" type="text/css" href="/theme/css/pygments.css"><link rel="stylesheet" type="text/css" href="/theme/css/default.css"><meta name="tags" content="debian"><meta name="tags" content="secureboot"><meta name="tags" content="systemd"><meta name="tags" content="uki"></head><body><div id="header" class="body"><div id="navigation"> | <a href="https://copyninja.in">Home</a> | | <a href="https://copyninja.in/about">About</a> | | <a href="https://copyninja.in/contact">Contact</a> | | <a href="https://copyninja.in/categories.html">Categories</a> | | <a href="https://copyninja.in/tags.html">Tags</a> | </div><h1><a href="https://copyninja.in/blog/enable_secureboot_ukify.html">Note to Self: Enabling Secure Boot with UKI on Debian</a></h1></div><div id="content"><section id="content" class="body"><footer class="post-info"><p> Posted on Sep 24, 2024 By copyninja under devops </p></abbr></footer><div class="entry-content"><div class="admonition note"><p class="first admonition-title">Note</p><p class="last"><em>This post is a continuation of my previous article on enabling the Unified Kernel Image (UKI) on Debian.</em></p></div><ul class="simple"><li><a class="reference external" href="https://copyninja.in/blog/enable_ukify_debian.html">Enabling Unified Kernel Image on Debian</a></li></ul><p>In this guide, we'll implement Secure Boot by taking full control of the device, removing preinstalled keys, and installing our own. For a comprehensive overview of the benefits and process, refer to this excellent post from <a class="reference external" href="https://www.rodsbooks.com/efi-bootloaders/controlling-sb.html">rodsbooks</a>.</p><div class="section" id="key-components"><h2>Key Components</h2><p>To implement Secure Boot, we need three essential keys:</p><ol class="arabic simple"><li>Platform Key (PK): The top-level key in Secure Boot, typically provided by the motherboard manufacturer. We'll replace the vendor-supplied PK with our own for complete control.</li><li>Key Exchange Key (KEK): Used to sign updates for the Signatures Database and Forbidden Signatures Database.</li><li>Database Key (DB): Used to sign or verify binaries (bootloaders, boot managers, shells, drivers, etc.).</li></ol><p>There's also a Forbidden Signature Key (dbx), which is the opposite of the DB key. We won't be generating this key in this guide.</p></div><div class="section" id="preparing-for-key-enrollment"><h2>Preparing for Key Enrollment</h2><p>Before enrolling our keys, we need to put the device in <em>Secure Boot Setup Mode</em>. Verify the status using the <tt class="docutils literal">bootctl status</tt> command. You should see output similar to the following image:</p><img alt="UEFI Setup mode" class="align-center" src="https://copyninja.in/images/uefi_setupmode.png"></div><div class="section" id="generating-keys"><h2>Generating Keys</h2><p>Follow <a class="reference external" href="https://wiki.archlinux.org/title/Unified_Extensible_Firmware_Interface/Secure_Boot#Creating_keys">these instructions from the Arch Wiki</a> to generate the keys manually. You'll need the <tt class="docutils literal">efitools</tt> and <tt class="docutils literal">openssl</tt> packages. I recommend using <tt class="docutils literal">rsa:2048</tt> as the key size for better compatibility with older firmware.</p><p>After generating the keys, copy all <tt class="docutils literal">.auth</tt> files to the <tt class="docutils literal"><span class="pre">/efi/loader/keys/&lt;hostname&gt;/</span></tt> folder. For example:</p><div class="highlight"><pre><span></span>‚ùØ<span class="w"> </span>sudo<span class="w"> </span>ls<span class="w"> </span>/efi/loader/keys/chamunda
db.auth<span class="w">  </span>KEK.auth<span class="w">  </span>PK.auth
</pre></div></div><div class="section" id="signing-the-bootloader"><h2>Signing the Bootloader</h2><p>Sign the <tt class="docutils literal"><span class="pre">systemd-boot</span></tt> bootloader with your new keys:</p><div class="highlight"><pre><span></span>sbsign<span class="w"> </span>--key<span class="w"> </span>&lt;path-to<span class="w"> </span>db.key&gt;<span class="w"> </span>--cert<span class="w"> </span>&lt;path-to<span class="w"> </span>db.crt&gt;<span class="w"> </span><span class="se">\</span>
<span class="w">   </span>/usr/lib/systemd/boot/efi/systemd-bootx64.efi
</pre></div><p>Install the signed bootloader using <tt class="docutils literal">bootctl install</tt>. The output should resemble this:</p><img alt="bootctl install" class="align-center" src="https://copyninja.in/images/bootctl_install.png"><div class="admonition note"><p class="first admonition-title">Note</p><p class="last"><em>If you encounter warnings about mount options, update your fstab with the `umask=0077` option for the EFI partition.</em></p></div><p>Verify the signature using <tt class="docutils literal">sbsign <span class="pre">--verify</span></tt>:</p><img alt="sbsign verify" class="align-center" src="https://copyninja.in/images/sbsign_verify_systemdboot.png"></div><div class="section" id="configuring-uki-for-secure-boot"><h2>Configuring UKI for Secure Boot</h2><p>Update the <tt class="docutils literal">/etc/kernel/uki.conf</tt> file with your key paths:</p><div class="highlight"><pre><span></span><span class="na">SecureBootPrivateKey</span><span class="o">=</span><span class="s">/path/to/db.key</span>
<span class="na">SecureBootCertificate</span><span class="o">=</span><span class="s">/path/to/db.crt</span>
</pre></div></div><div class="section" id="signing-the-uki-image"><h2>Signing the UKI Image</h2><p>On Debian, use <tt class="docutils literal"><span class="pre">dpkg-reconfigure</span></tt> to sign the UKI image for each kernel:</p><div class="highlight"><pre><span></span>sudo<span class="w"> </span>dpkg-reconfigure<span class="w"> </span>linux-image-<span class="k">$(</span>uname<span class="w"> </span>-r<span class="k">)</span>
<span class="c1"># Repeat for other kernel versions if necessary</span>
</pre></div><p>You should see output similar to this:</p><div class="highlight"><pre><span></span>sudo<span class="w"> </span>dpkg-reconfigure<span class="w"> </span>linux-image-<span class="k">$(</span>uname<span class="w"> </span>-r<span class="k">)</span>
/etc/kernel/postinst.d/dracut:
dracut:<span class="w"> </span>Generating<span class="w"> </span>/boot/initrd.img-6.10.9-amd64
Updating<span class="w"> </span>kernel<span class="w"> </span>version<span class="w"> </span><span class="m">6</span>.10.9-amd64<span class="w"> </span><span class="k">in</span><span class="w"> </span>systemd-boot...
Signing<span class="w"> </span>unsigned<span class="w"> </span>original<span class="w"> </span>image
Using<span class="w"> </span>config<span class="w"> </span>file:<span class="w"> </span>/etc/kernel/uki.conf
+<span class="w"> </span>sbverify<span class="w"> </span>--list<span class="w"> </span>/boot/vmlinuz-6.10.9-amd64
+<span class="w"> </span>sbsign<span class="w"> </span>--key<span class="w"> </span>/home/vasudeva.sk/Documents/personal/secureboot/db.key<span class="w"> </span>--cert<span class="w"> </span>/home/vasudeva.sk/Documents/personal/secureboot/db.crt<span class="w"> </span>/tmp/ukicc7vcxhy<span class="w"> </span>--output<span class="w"> </span>/tmp/kernel-install.staging.QLeGLn/uki.efi
Wrote<span class="w"> </span>signed<span class="w"> </span>/tmp/kernel-install.staging.QLeGLn/uki.efi
/etc/kernel/postinst.d/zz-systemd-boot:
Installing<span class="w"> </span>kernel<span class="w"> </span>version<span class="w"> </span><span class="m">6</span>.10.9-amd64<span class="w"> </span><span class="k">in</span><span class="w"> </span>systemd-boot...
Signing<span class="w"> </span>unsigned<span class="w"> </span>original<span class="w"> </span>image
Using<span class="w"> </span>config<span class="w"> </span>file:<span class="w"> </span>/etc/kernel/uki.conf
+<span class="w"> </span>sbverify<span class="w"> </span>--list<span class="w"> </span>/boot/vmlinuz-6.10.9-amd64
+<span class="w"> </span>sbsign<span class="w"> </span>--key<span class="w"> </span>/home/vasudeva.sk/Documents/personal/secureboot/db.key<span class="w"> </span>--cert<span class="w"> </span>/home/vasudeva.sk/Documents/personal/secureboot/db.crt<span class="w"> </span>/tmp/ukit7r1hzep<span class="w"> </span>--output<span class="w"> </span>/tmp/kernel-install.staging.dWVt5s/uki.efi
Wrote<span class="w"> </span>signed<span class="w"> </span>/tmp/kernel-install.staging.dWVt5s/uki.efi
</pre></div></div><div class="section" id="enrolling-keys-in-firmware"><h2>Enrolling Keys in Firmware</h2><p>Use <tt class="docutils literal"><span class="pre">systemd-boot</span></tt> to enroll your keys:</p><div class="highlight"><pre><span></span>systemctl<span class="w"> </span>reboot<span class="w"> </span>--boot-loader-menu<span class="o">=</span><span class="m">0</span>
</pre></div><p>Select the enroll option with your hostname in the <tt class="docutils literal"><span class="pre">systemd-boot</span></tt> menu.</p><p>After key enrollment, the system will reboot into the newly signed kernel. Verify with <tt class="docutils literal">bootctl</tt>:</p><img alt="uefi enabled" class="align-center" src="https://copyninja.in/images/bootctl_uefi_enabled.png"></div><div class="section" id="dealing-with-lockdown-mode"><h2>Dealing with Lockdown Mode</h2><p>Secure Boot enables lockdown mode on distro-shipped kernels, which restricts certain features like kprobes/BPF and DKMS drivers. To avoid this, consider compiling the upstream kernel directly, which doesn't enable lockdown mode by default.</p><p>As Linus Torvalds has stated, &quot;there is no reason to tie Secure Boot to lockdown LSM.&quot; You can read more about <a class="reference external" href="https://www.phoronix.com/news/UEFI-Kernel-Lockdown-Concerns">Torvalds' opinion on UEFI tied with lockdown</a>.</p></div><div class="section" id="next-steps"><h2>Next Steps</h2><p>One thing that remains is automating the signing of systemd-boot on upgrade, which is currently a manual process. I'm exploring dpkg triggers for achieving this, and if I succeed, I will write a new post with details.</p></div><div class="section" id="acknowledgments"><h2>Acknowledgments</h2><p>Special thanks to my anonymous colleague who provided invaluable assistance throughout this process.</p></div></div><div id="footer"><p><italic>Tagged as: debian, secureboot, systemd, uki, </italic></p></section></div><hr><div id="footer"> Site Proudly powered by <a href="http://getpelican.com/">Pelican</a></div></body></html>