<!DOCTYPE html><html lang="en"><head><link href="https://fonts.googleapis.com/css?family=Cantarell" rel="stylesheet"><title>Note to Self: LVM Shrink Resize HowTo</title><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1"><link href="https://copyninja.in/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Random Ramblings Full Atom Feed"><link href="https://copyninja.in/feeds/{slug}.atom.xml" type="application/atom+xml" rel="alternate" title="Random Ramblings Categories Atom Feed"><link rel="stylesheet" type="text/css" href="/theme/css/pygments.css"><link rel="stylesheet" type="text/css" href="/theme/css/default.css"><meta name="tags" content="lvm"><meta name="tags" content="debian-installer"><meta name="tags" content="partition"><meta name="tags" content="debian"></head><body><div id="header" class="body"><div id="navigation"> | <a href="https://copyninja.in">Home</a> | | <a href="https://copyninja.in/about">About</a> | | <a href="https://copyninja.in/contact">Contact</a> | | <a href="https://copyninja.in/categories.html">Categories</a> | | <a href="https://copyninja.in/tags.html">Tags</a> | </div><h1><a href="https://copyninja.in/blog/lvm-shrink-resize.html">Note to Self: LVM Shrink Resize HowTo</a></h1></div><div id="content"><section id="content" class="body"><footer class="post-info"><p> Posted on Oct 05, 2014 By copyninja under devops </p></abbr></footer><div class="entry-content"><p>Recently I had to reinstall a system at office with Debian Wheezy and I thought I should use this opportunity to experiment with LVM. Yeah I've not used LVM till date, even though I'm using Linux for more than 5 years now. I know many DD friends who use LVM with LUKS encryption and I always wanted to experiment, but since my laptop is only thing I've and its currently perfectly in shape I didn't dare to experiment it there. This reinstall was golden opportunity for me to experiment and learn something new.</p><p>I used Wheezy CD ISO downloaded using <em>jigdo</em> for installation. Now I will just go bit off topic and want to share the USB stick preparation. I have to say this because I had not done installation for quite a while now. Last I did was during Squeeze time so like usual I blindly executed following command.</p><div class="highlight"><pre><span></span>cat<span class="w"> </span>debian-wheezy.iso<span class="w"> </span>&gt;<span class="w"> </span>/dev/sdb
</pre></div><p>Surprisingly USB stick didn't boot! I was getting <strong>Corrupt or missing ISO.bin</strong>. So next I tried using <cite>dd</cite> for preparing.</p><div class="highlight"><pre><span></span>dd<span class="w"> </span><span class="k">if</span><span class="o">=</span>debian-wheezy.iso<span class="w"> </span><span class="nv">of</span><span class="o">=</span>/dev/sdb
</pre></div><p>Surprisingly this also didn't work and I get same error message as above. This is when I went back to debian manual and looked for installation step and there I found new way!</p><div class="highlight"><pre><span></span>cp<span class="w"> </span>debian-wheezy.iso<span class="w"> </span>/dev/sdb
</pre></div><p>Look at destination, its a device and voil√† this worked! This is something new I learnt and I'm surprised how easy it is now to prepare USB stick. But I still didn't get why first 2 methods failed!. If you guys know please do share.</p><p>Now coming back to LVM. I used default LVM when disk partitioning was asked, and I used guided partitioning method provided by <cite>debian-installer</cite> and ended up with following layout</p><div class="highlight"><pre><span></span>$<span class="w"> </span>lvs
<span class="w">  </span>LV<span class="w">     </span>VG<span class="w">        </span>Attr<span class="w">     </span>LSize<span class="w">  </span>Pool<span class="w"> </span>Origin<span class="w"> </span>Data%<span class="w">  </span>Move<span class="w"> </span>Log<span class="w"> </span>Copy%<span class="w">  </span>Convert
home<span class="w">   </span>system-disk<span class="w"> </span>-wi-ao--<span class="w"> </span><span class="m">62</span>.34g
root<span class="w">   </span>system-disk<span class="w"> </span>-wi-ao--<span class="w">  </span><span class="m">9</span>.31g
swap_1<span class="w"> </span>system-disk<span class="w"> </span>-wi-ao--<span class="w">  </span><span class="m">2</span>.64g
</pre></div><p>So guided partitioning of <cite>debian-installer</cite> allocates 10G for root and rest to home and swap. This is not a problem but when I started installing required software, I could see root running out of space quickly so I wanted to resize root and give it 10G more, for this I need to reduce the home by 10G for which I need to first unmount the home partition. Unmounting home from running system isn't possible so I booted into recovery assuming I can unmount home there but I couldn't. <cite>lsof</cite> didn't show any one using /home after searching a bit I found <cite>fuser</cite> command and it looks like kernel is using /home which is mounted by it.</p><div class="highlight"><pre><span></span>$<span class="w"> </span>fuser<span class="w"> </span>-vm<span class="w"> </span>/home
<span class="w">                     </span>USER<span class="w">        </span>PID<span class="w"> </span>ACCESS<span class="w"> </span>COMMAND
/home:<span class="w">               </span>root<span class="w">     </span>kernel<span class="w"> </span>mount<span class="w"> </span>/home
</pre></div><p>So it isn't possible to unmount /home in recovery mode also. Online materials told me to use live-cd for doing this but I didn't have patience to do that so I just went ahead commented /home mounting in /etc/fstab and rebooted!. This time it worked and /home is not mounted on recovery mode. Now comes the hard part resizing home, thanks to <a class="reference external" href="http://tldp.org/HOWTO/LVM-HOWTO/reducelv.html">TLDP doc on reducing</a> I coud do this with following step</p><div class="highlight"><pre><span></span><span class="c1"># e2fsck -f /dev/volume-name/home</span>
<span class="c1"># resize2fs /dev/volume-name/home 52G</span>
<span class="c1"># lvreduce -L-10G /dev/volume-name/home</span>
</pre></div><p>And now the next part live extending the root partition again thanks to <a class="reference external" href="http://tldp.org/HOWTO/LVM-HOWTO/extendlv.html">TLDP doc on extending</a> following command did it.</p><div class="highlight"><pre><span></span><span class="c1"># lvextend -L+10G /dev/volume-name/root</span>
<span class="c1"># resize2fs /dev/volumne-name/root</span>
</pre></div><p>And now important part! <strong>Uncomment /home line in /etc/fstab so it will be mounted normally in next boot</strong> and reboot! On login I can see my partitions updated.</p><div class="highlight"><pre><span></span><span class="c1"># lvs</span>
<span class="w">  </span>LV<span class="w">     </span>VG<span class="w">        </span>Attr<span class="w">     </span>LSize<span class="w">  </span>Pool<span class="w"> </span>Origin<span class="w"> </span>Data%<span class="w">  </span>Move<span class="w"> </span>Log<span class="w"> </span>Copy%<span class="w">  </span>Convert
home<span class="w">   </span>system-disk<span class="w"> </span>-wi-ao--<span class="w"> </span><span class="m">52</span>.34g
root<span class="w">   </span>system-disk<span class="w"> </span>-wi-ao--<span class="w"> </span><span class="m">19</span>.31g
swap_1<span class="w"> </span>system-disk<span class="w"> </span>-wi-ao--<span class="w">  </span><span class="m">2</span>.64g
</pre></div><p>I've started liking LVM more now! :)</p></div><div id="footer"><p><italic>Tagged as: debian, debian-installer, lvm, partition, </italic></p></section></div><hr><div id="footer"> Site Proudly powered by <a href="http://getpelican.com/">Pelican</a></div></body></html>