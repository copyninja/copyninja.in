<!DOCTYPE html><html lang="en"><head><link href="https://fonts.googleapis.com/css?family=Cantarell" rel="stylesheet"><title>Rust - Shell like Process pipelines using subprocess crate</title><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1"><link href="https://copyninja.in/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Random Ramblings Full Atom Feed"><link href="https://copyninja.in/feeds/{slug}.atom.xml" type="application/atom+xml" rel="alternate" title="Random Ramblings Categories Atom Feed"><link rel="stylesheet" type="text/css" href="/theme/css/pygments.css"><link rel="stylesheet" type="text/css" href="/theme/css/default.css"><meta name="tags" content="rust"><meta name="tags" content="subprocess"></head><body><div id="header" class="body"><div id="navigation"> | <a href="https://copyninja.in">Home</a> | | <a href="https://copyninja.in/about">About</a> | | <a href="https://copyninja.in/contact">Contact</a> | | <a href="https://copyninja.in/categories.html">Categories</a> | | <a href="https://copyninja.in/tags.html">Tags</a> | </div><h1><a href="https://copyninja.in/blog/shell-pipelines-rust.html">Rust - Shell like Process pipelines using subprocess crate</a></h1></div><div id="content"><section id="content" class="body"><footer class="post-info"><p> Posted on Jun 18, 2017 By copyninja under development </p></abbr></footer><div class="entry-content"><p>I had to extract copyright information from the git repository of the crate upstream. The need aroused as part of updating <em>debcargo</em>, tool to create Debian package source from the Rust crate.</p><p>General idea behind taking copyright information from git is to extract starting and latest contribution year for every author/committer. This can be easily achieved using following shell snippet</p><div class="highlight"><pre><span></span><span class="k">for</span><span class="w"> </span>author<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="k">$(</span>git<span class="w"> </span>log<span class="w"> </span>--format<span class="o">=</span><span class="s2">&quot;%an&quot;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>sort<span class="w"> </span>-u<span class="k">)</span><span class="p">;</span><span class="w"> </span><span class="k">do</span>
<span class="w">   </span><span class="nv">author_email</span><span class="o">=</span><span class="k">$(</span>git<span class="w"> </span>log<span class="w"> </span>--format<span class="o">=</span><span class="s2">&quot;%an &lt;%ae&gt;&quot;</span><span class="w"> </span>--author<span class="o">=</span><span class="s2">&quot;</span><span class="nv">$author</span><span class="s2">&quot;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>head<span class="w"> </span>-n1<span class="k">)</span>
<span class="w">   </span><span class="nv">first</span><span class="o">=</span><span class="k">$(</span>git<span class="w"> </span><span class="se">\</span>
<span class="w">   </span>log<span class="w"> </span>--author<span class="o">=</span><span class="s2">&quot;</span><span class="nv">$author</span><span class="s2">&quot;</span><span class="w"> </span>--date<span class="o">=</span>format:%Y<span class="w"> </span>--format<span class="o">=</span><span class="s2">&quot;%ad&quot;</span><span class="w"> </span>--reverse<span class="w"> </span><span class="se">\</span>
<span class="w">             </span><span class="p">|</span><span class="w"> </span>head<span class="w"> </span>-n1<span class="k">)</span>
<span class="w">   </span><span class="nv">latest</span><span class="o">=</span><span class="k">$(</span>git<span class="w"> </span>log<span class="w"> </span>--author<span class="o">=</span><span class="s2">&quot;</span><span class="nv">$author</span><span class="s2">&quot;</span><span class="w"> </span>--date<span class="o">=</span>format:%Y<span class="w"> </span>--format<span class="o">=</span><span class="s2">&quot;%ad&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">             </span><span class="p">|</span><span class="w"> </span>head<span class="w"> </span>-n1<span class="k">)</span>
<span class="w">   </span><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="nv">$first</span><span class="w"> </span>-eq<span class="w"> </span><span class="nv">$latest</span><span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">       </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$first</span><span class="s2">, </span><span class="nv">$author_email</span><span class="s2">&quot;</span>
<span class="w">   </span><span class="k">else</span>
<span class="w">       </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$first</span><span class="s2">-</span><span class="nv">$latest</span><span class="s2">, </span><span class="nv">$author_email</span><span class="s2">&quot;</span>
<span class="w">   </span><span class="k">fi</span>
<span class="k">done</span>
</pre></div><p>Now challenge was to execute these command in Rust and get the required answer. So first step was I looked at <em>std::process</em>, default standard library support for executing shell commands.</p><p>My idea was to execute first command to extract authors into a Rust <em>vectors</em> or <em>array</em> and then have 2 remaining command to extract years in a loop. (Yes I do not need additional author_email command in Rust as I can easily get both in the first command which is used in for loop of shell snippet and use it inside another loop). So I setup to 3 commands outside the loop with input and output redirected, following is snippet should give you some idea of what I tried to do.</p><div class="highlight"><pre><span></span><span class="kd">let</span><span class="w"> </span><span class="n">authors_command</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Command</span><span class="p">::</span><span class="n">new</span><span class="p">(</span><span class="s">&quot;/usr/bin/git&quot;</span><span class="p">)</span>
<span class="w">             </span><span class="p">.</span><span class="n">arg</span><span class="p">(</span><span class="s">&quot;log&quot;</span><span class="p">)</span>
<span class="w">             </span><span class="p">.</span><span class="n">arg</span><span class="p">(</span><span class="s">&quot;--format=</span><span class="se">\&quot;</span><span class="s">%an &lt;%ae&gt;</span><span class="se">\&quot;</span><span class="s">&quot;</span><span class="p">)</span>
<span class="w">             </span><span class="p">.</span><span class="n">spawn</span><span class="p">()</span><span class="o">?</span><span class="p">;</span>
<span class="kd">let</span><span class="w"> </span><span class="n">output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">authors_command</span><span class="p">.</span><span class="n">wait</span><span class="p">()</span><span class="o">?</span><span class="p">;</span>
<span class="kd">let</span><span class="w"> </span><span class="n">authors</span><span class="p">:</span><span class="w"> </span><span class="nb">Vec</span><span class="o">&lt;</span><span class="nb">String</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">String</span><span class="p">::</span><span class="n">from_utf8</span><span class="p">(</span><span class="n">output</span><span class="p">.</span><span class="n">stdout</span><span class="p">).</span><span class="n">split</span><span class="p">(</span><span class="sc">&#39;\n&#39;</span><span class="p">).</span><span class="n">collect</span><span class="p">();</span>
<span class="kd">let</span><span class="w"> </span><span class="n">head_n1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Command</span><span class="p">::</span><span class="n">new</span><span class="p">(</span><span class="s">&quot;/usr/bin/head&quot;</span><span class="p">)</span>
<span class="w">             </span><span class="p">.</span><span class="n">arg</span><span class="p">(</span><span class="s">&quot;-n1&quot;</span><span class="p">)</span>
<span class="w">             </span><span class="p">.</span><span class="n">stdin</span><span class="p">(</span><span class="n">Stdio</span><span class="p">::</span><span class="n">piped</span><span class="p">())</span>
<span class="w">             </span><span class="p">.</span><span class="n">stdout</span><span class="p">(</span><span class="n">Stdio</span><span class="p">::</span><span class="n">piped</span><span class="p">())</span>
<span class="w">             </span><span class="p">.</span><span class="n">spwn</span><span class="p">()</span><span class="o">?</span><span class="p">;</span>
<span class="k">for</span><span class="w"> </span><span class="n">author</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="o">&amp;</span><span class="n">authors</span><span class="w"> </span><span class="p">{</span>
<span class="w">             </span><span class="o">..</span><span class="p">.</span>
<span class="p">}</span>
</pre></div><p>And inside the loop I would create additional 2 git commands read their output via pipe and feed it to head command. This is where I learned that it is not straight forward as it looks :-). <em>std::process::Command</em> type does not implement <em>Copy</em> nor <em>Clone</em> traits which means one use of it I will give up the ownership!. And here I started fighting with borrow checker. I need to duplicate declarations to make sure I've required commands available all the time. Additionally I needed to handle error output at every point which created too many nested statements there by complicating the program and reducing its readability</p><p>When all started getting out of control I gave a second thought and wondered if it would be good to write down this in shell script ship it along with debcargo and use the script Rust program. This would satisfy my need but I would need to ship additional script along with debcargo which I was not really happy with.</p><p>Then a search on crates.io revealed <em>subprocess</em>, a crate designed to be similar with <em>subprocess</em> module from Python!. Though crate is not highly downloaded it still looked promising, especially the trait implements a trait called <cite>BitOr</cite> which allows use of <cite>|</cite> operator to chain the commands. Additionally it allows executing full shell commands without need of additional chaining of argument which was done above snippet. End result a much simplified easy to read and correct function which does what was needed. Below is the function I wrote to extract copyright information from git repo.</p><div class="highlight"><pre><span></span><span class="k">fn</span><span class="w"> </span><span class="nf">copyright_fromgit</span><span class="p">(</span><span class="n">repo</span><span class="p">:</span><span class="w"> </span><span class="kp">&amp;</span><span class="kt">str</span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nb">Result</span><span class="o">&lt;</span><span class="nb">Vec</span><span class="o">&lt;</span><span class="nb">String</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">tempdir</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TempDir</span><span class="p">::</span><span class="n">new_in</span><span class="p">(</span><span class="s">&quot;.&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;debcargo&quot;</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
<span class="w">    </span><span class="n">Exec</span><span class="p">::</span><span class="n">shell</span><span class="p">(</span><span class="n">OsStr</span><span class="p">::</span><span class="n">new</span><span class="p">(</span><span class="fm">format!</span><span class="p">(</span><span class="s">&quot;git clone --bare {} {}&quot;</span><span class="p">,</span>
<span class="w">                                </span><span class="n">repo</span><span class="p">,</span>
<span class="w">                                </span><span class="n">tempdir</span><span class="p">.</span><span class="n">path</span><span class="p">().</span><span class="n">to_str</span><span class="p">().</span><span class="n">unwrap</span><span class="p">())</span>
<span class="w">                              </span><span class="p">.</span><span class="n">as_str</span><span class="p">())).</span><span class="n">stdout</span><span class="p">(</span><span class="n">subprocess</span><span class="p">::</span><span class="n">NullFile</span><span class="p">)</span>
<span class="w">                              </span><span class="p">.</span><span class="n">stderr</span><span class="p">(</span><span class="n">subprocess</span><span class="p">::</span><span class="n">NullFile</span><span class="p">)</span>
<span class="w">                              </span><span class="p">.</span><span class="n">popen</span><span class="p">()</span><span class="o">?</span><span class="p">;</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">author_process</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="n">Exec</span><span class="p">::</span><span class="n">shell</span><span class="p">(</span><span class="n">OsStr</span><span class="p">::</span><span class="n">new</span><span class="p">(</span><span class="s">&quot;git log --format=</span><span class="se">\&quot;</span><span class="s">%an &lt;%ae&gt;</span><span class="se">\&quot;</span><span class="s">&quot;</span><span class="p">)).</span><span class="n">cwd</span><span class="p">(</span><span class="n">tempdir</span><span class="p">.</span><span class="n">path</span><span class="p">())</span><span class="w"> </span><span class="o">|</span>
<span class="w">         </span><span class="n">Exec</span><span class="p">::</span><span class="n">shell</span><span class="p">(</span><span class="n">OsStr</span><span class="p">::</span><span class="n">new</span><span class="p">(</span><span class="s">&quot;sort -u&quot;</span><span class="p">))</span>
<span class="w">     </span><span class="p">}.</span><span class="n">capture</span><span class="p">()</span><span class="o">?</span><span class="p">;</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">authors</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">author_process</span><span class="p">.</span><span class="n">stdout_str</span><span class="p">().</span><span class="n">trim</span><span class="p">().</span><span class="n">to_string</span><span class="p">();</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">authors</span><span class="p">:</span><span class="w"> </span><span class="nb">Vec</span><span class="o">&lt;&amp;</span><span class="kt">str</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">authors</span><span class="p">.</span><span class="n">split</span><span class="p">(</span><span class="sc">&#39;\n&#39;</span><span class="p">).</span><span class="n">collect</span><span class="p">();</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">notices</span><span class="p">:</span><span class="w"> </span><span class="nb">Vec</span><span class="o">&lt;</span><span class="nb">String</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Vec</span><span class="p">::</span><span class="n">new</span><span class="p">();</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="n">author</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="o">&amp;</span><span class="n">authors</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">reverse_command</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="fm">format!</span><span class="p">(</span><span class="s">&quot;git log --author=</span><span class="se">\&quot;</span><span class="s">{}</span><span class="se">\&quot;</span><span class="s"> --format=%ad --date=format:%Y \</span>
<span class="s">                                    --reverse&quot;</span><span class="p">,</span>
<span class="w">                                   </span><span class="n">author</span><span class="p">);</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">command</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="fm">format!</span><span class="p">(</span><span class="s">&quot;git log --author=</span><span class="se">\&quot;</span><span class="s">{}</span><span class="se">\&quot;</span><span class="s"> --format=%ad --date=format:%Y&quot;</span><span class="p">,</span>
<span class="w">                           </span><span class="n">author</span><span class="p">);</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">first</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">             </span><span class="n">Exec</span><span class="p">::</span><span class="n">shell</span><span class="p">(</span><span class="n">OsStr</span><span class="p">::</span><span class="n">new</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reverse_command</span><span class="p">)).</span><span class="n">cwd</span><span class="p">(</span><span class="n">tempdir</span><span class="p">.</span><span class="n">path</span><span class="p">())</span><span class="w"> </span><span class="o">|</span>
<span class="w">             </span><span class="n">Exec</span><span class="p">::</span><span class="n">shell</span><span class="p">(</span><span class="n">OsStr</span><span class="p">::</span><span class="n">new</span><span class="p">(</span><span class="s">&quot;head -n1&quot;</span><span class="p">))</span>
<span class="w">         </span><span class="p">}.</span><span class="n">capture</span><span class="p">()</span><span class="o">?</span><span class="p">;</span>

<span class="w">         </span><span class="kd">let</span><span class="w"> </span><span class="n">latest</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">             </span><span class="n">Exec</span><span class="p">::</span><span class="n">shell</span><span class="p">(</span><span class="n">OsStr</span><span class="p">::</span><span class="n">new</span><span class="p">(</span><span class="o">&amp;</span><span class="n">command</span><span class="p">)).</span><span class="n">cwd</span><span class="p">(</span><span class="n">tempdir</span><span class="p">.</span><span class="n">path</span><span class="p">())</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Exec</span><span class="p">::</span><span class="n">shell</span><span class="p">(</span><span class="s">&quot;head -n1&quot;</span><span class="p">)</span>
<span class="w">         </span><span class="p">}.</span><span class="n">capture</span><span class="p">()</span><span class="o">?</span><span class="p">;</span>

<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">start</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kt">i32</span><span class="p">::</span><span class="n">from_str</span><span class="p">(</span><span class="n">first</span><span class="p">.</span><span class="n">stdout_str</span><span class="p">().</span><span class="n">trim</span><span class="p">())</span><span class="o">?</span><span class="p">;</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">end</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kt">i32</span><span class="p">::</span><span class="n">from_str</span><span class="p">(</span><span class="n">latest</span><span class="p">.</span><span class="n">stdout_str</span><span class="p">().</span><span class="n">trim</span><span class="p">())</span><span class="o">?</span><span class="p">;</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">cnotice</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">match</span><span class="w"> </span><span class="n">start</span><span class="p">.</span><span class="n">cmp</span><span class="p">(</span><span class="o">&amp;</span><span class="n">end</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">Ordering</span><span class="p">::</span><span class="n">Equal</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="fm">format!</span><span class="p">(</span><span class="s">&quot;{}, {}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">start</span><span class="p">,</span><span class="w"> </span><span class="n">author</span><span class="p">),</span>
<span class="w">            </span><span class="n">_</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="fm">format!</span><span class="p">(</span><span class="s">&quot;{}-{}, {}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">start</span><span class="p">,</span><span class="w"> </span><span class="n">end</span><span class="p">,</span><span class="w"> </span><span class="n">author</span><span class="p">),</span>
<span class="w">        </span><span class="p">};</span>

<span class="w">        </span><span class="n">notices</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="n">cnotice</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nb">Ok</span><span class="p">(</span><span class="n">notices</span><span class="p">)</span>
<span class="p">}</span>
</pre></div><p>Of course it is not as short as the shell or probably Python code, but that is fine as Rust is system level programming language (which is intended to replace C/C++) and doing complex Shell code (complex due to need of shell pipelines) in approximately 50 lines of code in safe and secure way is very much acceptable. Besides code is as much readable as a plain shell snippet thanks to the <cite>|</cite> operator implemented by subprocess crate.</p></div><div id="footer"><p><italic>Tagged as: rust, subprocess, </italic></p></section></div><hr><div id="footer"> Site Proudly powered by <a href="http://getpelican.com/">Pelican</a></div></body></html>