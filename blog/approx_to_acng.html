<!DOCTYPE html><html lang="en"><head><link href="https://fonts.googleapis.com/css?family=Cantarell" rel="stylesheet"><title>Switching from approx to apt-cacher-ng</title><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1"><link href="https://copyninja.in/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Random Ramblings Full Atom Feed"><link href="https://copyninja.in/feeds/{slug}.atom.xml" type="application/atom+xml" rel="alternate" title="Random Ramblings Categories Atom Feed"><link rel="stylesheet" type="text/css" href="/theme/css/pygments.css"><link rel="stylesheet" type="text/css" href="/theme/css/default.css"><meta name="tags" content="apt"><meta name="tags" content="approx"><meta name="tags" content="apt-cacher-ng"><meta name="tags" content="debian"></head><body><div id="header" class="body"><div id="navigation"> | <a href="https://copyninja.in">Home</a> | | <a href="https://copyninja.in/about">About</a> | | <a href="https://copyninja.in/contact">Contact</a> | | <a href="https://copyninja.in/categories.html">Categories</a> | | <a href="https://copyninja.in/tags.html">Tags</a> | </div><h1><a href="https://copyninja.in/blog/approx_to_acng.html">Switching from approx to apt-cacher-ng</a></h1></div><div id="content"><section id="content" class="body"><footer class="post-info"><p> Posted on Jul 17, 2016 By copyninja under devops </p></abbr></footer><div class="entry-content"><p>After a long ~5 years (from 2011) journey with approx I finally wanted to switch to something new like apt-cacher-ng. And after a bit of changes I finally managed to get apt-cacher-ng into my work flow.</p><div class="section" id="bit-of-history"><h2>Bit of History</h2><p>I should first give you a brief on how I started using approx. It all started in MiniDebconf 2011 which I organized at my Alma-mater. I met Jonas Smedegaard here and from him I learned about approx. Jonas has a bunch of machines at his home and he was active user of approx and he showed it to me while explaining the <em>Boxer</em> project. I was quite impressed with approx. Back then I was using a 230kbps slow INTERNET connection and I was also maintaining a couple of packages in Debian. Updating the pbuilder chroots was time consuming task for me as I had to download multiple times over slow net. And approx largely solved this problem and I started using it.</p><p>5 years fast forward I now have quite fast INTERNET with good FUP. (About 50GB a month), but I still tend to use approx which makes building packages quite faster. I also use couple of containers on my laptop which all use my laptop as approx cache.</p></div><div class="section" id="why-switch"><h2>Why switch?</h2><p>So why change to apt-cacher-ng?. Approx is a simple tool, it runs mainly with inetd and sits between apt and the repository on INTERNET. Where as apt-cacher-ng provides a lot of features. Below are some listed from the apt-cacher-ng manual.</p><ul class="simple"><li>use of TLS/SSL repositories (may be possible with approx but I'm notsure how to do it)</li><li>Access control of who can access caching server</li><li>Integration with debdelta (I've not tried, approx also supports debdelta)</li><li>Avoiding use of apt-cacher-ng for some hosts</li><li>Avoiding caching of some file types</li><li>Partial mirroring for offline usage.</li><li>Selection of ipv4 or ipv6 for connections.</li></ul><p>The biggest change I see is the speed difference between approx and apt-cacher-ng. I think this is mainly because apt-cacher-ng is threaded where as approx runs using inetd.</p><p>I do not want all features of apt-cacher-ng at the moment, but who knows in future I might need some features and hence I decided to switch to apt-cacher-ng over approx.</p></div><div class="section" id="transition"><h2>Transition</h2><p>Transition from approx to apt-cacher-ng was smoother than I expected. There are 2 approaches you can use one is explicit routing another is transparent routing. I prefer transparent routing and I only had to change my /etc/apt/sources.list to use the actual repository URL.</p><div class="highlight"><pre><span></span><span class="k">deb</span><span class="w"> </span><span class="s">http://deb.debian.org/debian</span><span class="w"> </span><span class="kp">unstable</span><span class="w"> </span><span class="kp">main</span><span class="w"> </span><span class="kp">contrib</span><span class="w"> </span><span class="kp">non-free</span>
<span class="k">deb-src</span><span class="w"> </span><span class="s">http://deb.debian.org/debian</span><span class="w"> </span><span class="kp">unstable</span><span class="w"> </span><span class="kp">main</span>

<span class="k">deb</span><span class="w"> </span><span class="s">http://deb.debian.org/debian</span><span class="w"> </span><span class="kp">experimental</span><span class="w"> </span><span class="kp">main</span><span class="w"> </span><span class="kp">contrib</span><span class="w"> </span><span class="kp">non-free</span>
<span class="k">deb-src</span><span class="w"> </span><span class="s">http://deb.debian.org/debian</span><span class="w"> </span><span class="kp">experimental</span><span class="w"> </span><span class="kp">main</span>
</pre></div><p>After above change I had to add a <em>01proxy</em> configuration file to <em>/etc/apt/apt.conf.d/</em> with following content.</p><div class="highlight"><pre><span></span>Acquire::http::Proxy &quot;http://localhost:3142/&quot;
</pre></div><p>I use explicit routing only when using apt-cacher-ng with pbuilder and debootstrap. Following snippet shows explicit routing through <em>/etc/apt/sources.list</em>.</p><div class="highlight"><pre><span></span><span class="k">deb</span><span class="w"> </span><span class="s">http://localhost:3142/deb.debian.org/debian</span><span class="w"> </span><span class="kp">unstable</span><span class="w"> </span><span class="kp">main</span>
</pre></div><div class="section" id="usage-with-pbuilder-and-friends"><h3>Usage with pbuilder and friends</h3><p>To use apt-cacher-ng with pbuilder you need to modify /etc/pbuilderrc to contain following line</p><div class="highlight"><pre><span></span><span class="nv">MIRRORSITE</span><span class="o">=</span>http://localhost:3142/deb.debian.org/debian
</pre></div></div><div class="section" id="usage-with-debootstrap"><h3>Usage with debootstrap</h3><p>To use apt-cacher-ng with debootstrap, pass MIRROR argument of debootstrap as <cite>http://localhost:3142/deb.debian.org/debian</cite>.</p></div></div><div class="section" id="conclusion"><h2>Conclusion</h2><p>I've now completed full transition of my work flow to apt-cacher-ng and purged approx and its cache.</p><div class="strike docutils container"> Though it works fine I feel that there will be 2 caches created when you use transparent and explicit proxy using localhost:3142 URL. I'm sure it is possible to configure this to avoid duplication, but I've not yet figured it. If you know how to fix this do let me know.</div><div class="section" id="update"><h3>Update</h3><p>Jonas told me that its not 2 caches but 2 routing paths, one for transparent routing and another for explicit routing. So I guess there is nothing here to fix :-).</p></div></div></div><div id="footer"><p><italic>Tagged as: approx, apt, apt-cacher-ng, debian, </italic></p></section></div><hr><div id="footer"> Site Proudly powered by <a href="http://getpelican.com/">Pelican</a></div></body></html>