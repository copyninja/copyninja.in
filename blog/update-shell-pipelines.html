<!DOCTYPE html><html lang="en"><head><link href="https://fonts.googleapis.com/css?family=Cantarell" rel="stylesheet"><title>Update: - Shell pipelines with subprocess crate and use of Exec::shell function</title><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1"><link href="https://copyninja.in/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Random Ramblings Full Atom Feed"><link href="https://copyninja.in/feeds/{slug}.atom.xml" type="application/atom+xml" rel="alternate" title="Random Ramblings Categories Atom Feed"><link rel="stylesheet" type="text/css" href="/theme/css/pygments.css"><link rel="stylesheet" type="text/css" href="/theme/css/default.css"><meta name="tags" content="rust"><meta name="tags" content="subprocess"><meta name="tags" content="shell inejctions"></head><body><div id="header" class="body"><div id="navigation"> | <a href="https://copyninja.in">Home</a> | | <a href="https://copyninja.in/about">About</a> | | <a href="https://copyninja.in/contact">Contact</a> | | <a href="https://copyninja.in/categories.html">Categories</a> | | <a href="https://copyninja.in/tags.html">Tags</a> | </div><h1><a href="https://copyninja.in/blog/update-shell-pipelines.html">Update: - Shell pipelines with subprocess crate and use of Exec::shell function</a></h1></div><div id="content"><section id="content" class="body"><footer class="post-info"><p> Posted on Jun 19, 2017 By copyninja under development </p></abbr></footer><div class="entry-content"><p>In my <a class="reference external" href="https://copyninja.info/blog/shell-pipelines-rust.html">previous post</a> I used <cite>Exec::shell</cite> function from subprocess crate and passed it string generated by interpolating <em>--author</em> argument. This string was then run by the shell via <cite>Exec::shell</cite>. After publishing post I got ping on IRC by <a class="reference external" href="https://wiki.debian.org/JonasSmedegaard">Jonas Smedegaard</a> and <a class="reference external" href="https://wiki.debian.org/PaulWise">Paul Wise</a> that I should replace <cite>Exec::shell</cite>, as it might be prone to errors or vulnerabilities of shell injection attack. Indeed they were right, in hurry I did not completely read the function documentation which clearly mentions this fact.</p><blockquote> When invoking this function, be careful not to interpolate arguments into the string run by the shell, such as Exec::shell(format!(&quot;sort {}&quot;, filename)). Such code is prone to errors and, if filename comes from an untrusted source, to shell injection attacks. Instead, use Exec::cmd(&quot;sort&quot;).arg(filename).</blockquote><p>Though I'm not directly taking input from untrusted source, its still possible that the string I got back from git log command might contain some oddly formatted string with characters of different encoding which could possibly break the <cite>Exec::shell</cite> , as I'm not sanitizing the shell command. When we use <cite>Exec::cmd</cite> and pass argument using <em>.args</em> chaining, the library takes care of creating safe command line. So I went in and modified the function to use <cite>Exec::cmd</cite> instead of <cite>Exec::shell</cite>.</p><p>Below is updated function.</p><div class="highlight"><pre><span></span><span class="k">fn</span><span class="w"> </span><span class="nf">copyright_fromgit</span><span class="p">(</span><span class="n">repo</span><span class="p">:</span><span class="w"> </span><span class="kp">&amp;</span><span class="kt">str</span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nb">Result</span><span class="o">&lt;</span><span class="nb">Vec</span><span class="o">&lt;</span><span class="nb">String</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">tempdir</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TempDir</span><span class="p">::</span><span class="n">new_in</span><span class="p">(</span><span class="s">&quot;.&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;debcargo&quot;</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
<span class="w">    </span><span class="n">Exec</span><span class="p">::</span><span class="n">cmd</span><span class="p">(</span><span class="s">&quot;git&quot;</span><span class="p">)</span>
<span class="w">     </span><span class="p">.</span><span class="n">args</span><span class="p">(</span><span class="o">&amp;</span><span class="p">[</span><span class="s">&quot;clone&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;--bare&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">repo</span><span class="p">,</span><span class="w"> </span><span class="n">tempdir</span><span class="p">.</span><span class="n">path</span><span class="p">().</span><span class="n">to_str</span><span class="p">().</span><span class="n">unwrap</span><span class="p">()])</span>
<span class="w">     </span><span class="p">.</span><span class="n">stdout</span><span class="p">(</span><span class="n">subprocess</span><span class="p">::</span><span class="n">NullFile</span><span class="p">)</span>
<span class="w">     </span><span class="p">.</span><span class="n">stderr</span><span class="p">(</span><span class="n">subprocess</span><span class="p">::</span><span class="n">NullFile</span><span class="p">)</span>
<span class="w">     </span><span class="p">.</span><span class="n">popen</span><span class="p">()</span><span class="o">?</span><span class="p">;</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">author_process</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">Exec</span><span class="p">::</span><span class="n">shell</span><span class="p">(</span><span class="n">OsStr</span><span class="p">::</span><span class="n">new</span><span class="p">(</span><span class="s">&quot;git log --format=</span><span class="se">\&quot;</span><span class="s">%an &lt;%ae&gt;</span><span class="se">\&quot;</span><span class="s">&quot;</span><span class="p">)).</span><span class="n">cwd</span><span class="p">(</span><span class="n">tempdir</span><span class="p">.</span><span class="n">path</span><span class="p">())</span><span class="w"> </span><span class="o">|</span>
<span class="w">        </span><span class="n">Exec</span><span class="p">::</span><span class="n">shell</span><span class="p">(</span><span class="n">OsStr</span><span class="p">::</span><span class="n">new</span><span class="p">(</span><span class="s">&quot;sort -u&quot;</span><span class="p">))</span>
<span class="w">    </span><span class="p">}.</span><span class="n">capture</span><span class="p">()</span><span class="o">?</span><span class="p">;</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">authors</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">author_process</span><span class="p">.</span><span class="n">stdout_str</span><span class="p">().</span><span class="n">trim</span><span class="p">().</span><span class="n">to_string</span><span class="p">();</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">authors</span><span class="p">:</span><span class="w"> </span><span class="nb">Vec</span><span class="o">&lt;&amp;</span><span class="kt">str</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">authors</span><span class="p">.</span><span class="n">split</span><span class="p">(</span><span class="sc">&#39;\n&#39;</span><span class="p">).</span><span class="n">collect</span><span class="p">();</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">notices</span><span class="p">:</span><span class="w"> </span><span class="nb">Vec</span><span class="o">&lt;</span><span class="nb">String</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Vec</span><span class="p">::</span><span class="n">new</span><span class="p">();</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="n">author</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="o">&amp;</span><span class="n">authors</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">author_string</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="fm">format!</span><span class="p">(</span><span class="s">&quot;--author={}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">author</span><span class="p">);</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">first</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">Exec</span><span class="p">::</span><span class="n">cmd</span><span class="p">(</span><span class="s">&quot;/usr/bin/git&quot;</span><span class="p">)</span>
<span class="w">             </span><span class="p">.</span><span class="n">args</span><span class="p">(</span><span class="o">&amp;</span><span class="p">[</span><span class="s">&quot;log&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;--format=%ad&quot;</span><span class="p">,</span>
<span class="w">                    </span><span class="s">&quot;--date=format:%Y&quot;</span><span class="p">,</span>
<span class="w">                    </span><span class="s">&quot;--reverse&quot;</span><span class="p">,</span>
<span class="w">                    </span><span class="o">&amp;</span><span class="n">author_string</span><span class="p">])</span>
<span class="w">             </span><span class="p">.</span><span class="n">cwd</span><span class="p">(</span><span class="n">tempdir</span><span class="p">.</span><span class="n">path</span><span class="p">())</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Exec</span><span class="p">::</span><span class="n">shell</span><span class="p">(</span><span class="n">OsStr</span><span class="p">::</span><span class="n">new</span><span class="p">(</span><span class="s">&quot;head -n1&quot;</span><span class="p">))</span>
<span class="w">        </span><span class="p">}.</span><span class="n">capture</span><span class="p">()</span><span class="o">?</span><span class="p">;</span>

<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">latest</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">Exec</span><span class="p">::</span><span class="n">cmd</span><span class="p">(</span><span class="s">&quot;/usr/bin/git&quot;</span><span class="p">)</span>
<span class="w">             </span><span class="p">.</span><span class="n">args</span><span class="p">(</span><span class="o">&amp;</span><span class="p">[</span><span class="s">&quot;log&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;--format=%ad&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;--date=format:%Y&quot;</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">author_string</span><span class="p">])</span>
<span class="w">             </span><span class="p">.</span><span class="n">cwd</span><span class="p">(</span><span class="n">tempdir</span><span class="p">.</span><span class="n">path</span><span class="p">())</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Exec</span><span class="p">::</span><span class="n">shell</span><span class="p">(</span><span class="s">&quot;head -n1&quot;</span><span class="p">)</span>
<span class="w">        </span><span class="p">}.</span><span class="n">capture</span><span class="p">()</span><span class="o">?</span><span class="p">;</span>

<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">start</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kt">i32</span><span class="p">::</span><span class="n">from_str</span><span class="p">(</span><span class="n">first</span><span class="p">.</span><span class="n">stdout_str</span><span class="p">().</span><span class="n">trim</span><span class="p">())</span><span class="o">?</span><span class="p">;</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">end</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kt">i32</span><span class="p">::</span><span class="n">from_str</span><span class="p">(</span><span class="n">latest</span><span class="p">.</span><span class="n">stdout_str</span><span class="p">().</span><span class="n">trim</span><span class="p">())</span><span class="o">?</span><span class="p">;</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">cnotice</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">match</span><span class="w"> </span><span class="n">start</span><span class="p">.</span><span class="n">cmp</span><span class="p">(</span><span class="o">&amp;</span><span class="n">end</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">Ordering</span><span class="p">::</span><span class="n">Equal</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="fm">format!</span><span class="p">(</span><span class="s">&quot;{}, {}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">start</span><span class="p">,</span><span class="w"> </span><span class="n">author</span><span class="p">),</span>
<span class="w">            </span><span class="n">_</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="fm">format!</span><span class="p">(</span><span class="s">&quot;{}-{}, {}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">start</span><span class="p">,</span><span class="w"> </span><span class="n">end</span><span class="p">,</span><span class="w"> </span><span class="n">author</span><span class="p">),</span>
<span class="w">        </span><span class="p">};</span>

<span class="w">        </span><span class="n">notices</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="n">cnotice</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nb">Ok</span><span class="p">(</span><span class="n">notices</span><span class="p">)</span>
<span class="p">}</span>
</pre></div><p>I still use <cite>Exec::shell</cite> for generating author list, this is not problematic as I'm not interpolating arguments to create command string.</p></div><div id="footer"><p><italic>Tagged as: rust, shell inejctions, subprocess, </italic></p></section></div><hr><div id="footer"> Site Proudly powered by <a href="http://getpelican.com/">Pelican</a></div></body></html>