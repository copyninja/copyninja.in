<!DOCTYPE html><html lang="en"><head><link href="https://fonts.googleapis.com/css?family=Cantarell" rel="stylesheet"><title>Installing and Configuring NetBSD on Qemu in Debian</title><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1"><link href="https://copyninja.in/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Random Ramblings Full Atom Feed"><link href="https://copyninja.in/feeds/{slug}.atom.xml" type="application/atom+xml" rel="alternate" title="Random Ramblings Categories Atom Feed"><link rel="stylesheet" type="text/css" href="/theme/css/pygments.css"><link rel="stylesheet" type="text/css" href="/theme/css/default.css"><meta name="tags" content="debian"><meta name="tags" content="netbsd"><meta name="tags" content="qemu"><meta name="tags" content="vde"><meta name="tags" content="networking"></head><body><div id="header" class="body"><div id="navigation"> | <a href="https://copyninja.in">Home</a> | | <a href="https://copyninja.in/about">About</a> | | <a href="https://copyninja.in/contact">Contact</a> | | <a href="https://copyninja.in/categories.html">Categories</a> | | <a href="https://copyninja.in/tags.html">Tags</a> | </div><h1><a href="https://copyninja.in/blog/netbsd-on-qemu.html">Installing and Configuring NetBSD on Qemu in Debian</a></h1></div><div id="content"><section id="content" class="body"><footer class="post-info"><p> Posted on Mar 01, 2014 By copyninja under bsd </p></abbr></footer><div class="entry-content"><p>First step will be getting a NetBSD ISO image for installation purpose. It can be downloaded from <a class="reference external" href="http://www.netbsd.org/mirrors/torrents/#6.1.3-ports">here</a>.</p><p>Next step will be creating a disk image for installing NetBSD. This is done using <tt class="docutils literal"><span class="pre">qemu-img</span></tt> tool like below</p><div class="highlight"><pre><span></span><span class="gp">$ </span>qemu-img<span class="w"> </span>create<span class="w"> </span>-f<span class="w"> </span>raw<span class="w"> </span>netbsd-disk.img<span class="w"> </span>10G
</pre></div><p>Image format used is <em>raw</em> and size is specified as last arugment. Tune the size as per your need.</p><p>To start the installation run the following command</p><div class="highlight"><pre><span></span><span class="gp">$ </span>qemu-system-x86_64<span class="w"> </span>-m<span class="w"> </span>256M<span class="w"> </span>-hda<span class="w"> </span>netbsd-disk.img<span class="w"> </span>-cdrom<span class="w"> </span><span class="se">\</span>
<span class="w">             </span>NetBSD-6.1.3-amd64.iso<span class="w"> </span>-display<span class="w"> </span>curses<span class="w"> </span>-boot<span class="w"> </span>d<span class="w"> </span><span class="se">\</span>
<span class="w">             </span>-net<span class="w"> </span>nic<span class="w"> </span>-net<span class="w"> </span>user
</pre></div><p>So this is using user mode networking so you won't be able to have internet access during installation. I couldn't figure out on how to get network working during installation so I configured network after installation.</p><p>Once you run above command you will be given with 4 options as follows.</p><ol class="arabic simple"><li>install netbsd</li><li>install netbsd with ACPI disabled</li><li>install netbsd with ACPI and SMP disabled</li><li>drop to boot shell</li></ol><p>Even though I first installed using the option 1 I couldn't get it boot after installation so had to reinstall with option 2 and it works fine. I'm not gonna explain each step of installation here because the installer is really simple and straight forward! I guess the NetBSD installer is the first simplest installer I have encountered from the day I started with Linux. Its simple but powerful and gets job done very easily, and I didn't read manual for installation before using it.</p><div class="section" id="enabling-networking"><h2>Enabling Networking</h2><p>This section involves mixture of configuration in Debian host and inside NetBSD to get the network working. The wiki page of Debian on <a class="reference external" href="https://wiki.debian.org/QEMU#Networking">Qemu</a>. helped me here.</p><p>To share the network with Qemu there are 2 possiblities</p><ol class="arabic simple"><li>Bridged networking between host and guest using <em>bridge-utils</em></li><li>Using VDE <em>(Virtual Distributed Ethernet)</em></li></ol><p>The option 1 which is explained in wiki linked above didn't work for me as I use CDC Ether based datacard for connecting to Internet which gets detected as <em>eth1</em> on my machine. When bridging happens between <em>tap0</em> and <em>eth1</em> I end up loosing Internet on my host machine. So I selected to use VDE instead.</p><p>First install packages <em>vde2</em> and <em>uml-utilities</em> once done edit the <em>/etc/network/interfaces</em> file and add following lines:</p><pre class="literal-block">
auto vdetap
iface vdetap inet static
   address 192.168.2.1
   netmask 255.255.255.0
   vde2-switch -t vdetap
</pre><p>We can use <em>dnsmasq</em> as a DHCP server for the <em>vdetap</em> interface, but I'm not gonna explain the configuration of <em>dnsmasq</em> here. Run the below command to get vdetap up</p><div class="highlight"><pre><span></span><span class="go">modprobe tun</span>
<span class="go">ifup vdetap</span>
<span class="go">/etc/init.d/dnsmasq restart</span>
<span class="go">newgrp vde2-net # run as user starting Qemu VM&#39;s</span>
</pre></div><p>I couldn't get successful output for <em>newgrp</em> command, I was getting some <tt class="docutils literal">crypt: Invalid argument</tt> output. But I could still get network working on NetBSD so I considered to ignore that for now.</p><p>Now start the NetBSD qemu instance running using following command</p><div class="highlight"><pre><span></span><span class="gp">$ </span>qemu-system-x86_64<span class="w"> </span>-m<span class="w"> </span>256M<span class="w"> </span>-hda<span class="w"> </span><span class="se">\</span>
<span class="w">             </span>/mnt/kailash/BSDWorld/netbsd-disk.img<span class="w"> </span><span class="se">\</span>
<span class="w">             </span>-net<span class="w"> </span>nic<span class="w"> </span>-net<span class="w"> </span>vde,sock<span class="o">=</span>/var/run/vde2/vdetap.ctl<span class="w"> </span>-display<span class="w"> </span>curses
</pre></div><p>Once the system is up login using <em>root</em> user, NetBSD will warn you for this and suggest to create another user but for now ignore it. To find the network interface in NetBSD just run the usual <em>ifconfig</em> command. In my case interface is named <em>wm0</em>.</p><p>First step will be configuring the IP address for your interface and setting up the gateway route. Run the below command for this purpose</p><div class="highlight"><pre><span></span><span class="gp"># </span>ifconfig<span class="w"> </span>wm0<span class="w"> </span><span class="m">192</span>.168.2.2<span class="w"> </span>netmask<span class="w"> </span><span class="m">255</span>.255.255.0
<span class="gp"># </span>route<span class="w"> </span>add<span class="w"> </span>default<span class="w"> </span><span class="m">192</span>.168.2.1
</pre></div><p>Note that I added gateway as IP address of vdetap on my host machine. Now try pinging the host and even you can try ssh to host system.</p><p>But note that this is not persistent over the reboots and for some reason I didn't yet figure out how to make NetBSD get address over DHCP from my host machine. I will update once I figure it out. Now to make the connection address persistent over reboots you need to create a file by name <em>/etc/ifconfg.&lt;interface&gt;</em>. Replace <em>interface</em> with a proper interface on your running NetBSD. In my case this file is <em>/etc/ifconfig.wm0</em> and has following content.:</p><pre class="literal-block">
192.168.2.2 netmask 0xffffff00 media autoselect
</pre><p>Set the DNS server as host by adding file <em>/etc/resolv.conf</em> with following content.:</p><pre class="literal-block">
nameserver 192.168.2.1
</pre><p>After this you need to do NAT/masquerading using iptables. Just copy following script to a file and execute it as root</p><div class="highlight"><pre><span></span><span class="ch">#!/bin/sh</span>

<span class="c1"># Restart the dnsmasq</span>
/etc/init.d/dnsmasq<span class="w"> </span>restart

<span class="c1"># Set nat rules in iptables</span>
iptables<span class="w"> </span>--flush
iptables<span class="w"> </span>--table<span class="w"> </span>nat<span class="w"> </span>--flush
iptables<span class="w"> </span>--delete-chain
iptables<span class="w"> </span>--table<span class="w"> </span>nat<span class="w"> </span>--delete-chain

<span class="c1"># Replace accordingly usb0 with ppp0 for 3G</span>
iptables<span class="w"> </span>--table<span class="w"> </span>nat<span class="w"> </span>--append<span class="w"> </span>POSTROUTING<span class="w"> </span>--out-interface<span class="w"> </span>eth1<span class="w"> </span>-j<span class="w"> </span>MASQUERADE
iptables<span class="w"> </span>--append<span class="w"> </span>FORWARD<span class="w"> </span>--in-interface<span class="w"> </span>vdetap<span class="w"> </span>-j<span class="w"> </span>ACCEPT

<span class="c1"># Enable IP forwarding in Kernel</span>
sysctl<span class="w"> </span>-w<span class="w"> </span>net.ipv4.ip_forward<span class="o">=</span><span class="m">1</span>
</pre></div><p>With the above setup you will be able to get DNS resolution even after you reboot the Qemu instance but Internet connection will not work untill you run the <tt class="docutils literal">route</tt> command I mentioned above. I still didn't figure out how to persist route but I will update it here once I figure it out.</p><blockquote> Note that you won't be able to SSH as root to NetBSD (may be its configured to not allow by default), so you would need to create a normal user before trying to SSH from host to guest. Also make sure you add the user to <em>wheel</em> group to allow him execute su command.</blockquote><p>So now I've NetBSD running on my laptop with mere 256M ram and its amazingly fast even at such low RAM. I've created a new user and can SSH into it from host machine and use it just like I use a server!. I will put up the notes of my BSD adventure here periodically.</p><p>The feeling of using a BSD is amazing :-)</p><blockquote><strong>Update</strong>: I forgot to add masquerading step, I've added it now.</blockquote></div></div><div id="footer"><p><italic>Tagged as: debian, netbsd, networking, qemu, vde, </italic></p></section></div><hr><div id="footer"> Site Proudly powered by <a href="http://getpelican.com/">Pelican</a></div></body></html>