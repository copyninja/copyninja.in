<!DOCTYPE html><html lang="en"><head><link href="https://fonts.googleapis.com/css?family=Cantarell" rel="stylesheet"><title>Friendica instance on my VPS is down</title><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1"><link href="https://copyninja.in/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Random Ramblings Full Atom Feed"><link href="https://copyninja.in/feeds/{slug}.atom.xml" type="application/atom+xml" rel="alternate" title="Random Ramblings Categories Atom Feed"><link rel="stylesheet" type="text/css" href="/theme/css/pygments.css"><link rel="stylesheet" type="text/css" href="/theme/css/default.css"><meta name="tags" content="friendica"><meta name="tags" content="sysadmin"><meta name="tags" content="php"><meta name="tags" content="debian"><meta name="tags" content="sandboxing"></head><body><div id="header" class="body"><div id="navigation"> | <a href="https://copyninja.in">Home</a> | | <a href="https://copyninja.in/about">About</a> | | <a href="https://copyninja.in/contact">Contact</a> | | <a href="https://copyninja.in/categories.html">Categories</a> | | <a href="https://copyninja.in/tags.html">Tags</a> | </div><h1><a href="https://copyninja.in/blog/friendica-instance-down.html">Friendica instance on my VPS is down</a></h1></div><div id="content"><section id="content" class="body"><footer class="post-info"><p> Posted on Feb 08, 2014 By copyninja under misc </p></abbr></footer><div class="entry-content"><p>I started running <a class="reference external" href="http://friendica.com">Friendica</a> instance on my VPS. With help of <a class="reference external" href="http://dr.jones.dk">Jonas Smedegaard</a> I managed to run Friendica in a uWSGI container. The site was running at <em>samsargika.copyninja.info</em> and is no longer accessible.</p><p>Since VPS itself was running Debian Wheezy I couldn't run uWSGI with PHP support on it. <em>(support for PHP in uWSGI landed after Wheezy)</em>. But Jonas was kind enough for me to provide a backported version.</p><p>Recently Wheezy got a security update for PHP and thats where all the problem started. The backported <em>uwsgi-plugin-php</em> was not recompiled to use security updated PHP and I couldn't upgrade the things. After few days I noticed first freeze on my VPS and I had to reboot the VPS to get it online again. The fact I noticed was uWSGI being killed due to a OOM in syslog but I didn't explore much and consulted Jonas to get a updated uWSGI. But that didn't happen as Jonas himself is facing some problem with uWSGI builds. While again checking with aptitude for upgrade I accidentally confirmed removal of <em>uwsgi-plugin-php</em> for getting security updates :-/. But nothing happened to my running service as upgrade of libs in Debian doesn't cause the restart of all services which are using that lib <em>(desired effect is restart of service but I don't know the side affects involved)</em>.</p><p>Second freeze happened yesterday and on the reboot <em>uwsgi-plugin-php</em> was missing there by taking my Friendica instance down. More closer investigation showed the same OOM but this time I noticed each OOM occurred just after cronjob was running <em>poller.php</em> a script which is actually causing all federation in Friendica. So it was clear there is something wrong either in <em>poller.php</em> or in my setup which was making it eat memory and freeze my VPS.</p><p>But I also found some stupidity I did during configuration which Jonas also pointed me out.</p><ol class="arabic simple"><li><em>Installing cronjob inside crontab rather than cron.d</em></li><li><em>Installing poller.php crontab for root user :-/</em></li></ol><p>I basically violated the basic rule by running a unsafe script as root user, good that script didn't do some crazy stuff. So even though my instance went down I learnt my lessons</p><ol class="arabic simple"><li><em>Don't ever ever ever run a unsafe script as root that too through cron</em></li><li><em>Sandbox the unsafe script so it can be killed on time rather than it taking the whole system down.</em></li><li><em>PHP is not really secure, if it was secure there wouldn't be security updates and atleast my site would be still running :-D</em></li></ol><p>So I now need to wait till Jonas get me new shiny backported uWSGI linked against new PHP on Wheezy and till that time I need to explore on how I can sandbox the poller.php script.</p></div><div id="footer"><p><italic>Tagged as: debian, friendica, php, sandboxing, sysadmin, </italic></p></section></div><hr><div id="footer"> Site Proudly powered by <a href="http://getpelican.com/">Pelican</a></div></body></html>