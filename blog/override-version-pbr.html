<!DOCTYPE html><html lang="en"><head><link href="https://fonts.googleapis.com/css?family=Cantarell" rel="stylesheet"><title>Overriding version information from setup.py with pbr</title><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1"><link href="https://copyninja.in/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Random Ramblings Full Atom Feed"><link href="https://copyninja.in/feeds/{slug}.atom.xml" type="application/atom+xml" rel="alternate" title="Random Ramblings Categories Atom Feed"><link rel="stylesheet" type="text/css" href="/theme/css/pygments.css"><link rel="stylesheet" type="text/css" href="/theme/css/default.css"><meta name="tags" content="python"><meta name="tags" content="pbr"><meta name="tags" content="zfec"></head><body><div id="header" class="body"><div id="navigation"> | <a href="https://copyninja.in">Home</a> | | <a href="https://copyninja.in/about">About</a> | | <a href="https://copyninja.in/contact">Contact</a> | | <a href="https://copyninja.in/categories.html">Categories</a> | | <a href="https://copyninja.in/tags.html">Tags</a> | </div><h1><a href="https://copyninja.in/blog/override-version-pbr.html">Overriding version information from setup.py with pbr</a></h1></div><div id="content"><section id="content" class="body"><footer class="post-info"><p> Posted on Jul 16, 2017 By copyninja under development </p></abbr></footer><div class="entry-content"><p>I recently raised a <a class="reference external" href="https://github.com/tahoe-lafs/zfec/pull/5">pull request</a> on zfec for converting its python packaging from pure <cite>setup.py</cite> to <cite>pbr</cite> based. Today I got review from <em>Brian Warner</em> and one of the issue mentioned was <cite>python setup.py --version</cite> is not giving same output as previous version of <cite>setup.py</cite>.</p><p>Previous version used <a class="reference external" href="https://github.com/warner/python-versioneer">versioneer</a> which extracts version information needed from VCS tags. Versioneer also provides flexibility of specifying type of VCS used, style of version, tag prefix (for VCS) etc. <cite>pbr</cite> also does extract version information from git tag but it expects git tag to be of format <em>tags/refs/x.y.z</em> format but <em>zfec</em> used a <cite>zfec-</cite> prefix to tag (example <em>zfec-1.4.24</em>) and <em>pbr</em> does not process this. End result, I get a version in format <em>0.0.devNN</em> where <em>NN</em> is number of commits in the repository from its inception.</p><p>Me and Brian spent few hours trying to figure out a way to tell pbr that we would like to override version information it auto deduces, but there was none other than putting version string in <cite>PBR_VERSION</cite> environment variable. That documentation was contributed by me <a class="reference external" href="https://github.com/openstack-dev/pbr/commit/007f4ee2abf818b4b18b6e8347da1d4eb2e0ad9c">3 years back to pbr project.</a></p><p>So finally I used <cite>versioneer</cite> to create a version string and put it in the environment variable <em>PBR_VERSION</em>.</p><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">versioneer</span>

<span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;PBR_VERSION&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">versioneer</span><span class="o">.</span><span class="n">get_version</span><span class="p">()</span>

<span class="o">...</span>
<span class="n">setup</span><span class="p">(</span>
    <span class="n">setup_requires</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;pbr&#39;</span><span class="p">],</span>
    <span class="n">pbr</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">ext_modules</span><span class="o">=</span><span class="n">extensions</span>
<span class="p">)</span>
</pre></div><p>And added below snippet to <em>setup.cfg</em> which is how versioneer can be configured with various information including tag prefixes.</p><div class="highlight"><pre><span></span><span class="k">[versioneer]</span>
<span class="na">VCS</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">git</span>
<span class="na">style</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">pep440</span>
<span class="na">versionfile_source</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">zfec/_version.py</span>
<span class="na">versionfile_build</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">zfec/_version.py</span>
<span class="na">tag_prefix</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">zfec-</span>
<span class="na">parentdir_prefix</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">zfec-</span>
</pre></div><p>Though this work around gets the work done, it does not feel correct to set environment variable to change the logic of other part of same program. If you guys know the better way do let me know!. Also probably I should consider filing an feature request against <cite>pbr</cite> to provide a way to pass tag prefix for version calculation logic.</p></div><div id="footer"><p><italic>Tagged as: pbr, python, zfec, </italic></p></section></div><hr><div id="footer"> Site Proudly powered by <a href="http://getpelican.com/">Pelican</a></div></body></html>