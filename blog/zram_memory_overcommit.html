<!DOCTYPE html><html lang="en"><head><link href="https://fonts.googleapis.com/css?family=Cantarell" rel="stylesheet"><title>Notes: Experimenting with ZRAM and Memory Over commit</title><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1"><link href="https://copyninja.in/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Random Ramblings Full Atom Feed"><link href="https://copyninja.in/feeds/{slug}.atom.xml" type="application/atom+xml" rel="alternate" title="Random Ramblings Categories Atom Feed"><link rel="stylesheet" type="text/css" href="/theme/css/pygments.css"><link rel="stylesheet" type="text/css" href="/theme/css/default.css"><meta name="tags" content="zram"><meta name="tags" content="vm"><meta name="tags" content="overcommit"><meta name="tags" content="debian"></head><body><div id="header" class="body"><div id="navigation"> | <a href="https://copyninja.in">Home</a> | | <a href="https://copyninja.in/about">About</a> | | <a href="https://copyninja.in/contact">Contact</a> | | <a href="https://copyninja.in/categories.html">Categories</a> | | <a href="https://copyninja.in/tags.html">Tags</a> | </div><h1><a href="https://copyninja.in/blog/zram_memory_overcommit.html">Notes: Experimenting with ZRAM and Memory Over commit</a></h1></div><div id="content"><section id="content" class="body"><footer class="post-info"><p> Posted on Jun 20, 2023 By copyninja under devops </p></abbr></footer><div class="entry-content"><div class="section" id="introduction"><h2>Introduction</h2><p>The ZRAM module in the Linux kernel creates a memory-backed block device that stores its content in a compressed format. It offers users the choice of compression algorithms such as lz4, zstd, or lzo. These algorithms differ in compression ratio and speed, with zstd providing the best compression but being slower, while lz4 offers higher speed but lower compression.</p></div><div class="section" id="using-zram-as-swap"><h2>Using ZRAM as Swap</h2><p>One interesting use case for ZRAM is utilizing it as swap space in the system. There are two utilities available for configuring ZRAM as swap: zram-tools and systemd-zram-generator. However, Debian Bullseye lacks systemd-zram-generator, making zram-tools the only option for Bullseye users. While it's possible to use systemd-zram-generator by self-compiling or via cargo, I preferred using tools available in the distribution repository due to my restricted environment.</p></div><div class="section" id="installation"><h2>Installation</h2><p>The installation process is straightforward. Simply execute the following command:</p><div class="highlight"><pre><span></span>apt-get<span class="w"> </span>install<span class="w"> </span>zram-tools
</pre></div></div><div class="section" id="configuration"><h2>Configuration</h2><p>The configuration involves modifying a simple shell script file <em>/etc/default/zramswap</em> sourced by the <cite>/usr/bin/zramswap</cite> script. Here's an example of the configuration I used:</p><div class="highlight"><pre><span></span><span class="c1"># Compression algorithm selection</span>
<span class="c1"># Speed: lz4 &gt; zstd &gt; lzo</span>
<span class="c1"># Compression: zstd &gt; lzo &gt; lz4</span>
<span class="c1"># This is not inclusive of all the algorithms available in the latest kernels</span>
<span class="c1"># See /sys/block/zram0/comp_algorithm (when the zram module is loaded) to check</span>
<span class="c1"># the currently set and available algorithms for your kernel [1]</span>
<span class="c1"># [1]  https://github.com/torvalds/linux/blob/master/Documentation/blockdev/zram.txt#L86</span>
<span class="nv">ALGO</span><span class="o">=</span>zstd

<span class="c1"># Specifies the amount of RAM that should be used for zram</span>
<span class="c1"># based on a percentage of the total available memory</span>
<span class="c1"># This takes precedence and overrides SIZE below</span>
<span class="nv">PERCENT</span><span class="o">=</span><span class="m">30</span>

<span class="c1"># Specifies a static amount of RAM that should be used for</span>
<span class="c1"># the ZRAM devices, measured in MiB</span>
<span class="c1"># SIZE=256000</span>

<span class="c1"># Specifies the priority for the swap devices, see swapon(2)</span>
<span class="c1"># for more details. A higher number indicates higher priority</span>
<span class="c1"># This should probably be higher than hdd/ssd swaps.</span>
<span class="c1"># PRIORITY=100</span>
</pre></div><p>I chose zstd as the compression algorithm for its superior compression capabilities. Additionally, I reserved 30% of memory as the size of the zram device. After modifying the configuration, restart the <cite>zramswap.service</cite> to activate the swap:</p><div class="highlight"><pre><span></span>systemctl<span class="w"> </span>restart<span class="w"> </span>zramswap.service
</pre></div></div><div class="section" id="using-systemd-zram-generator"><h2>Using systemd-zram-generator</h2><p>For Debian Bookworm users, an alternative option is systemd-zram-generator. Although zram-tools is still available in Debian Bookworm, systemd-zram-generator offers a more integrated solution within the systemd ecosystem. Below is an example of the translated configuration for systemd-zram-generator, located at <cite>/etc/systemd/zram-generator.conf</cite>:</p><div class="highlight"><pre><span></span># This config file enables a /dev/zram0 swap device with the following
# properties:
# * size: 50% of available RAM or 4GiB, whichever is less
# * compression-algorithm: kernel default
#
# This device&#39;s properties can be modified by adding options under the
# [zram0] section below. For example, to set a fixed size of 2GiB, set
# `zram-size = 2GiB`.

[zram0]
zram-size = ceil(ram * 30/100)
compression-algorithm = zstd
swap-priority = 100
fs-type = swap
</pre></div><p>After making the necessary changes, reload systemd and start the <cite>systemd-zram-setup&#64;zram0.service</cite>:</p><div class="highlight"><pre><span></span>systemctl<span class="w"> </span>daemon-reload
systemctl<span class="w"> </span>start<span class="w"> </span>systemd-zram-setup@zram0.service
</pre></div><p>The <cite>systemd-zram-generator</cite> creates the zram device by loading the kernel module and then creates a <cite>systemd.swap</cite> unit to mount the zram device as swap. In this case, the swap file is called <cite>zram0.swap</cite>.</p></div><div class="section" id="checking-compression-and-details"><h2>Checking Compression and Details</h2><p>To verify the effectiveness of the swap configuration, you can use the <cite>zramctl</cite> command, which is part of the <cite>util-linux</cite> package. Alternatively, the <cite>zramswap</cite> utility provided by <cite>zram-tools</cite> can be used to obtain the same output.</p><p>During my testing with synthetic memory load created using <em>stress-ng</em> <em>vm</em> class I found that I can reach upto <em>40%</em> compression ratio.</p></div><div class="section" id="memory-overcommit"><h2>Memory Overcommit</h2><p>Another use case I was looking for is allowing the launching of applications that require more memory than what is available in the system. By default, the Linux kernel attempts to estimate the amount of free memory left on the system when user space requests more memory (<cite>vm.overcommit_memory=0</cite>). However, you can change this behavior by modifying the sysctl value for <cite>vm.overcommit_memory</cite> to <cite>1</cite>.</p><p>To demonstrate this, I ran a test using stress-ng to request more memory than the system had available. As expected, the Linux kernel refused to allocate memory, and the stress-ng process could not proceed.</p><div class="highlight"><pre><span></span>free<span class="w"> </span>-tg<span class="w">                                                                                                                                                                                         </span>──<span class="o">(</span>Mon,Jun19<span class="o">)</span>─┘
<span class="w">                </span>total<span class="w">        </span>used<span class="w">        </span>free<span class="w">      </span>shared<span class="w">  </span>buff/cache<span class="w">   </span>available
<span class="w"> </span>Mem:<span class="w">              </span><span class="m">31</span><span class="w">          </span><span class="m">12</span><span class="w">          </span><span class="m">11</span><span class="w">           </span><span class="m">3</span><span class="w">          </span><span class="m">11</span><span class="w">          </span><span class="m">18</span>
<span class="w"> </span>Swap:<span class="w">             </span><span class="m">10</span><span class="w">           </span><span class="m">2</span><span class="w">           </span><span class="m">8</span>
<span class="w"> </span>Total:<span class="w">            </span><span class="m">41</span><span class="w">          </span><span class="m">14</span><span class="w">          </span><span class="m">19</span>

sudo<span class="w"> </span>stress-ng<span class="w"> </span>--vm<span class="o">=</span><span class="m">1</span><span class="w"> </span>--vm-bytes<span class="o">=</span>50G<span class="w"> </span>-t<span class="w"> </span><span class="m">120</span><span class="w">                                                                                                                                                      </span>──<span class="o">(</span>Mon,Jun19<span class="o">)</span>─┘
<span class="w"> </span>stress-ng:<span class="w"> </span>info:<span class="w">  </span><span class="o">[</span><span class="m">1496310</span><span class="o">]</span><span class="w"> </span>setting<span class="w"> </span>to<span class="w"> </span>a<span class="w"> </span><span class="m">120</span><span class="w"> </span>second<span class="w"> </span><span class="o">(</span><span class="m">2</span><span class="w"> </span>mins,<span class="w"> </span><span class="m">0</span>.00<span class="w"> </span>secs<span class="o">)</span><span class="w"> </span>run<span class="w"> </span>per<span class="w"> </span>stressor
<span class="w"> </span>stress-ng:<span class="w"> </span>info:<span class="w">  </span><span class="o">[</span><span class="m">1496310</span><span class="o">]</span><span class="w"> </span>dispatching<span class="w"> </span>hogs:<span class="w"> </span><span class="m">1</span><span class="w"> </span>vm
<span class="w"> </span>stress-ng:<span class="w"> </span>info:<span class="w">  </span><span class="o">[</span><span class="m">1496312</span><span class="o">]</span><span class="w"> </span>vm:<span class="w"> </span>gave<span class="w"> </span>up<span class="w"> </span>trying<span class="w"> </span>to<span class="w"> </span>mmap,<span class="w"> </span>no<span class="w"> </span>available<span class="w"> </span>memory,<span class="w"> </span>skipping<span class="w"> </span>stressor
<span class="w"> </span>stress-ng:<span class="w"> </span>warn:<span class="w">  </span><span class="o">[</span><span class="m">1496310</span><span class="o">]</span><span class="w"> </span>vm:<span class="w"> </span><span class="o">[</span><span class="m">1496311</span><span class="o">]</span><span class="w"> </span>aborted<span class="w"> </span>early,<span class="w"> </span>out<span class="w"> </span>of<span class="w"> </span>system<span class="w"> </span>resources
<span class="w"> </span>stress-ng:<span class="w"> </span>info:<span class="w">  </span><span class="o">[</span><span class="m">1496310</span><span class="o">]</span><span class="w"> </span>vm:
<span class="w"> </span>stress-ng:<span class="w"> </span>warn:<span class="w">  </span><span class="o">[</span><span class="m">1496310</span><span class="o">]</span><span class="w">         </span><span class="m">14</span><span class="w"> </span>System<span class="w"> </span>Management<span class="w"> </span>Interrupts
<span class="w"> </span>stress-ng:<span class="w"> </span>info:<span class="w">  </span><span class="o">[</span><span class="m">1496310</span><span class="o">]</span><span class="w"> </span>passed:<span class="w"> </span><span class="m">0</span>
<span class="w"> </span>stress-ng:<span class="w"> </span>info:<span class="w">  </span><span class="o">[</span><span class="m">1496310</span><span class="o">]</span><span class="w"> </span>failed:<span class="w"> </span><span class="m">0</span>
<span class="w"> </span>stress-ng:<span class="w"> </span>info:<span class="w">  </span><span class="o">[</span><span class="m">1496310</span><span class="o">]</span><span class="w"> </span>skipped:<span class="w"> </span><span class="m">1</span>:<span class="w"> </span>vm<span class="w"> </span><span class="o">(</span><span class="m">1</span><span class="o">)</span>
<span class="w"> </span>stress-ng:<span class="w"> </span>info:<span class="w">  </span><span class="o">[</span><span class="m">1496310</span><span class="o">]</span><span class="w"> </span>successful<span class="w"> </span>run<span class="w"> </span>completed<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">10</span>.04s
</pre></div><p>By setting <cite>vm.overcommit_memory=1</cite>, Linux will allocate memory in a more relaxed manner, assuming an infinite amount of memory is available.</p></div><div class="section" id="conclusion"><h2>Conclusion</h2><p>ZRAM provides disks that allow for very fast I/O, and compression allows for a significant amount of memory savings. ZRAM is not restricted to just swap usage; it can be used as a normal block device with different file systems.</p><p>Using ZRAM as swap is beneficial because, unlike disk-based swap, it is faster, and compression ensures that we use a smaller amount of RAM itself as swap space.</p><p>Additionally, adjusting the memory overcommit settings can be beneficial for scenarios that require launching memory-intensive applications.</p><p><em>Note: When running stress tests or allocating excessive memory, be cautious about the actual memory capacity of your system to prevent out-of-memory (OOM) situations.</em></p><p>Feel free to explore the capabilities of ZRAM and optimize your system's memory management. Happy computing!</p></div><div class="section" id="reference"><h2>Reference</h2><ol class="arabic simple"><li><a class="reference external" href="https://www.kernel.org/doc/html/latest/admin-guide/blockdev/zram.html">zram: Compressed RAM-based block device</a></li><li><a class="reference external" href="https://www.kernel.org/doc/Documentation/vm/overcommit-accounting">Overcommit Accounting</a></li><li><a class="reference external" href="https://www.baeldung.com/linux/overcommit-modes">Linux Overcommit Modes</a></li><li><a class="reference external" href="https://wiki.archlinux.org/title/Zram">zram: Arch Wiki</a></li><li><a class="reference external" href="https://wiki.debian.org/ZRam">zram: Debian Wiki</a></li></ol></div></div><div id="footer"><p><italic>Tagged as: debian, overcommit, vm, zram, </italic></p></section></div><hr><div id="footer"> Site Proudly powered by <a href="http://getpelican.com/">Pelican</a></div></body></html>