<!DOCTYPE html><html lang="en"><head><link href="https://fonts.googleapis.com/css?family=Cantarell" rel="stylesheet"><title>Persisting resource control options for systemd-nspawn containers</title><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1"><link href="https://copyninja.in/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Random Ramblings Full Atom Feed"><link href="https://copyninja.in/feeds/{slug}.atom.xml" type="application/atom+xml" rel="alternate" title="Random Ramblings Categories Atom Feed"><link rel="stylesheet" type="text/css" href="/theme/css/pygments.css"><link rel="stylesheet" type="text/css" href="/theme/css/default.css"><meta name="tags" content="systemd"><meta name="tags" content="systemd-nspawn"><meta name="tags" content="resource-control"><meta name="tags" content="containers"></head><body><div id="header" class="body"><div id="navigation"> | <a href="https://copyninja.in">Home</a> | | <a href="https://copyninja.in/about">About</a> | | <a href="https://copyninja.in/contact">Contact</a> | | <a href="https://copyninja.in/categories.html">Categories</a> | | <a href="https://copyninja.in/tags.html">Tags</a> | </div><h1><a href="https://copyninja.in/blog/persist_resource_control.html">Persisting resource control options for systemd-nspawn containers</a></h1></div><div id="content"><section id="content" class="body"><footer class="post-info"><p> Posted on Dec 15, 2015 By copyninja under devops </p></abbr></footer><div class="entry-content"><p>In my previous <a class="reference external" href="https://copyninja.info/blog/taming_systemd_nsapwn.html">post on systemd-nspawn</a> I mentioned, I was unclear on how to persist resource control options for a container. Today I accidentally discovered how can the property be persisted across boot without modifying service file or writing custom service file for container. It is done using <em>systemctl set-property</em></p><p>To set <em>CPUAccounting</em> and <em>CPUShares</em> for a container we need to run following command.</p><div class="highlight"><pre><span></span>systemctl<span class="w"> </span>set-property<span class="w"> </span>systemd-nspawn@container.service<span class="w">  </span><span class="nv">CPUACCounting</span><span class="o">=</span><span class="m">1</span><span class="w"> </span><span class="nv">CPUShares</span><span class="o">=</span><span class="m">200</span>
</pre></div><p>This actually persists these settings at location, <em>/etc/systemd/systemd-nspawn&#64;container.service.d/</em> folder. So in our case there will be 2 files created under above location by name <em>50-CPUAccounting.conf</em> and <em>50-CPUShares.conf</em> with following contents.</p><div class="highlight"><pre><span></span><span class="c1"># 50-CPUAccounting.conf</span>
<span class="k">[Service]</span>
<span class="na">CPUAccounting</span><span class="o">=</span><span class="s">yes</span>

<span class="c1"># 50-CPUShares.conf</span>
<span class="k">[Service]</span>
<span class="na">CPUShares</span><span class="o">=</span><span class="s">200</span>
</pre></div><p>Today when I discovered this folder and saw the file contents, I became curious and started to wonder who created this folder. The look at systemctl man page made showed me this.</p><blockquote><dl class="docutils"><dt>set-property NAME ASSIGNMENT...</dt><dd><p class="first">Set the specified unit properties at runtime where this is supported. This allows changing configuration parameter properties such as resource control settings at runtime. Not all properties may be changed at runtime, but many resource control settings (primarily those in systemd.resource-control(5)) may. The changes are applied instantly, and stored on disk for future boots, unless --runtime is passed, in which case the settings only apply until the next reboot. The syntax of the property assignment follows closely the syntax of assignments in unit files.</p><p>Example: systemctl set-property foobar.service CPUShares=777</p><p class="last">Note that this command allows changing multiple properties at the same time, which is preferable over setting them individually. Like unit file configuration settings, assigning the empty list to list parameters will reset the list.</p></dd></dl></blockquote><p>I did remember doing this for my container and hence it became clear these files are actually written by <em>systemctl set-property</em>.</p><p>In case you don't want to persist the properties across boot you can simply pass <em>--runtime</em> switch.</p><p>Basically this is not just for container, resource control can be thus applied to any running service on the system. This is actually cool.</p></div><div id="footer"><p><italic>Tagged as: containers, resource-control, systemd, systemd-nspawn, </italic></p></section></div><hr><div id="footer"> Site Proudly powered by <a href="http://getpelican.com/">Pelican</a></div></body></html>