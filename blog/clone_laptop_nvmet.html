<!DOCTYPE html><html lang="en"><head><link href="https://fonts.googleapis.com/css?family=Cantarell" rel="stylesheet"><title>Cloning a laptop over NVME TCP</title><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1"><link href="https://copyninja.in/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Random Ramblings Full Atom Feed"><link href="https://copyninja.in/feeds/{slug}.atom.xml" type="application/atom+xml" rel="alternate" title="Random Ramblings Categories Atom Feed"><link rel="stylesheet" type="text/css" href="/theme/css/pygments.css"><link rel="stylesheet" type="text/css" href="/theme/css/default.css"><meta name="tags" content="debian"><meta name="tags" content="nvmet"><meta name="tags" content="clone"></head><body><div id="header" class="body"><div id="navigation"> | <a href="https://copyninja.in">Home</a> | | <a href="https://copyninja.in/about">About</a> | | <a href="https://copyninja.in/contact">Contact</a> | | <a href="https://copyninja.in/categories.html">Categories</a> | | <a href="https://copyninja.in/tags.html">Tags</a> | </div><h1><a href="https://copyninja.in/blog/clone_laptop_nvmet.html">Cloning a laptop over NVME TCP</a></h1></div><div id="content"><section id="content" class="body"><footer class="post-info"><p> Posted on Mar 10, 2024 By copyninja under devops </p></abbr></footer><div class="entry-content"><p>Recently, I got a new laptop and had to set it up so I could start using it. But I wasn't really in the mood to go through the same old steps which I had explained in this <a class="reference external" href="https://copyninja.in/blog/live_install_debian.html">post earlier</a>. I was complaining about this to my colleague, and there came the suggestion of why not copy the entire disk to the new laptop. Though it sounded like an interesting idea to me, I had my doubts, so here is what I told him in return.</p><ol class="arabic simple"><li>I don't have the tools to open my old laptop and connect the new disk over USB to my new laptop.</li><li>I use full disk encryption, and my old laptop has a 512GB disk, whereas the new laptop has a 1TB NVME, and I'm not so familiar with resizing LUKS.</li></ol><p>He promptly suggested both could be done. For step 1, just expose the disk using NVME over TCP and connect it over the network and do a full disk copy, and the rest is pretty simple to achieve. In short, he suggested the following:</p><ol class="arabic simple"><li>Export the disk using nvmet-tcp from the old laptop.</li><li>Do a disk copy to the new laptop.</li><li>Resize the partition to use the full 1TB.</li><li>Resize LUKS.</li><li>Finally, resize the BTRFS root disk.</li></ol><div class="section" id="exporting-disk-over-nvme-tcp"><h2>Exporting Disk over NVME TCP</h2><p>The easiest way suggested by my colleague to do this is using <a class="reference external" href="https://www.freedesktop.org/software/systemd/man/latest/systemd-storagetm.service.html">systemd-storagetm.service</a>. This service can be invoked by simply booting into <em>storage-target-mode.target</em> by specifying <em>rd.systemd.unit=storage-target-mode.target</em>. But he suggested not to use this as I need to tweak the dracut initrd image to involve network services as well as configuring WiFi from this mode is a painful thing to do.</p><p>So alternatively, I simply booted both my laptops with GRML rescue CD. And the following step was done to export the NVME disk on my current laptop using the nvmet-tcp module of Linux:</p><div class="highlight"><pre><span></span>modprobe<span class="w"> </span>nvmet-tcp
<span class="nb">cd</span><span class="w"> </span>/sys/kernel/config/nvmet
mkdir<span class="w"> </span>ports/0
<span class="nb">cd</span><span class="w"> </span>ports/0
<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;ipv4&quot;</span><span class="w"> </span>&gt;<span class="w"> </span>addr_adrfam
<span class="nb">echo</span><span class="w"> </span><span class="m">0</span>.0.0.0<span class="w"> </span>&gt;<span class="w"> </span>addr_traaddr
<span class="nb">echo</span><span class="w"> </span><span class="m">4420</span><span class="w"> </span>&gt;<span class="w"> </span>addr_trsvcid
<span class="nb">echo</span><span class="w"> </span>tcp<span class="w"> </span>&gt;<span class="w"> </span>addr_trtype

<span class="nb">cd</span><span class="w"> </span>/sys/kernel/config/nvmet/subsystems
mkdir<span class="w"> </span>testnqn
<span class="nb">echo</span><span class="w"> </span><span class="m">1</span><span class="w"> </span>&gt;testnqn/allow_any_host
mkdir<span class="w"> </span>testnqn/namespaces/1

<span class="nb">cd</span><span class="w"> </span>testnqn
<span class="c1"># replace the device name with the disk you want to export</span>
<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;/dev/nvme0n1&quot;</span><span class="w"> </span>&gt;<span class="w"> </span>namespaces/1/device_path
<span class="nb">echo</span><span class="w"> </span><span class="m">1</span><span class="w"> </span>&gt;<span class="w"> </span>namespaces/1/enable

ln<span class="w"> </span>-s<span class="w"> </span><span class="s2">&quot;../../subsystems/testnqn&quot;</span><span class="w"> </span>/sys/kernel/config/nvmet/ports/0/subsystems/testnqn
</pre></div><p>These steps ensure that the device is now exported using NVME over TCP. The next step is to detect this on the new laptop and connect the device:</p><div class="highlight"><pre><span></span>nvme<span class="w"> </span>discover<span class="w"> </span>-t<span class="w"> </span>tcp<span class="w"> </span>-a<span class="w"> </span>&lt;ip&gt;<span class="w"> </span>-s<span class="w"> </span><span class="m">4420</span>
nvme<span class="w"> </span>connectl-all<span class="w"> </span>-t<span class="w"> </span>tcp<span class="w"> </span>-a<span class="w"> </span>&lt;&gt;<span class="w"> </span>-s<span class="w"> </span><span class="m">4420</span>
</pre></div><p>Finally, <tt class="docutils literal">nvme list</tt> shows the device which is connected to the new laptop, and we can proceed with the next step, which is to do the disk copy.</p></div><div class="section" id="copying-the-disk"><h2>Copying the Disk</h2><p>I simply used the <tt class="docutils literal">dd</tt> command to copy the root disk to my new laptop. Since the new laptop didn't have an Ethernet port, I had to rely only on WiFi, and it took about 7 and a half hours to copy the entire 512GB to the new laptop. The speed at which I was copying was about 18-20MB/s. The other option would have been to create an initial partition and file system and do an rsync of the root disk or use BTRFS itself for file system transfer.</p><div class="highlight"><pre><span></span>dd<span class="w"> </span><span class="k">if</span><span class="o">=</span>/dev/nvme2n1<span class="w"> </span><span class="nv">of</span><span class="o">=</span>/dev/nvme0n1<span class="w"> </span><span class="nv">status</span><span class="o">=</span>progress<span class="w"> </span><span class="nv">bs</span><span class="o">=</span>40M
</pre></div></div><div class="section" id="resizing-partition-and-luks-container"><h2>Resizing Partition and LUKS Container</h2><p>The final part was very easy. When I launched <tt class="docutils literal">parted</tt>, it detected that the partition table does not match the disk size and asked if it can fix it, and I said yes. Next, I had to install <tt class="docutils literal"><span class="pre">cloud-guest-utils</span></tt> to get <tt class="docutils literal">growpart</tt> to fix the second partition, and the following command extended the partition to the full 1TB:</p><div class="highlight"><pre><span></span>growpart<span class="w"> </span>/dev/nvem0n1<span class="w"> </span>p2
</pre></div><p>Next, I used <tt class="docutils literal"><span class="pre">cryptsetup-resize</span></tt> to increase the LUKS container size.</p><div class="highlight"><pre><span></span>cryptsetup<span class="w"> </span>luksOpen<span class="w"> </span>/dev/nvme0n1p2<span class="w"> </span>ENC
cryptsetup<span class="w"> </span>resize<span class="w"> </span>ENC
</pre></div><p>Finally, I rebooted into the disk, and everything worked fine. After logging into the system, I resized the BTRFS file system. BTRFS requires the system to be mounted for resize, so I could not attempt it in live boot.</p><div class="highlight"><pre><span></span>btfs<span class="w"> </span>fielsystem<span class="w"> </span>resize<span class="w"> </span>max<span class="w"> </span>/
</pre></div></div><div class="section" id="conclusion"><h2>Conclusion</h2><p>The only benefit of this entire process is that I have a new laptop, but I still feel like I'm using my existing laptop. Typically, setting up a new laptop takes about a week or two to completely get adjusted, but in this case, that entire time is saved.</p><p>An added benefit is that I learned how to export disks using NVME over TCP, thanks to my colleague. This new knowledge adds to the value of the experience.</p></div></div><div id="footer"><p><italic>Tagged as: clone, debian, nvmet, </italic></p></section></div><hr><div id="footer"> Site Proudly powered by <a href="http://getpelican.com/">Pelican</a></div></body></html>