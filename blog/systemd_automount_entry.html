<!DOCTYPE html><html lang="en"><head><link href="https://fonts.googleapis.com/css?family=Cantarell" rel="stylesheet"><title>Mount ordering and automount options in systemd</title><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1"><link href="https://copyninja.in/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Random Ramblings Full Atom Feed"><link href="https://copyninja.in/feeds/{slug}.atom.xml" type="application/atom+xml" rel="alternate" title="Random Ramblings Categories Atom Feed"><link rel="stylesheet" type="text/css" href="/theme/css/pygments.css"><link rel="stylesheet" type="text/css" href="/theme/css/default.css"><meta name="tags" content="systemd"><meta name="tags" content="fstab"><meta name="tags" content="automount"></head><body><div id="header" class="body"><div id="navigation"> | <a href="https://copyninja.in">Home</a> | | <a href="https://copyninja.in/about">About</a> | | <a href="https://copyninja.in/contact">Contact</a> | | <a href="https://copyninja.in/categories.html">Categories</a> | | <a href="https://copyninja.in/tags.html">Tags</a> | </div><h1><a href="https://copyninja.in/blog/systemd_automount_entry.html">Mount ordering and automount options in systemd</a></h1></div><div id="content"><section id="content" class="body"><footer class="post-info"><p> Posted on Dec 13, 2015 By copyninja under devops </p></abbr></footer><div class="entry-content"><p>Just to give a brief recap of why I'm writing this post, I've to describe a brief encounter I had with systemd which rendered my system unbootable. I first felt its systemd's problem but later figured out it was my mistake. So below is brief story divided into 2 sections <em>Problem</em> and <em>Solution</em>. Here <em>Problem</em> describes issue I faced with systemd and <em>Solution</em> discusses the <em>.mount</em> and <em>.automount</em> suffix files used by systemd.</p><div class="section" id="problem"><h2>Problem</h2><p>I have several local bin folders and I don't want to modify <em>PATH</em> environment variable adding every other folder path. I first started using <em>aufs</em> as alternative to symlinks or modifying <em>PATH</em> variable. Recently I learnt about much more light weight union fs which is in kernel, <em>overlayfs</em>. And Google led me to Arch wiki article which showed me a fstab entry like below</p><div class="highlight"><pre><span></span>overlay        /usr/local/bin        overlay noauto,x-systemd.automount,lowerdir=/home/vasudev/Documents/utilities/bin,upperdir=/home/vasudev/Documents/utilities/jonas-bin,workdir=/home/vasudev/Documents/utilities/bin-overlay    0       0
</pre></div><p>And after adding this entry, on next reboot systemd is not able to mount my LVM home and swap partition. It does however mount root partition. It gives me emergency target but login never returns. So without any alternative I had to reinstall the system. But funnily enough I started encountering the same issue (yeah after I had added above entry into fstab). Yeah that time I never thought that its culprit. My friend Ritesh finally got my system booting after the weird x-systemd.automount option. I never investigated further that time on why this problem occurred.</p></div><div class="section" id="solution"><h2>Solution</h2><p>After re-encounter with similar problem and some other project I read the manual on <em>systemd.mount</em>, <em>systemd-fstab-generator</em> and <em>systemd.automount</em> and I had some understanding of what really went wrong in my case above.</p><p>So now let us see what really is happening. All the above happened because, <em>systemd translates the /etc/fstab into .mount units at run time using systemd-fstab-generator</em>. Every entry in fstab translates into a file named after the mount point. The <em>/</em> in the path of the mount point is replaced by a <em>-</em>. So <em>/</em> mount point is named as <em>-.mount</em> and <em>/home</em> is named as <em>home.mount</em> and <em>/boot</em> becomes <em>boot.mount</em>. All these files can be seen in directory <em>/run/systemd/generator</em>. And all these mount points are needed by <em>local-fs.target</em> , if any of these mount points fail, <em>local-fs.target</em> fails. And if <em>local-fs.target</em> fails it will invoke <em>emergency.target</em>.</p><p><em>systemd-fstab-generator</em> manual suggests the ordering information in <em>/etc/fstab</em> is discarded. That means if you have union mounts, bind mounts or fuse mounts in the fstab which is normally at end of fstab and uses path from /home or some other device mount points it will fail to get mounted. This happens because <em>systemd-fstab-generator</em> didn't consider the ordering in fstab. This is what happened in my case my <em>overlay</em> mount point which is <em>usr-local-bin.mount</em> was some how happened to be tried before <em>home.mount</em> because there is no explicit dependency like <em>Requires=</em> or <em>After=</em> was declared. When systemd tried to mount it the path required under /home were not really present hence failed which in return invoked <em>emergency.target</em> as <em>usr-local-bin.mount</em> is <em>Requires=</em> dependency for <em>local-fs.target</em>.</p><p>Now what I didn't understand is why <em>emregency.target</em> never gave me the root shell after entering login information. I feel that this part is unrelated to the problem I described above and is some other bug.</p><p>To over come this what we can do is provided <em>systemd-fstab-generator</em> some information on dependency of each mount point. <em>systemd.mount</em> manual page suggests several such options. One which I used in my case is <em>x-systemd.requires</em> which should be placed in options column of fstab and specify the mount point which is needed before it has to be mounted. So my overlay fs entry translates to something like below</p><div class="highlight"><pre><span></span>overlay        /usr/local/bin        overlay noauto,x-systemd.requires=/home,x-systemd.automount,lowerdir=/home/vasudev/Documents/utilities/bin,upperdir=/home/vasudev/Documents/utilities/jonas-bin,workdir=/home/vasudev/Documents/utilities/bin-overlay   0       0
</pre></div><p>There is another special option called <em>x-systemd.automount</em> this will make systemd-fstab-generator to create a <em>.automount</em> file for this mount point. What does <em>systemd.automount</em> do? It achieves on-demand file mounting and parallelized file system mounting. Something similar to <em>systemd.socket</em> the file system will be mounted when you access the mount point for first time.</p><p>So now if you try to see dependency of usr-local-bin.mount you will see following.</p><div class="highlight"><pre><span></span>systemctl<span class="w"> </span>show<span class="w"> </span>-p<span class="w"> </span>After<span class="w"> </span>usr-local-bin.mount
<span class="nv">After</span><span class="o">=</span>-.mount<span class="w"> </span>systemd-journald.socket<span class="w"> </span>local-fs-pre.target<span class="w"> </span>system.slice<span class="w"> </span>usr-local-bin.automount
</pre></div><p>This means now <em>usr-local-bin.mount</em> depends on <em>usr-local-bin.automount</em>. And let us see what usr-local-bin.automount needs.</p><div class="highlight"><pre><span></span>systemctl<span class="w"> </span>show<span class="w"> </span>-p<span class="w"> </span>Requires<span class="w"> </span>usr-local-bin.automount
<span class="nv">Requires</span><span class="o">=</span>-.mount<span class="w"> </span>home.mount

systemctl<span class="w"> </span>show<span class="w"> </span>-p<span class="w"> </span>After<span class="w"> </span>usr-local-bin.automount
<span class="nv">After</span><span class="o">=</span>-.mount<span class="w"> </span>home.mount
</pre></div><p>So clearly <em>usr-local-bin.automount</em> is activated after <em>-.mount</em> and <em>home.mount</em> is activated. Similar can be done for any bind mounts or fuse mounts which require other mount points before it can be mounted. Also note that <em>x-systemd.autmount</em> is not mandatory option for declaring dependencies, I used it just to make sure <em>/usr/local/bin</em> is mounted only when its really needed.</p></div><div class="section" id="conclusion"><h2>Conclusion</h2><p>A lot of traditional way has been changed by systemd. I never understood why my system failed to boot in first place this happened because I was not really aware of how systemd works and was trying to debug the problem with traditional approach. So there is really a learning curve involved for every sysadmin out there who is going to use systemd. Most of them will read documentation before hand but others like me will learn after having a situation like above. :-).</p><p>So systemd interfering into /etc/fstab is good?. I don't know but since systemd parallelizes the boot procedure something like this is really needed. Is there a way to make systemd not touch /etc/fstab?. Yes there is you need to pass <em>fstab=0</em> option in kernel command line and systemd-fstab-generator doesn't create any .mount or .swap files from your /etc/fstab.</p><p><strong>!NB Also it looks like x-systemd.requires option was introduced recently and is not available in systemd &lt;= 215 which is default in Jessie. So how do you declare dependencies in Jessie system?. I don't have any answer!. I did read that x-systemd.automount which is available in those versions of systemd can be used, but I'm yet to experiment this. If it succeeds I will write a post on it.</strong></p></div></div><div id="footer"><p><italic>Tagged as: automount, fstab, systemd, </italic></p></section></div><hr><div id="footer"> Site Proudly powered by <a href="http://getpelican.com/">Pelican</a></div></body></html>