<!DOCTYPE html><html lang="en"><head><link href="https://fonts.googleapis.com/css?family=Cantarell" rel="stylesheet"><title>Loading Python modules/plug-ins at runtime</title><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1"><link href="https://copyninja.in/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Random Ramblings Full Atom Feed"><link href="https://copyninja.in/feeds/{slug}.atom.xml" type="application/atom+xml" rel="alternate" title="Random Ramblings Categories Atom Feed"><link rel="stylesheet" type="text/css" href="/theme/css/pygments.css"><link rel="stylesheet" type="text/css" href="/theme/css/default.css"><meta name="tags" content="python"><meta name="tags" content="modules"><meta name="tags" content="import"><meta name="tags" content="programming"><meta name="tags" content="importlib"></head><body><div id="header" class="body"><div id="navigation"> | <a href="https://copyninja.in">Home</a> | | <a href="https://copyninja.in/about">About</a> | | <a href="https://copyninja.in/contact">Contact</a> | | <a href="https://copyninja.in/categories.html">Categories</a> | | <a href="https://copyninja.in/tags.html">Tags</a> | </div><h1><a href="https://copyninja.in/blog/dynamic-module-loading.html">Loading Python modules/plug-ins at runtime</a></h1></div><div id="content"><section id="content" class="body"><footer class="post-info"><p> Posted on Apr 07, 2014 By copyninja under development </p></abbr></footer><div class="entry-content"><p>Some times it is desired to load arbitrary python files or pre- installed python modules during application run time.I had encountered 2 such usecases, one is in <a class="reference external" href="http://silpa.org.in">SILPA application</a> and other is <a class="reference external" href="https://github.com/copyninja/dictionary-bot">dictionary-bot</a> which I was refactoring recently.</p><div class="section" id="case-1-loading-installed-python-module"><h2>Case 1: Loading installed python module</h2><p>In case of SILPA I need to load pre-installed modules and here is the <a class="reference external" href="https://github.com/Project-SILPA/Silpa-Flask/blob/master/core/modulehelper.py#L24">old code</a> , that is a bit hacky code I copied from Active State Python recipies. I found a bit better way to do it using <cite>importlib</cite> module as shown below.</p><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">print_function</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">importlib</span>

<span class="k">def</span> <span class="nf">load_module</span><span class="p">(</span><span class="n">modulename</span><span class="p">):</span>
    <span class="n">mod</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">mod</span> <span class="o">=</span> <span class="n">importlib</span><span class="o">.</span><span class="n">import_module</span><span class="p">(</span><span class="n">modulename</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Failed to load </span><span class="si">{module}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">module</span><span class="o">=</span><span class="n">modulename</span><span class="p">),</span>
                     <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">mod</span>
</pre></div><p>Here <cite>importlib</cite> itself takes care of checking if modulename is already loaded by checking <cite>sys.modules[modulename]</cite>, if loaded it returns that value, otherwise it loads the module and sets it to <cite>sys.modules[modulename]</cite> before returning module itself.</p></div><div class="section" id="case-2-loading-python-files-from-arbitrary-location"><h2>Case 2: Loading python files from arbitrary location</h2><p>In case of dictionary bot my requirement was bit different, I had some python files lying around in a directory, which I wanted to plug into the bot during run time and use them depending on some conditions. So basic structure which I was looking was as follows.</p><pre>
      pluginloader.py
      plugins
      |
      |__ aplugin.py
      |
      |__ bplugin.py
</pre><p><cite>pluginloader.py</cite> is the file which needs to load python files under <cite>plugins</cite> directory. This was again done using <cite>importlib</cite> module as shown below.</p><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">importlib</span>

<span class="k">def</span> <span class="nf">load_plugins</span><span class="p">():</span>
    <span class="n">pysearchre</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s1">&#39;.py$&#39;</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span><span class="p">)</span>
    <span class="n">pluginfiles</span> <span class="o">=</span> <span class="nb">filter</span><span class="p">(</span><span class="n">pysearchre</span><span class="o">.</span><span class="n">search</span><span class="p">,</span>
                           <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">),</span>
                                                 <span class="s1">&#39;plugins&#39;</span><span class="p">)))</span>
    <span class="n">form_module</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">fp</span><span class="p">:</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">fp</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">plugins</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="n">form_module</span><span class="p">,</span> <span class="n">pluginfiles</span><span class="p">)</span>
    <span class="c1"># import parent module / namespace</span>
    <span class="n">importlib</span><span class="o">.</span><span class="n">import_module</span><span class="p">(</span><span class="s1">&#39;plugins&#39;</span><span class="p">)</span>
    <span class="n">modules</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">plugin</span> <span class="ow">in</span> <span class="n">plugins</span><span class="p">:</span>
             <span class="k">if</span> <span class="ow">not</span> <span class="n">plugin</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;__&#39;</span><span class="p">):</span>
                 <span class="n">modules</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">importlib</span><span class="o">.</span><span class="n">import_module</span><span class="p">(</span><span class="n">plugin</span><span class="p">,</span> <span class="n">package</span><span class="o">=</span><span class="s2">&quot;plugins&quot;</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">modules</span>
</pre></div><p>Above code first searches for all python file under specified directory and creates a relative module name from it. For eg. file <cite>aplugin.py</cite> will become <cite>.aplugin</cite>. Before loading modules itself we will load the parent module in our case <cite>plugins</cite>, this is because <strong>relative imports in python expects parent module to be already loaded</strong>. Finally for relative imports to work with <cite>importlib.import_module</cite> we need to specify parent module name in <cite>package</cite> argument. Note that we ignore files begining with <em>__</em>, or specifically we don't want to import __init__.py, this will be done when we import parent module.</p><p>The above code was inspired from a <a class="reference external" href="https://stackoverflow.com/a/3381582">answer on StackOverflow</a>, which uses <cite>imp</cite> module, I avoided <cite>imp</cite> because its been deprecated from <em>Python 3.4</em> in favor of <cite>importlib</cite> module.</p></div></div><div id="footer"><p><italic>Tagged as: import, importlib, modules, programming, python, </italic></p></section></div><hr><div id="footer"> Site Proudly powered by <a href="http://getpelican.com/">Pelican</a></div></body></html>