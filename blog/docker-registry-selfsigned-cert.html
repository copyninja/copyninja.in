<!DOCTYPE html><html lang="en"><head><link href="https://fonts.googleapis.com/css?family=Cantarell" rel="stylesheet"><title>Docker Private Registry and Self Signed Certificates</title><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1"><link href="https://copyninja.in/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Random Ramblings Full Atom Feed"><link href="https://copyninja.in/feeds/{slug}.atom.xml" type="application/atom+xml" rel="alternate" title="Random Ramblings Categories Atom Feed"><link rel="stylesheet" type="text/css" href="/theme/css/pygments.css"><link rel="stylesheet" type="text/css" href="/theme/css/default.css"><meta name="tags" content="docker"><meta name="tags" content="container"><meta name="tags" content="openssl"></head><body><div id="header" class="body"><div id="navigation"> | <a href="https://copyninja.in">Home</a> | | <a href="https://copyninja.in/about">About</a> | | <a href="https://copyninja.in/contact">Contact</a> | | <a href="https://copyninja.in/categories.html">Categories</a> | | <a href="https://copyninja.in/tags.html">Tags</a> | </div><h1><a href="https://copyninja.in/blog/docker-registry-selfsigned-cert.html">Docker Private Registry and Self Signed Certificates</a></h1></div><div id="content"><section id="content" class="body"><footer class="post-info"><p> Posted on Apr 14, 2018 By copyninja under devops </p></abbr></footer><div class="entry-content"><p>I was recently experimenting with hosting a private registry on an internal LAN network for publishing docker private images. I found out that <em>docker-pull</em> works only with TLS secured registry. There is possible to run insecure registry by editing <em>daemon.json</em> file but its better to use self-signed certificates instead.</p><p>Once I followed the step and started registry I tried to <em>docker-pull</em> and it started complaining about certificate not having any valid names. But this same certificate worked fine with browsers too, of course you need to add exception but no other errors were encountered.</p><p><a class="reference external" href="https://docs.docker.com/registry/insecure/">Documentation</a> for Docker does not speaks any specific settings needs to be done prior to generating a self-signed certificate so I was bit confused at beginning.A bit of searching showed up following <a class="reference external" href="https://github.com/docker/for-linux/issues/248">issue</a> filed against docker and then later re-assigned against <a class="reference external" href="https://github.com/golang/go/issues/24293">*Golang*</a> for its method of handling x509 certificate. It appears that with valid <em>Subject Alternative Name</em> Go crypto library ignores the <em>Common Name</em>.</p><p>From thread on <a class="reference external" href="https://security.stackexchange.com/questions/74345/provide-subjectaltname-to-openssl-directly-on-command-line">Security Stack Exchange</a> I found the command to create a self-signed certificate to contain self-signed certificate. Command in excepted answer does not work until you add <em>--extensions</em> option to it as mentioned in one of the comments. Full command is as shown below.</p><div class="highlight"><pre><span></span>openssl<span class="w"> </span>req<span class="w"> </span>-new<span class="w"> </span>-sha256<span class="w"> </span>-key<span class="w"> </span>domain.key<span class="w"> </span><span class="se">\</span>
<span class="w">             </span>-subj<span class="w"> </span><span class="s2">&quot;/C=US/ST=CA/O=Acme, Inc./CN=example.com&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">             </span>-reqexts<span class="w"> </span>SAN<span class="w"> </span>-extensions<span class="w"> </span>SAN<span class="w"> </span><span class="se">\</span>
<span class="w">             </span>-config<span class="w"> </span><span class="se">\</span>
&lt;<span class="o">(</span>cat<span class="w"> </span>/etc/ssl/openssl.cnf<span class="w"> </span>&lt;<span class="o">(</span><span class="nb">printf</span><span class="w"> </span><span class="s2">&quot;[SAN]\nsubjectAltName=DNS:example.com,DNS:www.example.com&quot;</span><span class="o">))</span><span class="w"> </span>-out<span class="w"> </span>domain.crt
</pre></div><p>You would need to replace values in <em>-subj</em> and under <em>[SAN]</em> extension. Benefit of this command is you need not modify the <em>/etc/ssl/openssl.conf</em> file.</p><p>If you do not have a domain name for the registry and using IP address instead consider replacing <em>[SAN]</em> section in above command to have <em>IP: &lt;ip-address&gt;</em> instead of <em>DNS</em>.</p><p>Happy hacking.!</p></div><div id="footer"><p><italic>Tagged as: container, docker, openssl, </italic></p></section></div><hr><div id="footer"> Site Proudly powered by <a href="http://getpelican.com/">Pelican</a></div></body></html>