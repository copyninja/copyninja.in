<!DOCTYPE html><html lang="en"><head><link href="https://fonts.googleapis.com/css?family=Cantarell" rel="stylesheet"><title>Installing Debian from GRML Live CD</title><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1"><link href="https://copyninja.in/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Random Ramblings Full Atom Feed"><link href="https://copyninja.in/feeds/{slug}.atom.xml" type="application/atom+xml" rel="alternate" title="Random Ramblings Categories Atom Feed"><link rel="stylesheet" type="text/css" href="/theme/css/pygments.css"><link rel="stylesheet" type="text/css" href="/theme/css/default.css"><meta name="tags" content="debian"><meta name="tags" content="live"><meta name="tags" content="grml"><meta name="tags" content="systemd-boot"><meta name="tags" content="btrfs"></head><body><div id="header" class="body"><div id="navigation"> | <a href="https://copyninja.in">Home</a> | | <a href="https://copyninja.in/about">About</a> | | <a href="https://copyninja.in/contact">Contact</a> | | <a href="https://copyninja.in/categories.html">Categories</a> | | <a href="https://copyninja.in/tags.html">Tags</a> | </div><h1><a href="https://copyninja.in/blog/live_install_debian.html">Installing Debian from GRML Live CD</a></h1></div><div id="content"><section id="content" class="body"><footer class="post-info"><p> Posted on Dec 12, 2022 By copyninja under devops </p></abbr></footer><div class="entry-content"><p>I had bought a Thinkpad E470 laptop back in 2018 which was lying unused for quite some time. Recently when I wanted to use it, I found that the keyboard is not working, especially some keys and after some time the laptop will hang in Lenovo boot screen. I came back to Bangalore almost after 2 years from my hometown (WFH due to Covid) and thought it was the right time to get my laptop back to normal working state. After getting the keyboard replaced I noticed that 1TB HDD is no longer fast enough for my taste!. I've to admit I never thought I would start disliking HDD so quickly thanks to modern SSD based work laptops. So as a second upgrade I got the HDD removed from my laptop and got a 240G SSD. Yeah I know its reduction from my original size but I intend to continue using my old HDD via USB SATA enclosure as an external HDD which can house the extra data which I need to save.</p><p>So now that I've a SSD I need to install Debian Unstable again on it and this is where I tried something new. My colleague (name redacted on request) suggested to me use GRML live CD and install Debian via <em>debootstrap</em>. And after giving a thought I decided to try this out. Some reason for going ahead with this are listed below</p><ol class="arabic simple"><li>Debian Installer does not support a proper BTRFS based root file system. It just allows btrfs as root but no subvolume support. Also I'm not sure about the luks support with btrfs as root.</li><li>I also wanted to give a try to systemd-boot as my laptop is UEFI capable and I've slowly started disliking Grub.</li><li>I really hate installing task-kde-desktop (Yeah you read it right, I've switched to be a KDE user for quite some time) which will pull tons of unwanted stuff and bloat. Well it's not just task-kde-desktop but any other task-desktop package does similar and I don't want to have too much of unused stuff and services running.</li></ol><div class="section" id="disk-preparation"><h2>Disk Preparation</h2><p>As a first step I went to GRML website and downloaded <a class="reference external" href="https://grml.org/download/prerelease/">current pre-release</a>. Frankly, I'm using GRML for first time and I was not sure what to expect. When I booted it up I was bit taken a back to see its console based and I did not have a wired lan just a plain wireless dongle (Jiofi device) and was wondering what it will take to connect. But surprisingly curses based UI was pretty much straight forward to allow me to connect to Wifi AP. Another thing was the rescue CD had non-free firmware as the laptop was using ath10k device and needed non-free blobs to operate.</p><p>Once I got shell prompt in rescue CD first thing I did was to reconfigure console-setup to increase font size which was very very small on default boot. Once that is done I did the following to create a 1G (FAT32) partition for EFI.</p><div class="highlight"><pre><span></span>parted<span class="w"> </span>-a<span class="w"> </span>optimal<span class="w"> </span>-s<span class="w"> </span>/dev/sda<span class="w"> </span>mklabel<span class="w"> </span>gpt
parted<span class="w"> </span>-a<span class="w"> </span>optimal<span class="w"> </span>-s<span class="w"> </span>/dev/sda<span class="w"> </span>mkpart<span class="w"> </span>primary<span class="w"> </span>vfat<span class="w"> </span><span class="m">0</span>%<span class="w"> </span>1G
parted<span class="w"> </span>-a<span class="w"> </span>optimal<span class="w"> </span>-s<span class="w"> </span>/dev/sda<span class="w"> </span><span class="nb">set</span><span class="w"> </span><span class="m">1</span><span class="w"> </span>esp<span class="w"> </span>on
mkfs.vfat<span class="w"> </span>-n<span class="w"> </span>boot_disk<span class="w"> </span>-F<span class="w"> </span><span class="m">32</span><span class="w"> </span>/dev/sda1
</pre></div><p>So here is what I did: created a 1G vfat type partition and set the esp flag on it. This will be mounted to /boot/efi for systemd-boot. Next I created a single partition on the rest of the available free disk which will be used as the root file system.</p><p>Next I encrypted the root parition using LUKS and then created the BTRFS file system on top of it.</p><div class="highlight"><pre><span></span>cryptsetup<span class="w"> </span>luksFormat<span class="w"> </span>/dev/sda2
cryptsetup<span class="w"> </span>luksOpen<span class="w"> </span>/dev/sda2<span class="w"> </span>ENC
mkfs.btrfs<span class="w"> </span>-L<span class="w"> </span>root_disk<span class="w"> </span>/dev/mapper/ENC
</pre></div><p>Next is to create subvolumes in BTRFS. I followed suggestion by colleague and created a top-level <em>&#64;</em> as subvolume below which created <em>&#64;/home</em> <em>&#64;/var/log</em> <em>&#64;/opt</em> . Also enabled compression with zstd and level of 1 to avoid battery drain. Finally marked the <em>&#64;</em> as default subvolume to avoid adding it to fstab entry.</p><div class="highlight"><pre><span></span>mount<span class="w"> </span>-o<span class="w"> </span><span class="nv">compress</span><span class="o">=</span>zstd:1<span class="w"> </span>/dev/mapper/ENC<span class="w"> </span>/mnt
btrfs<span class="w"> </span>subvol<span class="w"> </span>create<span class="w"> </span>/mnt/@
<span class="nb">cd</span><span class="w"> </span>/mnt/@
btrfs<span class="w"> </span>subvol<span class="w"> </span>create<span class="w"> </span>./home
btrfs<span class="w"> </span>subvol<span class="w"> </span>create<span class="w"> </span>./opt
mkdir<span class="w"> </span>-p<span class="w"> </span>var
btrfs<span class="w"> </span>subvol<span class="w"> </span>create<span class="w"> </span>./var/log
btrfs<span class="w"> </span>suvol<span class="w"> </span>set-default<span class="w"> </span>/mnt/@
</pre></div></div><div class="section" id="bootstrapping-debian"><h2>Bootstrapping Debian</h2><p>Now that root disk is prepared next step was to bootstrap the root file system. I used debootstrap for this job. One thing I missed here from installer was ability to preseed. I tried looking around to figure out if we can preseed debootstrap but did not find much. If you know the procedure do point it to me.</p><div class="highlight"><pre><span></span><span class="nb">cd</span><span class="w"> </span>/mnt/
debootstrap<span class="w"> </span>--include<span class="o">=</span>dbus,locales,tzdata<span class="w"> </span>unstable<span class="w"> </span>@/<span class="w"> </span>http://deb.debian.org/debian
</pre></div><p>Well this just gets a bare minimal installation of Debian I need to install rest of the things post this step manually by chroot into target folder &#64;/.</p><p>I like the <strong>grml-chroot</strong> command for chroot purpose, it does most of the job of mounting all required directory like /dev/ /proc /sys etc. But before entering chroot I need to mount the ESP partition we created to <strong>/boot/efi</strong> so that I can finalize the installation of kernel and <strong>systemd-boot</strong>.</p><div class="highlight"><pre><span></span>umount<span class="w"> </span>/mnt
mount<span class="w"> </span>-o<span class="w"> </span><span class="nv">compress</span><span class="o">=</span>zstd:1<span class="w"> </span>/dev/mapper/ENC<span class="w"> </span>/mnt
mkdir<span class="w"> </span>-p<span class="w"> </span>/mnt/boot/efi
mount<span class="w"> </span>/dev/sda1<span class="w"> </span>/mnt/boot/efi
grml-chroot<span class="w"> </span>/mnt<span class="w"> </span>/bin/bash
</pre></div><p>I remounted the root subvolume <em>&#64;</em> directly to /mnt now, remember I made <em>&#64;</em> as default subvolume before. I also mounted ESP partition with FAT32 file system to <em>/boot/efi</em>. Finally I used grml-chroot to get into chroot of newly bootstrapped file system.</p><p>Now I will install the kernel and minimal KDE desktop installation and configure locales and time zone data for the new system. I wanted to use dracut instead of default initramfs-tools for initrd. I also need to install cryptsetup and btrfs-progs so I can decrypt and really boot into my new system.</p><div class="highlight"><pre><span></span>apt-get<span class="w"> </span>update
apt-get<span class="w"> </span>install<span class="w"> </span>linux-image-amd64<span class="w"> </span>dracut<span class="w"> </span>openssh-client<span class="w"> </span><span class="se">\</span>
<span class="w">                        </span>kde-plasma-desktop<span class="w"> </span>plasma-workspace-wayland<span class="w"> </span><span class="se">\</span>
<span class="w">                        </span>plasma-nm<span class="w"> </span>cryptsetup<span class="w"> </span>btrfs-progs<span class="w"> </span>sudo
</pre></div><p>Next is setting up crypttab and fstab entries for new system. Following entry is added to fstab</p><pre class="literal-block">
LABEL=&quot;root_disk&quot; / btrfs defaults,compress=zstd:1 0 0
</pre><p>And the crypttab entry</p><pre class="literal-block">
ENCRYPTED_ROOT UUID=xxxx none discard,x-initrd.attach
</pre><p>I've not written actual UUID above this is just for the purpose of showing the content of /etc/crypttab. Once these entries are added we need to recreate initrd. I just reconfigured the installed kernel package for retriggerring the recreation of initrd using dracut. .. Reconfiguration was locales is done by editing /etc/locales.gen to uncomment <em>en_US.UTF-8</em> and writing /etc/timezone with <em>Asia/Kolkata</em>. I used <em>DEBIAN_FRONTEND=noninteractive</em> to avoid another prompt asking for locale and timezone information.</p><div class="highlight"><pre><span></span><span class="nb">export</span><span class="w"> </span><span class="nv">DEBIAN_FRONTEND</span><span class="o">=</span>noninteractive
dpkg-reconfigure<span class="w"> </span>locales
dpkg-reconfigure<span class="w"> </span>tzdata
</pre></div><p>Added my user using <em>adduser</em> command and also set the root password as well. Added my user to <em>sudo</em> group so I can use sudo to elevate privileges.</p></div><div class="section" id="setting-up-systemd-boot"><h2>Setting up systemd-boot</h2><p>So now basic usable system is ready last part is enabling the systemd-boot configuration as I'm not gonna use grub. I did following to install systemd-boot. Frankly I'm not expert of this it was colleague's suggestion.</p><p>Before installing the systemd-boot I had to setup kernel command line. This can be done by writing command line to /etc/kernel/cmdline with following contents.</p><pre class="literal-block">
systemd.gpt_auto=no quiet root=LABEL=root_disk
</pre><p>I'm disabling systemd-gpt-generator to avoid race condition between crypttab entry and auto generated entry by systemd. I faced this mainly because of my stupidity of not adding entry <em>root=LABEL=root_disk</em></p><div class="highlight"><pre><span></span>apt-get<span class="w"> </span>install<span class="w"> </span>-y<span class="w"> </span>systemd-boot
bootctl<span class="w"> </span>install<span class="w"> </span>--make-entry-directory<span class="o">=</span>yes<span class="w"> </span>--entry-token<span class="o">=</span>machine-id
dpkg-reconfigure<span class="w"> </span>linux-image-6.0.0-5-amd64
</pre></div><p>Finally exit from the chroot and reboot into the freshly installed system.</p><p><em>systemd-boot</em> already ships a hook file <em>zz-systemd-boot</em> under <em>/etc/kernel</em> so its pretty much usable without any manual intervention. Previously after kernel installation we had to manually update kernel image in efi partitions using <em>bootctl</em></p></div><div class="section" id="conclussion"><h2>Conclussion</h2><p>Though installing from live image is not new and debian-installer also does the same only difference is more control over installation and doing things which is installer is not letting you do (or should I say is not part of default installation?). If properly automated using scripts we can leverage this to do custom installation in large scale environments. I know there is FAI but I've not explored it and felt there is too much to setup for a simple installations with specific requirements.</p><p>So finally I've a system with Debian which differs from default Debian installation :-). I should thank my colleague for rekindling nerd inside me who had stopped experimenting quite a long time back.</p></div></div><div id="footer"><p><italic>Tagged as: btrfs, debian, grml, live, systemd-boot, </italic></p></section></div><hr><div id="footer"> Site Proudly powered by <a href="http://getpelican.com/">Pelican</a></div></body></html>