<!DOCTYPE html><html lang="en"><head><link href="https://fonts.googleapis.com/css?family=Cantarell" rel="stylesheet"><title>Note to Self: Enabling Unified Kernel Image on Debian</title><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1"><link href="https://copyninja.in/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Random Ramblings Full Atom Feed"><link href="https://copyninja.in/feeds/{slug}.atom.xml" type="application/atom+xml" rel="alternate" title="Random Ramblings Categories Atom Feed"><link rel="stylesheet" type="text/css" href="/theme/css/pygments.css"><link rel="stylesheet" type="text/css" href="/theme/css/default.css"><meta name="tags" content="debian"><meta name="tags" content="systemd"><meta name="tags" content="ukify"></head><body><div id="header" class="body"><div id="navigation"> | <a href="https://copyninja.in">Home</a> | | <a href="https://copyninja.in/about">About</a> | | <a href="https://copyninja.in/contact">Contact</a> | | <a href="https://copyninja.in/categories.html">Categories</a> | | <a href="https://copyninja.in/tags.html">Tags</a> | </div><h1><a href="https://copyninja.in/blog/enable_ukify_debian.html">Note to Self: Enabling Unified Kernel Image on Debian</a></h1></div><div id="content"><section id="content" class="body"><footer class="post-info"><p> Posted on Sep 19, 2024 By copyninja under devops </p></abbr></footer><div class="entry-content"><div class="admonition note"><p class="first admonition-title">Note</p><p class="last"><em>These steps may not work on your system if you are using the default Debian installation. This guide assumes that your system is using systemd-boot as the bootloader, which is explained in the post linked below.</em></p></div><ul class="simple"><li><a class="reference external" href="https://copyninja.in/blog/live_install_debian.html">Install Debian from grml-liveboot</a></li></ul><p>A unified kernel image (UKI) is a single executable that can be booted directly from UEFI firmware or automatically sourced by bootloaders with little or no configuration. It combines a UEFI boot stub program like systemd-stub(7), a Linux kernel image, an initrd, and additional resources into a single UEFI PE file.</p><p>systemd-boot already provides a hook for kernel installation via <tt class="docutils literal"><span class="pre">/etc/kernel/postinst.d/zz-systemd-boot</span></tt>. We just need a couple of additional configurations to generate the UKI image.</p><div class="section" id="installation-and-configuration"><h2>Installation and Configuration</h2><ol class="arabic"><li><p class="first">Install the <tt class="docutils literal"><span class="pre">systemd-ukify</span></tt> package:</p><div class="highlight"><pre><span></span>sudo<span class="w"> </span>apt-get<span class="w"> </span>install<span class="w"> </span>systemd-ukify
</pre></div></li><li><p class="first">Create the following configuration in <tt class="docutils literal">/etc/kernel/install.conf</tt>:</p><div class="highlight"><pre><span></span><span class="na">layout</span><span class="o">=</span><span class="s">uki</span>
<span class="na">initrd_generator</span><span class="o">=</span><span class="s">dracut</span>
<span class="na">uki_generator</span><span class="o">=</span><span class="s">ukify</span>
</pre></div><p>This configuration specifies how to generate the UKI image for the installed kernel and which generator to use.</p></li><li><p class="first">Define the kernel command line for the UKI image. Create <tt class="docutils literal">/etc/kernel/uki.conf</tt> with the following content:</p><div class="highlight"><pre><span></span><span class="k">[UKI]</span>
<span class="na">Cmdline</span><span class="o">=</span><span class="s">@/etc/kernel/cmdline</span>
</pre></div></li></ol></div><div class="section" id="generating-the-uki-image"><h2>Generating the UKI Image</h2><p>To apply these changes, regenerate the UKI image for the currently running kernel:</p><div class="highlight"><pre><span></span>sudo<span class="w"> </span>dpkg-reconfigure<span class="w"> </span>linux-image-<span class="k">$(</span>uname<span class="w"> </span>-r<span class="k">)</span>
</pre></div></div><div class="section" id="verification"><h2>Verification</h2><p>Use the <tt class="docutils literal">bootctl list</tt> command to verify the presence of a &quot;Type #2&quot; entry for the current kernel. The output should look similar to this:</p><div class="highlight"><pre><span></span>bootctl list
      type: Boot Loader Specification Type #2 (.efi)
     title: Debian GNU/Linux trixie/sid (2d0080583f1a4127ac0b073b1a9d3e61-6.10.9-amd64.efi) (default) (selected)
        id: 2d0080583f1a4127ac0b073b1a9d3e61-6.10.9-amd64.efi
    source: /boot/efi/EFI/Linux/2d0080583f1a4127ac0b073b1a9d3e61-6.10.9-amd64.efi
  sort-key: debian
     linux: /boot/efi/EFI/Linux/2d0080583f1a4127ac0b073b1a9d3e61-6.10.9-amd64.efi
   options: systemd.gpt_auto=no quiet root=LABEL=root_disk ro systemd.machine_id=2d0080583f1a4127ac0b073b1a9d3e61

      type: Boot Loader Specification Type #2 (.efi)
     title: Debian GNU/Linux trixie/sid (2d0080583f1a4127ac0b073b1a9d3e61-6.10.7-amd64.efi)
        id: 2d0080583f1a4127ac0b073b1a9d3e61-6.10.7-amd64.efi
    source: /boot/efi/EFI/Linux/2d0080583f1a4127ac0b073b1a9d3e61-6.10.7-amd64.efi
  sort-key: debian
     linux: /boot/efi/EFI/Linux/2d0080583f1a4127ac0b073b1a9d3e61-6.10.7-amd64.efi
   options: systemd.gpt_auto=no quiet root=LABEL=root_disk ro systemd.machine_id=2d0080583f1a4127ac0b073b1a9d3e61

      type: Automatic
     title: Reboot Into Firmware Interface
        id: auto-reboot-to-firmware-setup
    source: /sys/firmware/efi/efivars/LoaderEntries-4a67b082-0a4c-41cf-b6c7-440b29bb8c4f
</pre></div></div><div class="section" id="cleanup-and-reboot"><h2>Cleanup and Reboot</h2><p>Once the &quot;Type #2&quot; entries are generated, remove any &quot;Type #1&quot; entries using the <tt class="docutils literal">bootctl unlink</tt> command. After this, reboot your system to boot from the UKI-based image.</p></div><div class="section" id="future-considerations"><h2>Future Considerations</h2><p>The primary use case for a UKI image is secure boot. Signing the UKI image can also be configured in the settings above, but this guide does not cover that process as it requires setting up secure boot on your system.</p></div></div><div id="footer"><p><italic>Tagged as: debian, systemd, ukify, </italic></p></section></div><hr><div id="footer"> Site Proudly powered by <a href="http://getpelican.com/">Pelican</a></div></body></html>