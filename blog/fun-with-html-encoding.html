<!DOCTYPE html><html lang="en"><head><link href="https://fonts.googleapis.com/css?family=Cantarell" rel="stylesheet"><title>Magic: Attach a HTML file to mail and get different on other side</title><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1"><link href="https://copyninja.in/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Random Ramblings Full Atom Feed"><link href="https://copyninja.in/feeds/{slug}.atom.xml" type="application/atom+xml" rel="alternate" title="Random Ramblings Categories Atom Feed"><link rel="stylesheet" type="text/css" href="/theme/css/pygments.css"><link rel="stylesheet" type="text/css" href="/theme/css/default.css"><meta name="tags" content="html"><meta name="tags" content="encoding"></head><body><div id="header" class="body"><div id="navigation"> | <a href="https://copyninja.in">Home</a> | | <a href="https://copyninja.in/about">About</a> | | <a href="https://copyninja.in/contact">Contact</a> | | <a href="https://copyninja.in/categories.html">Categories</a> | | <a href="https://copyninja.in/tags.html">Tags</a> | </div><h1><a href="https://copyninja.in/blog/fun-with-html-encoding.html">Magic: Attach a HTML file to mail and get different on other side</a></h1></div><div id="content"><section id="content" class="body"><footer class="post-info"><p> Posted on May 06, 2017 By copyninja under misc </p></abbr></footer><div class="entry-content"><p>It's been a long time I did not write any new blog posts, and finally I got something which is interesting enough for a new post and so here it is.</p><p>I actually wanted some bills from my ISP for some work and I could not find mail from the ISP which had bills for some specific months in my mailbox. Problem with my ISP is bills are accessible in their account which can be only accessed from their own network. They do have a mobile app and that does not seem to work especially for the billing section. I used mobile app and selected month for which I did not have bill and clicked <em>Send Mail</em> button. App happily showed message saying it sent the bill to my registered mail address but that was a fancy lie. After trying several time I gave up and decided I will do it once I get back home.</p><p>Fast forward few hours, I'm back home from office and then I sat in front of my laptop and connected to ISP site, promptly downloaded the bills, then used <em>notmuch-emacs</em> and fire up a mail composer, attach those HTML file (yeah they produce bill in HTML file :-/) send it to my gmail and forget about it.</p><p>Fast forward few more days, I just remember I need those bills. I got hold of mail I sent earlier in gmail inbox and clicked on attachment and when browser opened the attachment I was shocked/surprised . Did you ask why?. See what I saw when I opened attachment.</p><img alt src="https://copyninja.in/images/converted_html.png"><p>Well I was confused for moment on what happened, I tried downloading the file and opened it an editor, and I see Chinese characters here also. After reaching home I checked the Sent folder in my laptop where I keep copy of mails sent using <em>notmuch-emacs</em>'s <cite>notmuch-fcc-dirs</cite> variable. I open the file and open the attachement and I see same character as I saw in browser!. I open the original bills I downloaded and it looks fine. To check if I really attached the correct files I again drafted a mail this time to my personal email and sent it. Now I open the file from Sent folder and voila again there is different content inside my attachment!. Same happens when I receive the mail and open the attachment everything inside is Chinese characters!. Totally lost I finally opened the original file using <em>emacs</em>, since I use <em>spacemacs</em> it asked me for downloading of <em>html layer</em> and after which I was surprised because everything inside the editor is in Chinese!. OK finally I've something now so I opened same file at same time in <em>nano</em> from terminal and there it looks fine!. OK that is weird again I read carefully content and saw this line in beginning of file</p><div class="highlight"><pre><span></span><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-16&quot; ?&gt;</span>
<span class="nt">&lt;html</span><span class="w"> </span><span class="na">xmlns=</span><span class="s">&quot;http://www.w3.org/1999/xhtml</span><span class="nt">&gt;</span>....
</pre></div><p>OK that is new XML tag had encoding declared as <em>UTF-16</em>, really?. And just for checking I changed it to UTF-8 and voila file is back to normal in Emacs window!. To confirm this behavior I created a sample file with following content</p><div class="highlight"><pre><span></span><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</span><span class="p">&lt;</span><span class="nt">html</span> <span class="na">xmlns</span><span class="o">=</span><span class="s">&quot;http://www.w3.org/1999/xhtml&quot;</span><span class="p">&gt;&lt;</span><span class="nt">head</span><span class="p">&gt;&lt;</span><span class="nt">meta</span> <span class="na">http-equiv</span><span class="o">=</span><span class="s">&quot;Content-Type&quot;</span> <span class="na">content</span><span class="o">=</span><span class="s">&quot;text/html; charset=iso-8859-1&quot;</span> <span class="p">/&gt;&lt;</span><span class="nt">title</span><span class="p">&gt;</span> Something weird <span class="p">&lt;/</span><span class="nt">title</span><span class="p">&gt;&lt;</span><span class="nt">body</span><span class="p">&gt;</span>blablablablablalabkabakba<span class="p">&lt;/</span><span class="nt">body</span><span class="p">&gt;&lt;/</span><span class="nt">html</span><span class="p">&gt;</span>
</pre></div><p>Yeah with long line because ISP had similar case and now I opened the same file in nano using terminal and changed <cite>encoding=&quot;UTF-8&quot;</cite> to <cite>encoding=&quot;UTF-16&quot;</cite> and the behavior repeated I see Chinese character in the emacs buffer which has also opened the same file.</p><p>Below is the small gif showing this happening in real time, see what happens in emacs buffer when I change the encoding in terminal below. Fun right?.</p><img alt src="https://copyninja.in/images/html_weirdness.gif"><p>I made following observation from above experiments.</p><ol class="arabic simple"><li>When I open original file in browser or my sample file with <cite>encoding=&quot;UTF-16&quot;</cite> its normal, no Chinese characters.</li><li>When I attach the mail and send it out the attachment some how gets converted into HTML file with Chinese characters and viewing source from browser shows header containing xml declarations and original <cite>&lt;html&gt;</cite> declarations get ripped off and new tags show up which I've pasted below.</li><li>If I download the same file and open in editor only Chinese characters are present and no HTML tags inside it. So definitely the new tags which I saw by viewing source in browser is added by Firefox.</li><li>I create similar HTML file and change encoding I can see the characters changing back and forth in emacs <em>web-mode</em> when I change encoding of the file.</li></ol><div class="highlight"><pre><span></span><span class="cp">&lt;!DOCTYPE HTML PUBLIC &quot;-//W3C//DTD HTML 4.01 Transitional//EN&quot;&gt;</span>
<span class="p">&lt;</span><span class="nt">html</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">head</span><span class="p">&gt;&lt;</span><span class="nt">META</span> <span class="na">http-equiv</span><span class="o">=</span><span class="s">&quot;Content-Type&quot;</span>  <span class="na">content</span><span class="o">=</span><span class="s">&quot;text/html; charset=utf-8&quot;</span><span class="p">&gt;</span>
</pre></div><p>So if I'm understanding this correctly, <em>Emacs</em> due to encoding declaration interprets the actual contents differently. To see how <em>Emacs</em> really interpreted the content I opened the sent mail I had in raw format and saw following header lines for attachment.</p><div class="highlight"><pre><span></span><span class="na">Content-Type</span><span class="o">:</span><span class="w"> </span><span class="s">text/html</span><span class="c1">; charset=utf-8</span>
<span class="na">Content-Disposition</span><span class="o">:</span><span class="w"> </span><span class="s">attachment</span><span class="c1">;</span>
<span class="w">             </span><span class="na">filename</span><span class="o">=</span><span class="s">SOA-102012059675-FEBRUARY-2017.html</span>
<span class="na">Content-Transfer-Encoding</span><span class="o">:</span><span class="w"> </span><span class="s">base64</span>
</pre></div><p>This was followed with base64 encoded data. So does this mean emacs interpreted the content as UTF-16 and encoded the content using UTF-8?. Again I've no clue, so I changed the <cite>encoding</cite> in both the files to be as UTF-8 and sent the mail by attaching these files again to see what happens. And my guess was right I could get the attachment as is on the receiving side. And inspecting raw mail the attachment headers now different than before.</p><div class="highlight"><pre><span></span><span class="na">Content-Type</span><span class="o">:</span><span class="w"> </span><span class="s">text/html</span>
<span class="na">Content-Disposition</span><span class="o">:</span><span class="w"> </span><span class="s">attachment</span><span class="c1">;</span>
<span class="w">             </span><span class="na">filename</span><span class="o">=</span><span class="s">SOA-102012059675-DECEMBER-2016.html</span>
<span class="na">Content-Transfer-Encoding</span><span class="o">:</span><span class="w"> </span><span class="s">quoted-printable</span>
</pre></div><p>See how <em>Content-Type</em> its different now also see the <em>Content-Transfer-Encoding</em> its now <cite>quoted-printable</cite> as opposed to <cite>base64</cite> earlier. Additionally I can see HTML content below the header. When I opened the attachment from mail I get the actual bill.</p><p>As far as I understand base64 encoding is used when the data to be attached is base64. So I guess basically due to wrong encoding declared inside the file <em>Emacs</em> interpreted the content as a binary data and encoded it differently than what it really should be. Phew that was a lot of investigation to understand the magic but it was worth it.</p><p>Do let me know your thoughts on this.</p></div><div id="footer"><p><italic>Tagged as: encoding, html, </italic></p></section></div><hr><div id="footer"> Site Proudly powered by <a href="http://getpelican.com/">Pelican</a></div></body></html>