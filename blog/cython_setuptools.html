<!DOCTYPE html><html lang="en"><head><link href="https://fonts.googleapis.com/css?family=Cantarell" rel="stylesheet"><title>Integrating Cython extension with setuptools and unit testing</title><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1"><link href="https://copyninja.in/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Random Ramblings Full Atom Feed"><link href="https://copyninja.in/feeds/{slug}.atom.xml" type="application/atom+xml" rel="alternate" title="Random Ramblings Categories Atom Feed"><link rel="stylesheet" type="text/css" href="/theme/css/pygments.css"><link rel="stylesheet" type="text/css" href="/theme/css/default.css"><meta name="tags" content="python"><meta name="tags" content="cython"><meta name="tags" content="setuptools"><meta name="tags" content="pbr"></head><body><div id="header" class="body"><div id="navigation"> | <a href="https://copyninja.in">Home</a> | | <a href="https://copyninja.in/about">About</a> | | <a href="https://copyninja.in/contact">Contact</a> | | <a href="https://copyninja.in/categories.html">Categories</a> | | <a href="https://copyninja.in/tags.html">Tags</a> | </div><h1><a href="https://copyninja.in/blog/cython_setuptools.html">Integrating Cython extension with setuptools and unit testing</a></h1></div><div id="content"><section id="content" class="body"><footer class="post-info"><p> Posted on Jun 26, 2016 By copyninja under development </p></abbr></footer><div class="entry-content"><p>I was reviewing changes for <a class="reference external" href="https://github.com/libindic/indic-trans">indic-trans</a> as part of GSoC 2016. The module is an improvisation for our original transliteration module which was doing its job by substitution.</p><p>This new module uses machine learning of some sort and utilizes <em>Cython</em>, <em>numpy</em> and <em>scipy</em>. Student had kept pre-compiled shared library in the git tree to make sure it builds and passes the test. But this was not correct way. I started looking at way to build these files and remove it from the code base.</p><p>There is a <a class="reference external" href="http://docs.cython.org/src/quickstart/build.html">cython documentation</a> for distutils but none for setuptools. Probably it is similar to other Python extension integration into setuptools, but this was first time for me so after a bit of searching and trial and error below is what I did.</p><p>We need to use <cite>Extensions</cite> class from setuptools and give it path to modules we want to build. In my case <cite>beamsearch</cite> and <cite>viterbi</cite> are 2 modules. So I added following lines to setup.py</p><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">setuptools.extension</span> <span class="kn">import</span> <span class="n">Extension</span>
<span class="kn">from</span> <span class="nn">Cython.Build</span> <span class="kn">import</span> <span class="n">cythonize</span>

<span class="n">extensions</span> <span class="o">=</span> <span class="p">[</span>
 <span class="n">Extension</span><span class="p">(</span>
     <span class="s2">&quot;indictrans._decode.beamsearch&quot;</span><span class="p">,</span>
     <span class="p">[</span>
         <span class="s2">&quot;indictrans/_decode/beamsearch.pyx&quot;</span>
     <span class="p">],</span>
     <span class="n">include_dirs</span><span class="o">=</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">get_include</span><span class="p">()]</span>
 <span class="p">),</span>
 <span class="n">Extension</span><span class="p">(</span>
     <span class="s2">&quot;indictrans._decode.viterbi&quot;</span><span class="p">,</span>
     <span class="p">[</span>
         <span class="s2">&quot;indictrans/_decode/viterbi.pyx&quot;</span>
     <span class="p">],</span>
     <span class="n">include_dirs</span><span class="o">=</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">get_include</span><span class="p">()]</span>
 <span class="p">)</span>

<span class="p">]</span>
</pre></div><p>First argument to <cite>Extensions</cite> is the module name and second argument is a list of files to be used in building the module. The additional <cite>inculde_dirs</cite> argument is not normally necessary unless you are working in virtualenv. In my system the build used to work without this but it was failing in Travis CI, so added it to fix the CI builds. OTOH it did work without this on Circle CI.</p><p>Next is provide this <cite>extensions</cite> to <cite>ext_modules</cite> argument to <cite>setup</cite> as shown below</p><div class="highlight"><pre><span></span><span class="n">setup</span><span class="p">(</span>
 <span class="n">setup_requires</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;pbr&#39;</span><span class="p">],</span>
 <span class="n">pbr</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
 <span class="n">ext_modules</span><span class="o">=</span><span class="n">cythonize</span><span class="p">(</span><span class="n">extensions</span><span class="p">)</span>
<span class="p">)</span>
</pre></div><p>And for the reference here is full setup.py after modifications.</p><div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env python</span>

<span class="kn">from</span> <span class="nn">setuptools</span> <span class="kn">import</span> <span class="n">setup</span>
<span class="kn">from</span> <span class="nn">setuptools.extension</span> <span class="kn">import</span> <span class="n">Extension</span>
<span class="kn">from</span> <span class="nn">Cython.Build</span> <span class="kn">import</span> <span class="n">cythonize</span>

<span class="kn">import</span> <span class="nn">numpy</span>


<span class="n">extensions</span> <span class="o">=</span> <span class="p">[</span>
  <span class="n">Extension</span><span class="p">(</span>
     <span class="s2">&quot;indictrans._decode.beamsearch&quot;</span><span class="p">,</span>
     <span class="p">[</span>
         <span class="s2">&quot;indictrans/_decode/beamsearch.pyx&quot;</span>
     <span class="p">],</span>
     <span class="n">include_dirs</span><span class="o">=</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">get_include</span><span class="p">()]</span>
  <span class="p">),</span>
  <span class="n">Extension</span><span class="p">(</span>
     <span class="s2">&quot;indictrans._decode.viterbi&quot;</span><span class="p">,</span>
     <span class="p">[</span>
         <span class="s2">&quot;indictrans/_decode/viterbi.pyx&quot;</span>
     <span class="p">],</span>
     <span class="n">include_dirs</span><span class="o">=</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">get_include</span><span class="p">()]</span>
  <span class="p">)</span>
<span class="p">]</span>

<span class="n">setup</span><span class="p">(</span>
  <span class="n">setup_requires</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;pbr&#39;</span><span class="p">],</span>
  <span class="n">pbr</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
  <span class="n">ext_modules</span><span class="o">=</span><span class="n">cythonize</span><span class="p">(</span><span class="n">extensions</span><span class="p">)</span>
<span class="p">)</span>
</pre></div><p>So now we can build the extensions (shared library) using following command.</p><div class="highlight"><pre><span></span>python<span class="w"> </span>setup.py<span class="w"> </span>build_ext
</pre></div><p>Another challenge I faced was missing extension when running test. We use pbr in above project and testrepository with subunit for running tests. Looks like it does not build extensions by default so I modified the Makefile to build the extension in place before running test. The <cite>travis</cite> target of my Makefile is as follows.</p><div class="highlight"><pre><span></span><span class="nf">travis</span><span class="o">:</span>
<span class="w">     </span><span class="o">[</span><span class="w"> </span>!<span class="w"> </span>-d<span class="w"> </span>.testrepository<span class="w"> </span><span class="o">]</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="se">\</span>
<span class="w">             </span>find<span class="w"> </span>.testrepository<span class="w"> </span>-name<span class="w"> </span><span class="s2">&quot;times.dbm*&quot;</span><span class="w"> </span>-delete
<span class="w">     </span>python<span class="w"> </span>setup.py<span class="w"> </span>build_ext<span class="w"> </span>-i
<span class="w">     </span>python<span class="w"> </span>setup.py<span class="w"> </span><span class="nb">test</span><span class="w"> </span>--coverage<span class="w"> </span><span class="se">\</span>
<span class="w">             </span>--coverage-package-name<span class="o">=</span>indictrans
<span class="w">     </span>flake8<span class="w"> </span>--max-complexity<span class="w"> </span><span class="m">10</span><span class="w"> </span>indictrans
</pre></div><p>I had to build the extension in place using <cite>-i</cite> switch. This is because other wise the tests won't find the <cite>indictrans._decode.beamsearch</cite> and <cite>indictrans._decode.viterbi modules</cite>. What basically <cite>-i</cite> switch does is after building shared library symlinks it to the module directory, in ourcase <cite>indictrans._decode</cite></p><p>The test for existence of .testrepository folder is over come <a class="reference external" href="https://bugs.launchpad.net/testrepository/+bug/1229445">this bug</a> in testrepository which results in test failure when running tests using <cite>tox</cite>.</p></div><div id="footer"><p><italic>Tagged as: cython, pbr, python, setuptools, </italic></p></section></div><hr><div id="footer"> Site Proudly powered by <a href="http://getpelican.com/">Pelican</a></div></body></html>