<!DOCTYPE html><html lang="en"><head><link href="https://fonts.googleapis.com/css?family=Cantarell" rel="stylesheet"><title>Gzipped response for CSS/JS with Apache and mod_uwsgi</title><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1"><link href="https://copyninja.in/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Random Ramblings Full Atom Feed"><link href="https://copyninja.in/feeds/{slug}.atom.xml" type="application/atom+xml" rel="alternate" title="Random Ramblings Categories Atom Feed"><link rel="stylesheet" type="text/css" href="/theme/css/pygments.css"><link rel="stylesheet" type="text/css" href="/theme/css/default.css"><meta name="tags" content="python"><meta name="tags" content="apache2"><meta name="tags" content="mod_uwsgi"><meta name="tags" content="mod_deflate"></head><body><div id="header" class="body"><div id="navigation"> | <a href="https://copyninja.in">Home</a> | | <a href="https://copyninja.in/about">About</a> | | <a href="https://copyninja.in/contact">Contact</a> | | <a href="https://copyninja.in/categories.html">Categories</a> | | <a href="https://copyninja.in/tags.html">Tags</a> | </div><h1><a href="https://copyninja.in/blog/comressed-response.html">Gzipped response for CSS/JS with Apache and mod_uwsgi</a></h1></div><div id="content"><section id="content" class="body"><footer class="post-info"><p> Posted on Mar 01, 2014 By copyninja under development </p></abbr></footer><div class="entry-content"><p>So it may sound normal to receive compressed response for CSS/JS file from Apache2 but what I faced is completely different behavior, here I saw not just body of response but also header are getting compressed and send to browser and browser was unable to interpret the response there by leading page rendered without CSS and JS.</p><p>That was long story short, so let me explain in detail the case and what I found out.</p><p>I have <a class="reference external" href="http://silpa.org.in">hosted</a> <a class="reference external" href="https://github.com/Project-SILPA/Silpa-Flask">SILPA</a> on my VPS using uWSGI. I had used till date using <em>libapache2-mod-proxy-uwsgi</em> plugin for which uWSGI should be using network socket and in Apache2 config I need <em>ProxyPass</em> directive pointing to <em>uwsgi://host:port</em> and everything used to work out of box. There is a drawback for using network socket in uWSGI that is limited amount of ports (65535) and possible clash with other services if we use wrong port number, additionally network sockets will be slower compared to the file socket so yesterday I thought of changing it to file socket and removed <em>socket</em> directive in the ini file for uWSGI application container for SILPA and here is where all problems started. My updated configuration can be seen in our <a class="reference external" href="http://silpa.readthedocs.org/en/latest/installation.html#hosting-the-silpa-on-webserver">documentation page</a> that is if you are interested to look my configuration file :-).</p><div class="section" id="problem-reporting"><h2>Problem Reporting</h2><p>We got selected to Gsoc again this year and we have lot of students jumping in our channel <em>#silpa</em> on <em>irc.freenode.net</em> and yesterday night some students reported they are facing <em>500 internal server error</em> and subsequently others mentioned there is no theme being rendered. I checked and found everything was fine for me only to notice that my browser was using cached content, and when I clear cache there I go everything vanished, no theme no css no javascript just plain html!!!.</p></div><div class="section" id="investigation"><h2>Investigation</h2><p>So I thought I should investigate this and fired up <em>firebug</em> on my iceweasel to observe the network traffic. And below is what I observed in firebug network console!.</p><img alt="No response headers" class="align-center" src="https://copyninja.in/images/no-response-css.png"><p>So you can see no response header in the above image but there is a response and below how is response content visible on firebug.</p><img alt="gzipped response" class="align-center" src="https://copyninja.in/images/response-content.png"><p>Still weird part was when using wget/curl directly to get the CSS I was getting correct reply and the file, which is puzzling.</p><p>So I went ahead opened the CSS url directly using browser and saved the resulting file. When I used <tt class="docutils literal">file</tt> command on it, output suggested the saved file in gzip compressed!. I went ahead uncompressed it and opened the file and inside it I found response header and the response body! So what just happened? Did apache some how manage to compress entire respone not just response body?</p><p>The more puzzling question was why did it work when I was using <em>mod_proxy_uwsgi</em> and failed when I switched to <em>mod_uwsgi</em>. I had no clue at this point why this behavior is coming up.</p></div><div class="section" id="possible-solution"><h2>Possible Solution</h2><p>I was still not sure how to resolve this, and started searching in the network but nothing was coming up in search result which can explain me this. And finally I stumbled on a link which is <a class="reference external" href="http://bit.ly/1eJdQe8">totally unrelated</a> but I saw the word <em>mod_deflate</em> in the content and wandered on my system to see if its enabled. Yes mod_deflate was enabled I just opened the conf file and saw following.</p><div class="highlight"><pre><span></span><span class="nt">&lt;IfModule</span><span class="w"> </span><span class="s">mod_deflate.c</span><span class="nt">&gt;</span>
<span class="w">       </span><span class="c"># these are known to be safe with MSIE 6</span>
<span class="w">       </span><span class="nb">AddOutputFilterByType</span><span class="w"> </span>DEFLATE<span class="w"> </span>text/html<span class="w"> </span>text/plain<span class="w"> </span>text/xml

<span class="w">       </span><span class="c"># everything else may cause problems with MSIE 6</span>
<span class="w">       </span><span class="nb">AddOutputFilterByType</span><span class="w"> </span>DEFLATE<span class="w"> </span>text/css
<span class="w">       </span><span class="nb">AddOutputFilterByType</span><span class="w"> </span>DEFLATE<span class="w"> </span>application/x-javascript<span class="w"> </span>application/javascript<span class="w"> </span>application/ecmascript
<span class="w">       </span><span class="nb">AddOutputFilterByType</span><span class="w"> </span>DEFLATE<span class="w"> </span>application/rss+xml
<span class="nt">&lt;/IfModule&gt;</span>
</pre></div><p>Interesting so it suggests to compress css, javascript files etc. So I thought possibly its compressing the result of <em>mod_uwsgi</em>, yeah possibly so why not try disabling <em>mod_deflate</em> and check if it works well and good if not I'm not gonna loose anything. So I disabled <em>mod_deflate</em> and voila! Everything is working fine!</p></div><div class="section" id="what-might-be-the-reason-for-this-behavior"><h2>What might be the reason for this behavior?</h2><p>Well I'm not exactly sure but here is my assumption. The whole behavior depends on internal implementation of <strong>mod_uwsgi</strong> and <strong>mod_proxy_uwsgi</strong> module. To confirm this I switched back to use <strong>mod_proxy_uwsgi</strong> module and enabled <strong>mod_deflate</strong> and observed request response in <strong>Firebug</strong> network console and below is what I observed.</p><img alt="Response with mod_proxy_uwsgi" class="align-center" src="https://copyninja.in/images/response-content-uwsgi-proxy.png"><p>So response is still gziped but this time only response body was gziped and Content-Encoding field was set properly which makes browser to properly uncompress the response body and use it.</p><p>So it seems like there is a difference between mod_uwsgi and mod_proxy_uwsgi implementation. mod_uwsgi was sending the response along with response headers which was compressed by mod_deflate there by rendering browser helpless to interpret the response. But mod_proxy_uwsgi seems to be only sending the response content without response body and this content was later compressed by mod_deflate and proper response headers were set by apache before sending it to browser.</p><p>So now whose fault is this? Is it the bug in mod_uwsgi or, mod_deflate not being able to exclude response headers from compression? I've no clue! If you have a clue and you want to share it with me, please consider writing to me over email. My details are available in <a class="reference external" href="http://copyninja.info/contact">Contacts</a></p></div></div><div id="footer"><p><italic>Tagged as: apache2, mod_deflate, mod_uwsgi, python, </italic></p></section></div><hr><div id="footer"> Site Proudly powered by <a href="http://getpelican.com/">Pelican</a></div></body></html>