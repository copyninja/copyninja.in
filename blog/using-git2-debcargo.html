<!DOCTYPE html><html lang="en"><head><link href="https://fonts.googleapis.com/css?family=Cantarell" rel="stylesheet"><title>debcargo: Replacing subprocess crate with git2 crate</title><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1"><link href="https://copyninja.in/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Random Ramblings Full Atom Feed"><link href="https://copyninja.in/feeds/{slug}.atom.xml" type="application/atom+xml" rel="alternate" title="Random Ramblings Categories Atom Feed"><link rel="stylesheet" type="text/css" href="/theme/css/pygments.css"><link rel="stylesheet" type="text/css" href="/theme/css/default.css"><meta name="tags" content="rust"><meta name="tags" content="subprocess"><meta name="tags" content="git"></head><body><div id="header" class="body"><div id="navigation"> | <a href="https://copyninja.in">Home</a> | | <a href="https://copyninja.in/about">About</a> | | <a href="https://copyninja.in/contact">Contact</a> | | <a href="https://copyninja.in/categories.html">Categories</a> | | <a href="https://copyninja.in/tags.html">Tags</a> | </div><h1><a href="https://copyninja.in/blog/using-git2-debcargo.html">debcargo: Replacing subprocess crate with git2 crate</a></h1></div><div id="content"><section id="content" class="body"><footer class="post-info"><p> Posted on Jul 15, 2017 By copyninja under development </p></abbr></footer><div class="entry-content"><p>In my previous <a class="reference external" href="https://copyninja.info/blog/shell-pipelines-rust.html">post</a> I talked about using <em>subprocess</em> crate to extract beginning and ending year from git repository for generating debian/copyright file. In this post I'm going to talk on how I replaced <em>subprocess</em> with native <em>git2</em> crate and achieved the same result in much cleaner and safer way.</p><p>git2 is a native Rust crate which provides access to Git repository internals. git2 does not involve any <em>unsafe</em> invocation as it is built against <em>libgit2-sys</em> which is actually using Rust FFI to directly bind to underlying libgit library. Below is the new <em>copyright_fromgit</em> function with git2 crate.</p><div class="highlight"><pre><span></span><span class="k">fn</span><span class="w"> </span><span class="nf">copyright_fromgit</span><span class="p">(</span><span class="n">repo_url</span><span class="p">:</span><span class="w"> </span><span class="kp">&amp;</span><span class="kt">str</span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nb">Result</span><span class="o">&lt;</span><span class="nb">String</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">   </span><span class="kd">let</span><span class="w"> </span><span class="n">tempdir</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TempDir</span><span class="p">::</span><span class="n">new_in</span><span class="p">(</span><span class="s">&quot;.&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;debcargo&quot;</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
<span class="w">   </span><span class="kd">let</span><span class="w"> </span><span class="n">repo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Repository</span><span class="p">::</span><span class="n">clone</span><span class="p">(</span><span class="n">repo_url</span><span class="p">,</span><span class="w"> </span><span class="n">tempdir</span><span class="p">.</span><span class="n">path</span><span class="p">())</span><span class="o">?</span><span class="p">;</span>

<span class="w">   </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">revwalker</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">repo</span><span class="p">.</span><span class="n">revwalk</span><span class="p">()</span><span class="o">?</span><span class="p">;</span>
<span class="w">   </span><span class="n">revwalker</span><span class="p">.</span><span class="n">push_head</span><span class="p">()</span><span class="o">?</span><span class="p">;</span>

<span class="w">   </span><span class="c1">// Get the latest and first commit id. This is bit ugly</span>
<span class="w">   </span><span class="kd">let</span><span class="w"> </span><span class="n">latest_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">revwalker</span><span class="p">.</span><span class="n">next</span><span class="p">().</span><span class="n">unwrap</span><span class="p">()</span><span class="o">?</span><span class="p">;</span>
<span class="w">   </span><span class="kd">let</span><span class="w"> </span><span class="n">first_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">revwalker</span><span class="p">.</span><span class="n">last</span><span class="p">().</span><span class="n">unwrap</span><span class="p">()</span><span class="o">?</span><span class="p">;</span><span class="w"> </span><span class="c1">// revwalker ends here is consumed by last</span>

<span class="w">   </span><span class="kd">let</span><span class="w"> </span><span class="n">first_commit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">repo</span><span class="p">.</span><span class="n">find_commit</span><span class="p">(</span><span class="n">first_id</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
<span class="w">   </span><span class="kd">let</span><span class="w"> </span><span class="n">latest_commit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">repo</span><span class="p">.</span><span class="n">find_commit</span><span class="p">(</span><span class="n">latest_id</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>

<span class="w">   </span><span class="kd">let</span><span class="w"> </span><span class="n">first_year</span><span class="w"> </span><span class="o">=</span>
<span class="w">       </span><span class="n">DateTime</span><span class="p">::</span><span class="o">&lt;</span><span class="n">Utc</span><span class="o">&gt;</span><span class="p">::</span><span class="n">from_utc</span><span class="p">(</span>
<span class="w">               </span><span class="n">NaiveDateTime</span><span class="p">::</span><span class="n">from_timestamp</span><span class="p">(</span><span class="n">first_commit</span><span class="p">.</span><span class="n">time</span><span class="p">().</span><span class="n">seconds</span><span class="p">(),</span><span class="w"> </span><span class="mi">0</span><span class="p">),</span>
<span class="w">               </span><span class="n">Utc</span><span class="p">).</span><span class="n">year</span><span class="p">();</span>

<span class="w">   </span><span class="kd">let</span><span class="w"> </span><span class="n">latest_year</span><span class="w"> </span><span class="o">=</span>
<span class="w">       </span><span class="n">DateTime</span><span class="p">::</span><span class="o">&lt;</span><span class="n">Utc</span><span class="o">&gt;</span><span class="p">::</span><span class="n">from_utc</span><span class="p">(</span>
<span class="w">             </span><span class="n">NaiveDateTime</span><span class="p">::</span><span class="n">from_timestamp</span><span class="p">(</span><span class="n">latest_commit</span><span class="p">.</span><span class="n">time</span><span class="p">().</span><span class="n">seconds</span><span class="p">(),</span><span class="w"> </span><span class="mi">0</span><span class="p">),</span>
<span class="w">             </span><span class="n">Utc</span><span class="p">).</span><span class="n">year</span><span class="p">();</span>

<span class="w">   </span><span class="kd">let</span><span class="w"> </span><span class="n">notice</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">match</span><span class="w"> </span><span class="n">first_year</span><span class="p">.</span><span class="n">cmp</span><span class="p">(</span><span class="o">&amp;</span><span class="n">latest_year</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">       </span><span class="n">Ordering</span><span class="p">::</span><span class="n">Equal</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="fm">format!</span><span class="p">(</span><span class="s">&quot;{}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">first_year</span><span class="p">),</span>
<span class="w">       </span><span class="n">_</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="fm">format!</span><span class="p">(</span><span class="s">&quot;{}-{},&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">first_year</span><span class="p">,</span><span class="w"> </span><span class="n">latest_year</span><span class="p">),</span>
<span class="w">   </span><span class="p">};</span>

<span class="w">   </span><span class="nb">Ok</span><span class="p">(</span><span class="n">notice</span><span class="p">)</span>
<span class="p">}</span>
</pre></div><dl class="docutils"><dt>So here is what I'm doing</dt><dd><ol class="first last arabic simple"><li>Use <cite>git2::Repository::clone</cite> to clone the given URL. We are thus avoiding exec of <em>git clone</em> command.</li><li>Get a revision walker object. <cite>git2::RevWalk</cite> implements <cite>Iterator</cite> trait and allows walking through the git history. This is what we are using to avoid exec of <em>git log</em> command.</li><li><cite>revwalker.push_head()</cite> is important because we want to tell revwalker from where we want to walk the history. In this case we are asking it to walk history from repository HEAD. Without this line next line will not work. (Learned it in hard way :-) ).</li><li>Then we extract <cite>git2::Oid</cite> which is we can say similar to commit hash and can be used to lookup a particular commit. We take latest commit hash using <cite>RevWalk::next</cite> call and the first commit using <cite>Revwalk::last</cite>, note the order this is because <cite>Revwalk::last</cite> consumes the revwalker so doing it in reverse order will make borrow checker unhappy :-). This replaces exec of <cite>head -n1</cite> command.</li><li>Look up the <cite>git2::Commit</cite> objects using <cite>git2::Repository::find_commit</cite></li><li>Then convert the <cite>git2::Time</cite> to <cite>chrono::DateTime</cite> and take out the years.</li></ol></dd></dl><p>After this change I found an obvious error which went unnoticed in previous version, that is if there was no <em>repository</em> key in Cargo.toml. When there was no repo URL <em>git clone</em> exec did not error out and our shell commands happily extracted year from the <em>debcargo</em> repository!. Well since I was testing code from <em>debcargo</em> repository It never failed, but when I executed from non-git repository folder git threw an error but that was <em>git log</em> and not <em>git clone</em>. This error was spotted right away because git2 threw me an error that I gave it empty URL.</p><p>When it comes to performance I see that debcargo is faster compared to previous version. This makes sense because previously it was doing 5 fork and exec system calls and now that is avoided.</p></div><div id="footer"><p><italic>Tagged as: git, rust, subprocess, </italic></p></section></div><hr><div id="footer"> Site Proudly powered by <a href="http://getpelican.com/">Pelican</a></div></body></html>