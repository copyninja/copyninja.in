<!DOCTYPE html><html lang="en"><head><link href="https://fonts.googleapis.com/css?family=Cantarell" rel="stylesheet"><title>Disabling Lockdown Mode with Secure Boot on Distro Kernel</title><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1"><link href="https://copyninja.in/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Random Ramblings Full Atom Feed"><link href="https://copyninja.in/feeds/{slug}.atom.xml" type="application/atom+xml" rel="alternate" title="Random Ramblings Categories Atom Feed"><link rel="stylesheet" type="text/css" href="/theme/css/pygments.css"><link rel="stylesheet" type="text/css" href="/theme/css/default.css"><meta name="tags" content="debian"><meta name="tags" content="systemd"><meta name="tags" content="secureboot"><meta name="tags" content="lockdown"></head><body><div id="header" class="body"><div id="navigation"> | <a href="https://copyninja.in">Home</a> | | <a href="https://copyninja.in/about">About</a> | | <a href="https://copyninja.in/contact">Contact</a> | | <a href="https://copyninja.in/categories.html">Categories</a> | | <a href="https://copyninja.in/tags.html">Tags</a> | </div><h1><a href="https://copyninja.in/blog/disable_lockdown_on_distro_kernel.html">Disabling Lockdown Mode with Secure Boot on Distro Kernel</a></h1></div><div id="content"><section id="content" class="body"><footer class="post-info"><p> Posted on Sep 26, 2024 By copyninja under devops </p></abbr></footer><div class="entry-content"><p>In my <a class="reference external" href="https://copyninja.in/blog/enable_secureboot_ukify.html">previous post</a>, I mentioned that Lockdown mode is activated when Secure Boot is enabled. One way to override this was to use a self-compiled upstream kernel. However, sometimes we might want to use the distribution kernel itself. This post explains how to disable lockdown mode while keeping Secure Boot enabled with a distribution kernel.</p><div class="section" id="understanding-secure-boot-detection"><h2>Understanding Secure Boot Detection</h2><p>To begin, we need to understand how the kernel detects if Secure Boot is enabled. This is done by the <em>efi_get_secureboot</em> function, as shown in the image below:</p><img alt="Secure Boot status check" class="align-center" src="https://copyninja.in/images/secureboot_code.png"></div><div class="section" id="disabling-kernel-lockdown"><h2>Disabling Kernel Lockdown</h2><p>The kernel code uses the value of MokSBStateRT to identify the Secure Boot state, assuming that Secure Boot can only be enabled via shim. This assumption holds true when using the Microsoft certificate for signature validation (as Microsoft currently only signs shim). However, if we're using our own keys, we don't need shim and can sign the bootloader ourselves. In this case, the Secure Boot state of the system doesn't need to be tied to the MokSBStateRT variable.</p><p>To disable kernel lockdown, we need to set the UEFI runtime variable <em>MokSBStateRT</em>. This essentially tricks the kernel into thinking Secure Boot is disabled when it's actually enabled. This is achieved using a UEFI <em>initializing</em> driver.</p><p>The code for this was written by an anonymous colleague who also assisted me with various configuration guidance for setting up UKI and Secure Boot on my system. The code is available <a class="reference external" href="https://codeberg.org/scarletstorm/lockdown-disable/src/branch/main">here</a>.</p></div><div class="section" id="implementation"><h2>Implementation</h2><p>Detailed instructions for compiling and deploying the code are provided in the repository, so I won't repeat them here.</p></div><div class="section" id="results"><h2>Results</h2><p>I've tested this method with the default distribution kernel on my Debian unstable system, and it successfully disables lockdown while maintaining Secure Boot integrity. See the screenshot below for confirmation:</p><img alt="Distribution kernel lockdown disabled" class="align-center" src="https://copyninja.in/images/distro_kernel_lockdown.png"></div></div><div id="footer"><p><italic>Tagged as: debian, lockdown, secureboot, systemd, </italic></p></section></div><hr><div id="footer"> Site Proudly powered by <a href="http://getpelican.com/">Pelican</a></div></body></html>