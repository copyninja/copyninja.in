<!DOCTYPE html><html lang="en"><head><link href="https://fonts.googleapis.com/css?family=Cantarell" rel="stylesheet"><title>Managing Virtual Network Devices with systemd-networkd</title><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1"><link href="https://copyninja.in/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Random Ramblings Full Atom Feed"><link href="https://copyninja.in/feeds/{slug}.atom.xml" type="application/atom+xml" rel="alternate" title="Random Ramblings Categories Atom Feed"><link rel="stylesheet" type="text/css" href="/theme/css/pygments.css"><link rel="stylesheet" type="text/css" href="/theme/css/default.css"><meta name="tags" content="systemd-networkd"><meta name="tags" content="systemd"><meta name="tags" content="networking"></head><body><div id="header" class="body"><div id="navigation"> | <a href="https://copyninja.in">Home</a> | | <a href="https://copyninja.in/about">About</a> | | <a href="https://copyninja.in/contact">Contact</a> | | <a href="https://copyninja.in/categories.html">Categories</a> | | <a href="https://copyninja.in/tags.html">Tags</a> | </div><h1><a href="https://copyninja.in/blog/systemd-networkd-networking.html">Managing Virtual Network Devices with systemd-networkd</a></h1></div><div id="content"><section id="content" class="body"><footer class="post-info"><p> Posted on Jan 10, 2016 By copyninja under devops </p></abbr></footer><div class="entry-content"><p>I've been using bridge networking and tap networking for containers and virtual machines on my system. Configuration for bridge network which I use to connect containers was configured using <em>/etc/network/interfaces</em> file as shown below.</p><div class="highlight"><pre><span></span>auto natbr0
iface natbr0 inet static
   address 172.16.10.1
   netmask 255.255.255.0
   pre-up brctl addbr natbr0
   post-down brctl delbr natbr0
   post-down sysctl net.ipv4.ip_forward=0
   post-down sysctl net.ipv6.conf.all.forwarding=0
   post-up sysctl net.ipv4.ip_forward=1
   post-up sysctl net.ipv6.conf.all.forwarding=1
   post-up iptables -A POSTROUTING -t mangle -p udp --dport bootpc -s 172.16.0.0/16 -j CHECKSUM --checksum-fill
   pre-down iptables -D POSTROUTING -t mangle -p udp --dport bootpc -s 172.16.0.0/16 -j CHECKSUM --checksum-fill
</pre></div><p>Basically I setup masquerading and IP forwarding when network comes up using this, so all my containers and virtual machines can access internet.</p><p>This can be simply done using systemd-networkd with couple of lines, yes couple of lines. For this to work first you need to enable systemd-networkd.</p><div class="highlight"><pre><span></span>systemctl<span class="w"> </span><span class="nb">enable</span><span class="w"> </span>systemd-networkd.service
</pre></div><p>Now I need to write 2 configuration file for the above bridge interface under <em>/etc/systemd/network</em>. One file is <em>natbr0.netdev</em> which configures the bridge and the <em>natbr0.network</em> which configures IP address and other stuff for the bridge interface.</p><div class="highlight"><pre><span></span><span class="c1">#natbr0.netdev</span>
<span class="k">[NetDev]</span>
<span class="na">Description</span><span class="o">=</span><span class="s">Bridge interface for containers/vms</span>
<span class="na">Name</span><span class="o">=</span><span class="s">natbr0</span>
<span class="na">Kind</span><span class="o">=</span><span class="s">bridge</span>
</pre></div><div class="highlight"><pre><span></span><span class="c1">#natbr0.network</span>
<span class="k">[Match]</span>
<span class="na">Name</span><span class="o">=</span><span class="s">natbr0</span>

<span class="k">[Network]</span>
<span class="na">Description</span><span class="o">=</span><span class="s">IP configuration for natbr0</span>
<span class="na">Address</span><span class="o">=</span><span class="s">172.16.10.1/16</span>
<span class="na">IPForward</span><span class="o">=</span><span class="s">yes</span>
<span class="na">IPMasquerade</span><span class="o">=</span><span class="s">yes</span>
</pre></div><p>The <em>IPForward</em> in above configuration is actually redundant, when I set <em>IPMasquerade</em> it automatically enables IPForward. So these configuration is equivalent of what I did in my <em>interfaces</em> file. It also avoids me doing additional <em>iptables</em> usage to add masquerading rules. This pretty much simplifies handling of virtual network devices.</p><p>There are many other things which can you do with systemd-networkd, like running a DHCPServer on the interface and many other things. I suggest you to read manual pages on <em>systemd.network(5)</em> and <em>systemd.netdev(5)</em>.</p><p>systemd-networkd allows you configure all type of virtual networking devices and actual network interfaces. I've not myself used it to handle actual network interfaces yet.</p></div><div id="footer"><p><italic>Tagged as: networking, systemd, systemd-networkd, </italic></p></section></div><hr><div id="footer"> Site Proudly powered by <a href="http://getpelican.com/">Pelican</a></div></body></html>