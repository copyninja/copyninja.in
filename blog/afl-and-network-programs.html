<!DOCTYPE html><html lang="en"><head><link href="https://fonts.googleapis.com/css?family=Cantarell" rel="stylesheet"><title>Tips for fuzzing network programs with AFL</title><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1"><link href="https://copyninja.in/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Random Ramblings Full Atom Feed"><link href="https://copyninja.in/feeds/{slug}.atom.xml" type="application/atom+xml" rel="alternate" title="Random Ramblings Categories Atom Feed"><link rel="stylesheet" type="text/css" href="/theme/css/pygments.css"><link rel="stylesheet" type="text/css" href="/theme/css/default.css"><meta name="tags" content="AFL"><meta name="tags" content="fuzzing"><meta name="tags" content="preeny"><meta name="tags" content="security"></head><body><div id="header" class="body"><div id="navigation"> | <a href="https://copyninja.in">Home</a> | | <a href="https://copyninja.in/about">About</a> | | <a href="https://copyninja.in/contact">Contact</a> | | <a href="https://copyninja.in/categories.html">Categories</a> | | <a href="https://copyninja.in/tags.html">Tags</a> | </div><h1><a href="https://copyninja.in/blog/afl-and-network-programs.html">Tips for fuzzing network programs with AFL</a></h1></div><div id="content"><section id="content" class="body"><footer class="post-info"><p> Posted on May 07, 2017 By copyninja under security </p></abbr></footer><div class="entry-content"><p>Fuzzing is method of producing random malformed inputs for a software and observe the software behavior. If a software crashes then there is a bug and it can have security implications. Fuzzing has gained a lot of interest now a days, especially with automated tools like American Fuzzy Lop (AFL) which can easily help you to fuzz the program and record inputs which causes crash in the software.</p><p>American Fuzzy Lop is a file based fuzzer which feeds input to program via standard input. Using it with network program like server's or clients is not possible in the original state. There is a <a class="reference external" href="https://github.com/jdbirdwell/afl">version</a> of AFL with patches to allow it fuzz network programs, but this patch is not merged upstream and I do not know if it ever makes into upstream or not. Also the above repository contains version 1.9 which is older compared to currently released versions.</p><p>There is another method for fuzzing network program using AFL with help of <em>LD_PRELOAD</em> tricks. <a class="reference external" href="https://github.com/zardus/preeny">preeny</a> is a project which provides library which when used with LD_PRELOAD can desocket the network program and make it read from <em>stdin</em>.</p><p>There is this best tutorial from <a class="reference external" href="https://lolware.net/2015/04/28/nginx-fuzzing.html">LoLWare</a> which talks about fuzzing Nginx with <em>preeny</em> and AFL. There is a best AFL workflow by <a class="reference external" href="https://foxglovesecurity.com/2016/03/15/fuzzing-workflows-a-fuzz-job-from-start-to-finish/">Foxglove Security</a> which gives start to finish details about how to use AFL and its companion tool to do fuzzing. So I'm not going to talk about any steps of fuzzing in this post instead I'm going to list down my observations on changes that needs to be done to get clean fuzzing with AFL and preeny.</p><ol class="arabic simple"><li>desock.so provided by preeny works only with <em>read</em> and <em>write</em> (or rather other system call does not work with stdin) system calls and hence you need to make sure you replace any reference to <em>send</em>, <em>sendto</em>, <em>recv</em> and <em>recvfrom</em> with <em>read</em> and <em>write</em> system calls respectively. Without this change program will not read input provided by AFL on standard input.</li><li>If your network program is using forking or threading model make sure to remove all those and make it plain simple program which receives request and sends out response. Basically you are testing the ability of program to handle malformed input so we need very minimum logic to make program do what it is supposed to do when AFL runs it.</li><li>If you are using infinite loop like all normal programs replace the infinite loop with below mentioned AFL macro and use <em>afl-clang-fast</em> to compile it. This speeds up the testing as AFL will run the job <cite>n</cite> times before discarding the current fork and doing a fresh fork. After all fork is costly affair.</li></ol><div class="highlight"><pre><span></span><span class="k">while</span><span class="p">(</span><span class="n">__AFL_LOOP</span><span class="p">(</span><span class="mi">1000</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="c1">// Change 1000 with iteration count</span>
<span class="w">             </span><span class="c1">// your logic here</span>
<span class="p">}</span>
</pre></div><p>With above modification I could fuzz a server program talking binary protocol and another one talking textual protocol. In both case I used <em>Wireshark</em> capture to get the packet extract raw content and feed it as input to AFL.</p><p>I was successful in finding crashes which are exploitable in case of textual protocol program than in binary protocol case. In case of binary protocol AFL could not easily find new paths which probably is because of bad inputs I provided. I will continue to do more experiment with binary protocol case and provide my findings as new updates here.</p><p>If you have anything more to add do share with me :-). Happy fuzzing!.</p></div><div id="footer"><p><italic>Tagged as: AFL, fuzzing, preeny, security, </italic></p></section></div><hr><div id="footer"> Site Proudly powered by <a href="http://getpelican.com/">Pelican</a></div></body></html>