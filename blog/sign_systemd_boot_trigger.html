<!DOCTYPE html><html lang="en"><head><link href="https://fonts.googleapis.com/css?family=Cantarell" rel="stylesheet"><title>Signing the systemd-boot on Upgrade Using Dpkg Triggers</title><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1"><link href="https://copyninja.in/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Random Ramblings Full Atom Feed"><link href="https://copyninja.in/feeds/{slug}.atom.xml" type="application/atom+xml" rel="alternate" title="Random Ramblings Categories Atom Feed"><link rel="stylesheet" type="text/css" href="/theme/css/pygments.css"><link rel="stylesheet" type="text/css" href="/theme/css/default.css"><meta name="tags" content="systemd"><meta name="tags" content="dpkg"><meta name="tags" content="triggers"><meta name="tags" content="uefi"><meta name="tags" content="debian"></head><body><div id="header" class="body"><div id="navigation"> | <a href="https://copyninja.in">Home</a> | | <a href="https://copyninja.in/about">About</a> | | <a href="https://copyninja.in/contact">Contact</a> | | <a href="https://copyninja.in/categories.html">Categories</a> | | <a href="https://copyninja.in/tags.html">Tags</a> | </div><h1><a href="https://copyninja.in/blog/sign_systemd_boot_trigger.html">Signing the systemd-boot on Upgrade Using Dpkg Triggers</a></h1></div><div id="content"><section id="content" class="body"><footer class="post-info"><p> Posted on Sep 29, 2024 By copyninja under devops </p></abbr></footer><div class="entry-content"><p>In my previous post on <a class="reference external" href="https://copyninja.in/blog/enable_secureboot_ukify.html">enabling SecureBoot</a>, I mentioned that one pending improvement was signing the <em>systemd-boot</em> EFI binary with my keys on every upgrade. In this post, we'll explore the implementation of this process using dpkg triggers.</p><p>For an excellent introduction to dpkg triggers, refer to this <a class="reference external" href="https://web.archive.org/web/20111022012105/http://www.seanius.net/blog/2009/09/dpkg-triggers-howto/">archived blog post</a>. The source code mentioned in that post can be downloaded from <a class="reference external" href="https://alioth-archive.debian.org/git/users/seanius/dpkg-triggers-example.git.tar.xz">alioth archive</a>.</p><p>From <em>/usr/share/doc/dpkg/spec/triggers.txt</em>, triggers are described as follows:</p><blockquote><em>A dpkg trigger is a facility that allows events caused by one package but of interest to another package to be recorded and aggregated, and processed later by the interested package. This feature simplifies various registration and system-update tasks and reduces duplication of processing.</em></blockquote><p>To implement this, we create a custom package with a single script that signs the <em>systemd-boot</em> EFI binary using our key. The script is as simple as:</p><div class="highlight"><pre><span></span><span class="ch">#!/bin/bash</span>

<span class="nb">set</span><span class="w"> </span>-e

<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Signing the new systemd-bootx64.efi&quot;</span>
sbsign<span class="w"> </span>--key<span class="w"> </span>/etc/secureboot/db.key<span class="w"> </span>--cert<span class="w"> </span>/etc/secureboot/db.crt<span class="w"> </span><span class="se">\</span>
<span class="w">       </span>/usr/lib/systemd/boot/efi/systemd-bootx64.efi

<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Invoking bootctl install to copy stuff&quot;</span>
bootctl<span class="w"> </span>install
</pre></div><p>Invoking <em>bootctl install</em> is optional if we have enabled <em>systemd-boot-update.service</em>, which will update the signed bootloader on the next boot.</p><p>We need to have a <em>triggers</em> file under the <em>debian/</em> folder of the package, which declares its interest in modifications to the path <em>/usr/lib/systemd/boot/efi/systemd-bootx64.efi</em>. The trigger file looks like this:</p><div class="highlight"><pre><span></span># trigger 1 interest on systemd-bootx64.efi
interest-noawait /usr/lib/systemd/boot/efi/systemd-bootx64.efi
</pre></div><p>You can read about various directives and their meanings that can be used in the <em>triggers</em> file in the <em>deb-triggers</em> man page.</p><p>Once we build and install the package, this request is added to <em>/var/lib/dpkg/triggers/File</em>. See the screenshot below after installation of our package:</p><img alt="installed trigger" class="align-center" src="https://copyninja.in/images/trigger_install.png"><p>To test the functionality, I performed a re-installation of the <em>systemd-boot-efi</em> package, which provides the EFI binary for <em>systemd-boot</em>, using the following command:</p><div class="highlight"><pre><span></span>sudo<span class="w"> </span>apt<span class="w"> </span>install<span class="w"> </span>--reinstall<span class="w"> </span>systemd-boot-efi
</pre></div><p>During installation, you can see the debug message being printed in the screenshot below:</p><img alt="systemd-boot-signer triggered" class="align-center" src="https://copyninja.in/images/systemd_boot_sign_triggered.png"><p>To test the <em>systemd-boot-update.service</em>, I commented out the <em>bootctl install</em> line from the above script, performed a reinstallation, and restarted the <em>systemd-boot-update.service</em>. Checking the log, I saw the following:</p><div class="highlight"><pre><span></span>Sep 29 13:42:51 chamunda systemd[1]: Stopping systemd-boot-update.service - Automatic Boot Loader Update...
Sep 29 13:42:51 chamunda systemd[1]: Starting systemd-boot-update.service - Automatic Boot Loader Update...
Sep 29 13:42:51 chamunda bootctl[1801516]: Skipping &quot;/efi/EFI/systemd/systemd-bootx64.efi&quot;, same boot loader version in place already.
Sep 29 13:42:51 chamunda bootctl[1801516]: Skipping &quot;/efi/EFI/BOOT/BOOTX64.EFI&quot;, same boot loader version in place already.
Sep 29 13:42:51 chamunda bootctl[1801516]: Skipping &quot;/efi/EFI/BOOT/BOOTX64.EFI&quot;, same boot loader version in place already.
Sep 29 13:42:51 chamunda systemd[1]: Finished systemd-boot-update.service - Automatic Boot Loader Update.
Sep 29 13:43:37 chamunda systemd[1]: systemd-boot-update.service: Deactivated successfully.
Sep 29 13:43:37 chamunda systemd[1]: Stopped systemd-boot-update.service - Automatic Boot Loader Update.
Sep 29 13:43:37 chamunda systemd[1]: Stopping systemd-boot-update.service - Automatic Boot Loader Update...
</pre></div><p>Indeed, the service attempted to copy the bootloader but did not do so because there was no actual update to the binary; it was just a reinstallation trigger.</p><p>The complete code for this package can be found <a class="reference external" href="https://github.com/copyninja/systemd-boot-signer">here</a>.</p><p>With this post the entire series on using UKI to Secureboot with Debian comes to an end. Happy hacking!.</p></div><div id="footer"><p><italic>Tagged as: debian, dpkg, systemd, triggers, uefi, </italic></p></section></div><hr><div id="footer"> Site Proudly powered by <a href="http://getpelican.com/">Pelican</a></div></body></html>