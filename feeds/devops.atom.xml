<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom"><title>Random Ramblings - devops</title><link href="https://copyninja.in/" rel="alternate"/><link href="https://copyninja.in/feeds/devops.atom.xml" rel="self"/><id>https://copyninja.in/</id><updated>2024-09-29T13:08:00+05:30</updated><subtitle>Random thoughts shooting out of volatile mind</subtitle><entry><title>Signing the systemd-boot on Upgrade Using Dpkg Triggers</title><link href="https://copyninja.in/blog/sign_systemd_boot_trigger.html" rel="alternate"/><published>2024-09-29T13:08:00+05:30</published><updated>2024-09-29T13:08:00+05:30</updated><author><name>copyninja</name></author><id>tag:copyninja.in,2024-09-29:/blog/sign_systemd_boot_trigger.html</id><summary type="html">&lt;p class="first last"&gt;This post discusses signing the systemd-boot EFI binary on upgrade using
the dpkg trigger mechanism.&lt;/p&gt;
</summary><content type="html">&lt;p&gt;In my previous post on &lt;a class="reference external" href="https://copyninja.in/blog/enable_secureboot_ukify.html"&gt;enabling SecureBoot&lt;/a&gt;, I mentioned that one
pending improvement was signing the &lt;em&gt;systemd-boot&lt;/em&gt; EFI binary with my keys on
every upgrade. In this post, we'll explore the implementation of this process using
dpkg triggers.&lt;/p&gt;
&lt;p&gt;For an excellent introduction to dpkg triggers, refer to this &lt;a class="reference external" href="https://web.archive.org/web/20111022012105/http://www.seanius.net/blog/2009/09/dpkg-triggers-howto/"&gt;archived blog post&lt;/a&gt;.
The source code mentioned in that post can be downloaded from &lt;a class="reference external" href="https://alioth-archive.debian.org/git/users/seanius/dpkg-triggers-example.git.tar.xz"&gt;alioth archive&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;From &lt;em&gt;/usr/share/doc/dpkg/spec/triggers.txt&lt;/em&gt;, triggers are described as follows:&lt;/p&gt;
&lt;blockquote&gt;
&lt;em&gt;A dpkg trigger is a facility that allows events caused by one package
but of interest to another package to be recorded and aggregated, and
processed later by the interested package. This feature simplifies
various registration and system-update tasks and reduces duplication
of processing.&lt;/em&gt;&lt;/blockquote&gt;
&lt;p&gt;To implement this, we create a custom package with a single script that signs the
&lt;em&gt;systemd-boot&lt;/em&gt; EFI binary using our key. The script is as simple as:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="ch"&gt;#!/bin/bash&lt;/span&gt;

&lt;span class="nb"&gt;set&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;-e

&lt;span class="nb"&gt;echo&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;Signing the new systemd-bootx64.efi&amp;quot;&lt;/span&gt;
sbsign&lt;span class="w"&gt; &lt;/span&gt;--key&lt;span class="w"&gt; &lt;/span&gt;/etc/secureboot/db.key&lt;span class="w"&gt; &lt;/span&gt;--cert&lt;span class="w"&gt; &lt;/span&gt;/etc/secureboot/db.crt&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="se"&gt;\&lt;/span&gt;
&lt;span class="w"&gt;       &lt;/span&gt;/usr/lib/systemd/boot/efi/systemd-bootx64.efi

&lt;span class="nb"&gt;echo&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;Invoking bootctl install to copy stuff&amp;quot;&lt;/span&gt;
bootctl&lt;span class="w"&gt; &lt;/span&gt;install
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Invoking &lt;em&gt;bootctl install&lt;/em&gt; is optional if we have enabled
&lt;em&gt;systemd-boot-update.service&lt;/em&gt;, which will update the signed bootloader on the next
boot.&lt;/p&gt;
&lt;p&gt;We need to have a &lt;em&gt;triggers&lt;/em&gt; file under the &lt;em&gt;debian/&lt;/em&gt; folder of the package, which
declares its interest in modifications to the path
&lt;em&gt;/usr/lib/systemd/boot/efi/systemd-bootx64.efi&lt;/em&gt;. The trigger file looks like this:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;# trigger 1 interest on systemd-bootx64.efi
interest-noawait /usr/lib/systemd/boot/efi/systemd-bootx64.efi
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;You can read about various directives and their meanings that can be used in
the &lt;em&gt;triggers&lt;/em&gt; file in the &lt;em&gt;deb-triggers&lt;/em&gt; man page.&lt;/p&gt;
&lt;p&gt;Once we build and install the package, this request is added to
&lt;em&gt;/var/lib/dpkg/triggers/File&lt;/em&gt;. See the screenshot below after installation of
our package:&lt;/p&gt;
&lt;img alt="installed trigger" class="align-center" src="https://copyninja.in/images/trigger_install.png" /&gt;
&lt;p&gt;To test the functionality, I performed a re-installation of the &lt;em&gt;systemd-boot-efi&lt;/em&gt;
package, which provides the EFI binary for &lt;em&gt;systemd-boot&lt;/em&gt;, using the following command:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo&lt;span class="w"&gt; &lt;/span&gt;apt&lt;span class="w"&gt; &lt;/span&gt;install&lt;span class="w"&gt; &lt;/span&gt;--reinstall&lt;span class="w"&gt; &lt;/span&gt;systemd-boot-efi
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;During installation, you can see the debug message being printed in the screenshot below:&lt;/p&gt;
&lt;img alt="systemd-boot-signer triggered" class="align-center" src="https://copyninja.in/images/systemd_boot_sign_triggered.png" /&gt;
&lt;p&gt;To test the &lt;em&gt;systemd-boot-update.service&lt;/em&gt;, I commented out the &lt;em&gt;bootctl install&lt;/em&gt; line
from the above script, performed a reinstallation, and restarted the
&lt;em&gt;systemd-boot-update.service&lt;/em&gt;. Checking the log, I saw the following:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;Sep 29 13:42:51 chamunda systemd[1]: Stopping systemd-boot-update.service - Automatic Boot Loader Update...
Sep 29 13:42:51 chamunda systemd[1]: Starting systemd-boot-update.service - Automatic Boot Loader Update...
Sep 29 13:42:51 chamunda bootctl[1801516]: Skipping &amp;quot;/efi/EFI/systemd/systemd-bootx64.efi&amp;quot;, same boot loader version in place already.
Sep 29 13:42:51 chamunda bootctl[1801516]: Skipping &amp;quot;/efi/EFI/BOOT/BOOTX64.EFI&amp;quot;, same boot loader version in place already.
Sep 29 13:42:51 chamunda bootctl[1801516]: Skipping &amp;quot;/efi/EFI/BOOT/BOOTX64.EFI&amp;quot;, same boot loader version in place already.
Sep 29 13:42:51 chamunda systemd[1]: Finished systemd-boot-update.service - Automatic Boot Loader Update.
Sep 29 13:43:37 chamunda systemd[1]: systemd-boot-update.service: Deactivated successfully.
Sep 29 13:43:37 chamunda systemd[1]: Stopped systemd-boot-update.service - Automatic Boot Loader Update.
Sep 29 13:43:37 chamunda systemd[1]: Stopping systemd-boot-update.service - Automatic Boot Loader Update...
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Indeed, the service attempted to copy the bootloader but did not do so because
there was no actual update to the binary; it was just a reinstallation trigger.&lt;/p&gt;
&lt;p&gt;The complete code for this package can be found &lt;a class="reference external" href="https://github.com/copyninja/systemd-boot-signer"&gt;here&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;With this post the entire series on using  UKI to Secureboot with Debian comes
to an end. Happy hacking!.&lt;/p&gt;
</content><category term="devops"/><category term="systemd"/><category term="dpkg"/><category term="triggers"/><category term="uefi"/><category term="debian"/></entry><entry><title>Disabling Lockdown Mode with Secure Boot on Distro Kernel</title><link href="https://copyninja.in/blog/disable_lockdown_on_distro_kernel.html" rel="alternate"/><published>2024-09-26T22:13:00+05:30</published><updated>2024-09-26T22:13:00+05:30</updated><author><name>copyninja</name></author><id>tag:copyninja.in,2024-09-26:/blog/disable_lockdown_on_distro_kernel.html</id><summary type="html">&lt;p class="first last"&gt;This post discusses a method to disable kernel lockdown mode on a
distribution kernel when Secure Boot is enabled.&lt;/p&gt;
</summary><content type="html">&lt;p&gt;In my &lt;a class="reference external" href="https://copyninja.in/blog/enable_secureboot_ukify.html"&gt;previous post&lt;/a&gt;,
I mentioned that Lockdown mode is activated when Secure Boot is enabled. One way
to override this was to use a self-compiled upstream kernel. However, sometimes
we might want to use the distribution kernel itself. This post explains how to
disable lockdown mode while keeping Secure Boot enabled with a distribution
kernel.&lt;/p&gt;
&lt;div class="section" id="understanding-secure-boot-detection"&gt;
&lt;h2&gt;Understanding Secure Boot Detection&lt;/h2&gt;
&lt;p&gt;To begin, we need to understand how the kernel detects if Secure Boot is
enabled. This is done by the &lt;em&gt;efi_get_secureboot&lt;/em&gt; function, as shown in the
image below:&lt;/p&gt;
&lt;img alt="Secure Boot status check" class="align-center" src="https://copyninja.in/images/secureboot_code.png" /&gt;
&lt;/div&gt;
&lt;div class="section" id="disabling-kernel-lockdown"&gt;
&lt;h2&gt;Disabling Kernel Lockdown&lt;/h2&gt;
&lt;p&gt;The kernel code uses the value of MokSBStateRT to identify the Secure Boot state,
assuming that Secure Boot can only be enabled via shim. This assumption holds true
when using the Microsoft certificate for signature validation (as Microsoft currently
only signs shim). However, if we're using our own keys, we don't need shim and can
sign the bootloader ourselves. In this case, the Secure Boot state of the system
doesn't need to be tied to the MokSBStateRT variable.&lt;/p&gt;
&lt;p&gt;To disable kernel lockdown, we need to set the UEFI runtime variable
&lt;em&gt;MokSBStateRT&lt;/em&gt;. This essentially tricks the kernel into thinking Secure Boot is
disabled when it's actually enabled. This is achieved using a UEFI
&lt;em&gt;initializing&lt;/em&gt; driver.&lt;/p&gt;
&lt;p&gt;The code for this was written by an anonymous colleague who also assisted me
with various configuration guidance for setting up UKI and Secure Boot on my
system. The code is available &lt;a class="reference external" href="https://codeberg.org/scarletstorm/lockdown-disable/src/branch/main"&gt;here&lt;/a&gt;.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="implementation"&gt;
&lt;h2&gt;Implementation&lt;/h2&gt;
&lt;p&gt;Detailed instructions for compiling and deploying the code are provided in the
repository, so I won't repeat them here.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="results"&gt;
&lt;h2&gt;Results&lt;/h2&gt;
&lt;p&gt;I've tested this method with the default distribution kernel on my Debian
unstable system, and it successfully disables lockdown while maintaining Secure
Boot integrity. See the screenshot below for confirmation:&lt;/p&gt;
&lt;img alt="Distribution kernel lockdown disabled" class="align-center" src="https://copyninja.in/images/distro_kernel_lockdown.png" /&gt;
&lt;/div&gt;
</content><category term="devops"/><category term="debian"/><category term="systemd"/><category term="secureboot"/><category term="lockdown"/></entry><entry><title>Note to Self: Enabling Secure Boot with UKI on Debian</title><link href="https://copyninja.in/blog/enable_secureboot_ukify.html" rel="alternate"/><published>2024-09-24T11:30:00+05:30</published><updated>2024-09-24T11:30:00+05:30</updated><author><name>copyninja</name></author><id>tag:copyninja.in,2024-09-24:/blog/enable_secureboot_ukify.html</id><summary type="html">&lt;p class="first last"&gt;This post explains how to enable self-signed Secure Boot with Unified
Kernel Image (UKI) on Debian.&lt;/p&gt;
</summary><content type="html">&lt;div class="admonition note"&gt;
&lt;p class="first admonition-title"&gt;Note&lt;/p&gt;
&lt;p class="last"&gt;&lt;em&gt;This post is a continuation of my previous article on enabling the Unified
Kernel Image (UKI) on Debian.&lt;/em&gt;&lt;/p&gt;
&lt;/div&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;&lt;a class="reference external" href="https://copyninja.in/blog/enable_ukify_debian.html"&gt;Enabling Unified Kernel Image on Debian&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;In this guide, we'll implement Secure Boot by taking full control of the device,
removing preinstalled keys, and installing our own. For a comprehensive overview
of the benefits and process, refer to this excellent post from &lt;a class="reference external" href="https://www.rodsbooks.com/efi-bootloaders/controlling-sb.html"&gt;rodsbooks&lt;/a&gt;.&lt;/p&gt;
&lt;div class="section" id="key-components"&gt;
&lt;h2&gt;Key Components&lt;/h2&gt;
&lt;p&gt;To implement Secure Boot, we need three essential keys:&lt;/p&gt;
&lt;ol class="arabic simple"&gt;
&lt;li&gt;Platform Key (PK): The top-level key in Secure Boot, typically provided by
the motherboard manufacturer. We'll replace the vendor-supplied PK with our
own for complete control.&lt;/li&gt;
&lt;li&gt;Key Exchange Key (KEK): Used to sign updates for the Signatures Database and
Forbidden Signatures Database.&lt;/li&gt;
&lt;li&gt;Database Key (DB): Used to sign or verify binaries (bootloaders, boot
managers, shells, drivers, etc.).&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;There's also a Forbidden Signature Key (dbx), which is the opposite of the DB
key. We won't be generating this key in this guide.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="preparing-for-key-enrollment"&gt;
&lt;h2&gt;Preparing for Key Enrollment&lt;/h2&gt;
&lt;p&gt;Before enrolling our keys, we need to put the device in &lt;em&gt;Secure Boot Setup
Mode&lt;/em&gt;. Verify the status using the &lt;tt class="docutils literal"&gt;bootctl status&lt;/tt&gt; command. You should see
output similar to the following image:&lt;/p&gt;
&lt;img alt="UEFI Setup mode" class="align-center" src="https://copyninja.in/images/uefi_setupmode.png" /&gt;
&lt;/div&gt;
&lt;div class="section" id="generating-keys"&gt;
&lt;h2&gt;Generating Keys&lt;/h2&gt;
&lt;p&gt;Follow &lt;a class="reference external" href="https://wiki.archlinux.org/title/Unified_Extensible_Firmware_Interface/Secure_Boot#Creating_keys"&gt;these instructions from the Arch Wiki&lt;/a&gt;
to generate the keys manually. You'll need the &lt;tt class="docutils literal"&gt;efitools&lt;/tt&gt; and &lt;tt class="docutils literal"&gt;openssl&lt;/tt&gt;
packages. I recommend using &lt;tt class="docutils literal"&gt;rsa:2048&lt;/tt&gt; as the key size for better
compatibility with older firmware.&lt;/p&gt;
&lt;p&gt;After generating the keys, copy all &lt;tt class="docutils literal"&gt;.auth&lt;/tt&gt; files to the
&lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;/efi/loader/keys/&amp;lt;hostname&amp;gt;/&lt;/span&gt;&lt;/tt&gt; folder. For example:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;❯&lt;span class="w"&gt; &lt;/span&gt;sudo&lt;span class="w"&gt; &lt;/span&gt;ls&lt;span class="w"&gt; &lt;/span&gt;/efi/loader/keys/chamunda
db.auth&lt;span class="w"&gt;  &lt;/span&gt;KEK.auth&lt;span class="w"&gt;  &lt;/span&gt;PK.auth
&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;div class="section" id="signing-the-bootloader"&gt;
&lt;h2&gt;Signing the Bootloader&lt;/h2&gt;
&lt;p&gt;Sign the &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;systemd-boot&lt;/span&gt;&lt;/tt&gt; bootloader with your new keys:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sbsign&lt;span class="w"&gt; &lt;/span&gt;--key&lt;span class="w"&gt; &lt;/span&gt;&amp;lt;path-to&lt;span class="w"&gt; &lt;/span&gt;db.key&amp;gt;&lt;span class="w"&gt; &lt;/span&gt;--cert&lt;span class="w"&gt; &lt;/span&gt;&amp;lt;path-to&lt;span class="w"&gt; &lt;/span&gt;db.crt&amp;gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="se"&gt;\&lt;/span&gt;
&lt;span class="w"&gt;   &lt;/span&gt;/usr/lib/systemd/boot/efi/systemd-bootx64.efi
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Install the signed bootloader using &lt;tt class="docutils literal"&gt;bootctl install&lt;/tt&gt;. The output should
resemble this:&lt;/p&gt;
&lt;img alt="bootctl install" class="align-center" src="https://copyninja.in/images/bootctl_install.png" /&gt;
&lt;div class="admonition note"&gt;
&lt;p class="first admonition-title"&gt;Note&lt;/p&gt;
&lt;p class="last"&gt;&lt;em&gt;If you encounter warnings about mount options, update your fstab with the
`umask=0077` option for the EFI partition.&lt;/em&gt;&lt;/p&gt;
&lt;/div&gt;
&lt;p&gt;Verify the signature using &lt;tt class="docutils literal"&gt;sbsign &lt;span class="pre"&gt;--verify&lt;/span&gt;&lt;/tt&gt;:&lt;/p&gt;
&lt;img alt="sbsign verify" class="align-center" src="https://copyninja.in/images/sbsign_verify_systemdboot.png" /&gt;
&lt;/div&gt;
&lt;div class="section" id="configuring-uki-for-secure-boot"&gt;
&lt;h2&gt;Configuring UKI for Secure Boot&lt;/h2&gt;
&lt;p&gt;Update the &lt;tt class="docutils literal"&gt;/etc/kernel/uki.conf&lt;/tt&gt; file with your key paths:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="na"&gt;SecureBootPrivateKey&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s"&gt;/path/to/db.key&lt;/span&gt;
&lt;span class="na"&gt;SecureBootCertificate&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s"&gt;/path/to/db.crt&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;div class="section" id="signing-the-uki-image"&gt;
&lt;h2&gt;Signing the UKI Image&lt;/h2&gt;
&lt;p&gt;On Debian, use &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;dpkg-reconfigure&lt;/span&gt;&lt;/tt&gt; to sign the UKI image for each kernel:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo&lt;span class="w"&gt; &lt;/span&gt;dpkg-reconfigure&lt;span class="w"&gt; &lt;/span&gt;linux-image-&lt;span class="k"&gt;$(&lt;/span&gt;uname&lt;span class="w"&gt; &lt;/span&gt;-r&lt;span class="k"&gt;)&lt;/span&gt;
&lt;span class="c1"&gt;# Repeat for other kernel versions if necessary&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;You should see output similar to this:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo&lt;span class="w"&gt; &lt;/span&gt;dpkg-reconfigure&lt;span class="w"&gt; &lt;/span&gt;linux-image-&lt;span class="k"&gt;$(&lt;/span&gt;uname&lt;span class="w"&gt; &lt;/span&gt;-r&lt;span class="k"&gt;)&lt;/span&gt;
/etc/kernel/postinst.d/dracut:
dracut:&lt;span class="w"&gt; &lt;/span&gt;Generating&lt;span class="w"&gt; &lt;/span&gt;/boot/initrd.img-6.10.9-amd64
Updating&lt;span class="w"&gt; &lt;/span&gt;kernel&lt;span class="w"&gt; &lt;/span&gt;version&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;6&lt;/span&gt;.10.9-amd64&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="k"&gt;in&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;systemd-boot...
Signing&lt;span class="w"&gt; &lt;/span&gt;unsigned&lt;span class="w"&gt; &lt;/span&gt;original&lt;span class="w"&gt; &lt;/span&gt;image
Using&lt;span class="w"&gt; &lt;/span&gt;config&lt;span class="w"&gt; &lt;/span&gt;file:&lt;span class="w"&gt; &lt;/span&gt;/etc/kernel/uki.conf
+&lt;span class="w"&gt; &lt;/span&gt;sbverify&lt;span class="w"&gt; &lt;/span&gt;--list&lt;span class="w"&gt; &lt;/span&gt;/boot/vmlinuz-6.10.9-amd64
+&lt;span class="w"&gt; &lt;/span&gt;sbsign&lt;span class="w"&gt; &lt;/span&gt;--key&lt;span class="w"&gt; &lt;/span&gt;/home/vasudeva.sk/Documents/personal/secureboot/db.key&lt;span class="w"&gt; &lt;/span&gt;--cert&lt;span class="w"&gt; &lt;/span&gt;/home/vasudeva.sk/Documents/personal/secureboot/db.crt&lt;span class="w"&gt; &lt;/span&gt;/tmp/ukicc7vcxhy&lt;span class="w"&gt; &lt;/span&gt;--output&lt;span class="w"&gt; &lt;/span&gt;/tmp/kernel-install.staging.QLeGLn/uki.efi
Wrote&lt;span class="w"&gt; &lt;/span&gt;signed&lt;span class="w"&gt; &lt;/span&gt;/tmp/kernel-install.staging.QLeGLn/uki.efi
/etc/kernel/postinst.d/zz-systemd-boot:
Installing&lt;span class="w"&gt; &lt;/span&gt;kernel&lt;span class="w"&gt; &lt;/span&gt;version&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;6&lt;/span&gt;.10.9-amd64&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="k"&gt;in&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;systemd-boot...
Signing&lt;span class="w"&gt; &lt;/span&gt;unsigned&lt;span class="w"&gt; &lt;/span&gt;original&lt;span class="w"&gt; &lt;/span&gt;image
Using&lt;span class="w"&gt; &lt;/span&gt;config&lt;span class="w"&gt; &lt;/span&gt;file:&lt;span class="w"&gt; &lt;/span&gt;/etc/kernel/uki.conf
+&lt;span class="w"&gt; &lt;/span&gt;sbverify&lt;span class="w"&gt; &lt;/span&gt;--list&lt;span class="w"&gt; &lt;/span&gt;/boot/vmlinuz-6.10.9-amd64
+&lt;span class="w"&gt; &lt;/span&gt;sbsign&lt;span class="w"&gt; &lt;/span&gt;--key&lt;span class="w"&gt; &lt;/span&gt;/home/vasudeva.sk/Documents/personal/secureboot/db.key&lt;span class="w"&gt; &lt;/span&gt;--cert&lt;span class="w"&gt; &lt;/span&gt;/home/vasudeva.sk/Documents/personal/secureboot/db.crt&lt;span class="w"&gt; &lt;/span&gt;/tmp/ukit7r1hzep&lt;span class="w"&gt; &lt;/span&gt;--output&lt;span class="w"&gt; &lt;/span&gt;/tmp/kernel-install.staging.dWVt5s/uki.efi
Wrote&lt;span class="w"&gt; &lt;/span&gt;signed&lt;span class="w"&gt; &lt;/span&gt;/tmp/kernel-install.staging.dWVt5s/uki.efi
&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;div class="section" id="enrolling-keys-in-firmware"&gt;
&lt;h2&gt;Enrolling Keys in Firmware&lt;/h2&gt;
&lt;p&gt;Use &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;systemd-boot&lt;/span&gt;&lt;/tt&gt; to enroll your keys:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;systemctl&lt;span class="w"&gt; &lt;/span&gt;reboot&lt;span class="w"&gt; &lt;/span&gt;--boot-loader-menu&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="m"&gt;0&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Select the enroll option with your hostname in the &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;systemd-boot&lt;/span&gt;&lt;/tt&gt; menu.&lt;/p&gt;
&lt;p&gt;After key enrollment, the system will reboot into the newly signed kernel.
Verify with &lt;tt class="docutils literal"&gt;bootctl&lt;/tt&gt;:&lt;/p&gt;
&lt;img alt="uefi enabled" class="align-center" src="https://copyninja.in/images/bootctl_uefi_enabled.png" /&gt;
&lt;/div&gt;
&lt;div class="section" id="dealing-with-lockdown-mode"&gt;
&lt;h2&gt;Dealing with Lockdown Mode&lt;/h2&gt;
&lt;p&gt;Secure Boot enables lockdown mode on distro-shipped kernels, which restricts
certain features like kprobes/BPF and DKMS drivers. To avoid this, consider
compiling the upstream kernel directly, which doesn't enable lockdown mode by
default.&lt;/p&gt;
&lt;p&gt;As Linus Torvalds has stated, &amp;quot;there is no reason to tie Secure Boot to lockdown
LSM.&amp;quot; You can read more about &lt;a class="reference external" href="https://www.phoronix.com/news/UEFI-Kernel-Lockdown-Concerns"&gt;Torvalds' opinion on UEFI tied with lockdown&lt;/a&gt;.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="next-steps"&gt;
&lt;h2&gt;Next Steps&lt;/h2&gt;
&lt;p&gt;One thing that remains is automating the signing of systemd-boot on upgrade,
which is currently a manual process. I'm exploring dpkg triggers for achieving
this, and if I succeed, I will write a new post with details.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="acknowledgments"&gt;
&lt;h2&gt;Acknowledgments&lt;/h2&gt;
&lt;p&gt;Special thanks to my anonymous colleague who provided invaluable assistance
throughout this process.&lt;/p&gt;
&lt;/div&gt;
</content><category term="devops"/><category term="debian"/><category term="secureboot"/><category term="systemd"/><category term="uki"/></entry><entry><title>Note to Self: Enabling Unified Kernel Image on Debian</title><link href="https://copyninja.in/blog/enable_ukify_debian.html" rel="alternate"/><published>2024-09-19T11:40:00+05:30</published><updated>2024-09-19T11:40:00+05:30</updated><author><name>copyninja</name></author><id>tag:copyninja.in,2024-09-19:/blog/enable_ukify_debian.html</id><summary type="html">&lt;p class="first last"&gt;Enabling systemd-ukify based booting on Debian&lt;/p&gt;
</summary><content type="html">&lt;div class="admonition note"&gt;
&lt;p class="first admonition-title"&gt;Note&lt;/p&gt;
&lt;p class="last"&gt;&lt;em&gt;These steps may not work on your system if you are using the default Debian
installation. This guide assumes that your system is using systemd-boot as the
bootloader, which is explained in the post linked below.&lt;/em&gt;&lt;/p&gt;
&lt;/div&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;&lt;a class="reference external" href="https://copyninja.in/blog/live_install_debian.html"&gt;Install Debian from grml-liveboot&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;A unified kernel image (UKI) is a single executable that can be booted directly
from UEFI firmware or automatically sourced by bootloaders with little or no
configuration. It combines a UEFI boot stub program like
systemd-stub(7), a Linux kernel image, an initrd, and additional resources into
a single UEFI PE file.&lt;/p&gt;
&lt;p&gt;systemd-boot already provides a hook for kernel installation via
&lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;/etc/kernel/postinst.d/zz-systemd-boot&lt;/span&gt;&lt;/tt&gt;. We just need a couple of additional
configurations to generate the UKI image.&lt;/p&gt;
&lt;div class="section" id="installation-and-configuration"&gt;
&lt;h2&gt;Installation and Configuration&lt;/h2&gt;
&lt;ol class="arabic"&gt;
&lt;li&gt;&lt;p class="first"&gt;Install the &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;systemd-ukify&lt;/span&gt;&lt;/tt&gt; package:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo&lt;span class="w"&gt; &lt;/span&gt;apt-get&lt;span class="w"&gt; &lt;/span&gt;install&lt;span class="w"&gt; &lt;/span&gt;systemd-ukify
&lt;/pre&gt;&lt;/div&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p class="first"&gt;Create the following configuration in &lt;tt class="docutils literal"&gt;/etc/kernel/install.conf&lt;/tt&gt;:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="na"&gt;layout&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s"&gt;uki&lt;/span&gt;
&lt;span class="na"&gt;initrd_generator&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s"&gt;dracut&lt;/span&gt;
&lt;span class="na"&gt;uki_generator&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s"&gt;ukify&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;This configuration specifies how to generate the UKI image for the installed
kernel and which generator to use.&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p class="first"&gt;Define the kernel command line for the UKI image. Create &lt;tt class="docutils literal"&gt;/etc/kernel/uki.conf&lt;/tt&gt; with the following content:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="k"&gt;[UKI]&lt;/span&gt;
&lt;span class="na"&gt;Cmdline&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s"&gt;@/etc/kernel/cmdline&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;/div&gt;
&lt;div class="section" id="generating-the-uki-image"&gt;
&lt;h2&gt;Generating the UKI Image&lt;/h2&gt;
&lt;p&gt;To apply these changes, regenerate the UKI image for the currently running kernel:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo&lt;span class="w"&gt; &lt;/span&gt;dpkg-reconfigure&lt;span class="w"&gt; &lt;/span&gt;linux-image-&lt;span class="k"&gt;$(&lt;/span&gt;uname&lt;span class="w"&gt; &lt;/span&gt;-r&lt;span class="k"&gt;)&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;div class="section" id="verification"&gt;
&lt;h2&gt;Verification&lt;/h2&gt;
&lt;p&gt;Use the &lt;tt class="docutils literal"&gt;bootctl list&lt;/tt&gt; command to verify the presence of a &amp;quot;Type #2&amp;quot; entry for the current kernel. The output should look similar to this:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;bootctl list
      type: Boot Loader Specification Type #2 (.efi)
     title: Debian GNU/Linux trixie/sid (2d0080583f1a4127ac0b073b1a9d3e61-6.10.9-amd64.efi) (default) (selected)
        id: 2d0080583f1a4127ac0b073b1a9d3e61-6.10.9-amd64.efi
    source: /boot/efi/EFI/Linux/2d0080583f1a4127ac0b073b1a9d3e61-6.10.9-amd64.efi
  sort-key: debian
     linux: /boot/efi/EFI/Linux/2d0080583f1a4127ac0b073b1a9d3e61-6.10.9-amd64.efi
   options: systemd.gpt_auto=no quiet root=LABEL=root_disk ro systemd.machine_id=2d0080583f1a4127ac0b073b1a9d3e61

      type: Boot Loader Specification Type #2 (.efi)
     title: Debian GNU/Linux trixie/sid (2d0080583f1a4127ac0b073b1a9d3e61-6.10.7-amd64.efi)
        id: 2d0080583f1a4127ac0b073b1a9d3e61-6.10.7-amd64.efi
    source: /boot/efi/EFI/Linux/2d0080583f1a4127ac0b073b1a9d3e61-6.10.7-amd64.efi
  sort-key: debian
     linux: /boot/efi/EFI/Linux/2d0080583f1a4127ac0b073b1a9d3e61-6.10.7-amd64.efi
   options: systemd.gpt_auto=no quiet root=LABEL=root_disk ro systemd.machine_id=2d0080583f1a4127ac0b073b1a9d3e61

      type: Automatic
     title: Reboot Into Firmware Interface
        id: auto-reboot-to-firmware-setup
    source: /sys/firmware/efi/efivars/LoaderEntries-4a67b082-0a4c-41cf-b6c7-440b29bb8c4f
&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;div class="section" id="cleanup-and-reboot"&gt;
&lt;h2&gt;Cleanup and Reboot&lt;/h2&gt;
&lt;p&gt;Once the &amp;quot;Type #2&amp;quot; entries are generated, remove any &amp;quot;Type #1&amp;quot; entries using the &lt;tt class="docutils literal"&gt;bootctl unlink&lt;/tt&gt; command. After this, reboot your system to boot from the UKI-based image.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="future-considerations"&gt;
&lt;h2&gt;Future Considerations&lt;/h2&gt;
&lt;p&gt;The primary use case for a UKI image is secure boot. Signing the UKI image can also be configured in the settings above, but this guide does not cover that process as it requires setting up secure boot on your system.&lt;/p&gt;
&lt;/div&gt;
</content><category term="devops"/><category term="debian"/><category term="systemd"/><category term="ukify"/></entry><entry><title>Cloning a laptop over NVME TCP</title><link href="https://copyninja.in/blog/clone_laptop_nvmet.html" rel="alternate"/><published>2024-03-10T17:15:00+05:30</published><updated>2024-03-10T17:15:00+05:30</updated><author><name>copyninja</name></author><id>tag:copyninja.in,2024-03-10:/blog/clone_laptop_nvmet.html</id><summary type="html">&lt;p class="first last"&gt;Cloning old laptop over NVME TCP&lt;/p&gt;
</summary><content type="html">&lt;p&gt;Recently, I got a new laptop and had to set it up so I could start using it. But
I wasn't really in the mood to go through the same old steps which I had
explained in this &lt;a class="reference external" href="https://copyninja.in/blog/live_install_debian.html"&gt;post earlier&lt;/a&gt;. I was complaining about
this to my colleague, and there came the suggestion of why not copy the entire
disk to the new laptop. Though it sounded like an interesting idea to me, I had
my doubts, so here is what I told him in return.&lt;/p&gt;
&lt;ol class="arabic simple"&gt;
&lt;li&gt;I don't have the tools to open my old laptop and connect the new disk over
USB to my new laptop.&lt;/li&gt;
&lt;li&gt;I use full disk encryption, and my old laptop has a 512GB disk, whereas the
new laptop has a 1TB NVME, and I'm not so familiar with resizing LUKS.&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;He promptly suggested both could be done. For step 1, just expose the disk using
NVME over TCP and connect it over the network and do a full disk copy, and the
rest is pretty simple to achieve. In short, he suggested the following:&lt;/p&gt;
&lt;ol class="arabic simple"&gt;
&lt;li&gt;Export the disk using nvmet-tcp from the old laptop.&lt;/li&gt;
&lt;li&gt;Do a disk copy to the new laptop.&lt;/li&gt;
&lt;li&gt;Resize the partition to use the full 1TB.&lt;/li&gt;
&lt;li&gt;Resize LUKS.&lt;/li&gt;
&lt;li&gt;Finally, resize the BTRFS root disk.&lt;/li&gt;
&lt;/ol&gt;
&lt;div class="section" id="exporting-disk-over-nvme-tcp"&gt;
&lt;h2&gt;Exporting Disk over NVME TCP&lt;/h2&gt;
&lt;p&gt;The easiest way suggested by my colleague to do this is using
&lt;a class="reference external" href="https://www.freedesktop.org/software/systemd/man/latest/systemd-storagetm.service.html"&gt;systemd-storagetm.service&lt;/a&gt;.
This service can be invoked by simply booting into &lt;em&gt;storage-target-mode.target&lt;/em&gt;
by specifying &lt;em&gt;rd.systemd.unit=storage-target-mode.target&lt;/em&gt;. But he suggested not
to use this as I need to tweak the dracut initrd image to involve network
services as well as configuring WiFi from this mode is a painful thing to do.&lt;/p&gt;
&lt;p&gt;So alternatively, I simply booted both my laptops with GRML rescue CD. And the
following step was done to export the NVME disk on my current laptop using the
nvmet-tcp module of Linux:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;modprobe&lt;span class="w"&gt; &lt;/span&gt;nvmet-tcp
&lt;span class="nb"&gt;cd&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;/sys/kernel/config/nvmet
mkdir&lt;span class="w"&gt; &lt;/span&gt;ports/0
&lt;span class="nb"&gt;cd&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;ports/0
&lt;span class="nb"&gt;echo&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;ipv4&amp;quot;&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&amp;gt;&lt;span class="w"&gt; &lt;/span&gt;addr_adrfam
&lt;span class="nb"&gt;echo&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;0&lt;/span&gt;.0.0.0&lt;span class="w"&gt; &lt;/span&gt;&amp;gt;&lt;span class="w"&gt; &lt;/span&gt;addr_traaddr
&lt;span class="nb"&gt;echo&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;4420&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&amp;gt;&lt;span class="w"&gt; &lt;/span&gt;addr_trsvcid
&lt;span class="nb"&gt;echo&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;tcp&lt;span class="w"&gt; &lt;/span&gt;&amp;gt;&lt;span class="w"&gt; &lt;/span&gt;addr_trtype

&lt;span class="nb"&gt;cd&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;/sys/kernel/config/nvmet/subsystems
mkdir&lt;span class="w"&gt; &lt;/span&gt;testnqn
&lt;span class="nb"&gt;echo&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;1&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&amp;gt;testnqn/allow_any_host
mkdir&lt;span class="w"&gt; &lt;/span&gt;testnqn/namespaces/1

&lt;span class="nb"&gt;cd&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;testnqn
&lt;span class="c1"&gt;# replace the device name with the disk you want to export&lt;/span&gt;
&lt;span class="nb"&gt;echo&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;/dev/nvme0n1&amp;quot;&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&amp;gt;&lt;span class="w"&gt; &lt;/span&gt;namespaces/1/device_path
&lt;span class="nb"&gt;echo&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;1&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&amp;gt;&lt;span class="w"&gt; &lt;/span&gt;namespaces/1/enable

ln&lt;span class="w"&gt; &lt;/span&gt;-s&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;../../subsystems/testnqn&amp;quot;&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;/sys/kernel/config/nvmet/ports/0/subsystems/testnqn
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;These steps ensure that the device is now exported using NVME over TCP. The next
step is to detect this on the new laptop and connect the device:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;nvme&lt;span class="w"&gt; &lt;/span&gt;discover&lt;span class="w"&gt; &lt;/span&gt;-t&lt;span class="w"&gt; &lt;/span&gt;tcp&lt;span class="w"&gt; &lt;/span&gt;-a&lt;span class="w"&gt; &lt;/span&gt;&amp;lt;ip&amp;gt;&lt;span class="w"&gt; &lt;/span&gt;-s&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;4420&lt;/span&gt;
nvme&lt;span class="w"&gt; &lt;/span&gt;connectl-all&lt;span class="w"&gt; &lt;/span&gt;-t&lt;span class="w"&gt; &lt;/span&gt;tcp&lt;span class="w"&gt; &lt;/span&gt;-a&lt;span class="w"&gt; &lt;/span&gt;&amp;lt;&amp;gt;&lt;span class="w"&gt; &lt;/span&gt;-s&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;4420&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Finally, &lt;tt class="docutils literal"&gt;nvme list&lt;/tt&gt; shows the device which is connected to the new laptop,
and we can proceed with the next step, which is to do the disk copy.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="copying-the-disk"&gt;
&lt;h2&gt;Copying the Disk&lt;/h2&gt;
&lt;p&gt;I simply used the &lt;tt class="docutils literal"&gt;dd&lt;/tt&gt; command to copy the root disk to my new laptop. Since
the new laptop didn't have an Ethernet port, I had to rely only on WiFi, and it
took about 7 and a half hours to copy the entire 512GB to the new laptop. The
speed at which I was copying was about 18-20MB/s. The other option would have
been to create an initial partition and file system and do an rsync of the root
disk or use BTRFS itself for file system transfer.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;dd&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="k"&gt;if&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;/dev/nvme2n1&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nv"&gt;of&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;/dev/nvme0n1&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nv"&gt;status&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;progress&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nv"&gt;bs&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;40M
&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;div class="section" id="resizing-partition-and-luks-container"&gt;
&lt;h2&gt;Resizing Partition and LUKS Container&lt;/h2&gt;
&lt;p&gt;The final part was very easy. When I launched &lt;tt class="docutils literal"&gt;parted&lt;/tt&gt;, it detected that the
partition table does not match the disk size and asked if it can fix it, and I
said yes. Next, I had to install &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;cloud-guest-utils&lt;/span&gt;&lt;/tt&gt; to get &lt;tt class="docutils literal"&gt;growpart&lt;/tt&gt; to
fix the second partition, and the following command extended the partition to
the full 1TB:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;growpart&lt;span class="w"&gt; &lt;/span&gt;/dev/nvem0n1&lt;span class="w"&gt; &lt;/span&gt;p2
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Next, I used &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;cryptsetup-resize&lt;/span&gt;&lt;/tt&gt; to increase the LUKS container size.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;cryptsetup&lt;span class="w"&gt; &lt;/span&gt;luksOpen&lt;span class="w"&gt; &lt;/span&gt;/dev/nvme0n1p2&lt;span class="w"&gt; &lt;/span&gt;ENC
cryptsetup&lt;span class="w"&gt; &lt;/span&gt;resize&lt;span class="w"&gt; &lt;/span&gt;ENC
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Finally, I rebooted into the disk, and everything worked fine. After logging
into the system, I resized the BTRFS file system. BTRFS requires the system to
be mounted for resize, so I could not attempt it in live boot.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;btfs&lt;span class="w"&gt; &lt;/span&gt;fielsystem&lt;span class="w"&gt; &lt;/span&gt;resize&lt;span class="w"&gt; &lt;/span&gt;max&lt;span class="w"&gt; &lt;/span&gt;/
&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;div class="section" id="conclusion"&gt;
&lt;h2&gt;Conclusion&lt;/h2&gt;
&lt;p&gt;The only benefit of this entire process is that I have a new laptop, but I still
feel like I'm using my existing laptop. Typically, setting up a new laptop takes
about a week or two to completely get adjusted, but in this case, that entire
time is saved.&lt;/p&gt;
&lt;p&gt;An added benefit is that I learned how to export disks using NVME over TCP,
thanks to my colleague. This new knowledge adds to the value of the experience.&lt;/p&gt;
&lt;/div&gt;
</content><category term="devops"/><category term="debian"/><category term="nvmet"/><category term="clone"/></entry><entry><title>Using LUKS-Encrypted USB Stick with TPM2 Integration</title><link href="https://copyninja.in/blog/luks2_tpm_mount.html" rel="alternate"/><published>2023-07-09T13:17:00+05:30</published><updated>2023-07-09T13:17:00+05:30</updated><author><name>copyninja</name></author><id>tag:copyninja.in,2023-07-09:/blog/luks2_tpm_mount.html</id><summary type="html">&lt;p class="first last"&gt;Experimenting with systemd-cryptenroll to mount luks2 encrypted usb
device&lt;/p&gt;
</summary><content type="html">&lt;p&gt;I use a LUKS-encrypted USB stick to store my GPG and SSH keys, which acts as a
backup and portable key setup when working on different laptops. One
inconvenience with LUKS-encrypted USB sticks is that you need to enter the
password every time you want to mount the device, either through a Window
Manager like KDE or using the &lt;cite&gt;cryptsetup luksOpen&lt;/cite&gt; command. Fortunately, many
laptops nowadays come equipped with TPM2 modules, which can be utilized to
automatically decrypt the device and subsequently mount it. In this post, we'll
explore the usage of &lt;em&gt;systemd-cryptenroll&lt;/em&gt; for this purpose, along with udev
rules and a set of scripts to automate the mounting of the encrypted USB.&lt;/p&gt;
&lt;p&gt;First, ensure that your device has a TPM2 module. You can run the following
command to check:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo&lt;span class="w"&gt; &lt;/span&gt;journalctl&lt;span class="w"&gt; &lt;/span&gt;-k&lt;span class="w"&gt; &lt;/span&gt;--grep&lt;span class="o"&gt;=&lt;/span&gt;tpm2
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;The output should resemble the following:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;Jul&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;08&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;18&lt;/span&gt;:57:32&lt;span class="w"&gt; &lt;/span&gt;bhairava&lt;span class="w"&gt; &lt;/span&gt;kernel:&lt;span class="w"&gt; &lt;/span&gt;ACPI:&lt;span class="w"&gt; &lt;/span&gt;SSDT&lt;span class="w"&gt; &lt;/span&gt;0x00000000BBEFC000&lt;span class="w"&gt; &lt;/span&gt;0003C6&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;v02
LENOVO&lt;span class="w"&gt; &lt;/span&gt;Tpm2Tabl&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;00001000&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;INTL&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;20160422&lt;/span&gt;&lt;span class="o"&gt;)&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;Jul&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;08&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;18&lt;/span&gt;:57:32&lt;span class="w"&gt; &lt;/span&gt;bhairava&lt;span class="w"&gt; &lt;/span&gt;kernel:
ACPI:&lt;span class="w"&gt; &lt;/span&gt;TPM2&lt;span class="w"&gt; &lt;/span&gt;0x00000000BBEFB000&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;000034&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;v03&lt;span class="w"&gt; &lt;/span&gt;LENOVO&lt;span class="w"&gt; &lt;/span&gt;TP-R0D&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;00000830&lt;/span&gt;
PTEC&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;00000002&lt;/span&gt;&lt;span class="o"&gt;)&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;Jul&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;08&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;18&lt;/span&gt;:57:32&lt;span class="w"&gt; &lt;/span&gt;bhairava&lt;span class="w"&gt; &lt;/span&gt;kernel:&lt;span class="w"&gt; &lt;/span&gt;ACPI:&lt;span class="w"&gt; &lt;/span&gt;Reserving&lt;span class="w"&gt; &lt;/span&gt;TPM2&lt;span class="w"&gt; &lt;/span&gt;table
memory&lt;span class="w"&gt; &lt;/span&gt;at&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;[&lt;/span&gt;mem&lt;span class="w"&gt; &lt;/span&gt;0xbbefb000-0xbbefb033&lt;span class="o"&gt;]&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;You can also use the &lt;cite&gt;systemd-cryptenroll&lt;/cite&gt; command to check for the availability
of a TPM2 device on your laptop:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;systemd-cryptenroll&lt;span class="w"&gt; &lt;/span&gt;--tpm2-device&lt;span class="o"&gt;=&lt;/span&gt;list
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;The output will be something like following:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;blog&lt;span class="w"&gt; &lt;/span&gt;git:&lt;span class="o"&gt;(&lt;/span&gt;master&lt;span class="o"&gt;)&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;systemd-cryptenroll&lt;span class="w"&gt; &lt;/span&gt;--tpm2-device&lt;span class="o"&gt;=&lt;/span&gt;list
PATH&lt;span class="w"&gt;        &lt;/span&gt;DEVICE&lt;span class="w"&gt;      &lt;/span&gt;DRIVER
/dev/tpmrm0&lt;span class="w"&gt; &lt;/span&gt;MSFT0101:00&lt;span class="w"&gt; &lt;/span&gt;tpm_tis
➜&lt;span class="w"&gt;  &lt;/span&gt;blog&lt;span class="w"&gt; &lt;/span&gt;git:&lt;span class="o"&gt;(&lt;/span&gt;master&lt;span class="o"&gt;)&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Next, ensure that you have connected your encrypted USB device. Note that
&lt;cite&gt;systemd-cryptenroll&lt;/cite&gt; only works with LUKS2 and not LUKS1. If your device is
LUKS1-encrypted, you may encounter an error while enrolling the device,
complaining about the LUKS2 superblock not found.&lt;/p&gt;
&lt;p&gt;To determine if your device uses a LUKS1 header or LUKS2, use the &lt;cite&gt;cryptsetup
luksDump &amp;lt;device&amp;gt;&lt;/cite&gt; command. If it is LUKS1, the header will begin with:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;LUKS&lt;span class="w"&gt; &lt;/span&gt;header&lt;span class="w"&gt; &lt;/span&gt;information&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="k"&gt;for&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;/dev/sdb1

Version:&lt;span class="w"&gt;        &lt;/span&gt;&lt;span class="m"&gt;1&lt;/span&gt;
Cipher&lt;span class="w"&gt; &lt;/span&gt;name:&lt;span class="w"&gt;    &lt;/span&gt;aes
Cipher&lt;span class="w"&gt; &lt;/span&gt;mode:&lt;span class="w"&gt;    &lt;/span&gt;xts-plain64
Hash&lt;span class="w"&gt; &lt;/span&gt;spec:&lt;span class="w"&gt;      &lt;/span&gt;sha256
Payload&lt;span class="w"&gt; &lt;/span&gt;offset:&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;4096&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Converting from LUKS1 to LUKS2 is a simple process, but for safety, ensure that
you backup the header using the &lt;cite&gt;cryptsetup luksHeaderBackup&lt;/cite&gt; command. Once
backed up, use the following command to convert the header to LUKS2:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo&lt;span class="w"&gt; &lt;/span&gt;cryptsetup&lt;span class="w"&gt; &lt;/span&gt;convert&lt;span class="w"&gt; &lt;/span&gt;--type&lt;span class="w"&gt; &lt;/span&gt;luks2&lt;span class="w"&gt; &lt;/span&gt;/dev/sdb1
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;After conversion, the header will look like this:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;Version:&lt;span class="w"&gt;        &lt;/span&gt;&lt;span class="m"&gt;2&lt;/span&gt;
Epoch:&lt;span class="w"&gt;          &lt;/span&gt;&lt;span class="m"&gt;4&lt;/span&gt;
Metadata&lt;span class="w"&gt; &lt;/span&gt;area:&lt;span class="w"&gt;  &lt;/span&gt;&lt;span class="m"&gt;16384&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;[&lt;/span&gt;bytes&lt;span class="o"&gt;]&lt;/span&gt;
Keyslots&lt;span class="w"&gt; &lt;/span&gt;area:&lt;span class="w"&gt;  &lt;/span&gt;&lt;span class="m"&gt;2064384&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;[&lt;/span&gt;bytes&lt;span class="o"&gt;]&lt;/span&gt;
UUID:&lt;span class="w"&gt;           &lt;/span&gt;000b2670-be4a-41b4-98eb-9adbd12a7616
Label:&lt;span class="w"&gt;          &lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;no&lt;span class="w"&gt; &lt;/span&gt;label&lt;span class="o"&gt;)&lt;/span&gt;
Subsystem:&lt;span class="w"&gt;      &lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;no&lt;span class="w"&gt; &lt;/span&gt;subsystem&lt;span class="o"&gt;)&lt;/span&gt;
Flags:&lt;span class="w"&gt;          &lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;no&lt;span class="w"&gt; &lt;/span&gt;flags&lt;span class="o"&gt;)&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;The next step is to enroll the new LUKS key for the encrypted device using
&lt;cite&gt;systemd-cryptenroll&lt;/cite&gt;. Run the following command:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo&lt;span class="w"&gt; &lt;/span&gt;systemd-cryptenroll&lt;span class="w"&gt; &lt;/span&gt;--tpm2-device&lt;span class="o"&gt;=&lt;/span&gt;/dev/tpmrm0&lt;span class="w"&gt; &lt;/span&gt;--tpm2-pcrs&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;0+7&amp;quot;&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;/dev/sdb1
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;This command will prompt you to provide the existing key to unseal the device.
It will then add a new random key to the volume, allowing it to be unlocked in
addition to the existing keys. Additionally, it will bind this new key to PCRs 0
and 7, representing the system firmware and Secure Boot state.&lt;/p&gt;
&lt;p&gt;If there is only one TPM device on the system, you can use &lt;cite&gt;--tpm2-device=auto&lt;/cite&gt;
to automatically select the device. To confirm that the new key has been
enrolled, you can dump the LUKS configuration and look for a &lt;cite&gt;systemd-tpm2&lt;/cite&gt;
token entry, as well as an additional entry in the Keyslots section.&lt;/p&gt;
&lt;p&gt;To test the setup, you can use the &lt;cite&gt;/usr/lib/systemd/systemd-cryptsetup&lt;/cite&gt; command. Additionally, you can check if the device is unsealed by using &lt;cite&gt;lsblk&lt;/cite&gt;:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo&lt;span class="w"&gt; &lt;/span&gt;/usr/lib/systemd/systemd-cryptsetup&lt;span class="w"&gt; &lt;/span&gt;attach&lt;span class="w"&gt; &lt;/span&gt;GPG_USB&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;/dev/sdb1&amp;quot;&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;-&lt;span class="w"&gt; &lt;/span&gt;tpm2-device&lt;span class="o"&gt;=&lt;/span&gt;auto

lsblk
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;The &lt;cite&gt;lsblk&lt;/cite&gt; command should display the unsealed and mounted device, like this:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;NAME&lt;span class="w"&gt;        &lt;/span&gt;MAJ:MIN&lt;span class="w"&gt; &lt;/span&gt;RM&lt;span class="w"&gt;   &lt;/span&gt;SIZE&lt;span class="w"&gt; &lt;/span&gt;RO&lt;span class="w"&gt; &lt;/span&gt;TYPE&lt;span class="w"&gt;  &lt;/span&gt;MOUNTPOINTS
sda&lt;span class="w"&gt;           &lt;/span&gt;&lt;span class="m"&gt;8&lt;/span&gt;:0&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="m"&gt;0&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;223&lt;/span&gt;.6G&lt;span class="w"&gt;  &lt;/span&gt;&lt;span class="m"&gt;0&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;disk
├─sda1&lt;span class="w"&gt;        &lt;/span&gt;&lt;span class="m"&gt;8&lt;/span&gt;:1&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="m"&gt;0&lt;/span&gt;&lt;span class="w"&gt;   &lt;/span&gt;976M&lt;span class="w"&gt;  &lt;/span&gt;&lt;span class="m"&gt;0&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;part&lt;span class="w"&gt;  &lt;/span&gt;/boot/efi
└─sda2&lt;span class="w"&gt;        &lt;/span&gt;&lt;span class="m"&gt;8&lt;/span&gt;:2&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="m"&gt;0&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;222&lt;/span&gt;.6G&lt;span class="w"&gt;  &lt;/span&gt;&lt;span class="m"&gt;0&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;part
&lt;span class="w"&gt;  &lt;/span&gt;└─root&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="m"&gt;254&lt;/span&gt;:0&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="m"&gt;0&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;222&lt;/span&gt;.6G&lt;span class="w"&gt;  &lt;/span&gt;&lt;span class="m"&gt;0&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;crypt&lt;span class="w"&gt; &lt;/span&gt;/
sdb&lt;span class="w"&gt;           &lt;/span&gt;&lt;span class="m"&gt;8&lt;/span&gt;:16&lt;span class="w"&gt;   &lt;/span&gt;&lt;span class="m"&gt;1&lt;/span&gt;&lt;span class="w"&gt;   &lt;/span&gt;&lt;span class="m"&gt;7&lt;/span&gt;.5G&lt;span class="w"&gt;  &lt;/span&gt;&lt;span class="m"&gt;0&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;disk
└─sdb1&lt;span class="w"&gt;        &lt;/span&gt;&lt;span class="m"&gt;8&lt;/span&gt;:17&lt;span class="w"&gt;   &lt;/span&gt;&lt;span class="m"&gt;1&lt;/span&gt;&lt;span class="w"&gt;   &lt;/span&gt;&lt;span class="m"&gt;7&lt;/span&gt;.5G&lt;span class="w"&gt;  &lt;/span&gt;&lt;span class="m"&gt;0&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;part
&lt;span class="w"&gt;  &lt;/span&gt;└─GPG_USB&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;254&lt;/span&gt;:1&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="m"&gt;0&lt;/span&gt;&lt;span class="w"&gt;   &lt;/span&gt;&lt;span class="m"&gt;7&lt;/span&gt;.5G&lt;span class="w"&gt;  &lt;/span&gt;&lt;span class="m"&gt;0&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;crypt&lt;span class="w"&gt; &lt;/span&gt;/media/vasudev/GPG_USB
&lt;/pre&gt;&lt;/div&gt;
&lt;div class="section" id="auto-mounting-the-device"&gt;
&lt;h2&gt;Auto Mounting the device&lt;/h2&gt;
&lt;p&gt;Now that we have solved the initial problem of unsealing the USB device using
TPM2 instead of manually entering the key, the next step is to automatically
mount the device upon insertion and remove the mapping when the device is
removed. This can be achieved using the following udev rules:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;ACTION==&amp;quot;add&amp;quot;, KERNEL==&amp;quot;sd*&amp;quot;, ENV{DEVTYPE}==&amp;quot;partition&amp;quot;, ENV{ID_BUS}==&amp;quot;usb&amp;quot;, ENV{SYSTEMD_WANTS}=&amp;quot;mount-gpg-usb@$env{DEVNAME}.service&amp;quot;
ACTION==&amp;quot;remove&amp;quot;, KERNEL==&amp;quot;sd*&amp;quot;, ENV{DEVTYPE}==&amp;quot;partition&amp;quot;, ENV{ID_BUS}==&amp;quot;usb&amp;quot;, RUN+=&amp;quot;/usr/local/bin/umount_enc_usb.sh &amp;#39;%E{ID_FS_UUID}&amp;#39;&amp;quot;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;When a device is added, a systemd service is triggered to mount the device at a
specific location. Initially, I used a script with the &lt;cite&gt;RUN&lt;/cite&gt; directive, but it
resulted in an exit code of &lt;cite&gt;32&lt;/cite&gt;. This might be due to &lt;cite&gt;systemd-cryptsetup&lt;/cite&gt;
taking some time to return, causing udev to time out. To address this, I opted
to use a systemd service instead.&lt;/p&gt;
&lt;p&gt;For device removal, even though the physical device is no longer present, the
mapping may still remain, causing issues upon reinsertion. To resolve this, I
created a script to close the luks mapping upon device removal.&lt;/p&gt;
&lt;p&gt;Below are the systemd service and script files:&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;mount_enc_usb.sh:&lt;/strong&gt;&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="ch"&gt;#!/bin/bash&lt;/span&gt;
&lt;span class="nb"&gt;set&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;-x

&lt;span class="k"&gt;if&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;[[&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;&lt;/span&gt;&lt;span class="nv"&gt;$#&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;-ne&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;1&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;]]&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="k"&gt;then&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="nb"&gt;echo&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;&lt;/span&gt;&lt;span class="k"&gt;$(&lt;/span&gt;basename&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nv"&gt;$0&lt;/span&gt;&lt;span class="k"&gt;)&lt;/span&gt;&lt;span class="s2"&gt; &amp;lt;device&amp;gt;&amp;quot;&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="nb"&gt;exit&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;1&lt;/span&gt;
&lt;span class="k"&gt;fi&lt;/span&gt;

&lt;span class="nv"&gt;device_uuid&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;&lt;/span&gt;&lt;span class="k"&gt;$(&lt;/span&gt;blkid&lt;span class="w"&gt; &lt;/span&gt;--output&lt;span class="w"&gt; &lt;/span&gt;udev&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nv"&gt;$1&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;|&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;grep&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nv"&gt;ID_FS_UUID&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;|&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;cut&lt;span class="w"&gt; &lt;/span&gt;-d&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;-f2&lt;span class="k"&gt;)&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;&lt;/span&gt;
&lt;span class="k"&gt;if&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;[[&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;&lt;/span&gt;&lt;span class="nv"&gt;$device_uuid&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;==&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;000b2670-be4a-41b4-98eb-9adbd12a7616&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;]]&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="k"&gt;then&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="c1"&gt;# Found our device, let&amp;#39;s trigger systemd-cryptsetup&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;/usr/lib/systemd/systemd-cryptsetup&lt;span class="w"&gt; &lt;/span&gt;attach&lt;span class="w"&gt; &lt;/span&gt;GPG_USB&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;&lt;/span&gt;&lt;span class="nv"&gt;$1&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;-&lt;span class="w"&gt; &lt;/span&gt;tpm2-device&lt;span class="o"&gt;=&lt;/span&gt;auto
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="o"&gt;[[&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;-d&lt;span class="w"&gt; &lt;/span&gt;/media/vasudev/GPG_USB&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;]]&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;||&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;mkdir&lt;span class="w"&gt; &lt;/span&gt;-p&lt;span class="w"&gt; &lt;/span&gt;/media/vasudev/GPG_USB/&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;&amp;amp;&amp;amp;&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;chown&lt;span class="w"&gt; &lt;/span&gt;vasudev:vasudev&lt;span class="w"&gt; &lt;/span&gt;/media/vasudev/GPG_USB&lt;span class="o"&gt;)&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;mount&lt;span class="w"&gt; &lt;/span&gt;/dev/mapper/GPG_USB&lt;span class="w"&gt; &lt;/span&gt;/media/vasudev/GPG_USB
&lt;span class="k"&gt;else&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="nb"&gt;echo&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;Not the interested device. Ignoring.&amp;quot;&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="nb"&gt;exit&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;0&lt;/span&gt;
&lt;span class="k"&gt;fi&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;strong&gt;umount_enc_usb.sh:&lt;/strong&gt;&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="ch"&gt;#!/bin/bash&lt;/span&gt;
&lt;span class="k"&gt;if&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;[[&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;&lt;/span&gt;&lt;span class="nv"&gt;$#&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;-ne&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;1&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;]]&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="k"&gt;then&lt;/span&gt;
&lt;span class="w"&gt;  &lt;/span&gt;&lt;span class="nb"&gt;echo&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;&lt;/span&gt;&lt;span class="k"&gt;$(&lt;/span&gt;basename&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nv"&gt;$0&lt;/span&gt;&lt;span class="k"&gt;)&lt;/span&gt;&lt;span class="s2"&gt; &amp;lt;fsuuid&amp;gt;&amp;quot;&lt;/span&gt;
&lt;span class="w"&gt;  &lt;/span&gt;&lt;span class="nb"&gt;exit&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;1&lt;/span&gt;
&lt;span class="k"&gt;fi&lt;/span&gt;

&lt;span class="k"&gt;if&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;[[&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;&lt;/span&gt;&lt;span class="nv"&gt;$1&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;==&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;000b2670-be4a-41b4-98eb-9adbd12a7616&amp;quot;&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;]]&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="k"&gt;then&lt;/span&gt;
&lt;span class="w"&gt;  &lt;/span&gt;&lt;span class="c1"&gt;# Our device is removed, let&amp;#39;s close the luks mapping&lt;/span&gt;
&lt;span class="w"&gt;  &lt;/span&gt;&lt;span class="o"&gt;[[&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;-e&lt;span class="w"&gt; &lt;/span&gt;/dev/mapper/GPG_USB&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;]]&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;&amp;amp;&amp;amp;&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;cryptsetup&lt;span class="w"&gt; &lt;/span&gt;luksClose&lt;span class="w"&gt; &lt;/span&gt;/dev/mapper/GPG_USB
&lt;span class="k"&gt;else&lt;/span&gt;
&lt;span class="w"&gt;  &lt;/span&gt;&lt;span class="nb"&gt;echo&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;Not our device.&amp;quot;&lt;/span&gt;
&lt;span class="w"&gt;  &lt;/span&gt;&lt;span class="nb"&gt;exit&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;0&lt;/span&gt;
&lt;span class="k"&gt;fi&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;strong&gt;mount-gpg-usb&amp;#64;.service:&lt;/strong&gt;&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="k"&gt;[Unit]&lt;/span&gt;
&lt;span class="na"&gt;Description&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s"&gt;Mount the encrypted USB device service&lt;/span&gt;

&lt;span class="k"&gt;[Service]&lt;/span&gt;
&lt;span class="na"&gt;Type&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s"&gt;simple&lt;/span&gt;
&lt;span class="na"&gt;ExecStart&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s"&gt;/usr/local/bin/mount_enc_usb.sh&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;With this setup, plugging in the USB device will automatically unseal and mount
it, and upon removal, the luks mapping will be closed.&lt;/p&gt;
&lt;div class="admonition note"&gt;
&lt;p class="first admonition-title"&gt;Note&lt;/p&gt;
&lt;p class="last"&gt;This can be even done for LUKS2 encrypted root disk but will need some
tweaking in initramfs.&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class="section" id="references"&gt;
&lt;h2&gt;References&lt;/h2&gt;
&lt;ol class="arabic simple"&gt;
&lt;li&gt;&lt;a class="reference external" href="https://wiki.archlinux.org/title/Trusted_Platform_Module"&gt;Trusted Platform Module Arch Wiki&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a class="reference external" href="https://www.reddit.com/r/openSUSE/comments/oydwuz/unable_to_use_systemdcryptenroll/"&gt;systemd-cryptenroll issue with LUKS1&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a class="reference external" href="https://www.baeldung.com/linux/shell-run-script-usb-plugged"&gt;Execute shell script when USB Device is plugged&lt;/a&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;/div&gt;
</content><category term="devops"/><category term="systemd-cryptenroll"/><category term="systemd"/><category term="tpm2"/><category term="luks2"/><category term="mount"/></entry><entry><title>Notes: Experimenting with ZRAM and Memory Over commit</title><link href="https://copyninja.in/blog/zram_memory_overcommit.html" rel="alternate"/><published>2023-06-20T10:55:00+05:30</published><updated>2023-06-20T10:55:00+05:30</updated><author><name>copyninja</name></author><id>tag:copyninja.in,2023-06-20:/blog/zram_memory_overcommit.html</id><summary type="html">&lt;p class="first last"&gt;Notes on experiments with ZRAM and vm.overcommit_memory&lt;/p&gt;
</summary><content type="html">&lt;div class="section" id="introduction"&gt;
&lt;h2&gt;Introduction&lt;/h2&gt;
&lt;p&gt;The ZRAM module in the Linux kernel creates a memory-backed block device that
stores its content in a compressed format. It offers users the choice of
compression algorithms such as lz4, zstd, or lzo. These algorithms differ in
compression ratio and speed, with zstd providing the best compression but being
slower, while lz4 offers higher speed but lower compression.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="using-zram-as-swap"&gt;
&lt;h2&gt;Using ZRAM as Swap&lt;/h2&gt;
&lt;p&gt;One interesting use case for ZRAM is utilizing it as swap space in the system.
There are two utilities available for configuring ZRAM as swap: zram-tools and
systemd-zram-generator. However, Debian Bullseye lacks systemd-zram-generator,
making zram-tools the only option for Bullseye users. While it's possible to use
systemd-zram-generator by self-compiling or via cargo, I preferred using tools
available in the distribution repository due to my restricted environment.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="installation"&gt;
&lt;h2&gt;Installation&lt;/h2&gt;
&lt;p&gt;The installation process is straightforward. Simply execute the following command:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;apt-get&lt;span class="w"&gt; &lt;/span&gt;install&lt;span class="w"&gt; &lt;/span&gt;zram-tools
&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;div class="section" id="configuration"&gt;
&lt;h2&gt;Configuration&lt;/h2&gt;
&lt;p&gt;The configuration involves modifying a simple shell script file
&lt;em&gt;/etc/default/zramswap&lt;/em&gt; sourced by the &lt;cite&gt;/usr/bin/zramswap&lt;/cite&gt; script. Here's an
example of the configuration I used:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="c1"&gt;# Compression algorithm selection&lt;/span&gt;
&lt;span class="c1"&gt;# Speed: lz4 &amp;gt; zstd &amp;gt; lzo&lt;/span&gt;
&lt;span class="c1"&gt;# Compression: zstd &amp;gt; lzo &amp;gt; lz4&lt;/span&gt;
&lt;span class="c1"&gt;# This is not inclusive of all the algorithms available in the latest kernels&lt;/span&gt;
&lt;span class="c1"&gt;# See /sys/block/zram0/comp_algorithm (when the zram module is loaded) to check&lt;/span&gt;
&lt;span class="c1"&gt;# the currently set and available algorithms for your kernel [1]&lt;/span&gt;
&lt;span class="c1"&gt;# [1]  https://github.com/torvalds/linux/blob/master/Documentation/blockdev/zram.txt#L86&lt;/span&gt;
&lt;span class="nv"&gt;ALGO&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;zstd

&lt;span class="c1"&gt;# Specifies the amount of RAM that should be used for zram&lt;/span&gt;
&lt;span class="c1"&gt;# based on a percentage of the total available memory&lt;/span&gt;
&lt;span class="c1"&gt;# This takes precedence and overrides SIZE below&lt;/span&gt;
&lt;span class="nv"&gt;PERCENT&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="m"&gt;30&lt;/span&gt;

&lt;span class="c1"&gt;# Specifies a static amount of RAM that should be used for&lt;/span&gt;
&lt;span class="c1"&gt;# the ZRAM devices, measured in MiB&lt;/span&gt;
&lt;span class="c1"&gt;# SIZE=256000&lt;/span&gt;

&lt;span class="c1"&gt;# Specifies the priority for the swap devices, see swapon(2)&lt;/span&gt;
&lt;span class="c1"&gt;# for more details. A higher number indicates higher priority&lt;/span&gt;
&lt;span class="c1"&gt;# This should probably be higher than hdd/ssd swaps.&lt;/span&gt;
&lt;span class="c1"&gt;# PRIORITY=100&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;I chose zstd as the compression algorithm for its superior compression
capabilities. Additionally, I reserved 30% of memory as the size of the zram
device. After modifying the configuration, restart the &lt;cite&gt;zramswap.service&lt;/cite&gt; to
activate the swap:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;systemctl&lt;span class="w"&gt; &lt;/span&gt;restart&lt;span class="w"&gt; &lt;/span&gt;zramswap.service
&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;div class="section" id="using-systemd-zram-generator"&gt;
&lt;h2&gt;Using systemd-zram-generator&lt;/h2&gt;
&lt;p&gt;For Debian Bookworm users, an alternative option is systemd-zram-generator.
Although zram-tools is still available in Debian Bookworm,
systemd-zram-generator offers a more integrated solution within the systemd
ecosystem. Below is an example of the translated configuration for
systemd-zram-generator, located at &lt;cite&gt;/etc/systemd/zram-generator.conf&lt;/cite&gt;:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;# This config file enables a /dev/zram0 swap device with the following
# properties:
# * size: 50% of available RAM or 4GiB, whichever is less
# * compression-algorithm: kernel default
#
# This device&amp;#39;s properties can be modified by adding options under the
# [zram0] section below. For example, to set a fixed size of 2GiB, set
# `zram-size = 2GiB`.

[zram0]
zram-size = ceil(ram * 30/100)
compression-algorithm = zstd
swap-priority = 100
fs-type = swap
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;After making the necessary changes, reload systemd and start the &lt;cite&gt;systemd-zram-setup&amp;#64;zram0.service&lt;/cite&gt;:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;systemctl&lt;span class="w"&gt; &lt;/span&gt;daemon-reload
systemctl&lt;span class="w"&gt; &lt;/span&gt;start&lt;span class="w"&gt; &lt;/span&gt;systemd-zram-setup@zram0.service
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;The &lt;cite&gt;systemd-zram-generator&lt;/cite&gt; creates the zram device by loading the kernel
module and then creates a &lt;cite&gt;systemd.swap&lt;/cite&gt; unit to mount the zram device as swap.
In this case, the swap file is called &lt;cite&gt;zram0.swap&lt;/cite&gt;.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="checking-compression-and-details"&gt;
&lt;h2&gt;Checking Compression and Details&lt;/h2&gt;
&lt;p&gt;To verify the effectiveness of the swap configuration, you can use the &lt;cite&gt;zramctl&lt;/cite&gt;
command, which is part of the &lt;cite&gt;util-linux&lt;/cite&gt; package. Alternatively, the
&lt;cite&gt;zramswap&lt;/cite&gt; utility provided by &lt;cite&gt;zram-tools&lt;/cite&gt; can be used to obtain the same
output.&lt;/p&gt;
&lt;p&gt;During my testing with synthetic memory load created using &lt;em&gt;stress-ng&lt;/em&gt; &lt;em&gt;vm&lt;/em&gt;
class I found that I can reach upto &lt;em&gt;40%&lt;/em&gt; compression ratio.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="memory-overcommit"&gt;
&lt;h2&gt;Memory Overcommit&lt;/h2&gt;
&lt;p&gt;Another use case I was looking for is allowing the launching of applications
that require more memory than what is available in the system. By default, the
Linux kernel attempts to estimate the amount of free memory left on the system
when user space requests more memory (&lt;cite&gt;vm.overcommit_memory=0&lt;/cite&gt;). However, you
can change this behavior by modifying the sysctl value for
&lt;cite&gt;vm.overcommit_memory&lt;/cite&gt; to &lt;cite&gt;1&lt;/cite&gt;.&lt;/p&gt;
&lt;p&gt;To demonstrate this, I ran a test using stress-ng to request more memory than
the system had available. As expected, the Linux kernel refused to allocate
memory, and the stress-ng process could not proceed.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;free&lt;span class="w"&gt; &lt;/span&gt;-tg&lt;span class="w"&gt;                                                                                                                                                                                         &lt;/span&gt;──&lt;span class="o"&gt;(&lt;/span&gt;Mon,Jun19&lt;span class="o"&gt;)&lt;/span&gt;─┘
&lt;span class="w"&gt;                &lt;/span&gt;total&lt;span class="w"&gt;        &lt;/span&gt;used&lt;span class="w"&gt;        &lt;/span&gt;free&lt;span class="w"&gt;      &lt;/span&gt;shared&lt;span class="w"&gt;  &lt;/span&gt;buff/cache&lt;span class="w"&gt;   &lt;/span&gt;available
&lt;span class="w"&gt; &lt;/span&gt;Mem:&lt;span class="w"&gt;              &lt;/span&gt;&lt;span class="m"&gt;31&lt;/span&gt;&lt;span class="w"&gt;          &lt;/span&gt;&lt;span class="m"&gt;12&lt;/span&gt;&lt;span class="w"&gt;          &lt;/span&gt;&lt;span class="m"&gt;11&lt;/span&gt;&lt;span class="w"&gt;           &lt;/span&gt;&lt;span class="m"&gt;3&lt;/span&gt;&lt;span class="w"&gt;          &lt;/span&gt;&lt;span class="m"&gt;11&lt;/span&gt;&lt;span class="w"&gt;          &lt;/span&gt;&lt;span class="m"&gt;18&lt;/span&gt;
&lt;span class="w"&gt; &lt;/span&gt;Swap:&lt;span class="w"&gt;             &lt;/span&gt;&lt;span class="m"&gt;10&lt;/span&gt;&lt;span class="w"&gt;           &lt;/span&gt;&lt;span class="m"&gt;2&lt;/span&gt;&lt;span class="w"&gt;           &lt;/span&gt;&lt;span class="m"&gt;8&lt;/span&gt;
&lt;span class="w"&gt; &lt;/span&gt;Total:&lt;span class="w"&gt;            &lt;/span&gt;&lt;span class="m"&gt;41&lt;/span&gt;&lt;span class="w"&gt;          &lt;/span&gt;&lt;span class="m"&gt;14&lt;/span&gt;&lt;span class="w"&gt;          &lt;/span&gt;&lt;span class="m"&gt;19&lt;/span&gt;

sudo&lt;span class="w"&gt; &lt;/span&gt;stress-ng&lt;span class="w"&gt; &lt;/span&gt;--vm&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="m"&gt;1&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;--vm-bytes&lt;span class="o"&gt;=&lt;/span&gt;50G&lt;span class="w"&gt; &lt;/span&gt;-t&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;120&lt;/span&gt;&lt;span class="w"&gt;                                                                                                                                                      &lt;/span&gt;──&lt;span class="o"&gt;(&lt;/span&gt;Mon,Jun19&lt;span class="o"&gt;)&lt;/span&gt;─┘
&lt;span class="w"&gt; &lt;/span&gt;stress-ng:&lt;span class="w"&gt; &lt;/span&gt;info:&lt;span class="w"&gt;  &lt;/span&gt;&lt;span class="o"&gt;[&lt;/span&gt;&lt;span class="m"&gt;1496310&lt;/span&gt;&lt;span class="o"&gt;]&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;setting&lt;span class="w"&gt; &lt;/span&gt;to&lt;span class="w"&gt; &lt;/span&gt;a&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;120&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;second&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="m"&gt;2&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;mins,&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;0&lt;/span&gt;.00&lt;span class="w"&gt; &lt;/span&gt;secs&lt;span class="o"&gt;)&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;run&lt;span class="w"&gt; &lt;/span&gt;per&lt;span class="w"&gt; &lt;/span&gt;stressor
&lt;span class="w"&gt; &lt;/span&gt;stress-ng:&lt;span class="w"&gt; &lt;/span&gt;info:&lt;span class="w"&gt;  &lt;/span&gt;&lt;span class="o"&gt;[&lt;/span&gt;&lt;span class="m"&gt;1496310&lt;/span&gt;&lt;span class="o"&gt;]&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;dispatching&lt;span class="w"&gt; &lt;/span&gt;hogs:&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;1&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;vm
&lt;span class="w"&gt; &lt;/span&gt;stress-ng:&lt;span class="w"&gt; &lt;/span&gt;info:&lt;span class="w"&gt;  &lt;/span&gt;&lt;span class="o"&gt;[&lt;/span&gt;&lt;span class="m"&gt;1496312&lt;/span&gt;&lt;span class="o"&gt;]&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;vm:&lt;span class="w"&gt; &lt;/span&gt;gave&lt;span class="w"&gt; &lt;/span&gt;up&lt;span class="w"&gt; &lt;/span&gt;trying&lt;span class="w"&gt; &lt;/span&gt;to&lt;span class="w"&gt; &lt;/span&gt;mmap,&lt;span class="w"&gt; &lt;/span&gt;no&lt;span class="w"&gt; &lt;/span&gt;available&lt;span class="w"&gt; &lt;/span&gt;memory,&lt;span class="w"&gt; &lt;/span&gt;skipping&lt;span class="w"&gt; &lt;/span&gt;stressor
&lt;span class="w"&gt; &lt;/span&gt;stress-ng:&lt;span class="w"&gt; &lt;/span&gt;warn:&lt;span class="w"&gt;  &lt;/span&gt;&lt;span class="o"&gt;[&lt;/span&gt;&lt;span class="m"&gt;1496310&lt;/span&gt;&lt;span class="o"&gt;]&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;vm:&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;[&lt;/span&gt;&lt;span class="m"&gt;1496311&lt;/span&gt;&lt;span class="o"&gt;]&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;aborted&lt;span class="w"&gt; &lt;/span&gt;early,&lt;span class="w"&gt; &lt;/span&gt;out&lt;span class="w"&gt; &lt;/span&gt;of&lt;span class="w"&gt; &lt;/span&gt;system&lt;span class="w"&gt; &lt;/span&gt;resources
&lt;span class="w"&gt; &lt;/span&gt;stress-ng:&lt;span class="w"&gt; &lt;/span&gt;info:&lt;span class="w"&gt;  &lt;/span&gt;&lt;span class="o"&gt;[&lt;/span&gt;&lt;span class="m"&gt;1496310&lt;/span&gt;&lt;span class="o"&gt;]&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;vm:
&lt;span class="w"&gt; &lt;/span&gt;stress-ng:&lt;span class="w"&gt; &lt;/span&gt;warn:&lt;span class="w"&gt;  &lt;/span&gt;&lt;span class="o"&gt;[&lt;/span&gt;&lt;span class="m"&gt;1496310&lt;/span&gt;&lt;span class="o"&gt;]&lt;/span&gt;&lt;span class="w"&gt;         &lt;/span&gt;&lt;span class="m"&gt;14&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;System&lt;span class="w"&gt; &lt;/span&gt;Management&lt;span class="w"&gt; &lt;/span&gt;Interrupts
&lt;span class="w"&gt; &lt;/span&gt;stress-ng:&lt;span class="w"&gt; &lt;/span&gt;info:&lt;span class="w"&gt;  &lt;/span&gt;&lt;span class="o"&gt;[&lt;/span&gt;&lt;span class="m"&gt;1496310&lt;/span&gt;&lt;span class="o"&gt;]&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;passed:&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;0&lt;/span&gt;
&lt;span class="w"&gt; &lt;/span&gt;stress-ng:&lt;span class="w"&gt; &lt;/span&gt;info:&lt;span class="w"&gt;  &lt;/span&gt;&lt;span class="o"&gt;[&lt;/span&gt;&lt;span class="m"&gt;1496310&lt;/span&gt;&lt;span class="o"&gt;]&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;failed:&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;0&lt;/span&gt;
&lt;span class="w"&gt; &lt;/span&gt;stress-ng:&lt;span class="w"&gt; &lt;/span&gt;info:&lt;span class="w"&gt;  &lt;/span&gt;&lt;span class="o"&gt;[&lt;/span&gt;&lt;span class="m"&gt;1496310&lt;/span&gt;&lt;span class="o"&gt;]&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;skipped:&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;1&lt;/span&gt;:&lt;span class="w"&gt; &lt;/span&gt;vm&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="m"&gt;1&lt;/span&gt;&lt;span class="o"&gt;)&lt;/span&gt;
&lt;span class="w"&gt; &lt;/span&gt;stress-ng:&lt;span class="w"&gt; &lt;/span&gt;info:&lt;span class="w"&gt;  &lt;/span&gt;&lt;span class="o"&gt;[&lt;/span&gt;&lt;span class="m"&gt;1496310&lt;/span&gt;&lt;span class="o"&gt;]&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;successful&lt;span class="w"&gt; &lt;/span&gt;run&lt;span class="w"&gt; &lt;/span&gt;completed&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="k"&gt;in&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;10&lt;/span&gt;.04s
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;By setting &lt;cite&gt;vm.overcommit_memory=1&lt;/cite&gt;, Linux will allocate memory in a more relaxed
manner, assuming an infinite amount of memory is available.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="conclusion"&gt;
&lt;h2&gt;Conclusion&lt;/h2&gt;
&lt;p&gt;ZRAM provides disks that allow for very fast I/O, and compression allows for a
significant amount of memory savings. ZRAM is not restricted to just swap usage;
it can be used as a normal block device with different file systems.&lt;/p&gt;
&lt;p&gt;Using ZRAM as swap is beneficial because, unlike disk-based swap, it is faster,
and compression ensures that we use a smaller amount of RAM itself as swap
space.&lt;/p&gt;
&lt;p&gt;Additionally, adjusting the memory overcommit settings can be beneficial for
scenarios that require launching memory-intensive applications.&lt;/p&gt;
&lt;p&gt;&lt;em&gt;Note: When running stress tests or allocating excessive memory, be cautious
about the actual memory capacity of your system to prevent out-of-memory (OOM)
situations.&lt;/em&gt;&lt;/p&gt;
&lt;p&gt;Feel free to explore the capabilities of ZRAM and optimize your system's memory
management. Happy computing!&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="reference"&gt;
&lt;h2&gt;Reference&lt;/h2&gt;
&lt;ol class="arabic simple"&gt;
&lt;li&gt;&lt;a class="reference external" href="https://www.kernel.org/doc/html/latest/admin-guide/blockdev/zram.html"&gt;zram: Compressed RAM-based block device&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a class="reference external" href="https://www.kernel.org/doc/Documentation/vm/overcommit-accounting"&gt;Overcommit Accounting&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a class="reference external" href="https://www.baeldung.com/linux/overcommit-modes"&gt;Linux Overcommit Modes&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a class="reference external" href="https://wiki.archlinux.org/title/Zram"&gt;zram: Arch Wiki&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a class="reference external" href="https://wiki.debian.org/ZRam"&gt;zram: Debian Wiki&lt;/a&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;/div&gt;
</content><category term="devops"/><category term="zram"/><category term="vm"/><category term="overcommit"/><category term="debian"/></entry><entry><title>Installing Debian from GRML Live CD</title><link href="https://copyninja.in/blog/live_install_debian.html" rel="alternate"/><published>2022-12-12T12:35:00+05:30</published><updated>2022-12-12T12:35:00+05:30</updated><author><name>copyninja</name></author><id>tag:copyninja.in,2022-12-12:/blog/live_install_debian.html</id><summary type="html">&lt;p class="first last"&gt;New experiment to install Debian from GRML Live boot&lt;/p&gt;
</summary><content type="html">&lt;p&gt;I had bought a Thinkpad E470 laptop back in 2018 which was lying unused for
quite some time. Recently when I wanted to use it, I found that the keyboard is
not working, especially some keys and after some time the laptop will hang in
Lenovo boot screen. I came back to Bangalore almost after 2 years from my
hometown (WFH due to Covid) and thought it was the right time to get my laptop
back to normal working state. After getting the keyboard replaced I noticed that
1TB HDD is no longer fast enough for my taste!. I've to admit I never thought I
would start disliking HDD so quickly thanks to modern SSD based work laptops. So
as a second upgrade I got the HDD removed from my laptop and got a 240G SSD.
Yeah I know its reduction from my original size but I intend to continue using
my old HDD via USB SATA enclosure as an external HDD which can house the extra
data which I need to save.&lt;/p&gt;
&lt;p&gt;So now that I've a SSD I need to install Debian Unstable again on it and this is
where I tried something new. My colleague (name redacted on request) suggested
to me use GRML live CD and install Debian via &lt;em&gt;debootstrap&lt;/em&gt;. And after giving a
thought I decided to try this out. Some reason for going ahead with this are
listed below&lt;/p&gt;
&lt;ol class="arabic simple"&gt;
&lt;li&gt;Debian Installer does not support a proper BTRFS based root file system. It
just allows btrfs as root but no subvolume support. Also I'm not sure about
the luks support with btrfs as root.&lt;/li&gt;
&lt;li&gt;I also wanted to give a try to systemd-boot as my laptop is UEFI capable and
I've slowly started disliking Grub.&lt;/li&gt;
&lt;li&gt;I really hate installing task-kde-desktop (Yeah you read it right, I've switched
to be a KDE user for quite some time) which will pull tons of unwanted stuff
and bloat. Well it's not just task-kde-desktop but any other task-desktop
package does similar and I don't want to have too much of unused stuff and
services running.&lt;/li&gt;
&lt;/ol&gt;
&lt;div class="section" id="disk-preparation"&gt;
&lt;h2&gt;Disk Preparation&lt;/h2&gt;
&lt;p&gt;As a first step I went to GRML website and downloaded &lt;a class="reference external" href="https://grml.org/download/prerelease/"&gt;current pre-release&lt;/a&gt;. Frankly, I'm using GRML for first
time and I was not sure what to expect. When I booted it up I was bit taken a
back to see its console based and I did not have a wired lan just a plain
wireless dongle (Jiofi device) and was wondering what it will take to connect.
But surprisingly curses based UI was pretty much straight forward to allow me to
connect to Wifi AP. Another thing was the rescue CD had non-free firmware as the
laptop was using ath10k device and needed non-free blobs to operate.&lt;/p&gt;
&lt;p&gt;Once I got shell prompt in rescue CD first thing I did was to reconfigure
console-setup to increase  font size which was very very small on default boot.
Once that is done I did the following to create a 1G (FAT32) partition for EFI.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;parted&lt;span class="w"&gt; &lt;/span&gt;-a&lt;span class="w"&gt; &lt;/span&gt;optimal&lt;span class="w"&gt; &lt;/span&gt;-s&lt;span class="w"&gt; &lt;/span&gt;/dev/sda&lt;span class="w"&gt; &lt;/span&gt;mklabel&lt;span class="w"&gt; &lt;/span&gt;gpt
parted&lt;span class="w"&gt; &lt;/span&gt;-a&lt;span class="w"&gt; &lt;/span&gt;optimal&lt;span class="w"&gt; &lt;/span&gt;-s&lt;span class="w"&gt; &lt;/span&gt;/dev/sda&lt;span class="w"&gt; &lt;/span&gt;mkpart&lt;span class="w"&gt; &lt;/span&gt;primary&lt;span class="w"&gt; &lt;/span&gt;vfat&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;0&lt;/span&gt;%&lt;span class="w"&gt; &lt;/span&gt;1G
parted&lt;span class="w"&gt; &lt;/span&gt;-a&lt;span class="w"&gt; &lt;/span&gt;optimal&lt;span class="w"&gt; &lt;/span&gt;-s&lt;span class="w"&gt; &lt;/span&gt;/dev/sda&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nb"&gt;set&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;1&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;esp&lt;span class="w"&gt; &lt;/span&gt;on
mkfs.vfat&lt;span class="w"&gt; &lt;/span&gt;-n&lt;span class="w"&gt; &lt;/span&gt;boot_disk&lt;span class="w"&gt; &lt;/span&gt;-F&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;32&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;/dev/sda1
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;So here is what I did: created a 1G vfat type partition and set the esp flag on
it. This will be mounted to /boot/efi for systemd-boot. Next I created a single
partition on the rest of the available free disk which will be used as the root
file system.&lt;/p&gt;
&lt;p&gt;Next I encrypted the root parition using LUKS and then created the BTRFS file
system on top of it.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;cryptsetup&lt;span class="w"&gt; &lt;/span&gt;luksFormat&lt;span class="w"&gt; &lt;/span&gt;/dev/sda2
cryptsetup&lt;span class="w"&gt; &lt;/span&gt;luksOpen&lt;span class="w"&gt; &lt;/span&gt;/dev/sda2&lt;span class="w"&gt; &lt;/span&gt;ENC
mkfs.btrfs&lt;span class="w"&gt; &lt;/span&gt;-L&lt;span class="w"&gt; &lt;/span&gt;root_disk&lt;span class="w"&gt; &lt;/span&gt;/dev/mapper/ENC
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Next is to create subvolumes in BTRFS. I followed suggestion by colleague and
created a top-level &lt;em&gt;&amp;#64;&lt;/em&gt; as subvolume below which created &lt;em&gt;&amp;#64;/home&lt;/em&gt; &lt;em&gt;&amp;#64;/var/log&lt;/em&gt; &lt;em&gt;&amp;#64;/opt&lt;/em&gt; .
Also enabled compression with zstd and level of 1 to avoid battery drain.
Finally marked the &lt;em&gt;&amp;#64;&lt;/em&gt; as default subvolume to avoid adding it to fstab entry.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;mount&lt;span class="w"&gt; &lt;/span&gt;-o&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nv"&gt;compress&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;zstd:1&lt;span class="w"&gt; &lt;/span&gt;/dev/mapper/ENC&lt;span class="w"&gt; &lt;/span&gt;/mnt
btrfs&lt;span class="w"&gt; &lt;/span&gt;subvol&lt;span class="w"&gt; &lt;/span&gt;create&lt;span class="w"&gt; &lt;/span&gt;/mnt/@
&lt;span class="nb"&gt;cd&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;/mnt/@
btrfs&lt;span class="w"&gt; &lt;/span&gt;subvol&lt;span class="w"&gt; &lt;/span&gt;create&lt;span class="w"&gt; &lt;/span&gt;./home
btrfs&lt;span class="w"&gt; &lt;/span&gt;subvol&lt;span class="w"&gt; &lt;/span&gt;create&lt;span class="w"&gt; &lt;/span&gt;./opt
mkdir&lt;span class="w"&gt; &lt;/span&gt;-p&lt;span class="w"&gt; &lt;/span&gt;var
btrfs&lt;span class="w"&gt; &lt;/span&gt;subvol&lt;span class="w"&gt; &lt;/span&gt;create&lt;span class="w"&gt; &lt;/span&gt;./var/log
btrfs&lt;span class="w"&gt; &lt;/span&gt;suvol&lt;span class="w"&gt; &lt;/span&gt;set-default&lt;span class="w"&gt; &lt;/span&gt;/mnt/@
&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;div class="section" id="bootstrapping-debian"&gt;
&lt;h2&gt;Bootstrapping Debian&lt;/h2&gt;
&lt;p&gt;Now that root disk is prepared next step was to bootstrap the root file system.
I used debootstrap for this job. One thing I missed here from installer was
ability to preseed. I tried looking around to figure out if we can preseed
debootstrap but did not find much. If you know the procedure do point it to me.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="nb"&gt;cd&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;/mnt/
debootstrap&lt;span class="w"&gt; &lt;/span&gt;--include&lt;span class="o"&gt;=&lt;/span&gt;dbus,locales,tzdata&lt;span class="w"&gt; &lt;/span&gt;unstable&lt;span class="w"&gt; &lt;/span&gt;@/&lt;span class="w"&gt; &lt;/span&gt;http://deb.debian.org/debian
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Well this just gets a bare minimal installation of Debian I need to install rest
of the things post this step manually by chroot into target folder &amp;#64;/.&lt;/p&gt;
&lt;p&gt;I like the &lt;strong&gt;grml-chroot&lt;/strong&gt; command for chroot purpose, it does most of the job of
mounting all required directory like /dev/ /proc /sys etc. But before entering
chroot I need to mount the ESP partition we created to &lt;strong&gt;/boot/efi&lt;/strong&gt; so that I
can finalize the installation of kernel and &lt;strong&gt;systemd-boot&lt;/strong&gt;.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;umount&lt;span class="w"&gt; &lt;/span&gt;/mnt
mount&lt;span class="w"&gt; &lt;/span&gt;-o&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nv"&gt;compress&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;zstd:1&lt;span class="w"&gt; &lt;/span&gt;/dev/mapper/ENC&lt;span class="w"&gt; &lt;/span&gt;/mnt
mkdir&lt;span class="w"&gt; &lt;/span&gt;-p&lt;span class="w"&gt; &lt;/span&gt;/mnt/boot/efi
mount&lt;span class="w"&gt; &lt;/span&gt;/dev/sda1&lt;span class="w"&gt; &lt;/span&gt;/mnt/boot/efi
grml-chroot&lt;span class="w"&gt; &lt;/span&gt;/mnt&lt;span class="w"&gt; &lt;/span&gt;/bin/bash
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;I remounted the root subvolume &lt;em&gt;&amp;#64;&lt;/em&gt; directly to /mnt now, remember I made &lt;em&gt;&amp;#64;&lt;/em&gt; as
default subvolume before. I also mounted ESP partition with FAT32 file system to
&lt;em&gt;/boot/efi&lt;/em&gt;. Finally I used grml-chroot to get into chroot of newly bootstrapped
file system.&lt;/p&gt;
&lt;p&gt;Now I will install the kernel and minimal KDE desktop installation and configure
locales and time zone data for the new system. I wanted to use dracut instead of
default initramfs-tools for initrd. I also need to install cryptsetup and
btrfs-progs so I can decrypt and really boot into my new system.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;apt-get&lt;span class="w"&gt; &lt;/span&gt;update
apt-get&lt;span class="w"&gt; &lt;/span&gt;install&lt;span class="w"&gt; &lt;/span&gt;linux-image-amd64&lt;span class="w"&gt; &lt;/span&gt;dracut&lt;span class="w"&gt; &lt;/span&gt;openssh-client&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="se"&gt;\&lt;/span&gt;
&lt;span class="w"&gt;                        &lt;/span&gt;kde-plasma-desktop&lt;span class="w"&gt; &lt;/span&gt;plasma-workspace-wayland&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="se"&gt;\&lt;/span&gt;
&lt;span class="w"&gt;                        &lt;/span&gt;plasma-nm&lt;span class="w"&gt; &lt;/span&gt;cryptsetup&lt;span class="w"&gt; &lt;/span&gt;btrfs-progs&lt;span class="w"&gt; &lt;/span&gt;sudo
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Next is setting up crypttab and fstab entries for new system. Following entry is
added to fstab&lt;/p&gt;
&lt;pre class="literal-block"&gt;
LABEL=&amp;quot;root_disk&amp;quot; / btrfs defaults,compress=zstd:1 0 0
&lt;/pre&gt;
&lt;p&gt;And the crypttab entry&lt;/p&gt;
&lt;pre class="literal-block"&gt;
ENCRYPTED_ROOT UUID=xxxx none discard,x-initrd.attach
&lt;/pre&gt;
&lt;p&gt;I've not written actual UUID above this is just for the purpose of showing the
content of /etc/crypttab. Once these entries are added we need to recreate
initrd. I just reconfigured the installed kernel package for retriggerring the
recreation of initrd using dracut.
..
Reconfiguration was locales is done by editing /etc/locales.gen to uncomment
&lt;em&gt;en_US.UTF-8&lt;/em&gt; and writing /etc/timezone with &lt;em&gt;Asia/Kolkata&lt;/em&gt;. I used
&lt;em&gt;DEBIAN_FRONTEND=noninteractive&lt;/em&gt; to avoid another prompt asking for locale and
timezone information.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="nb"&gt;export&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nv"&gt;DEBIAN_FRONTEND&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;noninteractive
dpkg-reconfigure&lt;span class="w"&gt; &lt;/span&gt;locales
dpkg-reconfigure&lt;span class="w"&gt; &lt;/span&gt;tzdata
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Added my user using &lt;em&gt;adduser&lt;/em&gt; command and also set the root password as well.
Added my user to &lt;em&gt;sudo&lt;/em&gt; group so I can use sudo to elevate privileges.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="setting-up-systemd-boot"&gt;
&lt;h2&gt;Setting up systemd-boot&lt;/h2&gt;
&lt;p&gt;So now basic usable system is ready last part is enabling the systemd-boot
configuration as I'm not gonna use grub. I did following to install
systemd-boot. Frankly I'm not expert of this it was colleague's suggestion.&lt;/p&gt;
&lt;p&gt;Before installing the systemd-boot I had to setup kernel command line. This can
be done by writing command line to /etc/kernel/cmdline with following contents.&lt;/p&gt;
&lt;pre class="literal-block"&gt;
systemd.gpt_auto=no quiet root=LABEL=root_disk
&lt;/pre&gt;
&lt;p&gt;I'm disabling systemd-gpt-generator to avoid race condition between crypttab
entry and auto generated entry by systemd. I faced this mainly because of my
stupidity of not adding entry &lt;em&gt;root=LABEL=root_disk&lt;/em&gt;&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;apt-get&lt;span class="w"&gt; &lt;/span&gt;install&lt;span class="w"&gt; &lt;/span&gt;-y&lt;span class="w"&gt; &lt;/span&gt;systemd-boot
bootctl&lt;span class="w"&gt; &lt;/span&gt;install&lt;span class="w"&gt; &lt;/span&gt;--make-entry-directory&lt;span class="o"&gt;=&lt;/span&gt;yes&lt;span class="w"&gt; &lt;/span&gt;--entry-token&lt;span class="o"&gt;=&lt;/span&gt;machine-id
dpkg-reconfigure&lt;span class="w"&gt; &lt;/span&gt;linux-image-6.0.0-5-amd64
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Finally exit from the chroot and reboot into the freshly installed system.&lt;/p&gt;
&lt;p&gt;&lt;em&gt;systemd-boot&lt;/em&gt; already ships a hook file &lt;em&gt;zz-systemd-boot&lt;/em&gt; under &lt;em&gt;/etc/kernel&lt;/em&gt;
so its pretty much usable without any manual intervention. Previously after
kernel installation  we had to manually update kernel image in efi partitions
using &lt;em&gt;bootctl&lt;/em&gt;&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="conclussion"&gt;
&lt;h2&gt;Conclussion&lt;/h2&gt;
&lt;p&gt;Though installing from live image is not new and debian-installer also does the
same only difference is more control over installation and doing things which is
installer is not letting you do (or should I say is not part of default
installation?). If properly automated using scripts we can leverage this to do
custom installation in large scale environments. I know there is FAI but I've
not explored it and felt there is too much to setup for a simple installations
with specific requirements.&lt;/p&gt;
&lt;p&gt;So finally I've a system with Debian which differs from default Debian
installation :-). I should thank my colleague for rekindling nerd inside me who
had stopped experimenting quite a long time back.&lt;/p&gt;
&lt;/div&gt;
</content><category term="devops"/><category term="debian"/><category term="live"/><category term="grml"/><category term="systemd-boot"/><category term="btrfs"/></entry><entry><title>Note to Self: Growing the Root File System on First Boot</title><link href="https://copyninja.in/blog/grow_rootfs.html" rel="alternate"/><published>2019-02-16T22:13:00+05:30</published><updated>2019-02-16T22:13:00+05:30</updated><author><name>copyninja</name></author><id>tag:copyninja.in,2019-02-16:/blog/grow_rootfs.html</id><summary type="html">&lt;p class="first last"&gt;Post discusses about expanding root file system of a system to full
extent of available space in device.&lt;/p&gt;
</summary><content type="html">&lt;p&gt;These 2 are the use cases I came across for expanding root file system.&lt;/p&gt;
&lt;ol class="arabic simple"&gt;
&lt;li&gt;RaspberryPi images which comes in smaller image size like 1GB which you write
bigger size SD cards like 32GB but you want to use full 32GB of space when
system comes up.&lt;/li&gt;
&lt;li&gt;You have a VM image which is contains basic server operating system and you want
to provision the same as a VM with much larger size root file system.&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;My current use case was second but I learnt the trick from 1, that is the
&lt;a class="reference external" href="https://github.com/Debian/raspi3-image-spec"&gt;RaspberryPi3 image spec&lt;/a&gt; by
Debian project.&lt;/p&gt;
&lt;p&gt;Idea behind the expanding root file system is first expanding the root file
system to full available size and then run resize2fs on the expanded partition
to grow file system. &lt;em&gt;resize2fs&lt;/em&gt; is a tool specific for ext2/3/4 file system.
But this needs to be done before the file system is mounted.&lt;/p&gt;
&lt;p&gt;Here is my modified script from &lt;a class="reference external" href="https://github.com/Debian/raspi3-image-spec/blob/master/rpi3-resizerootfs"&gt;raspi3-image-spec repo&lt;/a&gt;.
Only difference is I've changed the logic of extracting root partition device to
my need, and of course added comments based on my understanding.&lt;/p&gt;
&lt;pre class="code shell literal-block"&gt;
&lt;span class="ch"&gt;#!/bin/sh
&lt;/span&gt;&lt;span class="w"&gt;
&lt;/span&gt;&lt;span class="c1"&gt;# Just extracts root partition and removes partition number to get the device
# name eg. /dev/sda1 becomes /dev/sda
&lt;/span&gt;&lt;span class="nv"&gt;roottmp&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="k"&gt;$(&lt;/span&gt;lsblk&lt;span class="w"&gt; &lt;/span&gt;-l&lt;span class="w"&gt; &lt;/span&gt;-o&lt;span class="w"&gt; &lt;/span&gt;NAME,MOUNTPOINT&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;|&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;grep&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s1"&gt;'/$'&lt;/span&gt;&lt;span class="k"&gt;)&lt;/span&gt;&lt;span class="w"&gt;
&lt;/span&gt;&lt;span class="nv"&gt;rootpart&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;/dev/&lt;span class="si"&gt;${&lt;/span&gt;&lt;span class="nv"&gt;roottmp&lt;/span&gt;&lt;span class="p"&gt;%% */&lt;/span&gt;&lt;span class="si"&gt;}&lt;/span&gt;&lt;span class="w"&gt;
&lt;/span&gt;&lt;span class="nv"&gt;rootdev&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="si"&gt;${&lt;/span&gt;&lt;span class="nv"&gt;rootpart&lt;/span&gt;&lt;span class="p"&gt;%1&lt;/span&gt;&lt;span class="si"&gt;}&lt;/span&gt;&lt;span class="w"&gt;

&lt;/span&gt;&lt;span class="c1"&gt;# Use sfdisk to extend partition to all available free space on device.
&lt;/span&gt;flock&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nv"&gt;$rootdev&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;sfdisk&lt;span class="w"&gt; &lt;/span&gt;-f&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nv"&gt;$rootdev&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;-N&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;2&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;&amp;lt;&amp;lt;EOF
,+
EOF&lt;/span&gt;&lt;span class="w"&gt;

&lt;/span&gt;sleep&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;5&lt;/span&gt;&lt;span class="w"&gt;

&lt;/span&gt;&lt;span class="c1"&gt;# Wait for all pending udev events to be handled
&lt;/span&gt;udevadm&lt;span class="w"&gt; &lt;/span&gt;settle&lt;span class="w"&gt;

&lt;/span&gt;sleep&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;5&lt;/span&gt;&lt;span class="w"&gt;

&lt;/span&gt;&lt;span class="c1"&gt;# detect the changes to partition (we extended it).
&lt;/span&gt;flock&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nv"&gt;$rootdev&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;partprobe&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nv"&gt;$rootdev&lt;/span&gt;&lt;span class="w"&gt;

&lt;/span&gt;&lt;span class="c1"&gt;# remount the root partition in read write mode
&lt;/span&gt;mount&lt;span class="w"&gt; &lt;/span&gt;-o&lt;span class="w"&gt; &lt;/span&gt;remount,rw&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nv"&gt;$rootpart&lt;/span&gt;&lt;span class="w"&gt;

&lt;/span&gt;&lt;span class="c1"&gt;# Finally grow the file system on root partition
&lt;/span&gt;resize2fs&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nv"&gt;$rootpart&lt;/span&gt;&lt;span class="w"&gt;

&lt;/span&gt;&lt;span class="nb"&gt;exit&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;0fs
&lt;/pre&gt;
&lt;p&gt;raspi3-image-spec uses &lt;a class="reference external" href="https://github.com/Debian/raspi3-image-spec/blob/master/rpi3-resizerootfs.service"&gt;sytemd service&lt;/a&gt;
file to execute this script just before any file system is mounted. This is done
by a making service execute before &lt;em&gt;local-fs.pre&lt;/em&gt; target. From the man page for
&lt;em&gt;systemd.special&lt;/em&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;dl class="docutils"&gt;
&lt;dt&gt;local-fs.target&lt;/dt&gt;
&lt;dd&gt;systemd-fstab-generator(3) automatically adds dependencies of type
Before= to all mount units that refer to local mount points for this
target unit. In addition, it adds dependencies of type Wants= to this
target unit for those mounts listed in /etc/fstab that have the auto
mount option set.&lt;/dd&gt;
&lt;/dl&gt;
&lt;/blockquote&gt;
&lt;p&gt;Service also disables itself on executing to avoid re-runs on every boot. I've
used the service file from raspi3-image-spec as is.&lt;/p&gt;
&lt;div class="section" id="testing-with-vm"&gt;
&lt;h2&gt;Testing with VM&lt;/h2&gt;
&lt;p&gt;&lt;em&gt;raspi3-image-spec&lt;/em&gt; is well tested, but I wanted to make sure this works with my
use case for VM. Since I didn't have any spare physical disks to experiment with
I used kpartx with raw file images. Here is what I did&lt;/p&gt;
&lt;ol class="arabic simple"&gt;
&lt;li&gt;Created a stretch image using vmdb2 with grub installed. Image size is 1.5G&lt;/li&gt;
&lt;li&gt;I created another raw disk using fallocate of 4G size.&lt;/li&gt;
&lt;li&gt;I created a partition on 4G disk.&lt;/li&gt;
&lt;li&gt;Loop mounted the disk and wrote 1.5G image on it using dd&lt;/li&gt;
&lt;li&gt;Finally created a VM using virt-install  with this loop mounted device as
root disk.&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;Below is my vmdb configuration yml again derived from &lt;a class="reference external" href="https://github.com/Debian/raspi3-image-spec/blob/master/raspi3.yaml"&gt;raspi3-image-spec&lt;/a&gt; one with
some modifications to suit my needs.&lt;/p&gt;
&lt;pre class="code yaml literal-block"&gt;
&lt;span class="c1"&gt;# See https://wiki.debian.org/RaspberryPi3 for known issues and more details.&lt;/span&gt;&lt;span class="w"&gt;
&lt;/span&gt;&lt;span class="nt"&gt;steps&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="w"&gt;
&lt;/span&gt;&lt;span class="p-Indicator"&gt;-&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nt"&gt;mkimg&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;&amp;quot;{{&lt;/span&gt;&lt;span class="nv"&gt; &lt;/span&gt;&lt;span class="s"&gt;output&lt;/span&gt;&lt;span class="nv"&gt; &lt;/span&gt;&lt;span class="s"&gt;}}&amp;quot;&lt;/span&gt;&lt;span class="w"&gt;
  &lt;/span&gt;&lt;span class="nt"&gt;size&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="l-Scalar-Plain"&gt;1.5G&lt;/span&gt;&lt;span class="w"&gt;

&lt;/span&gt;&lt;span class="p-Indicator"&gt;-&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nt"&gt;mklabel&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="l-Scalar-Plain"&gt;msdos&lt;/span&gt;&lt;span class="w"&gt;
  &lt;/span&gt;&lt;span class="nt"&gt;device&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;&amp;quot;{{&lt;/span&gt;&lt;span class="nv"&gt; &lt;/span&gt;&lt;span class="s"&gt;output&lt;/span&gt;&lt;span class="nv"&gt; &lt;/span&gt;&lt;span class="s"&gt;}}&amp;quot;&lt;/span&gt;&lt;span class="w"&gt;

&lt;/span&gt;&lt;span class="p-Indicator"&gt;-&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nt"&gt;mkpart&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="l-Scalar-Plain"&gt;primary&lt;/span&gt;&lt;span class="w"&gt;
  &lt;/span&gt;&lt;span class="nt"&gt;device&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;&amp;quot;{{&lt;/span&gt;&lt;span class="nv"&gt; &lt;/span&gt;&lt;span class="s"&gt;output&lt;/span&gt;&lt;span class="nv"&gt; &lt;/span&gt;&lt;span class="s"&gt;}}&amp;quot;&lt;/span&gt;&lt;span class="w"&gt;
  &lt;/span&gt;&lt;span class="nt"&gt;start&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="l-Scalar-Plain"&gt;0%&lt;/span&gt;&lt;span class="w"&gt;
  &lt;/span&gt;&lt;span class="nt"&gt;end&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="l-Scalar-Plain"&gt;100%&lt;/span&gt;&lt;span class="w"&gt;
  &lt;/span&gt;&lt;span class="nt"&gt;tag&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="l-Scalar-Plain"&gt;/&lt;/span&gt;&lt;span class="w"&gt;

&lt;/span&gt;&lt;span class="p-Indicator"&gt;-&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nt"&gt;kpartx&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;&amp;quot;{{&lt;/span&gt;&lt;span class="nv"&gt; &lt;/span&gt;&lt;span class="s"&gt;output&lt;/span&gt;&lt;span class="nv"&gt; &lt;/span&gt;&lt;span class="s"&gt;}}&amp;quot;&lt;/span&gt;&lt;span class="w"&gt;

&lt;/span&gt;&lt;span class="p-Indicator"&gt;-&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nt"&gt;mkfs&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="l-Scalar-Plain"&gt;ext4&lt;/span&gt;&lt;span class="w"&gt;
  &lt;/span&gt;&lt;span class="nt"&gt;partition&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="l-Scalar-Plain"&gt;/&lt;/span&gt;&lt;span class="w"&gt;
  &lt;/span&gt;&lt;span class="nt"&gt;label&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="l-Scalar-Plain"&gt;RASPIROOT&lt;/span&gt;&lt;span class="w"&gt;

&lt;/span&gt;&lt;span class="p-Indicator"&gt;-&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nt"&gt;mount&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="l-Scalar-Plain"&gt;/&lt;/span&gt;&lt;span class="w"&gt;

&lt;/span&gt;&lt;span class="p-Indicator"&gt;-&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nt"&gt;unpack-rootfs&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="l-Scalar-Plain"&gt;/&lt;/span&gt;&lt;span class="w"&gt;

&lt;/span&gt;&lt;span class="p-Indicator"&gt;-&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nt"&gt;debootstrap&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="l-Scalar-Plain"&gt;stretch&lt;/span&gt;&lt;span class="w"&gt;
  &lt;/span&gt;&lt;span class="nt"&gt;mirror&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="l-Scalar-Plain"&gt;http://localhost:3142/deb.debian.org/debian&lt;/span&gt;&lt;span class="w"&gt;
  &lt;/span&gt;&lt;span class="nt"&gt;target&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="l-Scalar-Plain"&gt;/&lt;/span&gt;&lt;span class="w"&gt;
  &lt;/span&gt;&lt;span class="nt"&gt;variant&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="l-Scalar-Plain"&gt;minbase&lt;/span&gt;&lt;span class="w"&gt;
  &lt;/span&gt;&lt;span class="nt"&gt;components&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="w"&gt;
  &lt;/span&gt;&lt;span class="p-Indicator"&gt;-&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="l-Scalar-Plain"&gt;main&lt;/span&gt;&lt;span class="w"&gt;
  &lt;/span&gt;&lt;span class="p-Indicator"&gt;-&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="l-Scalar-Plain"&gt;contrib&lt;/span&gt;&lt;span class="w"&gt;
  &lt;/span&gt;&lt;span class="p-Indicator"&gt;-&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="l-Scalar-Plain"&gt;non-free&lt;/span&gt;&lt;span class="w"&gt;
  &lt;/span&gt;&lt;span class="nt"&gt;unless&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="l-Scalar-Plain"&gt;rootfs_unpacked&lt;/span&gt;&lt;span class="w"&gt;

&lt;/span&gt;&lt;span class="c1"&gt;# TODO(https://bugs.debian.org/877855): remove this workaround once&lt;/span&gt;&lt;span class="w"&gt;
&lt;/span&gt;&lt;span class="c1"&gt;# debootstrap is fixed&lt;/span&gt;&lt;span class="w"&gt;
&lt;/span&gt;&lt;span class="p-Indicator"&gt;-&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nt"&gt;chroot&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="l-Scalar-Plain"&gt;/&lt;/span&gt;&lt;span class="w"&gt;
  &lt;/span&gt;&lt;span class="nt"&gt;shell&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p-Indicator"&gt;|&lt;/span&gt;&lt;span class="w"&gt;
    &lt;/span&gt;&lt;span class="no"&gt;echo 'deb http://deb.debian.org/debian buster main contrib non-free' &amp;gt; /etc/apt/sources.list&lt;/span&gt;&lt;span class="w"&gt;
    &lt;/span&gt;&lt;span class="no"&gt;apt-get update&lt;/span&gt;&lt;span class="w"&gt;
  &lt;/span&gt;&lt;span class="nt"&gt;unless&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="l-Scalar-Plain"&gt;rootfs_unpacked&lt;/span&gt;&lt;span class="w"&gt;

&lt;/span&gt;&lt;span class="p-Indicator"&gt;-&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nt"&gt;apt&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="l-Scalar-Plain"&gt;install&lt;/span&gt;&lt;span class="w"&gt;
  &lt;/span&gt;&lt;span class="nt"&gt;packages&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="w"&gt;
  &lt;/span&gt;&lt;span class="p-Indicator"&gt;-&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="l-Scalar-Plain"&gt;ssh&lt;/span&gt;&lt;span class="w"&gt;
  &lt;/span&gt;&lt;span class="p-Indicator"&gt;-&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="l-Scalar-Plain"&gt;parted&lt;/span&gt;&lt;span class="w"&gt;
  &lt;/span&gt;&lt;span class="p-Indicator"&gt;-&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="l-Scalar-Plain"&gt;dosfstools&lt;/span&gt;&lt;span class="w"&gt;
  &lt;/span&gt;&lt;span class="p-Indicator"&gt;-&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="l-Scalar-Plain"&gt;linux-image-amd64&lt;/span&gt;&lt;span class="w"&gt;
  &lt;/span&gt;&lt;span class="nt"&gt;tag&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="l-Scalar-Plain"&gt;/&lt;/span&gt;&lt;span class="w"&gt;
  &lt;/span&gt;&lt;span class="nt"&gt;unless&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="l-Scalar-Plain"&gt;rootfs_unpacked&lt;/span&gt;&lt;span class="w"&gt;

&lt;/span&gt;&lt;span class="p-Indicator"&gt;-&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nt"&gt;grub&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="l-Scalar-Plain"&gt;bios&lt;/span&gt;&lt;span class="w"&gt;
  &lt;/span&gt;&lt;span class="nt"&gt;tag&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="l-Scalar-Plain"&gt;/&lt;/span&gt;&lt;span class="w"&gt;

&lt;/span&gt;&lt;span class="p-Indicator"&gt;-&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nt"&gt;cache-rootfs&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="l-Scalar-Plain"&gt;/&lt;/span&gt;&lt;span class="w"&gt;
  &lt;/span&gt;&lt;span class="nt"&gt;unless&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="l-Scalar-Plain"&gt;rootfs_unpacked&lt;/span&gt;&lt;span class="w"&gt;

&lt;/span&gt;&lt;span class="p-Indicator"&gt;-&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nt"&gt;shell&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p-Indicator"&gt;|&lt;/span&gt;&lt;span class="w"&gt;
     &lt;/span&gt;&lt;span class="no"&gt;echo &amp;quot;experimental&amp;quot; &amp;gt; &amp;quot;${ROOT?}/etc/hostname&amp;quot;&lt;/span&gt;&lt;span class="w"&gt;

     &lt;/span&gt;&lt;span class="no"&gt;# '..VyaTFxP8kT6' is crypt.crypt('raspberry', '..')&lt;/span&gt;&lt;span class="w"&gt;
     &lt;/span&gt;&lt;span class="no"&gt;sed -i 's,root:[^:]*,root:..VyaTFxP8kT6,' &amp;quot;${ROOT?}/etc/shadow&amp;quot;&lt;/span&gt;&lt;span class="w"&gt;

     &lt;/span&gt;&lt;span class="no"&gt;sed -i 's,#PermitRootLogin prohibit-password,PermitRootLogin yes,g' &amp;quot;${ROOT?}/etc/ssh/sshd_config&amp;quot;&lt;/span&gt;&lt;span class="w"&gt;

     &lt;/span&gt;&lt;span class="no"&gt;install -m 644 -o root -g root fstab &amp;quot;${ROOT?}/etc/fstab&amp;quot;&lt;/span&gt;&lt;span class="w"&gt;

     &lt;/span&gt;&lt;span class="no"&gt;install -m 644 -o root -g root eth0 &amp;quot;${ROOT?}/etc/network/interfaces.d/eth0&amp;quot;&lt;/span&gt;&lt;span class="w"&gt;

     &lt;/span&gt;&lt;span class="no"&gt;install -m 755 -o root -g root rpi3-resizerootfs &amp;quot;${ROOT?}/usr/sbin/rpi3-resizerootfs&amp;quot;&lt;/span&gt;&lt;span class="w"&gt;
     &lt;/span&gt;&lt;span class="no"&gt;install -m 644 -o root -g root rpi3-resizerootfs.service &amp;quot;${ROOT?}/etc/systemd/system&amp;quot;&lt;/span&gt;&lt;span class="w"&gt;
     &lt;/span&gt;&lt;span class="no"&gt;mkdir -p &amp;quot;${ROOT?}/etc/systemd/system/systemd-remount-fs.service.requires/&amp;quot;&lt;/span&gt;&lt;span class="w"&gt;
     &lt;/span&gt;&lt;span class="no"&gt;ln -s /etc/systemd/system/rpi3-resizerootfs.service &amp;quot;${ROOT?}/etc/systemd/system/systemd-remount-fs.service.requires/rpi3-resizerootfs.service&amp;quot;&lt;/span&gt;&lt;span class="w"&gt;

     &lt;/span&gt;&lt;span class="no"&gt;install -m 644 -o root -g root rpi3-generate-ssh-host-keys.service &amp;quot;${ROOT?}/etc/systemd/system&amp;quot;&lt;/span&gt;&lt;span class="w"&gt;
     &lt;/span&gt;&lt;span class="no"&gt;mkdir -p &amp;quot;${ROOT?}/etc/systemd/system/multi-user.target.requires/&amp;quot;&lt;/span&gt;&lt;span class="w"&gt;
     &lt;/span&gt;&lt;span class="no"&gt;ln -s /etc/systemd/system/rpi3-generate-ssh-host-keys.service &amp;quot;${ROOT?}/etc/systemd/system/multi-user.target.requires/rpi3-generate-ssh-host-keys.service&amp;quot;&lt;/span&gt;&lt;span class="w"&gt;
     &lt;/span&gt;&lt;span class="no"&gt;rm -f ${ROOT?}/etc/ssh/ssh_host_*_key*&lt;/span&gt;&lt;span class="w"&gt;

  &lt;/span&gt;&lt;span class="nt"&gt;root-fs&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="l-Scalar-Plain"&gt;/&lt;/span&gt;&lt;span class="w"&gt;

&lt;/span&gt;&lt;span class="c1"&gt;# Clean up archive cache (likely not useful) and lists (likely outdated) to&lt;/span&gt;&lt;span class="w"&gt;
&lt;/span&gt;&lt;span class="c1"&gt;# reduce image size by several hundred megabytes.&lt;/span&gt;&lt;span class="w"&gt;
&lt;/span&gt;&lt;span class="p-Indicator"&gt;-&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nt"&gt;chroot&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="l-Scalar-Plain"&gt;/&lt;/span&gt;&lt;span class="w"&gt;
  &lt;/span&gt;&lt;span class="nt"&gt;shell&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p-Indicator"&gt;|&lt;/span&gt;&lt;span class="w"&gt;
     &lt;/span&gt;&lt;span class="no"&gt;apt-get clean&lt;/span&gt;&lt;span class="w"&gt;
     &lt;/span&gt;&lt;span class="no"&gt;rm -rf /var/lib/apt/lists&lt;/span&gt;&lt;span class="w"&gt;

&lt;/span&gt;&lt;span class="c1"&gt;# TODO(https://github.com/larswirzenius/vmdb2/issues/24): remove once vmdb&lt;/span&gt;&lt;span class="w"&gt;
&lt;/span&gt;&lt;span class="c1"&gt;# clears /etc/resolv.conf on its own.&lt;/span&gt;&lt;span class="w"&gt;
&lt;/span&gt;&lt;span class="p-Indicator"&gt;-&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nt"&gt;shell&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p-Indicator"&gt;|&lt;/span&gt;&lt;span class="w"&gt;
     &lt;/span&gt;&lt;span class="no"&gt;rm &amp;quot;${ROOT?}/etc/resolv.conf&amp;quot;&lt;/span&gt;&lt;span class="w"&gt;
  &lt;/span&gt;&lt;span class="nt"&gt;root-fs&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="l-Scalar-Plain"&gt;/&lt;/span&gt;
&lt;/pre&gt;
&lt;p&gt;I could not run with vmdb2 installed from Debian archive, so I cloned
raspi3-image-spec and used vmdb2 submodule from it. And here are rest of
commands used for testing the script.&lt;/p&gt;
&lt;pre class="code shell literal-block"&gt;
fallocate&lt;span class="w"&gt; &lt;/span&gt;-l&lt;span class="w"&gt; &lt;/span&gt;4G&lt;span class="w"&gt; &lt;/span&gt;rootdisk.img&lt;span class="w"&gt;
&lt;/span&gt;&lt;span class="c1"&gt;# Create one partition with full disk
&lt;/span&gt;sfdisk&lt;span class="w"&gt; &lt;/span&gt;-f&lt;span class="w"&gt; &lt;/span&gt;rootdisk.img&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;&amp;lt;&amp;lt;EOF
,+
EOF&lt;/span&gt;&lt;span class="w"&gt;
&lt;/span&gt;kpartx&lt;span class="w"&gt; &lt;/span&gt;-av&lt;span class="w"&gt; &lt;/span&gt;rootdisk.img&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="c1"&gt;# mounts on /dev/loop0 for me
&lt;/span&gt;dd&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="k"&gt;if&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;vmdb.img&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nv"&gt;of&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;/dev/loop0&lt;span class="w"&gt;
&lt;/span&gt;sudo&lt;span class="w"&gt; &lt;/span&gt;virt-install&lt;span class="w"&gt; &lt;/span&gt;--name&lt;span class="w"&gt; &lt;/span&gt;experimental&lt;span class="w"&gt; &lt;/span&gt;--memory&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;1024&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;--disk&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nv"&gt;path&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;/dev/loop0&lt;span class="w"&gt; &lt;/span&gt;--controller&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nv"&gt;type&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;scsi,model&lt;span class="o"&gt;=&lt;/span&gt;virtio-scsi&lt;span class="w"&gt; &lt;/span&gt;--boot&lt;span class="w"&gt; &lt;/span&gt;hd&lt;span class="w"&gt; &lt;/span&gt;--network&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nv"&gt;bridge&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;lxcbr0
&lt;/pre&gt;
&lt;p&gt;Once VM booted I could see the root file system is 4G of size instead of 1.5G it
was after using dd to write image on to it. So success!.&lt;/p&gt;
&lt;/div&gt;
</content><category term="devops"/><category term="resize2fs"/><category term="notetoself"/></entry><entry><title>Docker Private Registry and Self Signed Certificates</title><link href="https://copyninja.in/blog/docker-registry-selfsigned-cert.html" rel="alternate"/><published>2018-04-14T19:47:00+05:30</published><updated>2018-04-14T19:47:00+05:30</updated><author><name>copyninja</name></author><id>tag:copyninja.in,2018-04-14:/blog/docker-registry-selfsigned-cert.html</id><summary type="html">&lt;p class="first last"&gt;Post describes additional steps that needs to be taken
while generating a self signed certificates for docker private
registry.&lt;/p&gt;
</summary><content type="html">&lt;p&gt;I was recently experimenting with hosting a private registry on an internal LAN
network for publishing docker private images. I found out that &lt;em&gt;docker-pull&lt;/em&gt;
works only with TLS secured registry. There is possible to run insecure registry
by editing &lt;em&gt;daemon.json&lt;/em&gt; file but its better to use self-signed certificates
instead.&lt;/p&gt;
&lt;p&gt;Once I followed the step and started registry I tried to &lt;em&gt;docker-pull&lt;/em&gt; and it
started complaining about certificate not having any valid names. But this same
certificate worked fine with browsers too, of course you need to add exception
but no other errors were encountered.&lt;/p&gt;
&lt;p&gt;&lt;a class="reference external" href="https://docs.docker.com/registry/insecure/"&gt;Documentation&lt;/a&gt; for Docker does
not speaks any specific settings needs to be done prior to generating a
self-signed certificate so I was bit confused at beginning.A bit of searching
showed up following &lt;a class="reference external" href="https://github.com/docker/for-linux/issues/248"&gt;issue&lt;/a&gt;
filed against docker and then later re-assigned against &lt;a class="reference external" href="https://github.com/golang/go/issues/24293"&gt;*Golang*&lt;/a&gt; for its method of handling x509
certificate. It appears that with valid &lt;em&gt;Subject Alternative Name&lt;/em&gt; Go crypto
library ignores the &lt;em&gt;Common Name&lt;/em&gt;.&lt;/p&gt;
&lt;p&gt;From thread on &lt;a class="reference external" href="https://security.stackexchange.com/questions/74345/provide-subjectaltname-to-openssl-directly-on-command-line"&gt;Security Stack Exchange&lt;/a&gt;
I found the command to create a self-signed certificate to contain self-signed
certificate. Command in excepted answer does not work until you add
&lt;em&gt;--extensions&lt;/em&gt; option to it as mentioned in one of the comments. Full command is
as shown below.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;openssl&lt;span class="w"&gt; &lt;/span&gt;req&lt;span class="w"&gt; &lt;/span&gt;-new&lt;span class="w"&gt; &lt;/span&gt;-sha256&lt;span class="w"&gt; &lt;/span&gt;-key&lt;span class="w"&gt; &lt;/span&gt;domain.key&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="se"&gt;\&lt;/span&gt;
&lt;span class="w"&gt;             &lt;/span&gt;-subj&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;/C=US/ST=CA/O=Acme, Inc./CN=example.com&amp;quot;&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="se"&gt;\&lt;/span&gt;
&lt;span class="w"&gt;             &lt;/span&gt;-reqexts&lt;span class="w"&gt; &lt;/span&gt;SAN&lt;span class="w"&gt; &lt;/span&gt;-extensions&lt;span class="w"&gt; &lt;/span&gt;SAN&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="se"&gt;\&lt;/span&gt;
&lt;span class="w"&gt;             &lt;/span&gt;-config&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="se"&gt;\&lt;/span&gt;
&amp;lt;&lt;span class="o"&gt;(&lt;/span&gt;cat&lt;span class="w"&gt; &lt;/span&gt;/etc/ssl/openssl.cnf&lt;span class="w"&gt; &lt;/span&gt;&amp;lt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="nb"&gt;printf&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;[SAN]\nsubjectAltName=DNS:example.com,DNS:www.example.com&amp;quot;&lt;/span&gt;&lt;span class="o"&gt;))&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;-out&lt;span class="w"&gt; &lt;/span&gt;domain.crt
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;You would need to replace values in &lt;em&gt;-subj&lt;/em&gt; and under &lt;em&gt;[SAN]&lt;/em&gt; extension. Benefit
of this command is you need not modify the &lt;em&gt;/etc/ssl/openssl.conf&lt;/em&gt; file.&lt;/p&gt;
&lt;p&gt;If you do not have a domain name for the registry and using IP address instead
consider replacing &lt;em&gt;[SAN]&lt;/em&gt; section in above command to have &lt;em&gt;IP: &amp;lt;ip-address&amp;gt;&lt;/em&gt;
instead of &lt;em&gt;DNS&lt;/em&gt;.&lt;/p&gt;
&lt;p&gt;Happy hacking.!&lt;/p&gt;
</content><category term="devops"/><category term="docker"/><category term="container"/><category term="openssl"/></entry><entry><title>Docker container as Development Environment</title><link href="https://copyninja.in/blog/docker-dev-environment.html" rel="alternate"/><published>2018-04-14T13:15:00+05:30</published><updated>2018-04-14T13:15:00+05:30</updated><author><name>copyninja</name></author><id>tag:copyninja.in,2018-04-14:/blog/docker-dev-environment.html</id><summary type="html">&lt;p class="first last"&gt;Post describing how Docker can be used to create uniform development
environment in development teams.&lt;/p&gt;
</summary><content type="html">&lt;p&gt;When you have a distributed team working on a project, you need to make sure
that every one uses similar development environment. This is critical if you are
working on embedded systems project. There are multiple possibility for this
scenario.&lt;/p&gt;
&lt;ol class="arabic simple"&gt;
&lt;li&gt;Use a common development server and provide every developer in your team an
account in it.&lt;/li&gt;
&lt;li&gt;Provide description to every one how to setup their development environment
and trust them they will do so.&lt;/li&gt;
&lt;li&gt;Use Docker to provide the developer with ready made environment and use
build server (CI) for creating final deployment binaries.&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;1st approach was most common approach used, but it has some drawbacks. Since its
a shared system you should make sure not every one is able to install or modify
system and hence have a single administrator so that no one accidentally breaks
the development environment. Other problems include forced to use older OS due
to specific requirements of compilers etc.&lt;/p&gt;
&lt;p&gt;2nd approach makes you put your trust on your developer to get the correct
development environment. Of course you need to trust your team, but every one is
a human being and humans can make mistake.&lt;/p&gt;
&lt;div class="section" id="enter-docker"&gt;
&lt;h2&gt;Enter Docker&lt;/h2&gt;
&lt;p&gt;&lt;em&gt;Dockerfile&lt;/em&gt; is best way to document/setup development environment. A developer
can read &lt;em&gt;Dockerfile&lt;/em&gt; and understand what is being done to setup the environment
and simply execute &lt;cite&gt;docker build&lt;/cite&gt; command to generate his/her development
environment, or better you build the image and publish it in either public
registry and if that is not possible put it in a private registry, and ask
developers to pull a image of development environment.&lt;/p&gt;
&lt;p&gt;Don't be scared by &lt;em&gt;private registry&lt;/em&gt;, setting one up is not a humongous task!
Its just couple of docker commands and there is a pretty good &lt;a class="reference external" href="https://docs.docker.com/registry/deploying/#run-a-local-registry"&gt;documentation&lt;/a&gt; available
to set one up.&lt;/p&gt;
&lt;p&gt;While setting up a development environment you need to make sure last
instruction in your &lt;cite&gt;Dockerfile&lt;/cite&gt; is executing the shell of your choice. This is
because when you start a container this last instruction is what actually is run
by docker, and in our case we need to provide developer with a shell all build
toolchain and libraries.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;...
&lt;span class="k"&gt;CMD&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;/bin/bash&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Now developer just needs to get/build the image, start the container and use it
for their work!. To summarize below command is sufficient for developer to run a
fresh environment.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;$&lt;span class="w"&gt; &lt;/span&gt;docker&lt;span class="w"&gt; &lt;/span&gt;build&lt;span class="w"&gt; &lt;/span&gt;-t&lt;span class="w"&gt; &lt;/span&gt;devenv&lt;span class="w"&gt; &lt;/span&gt;.&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="c1"&gt;# If they are building it&lt;/span&gt;

&lt;span class="c1"&gt;# If they are pulling it from say private registry&lt;/span&gt;
$&lt;span class="w"&gt; &lt;/span&gt;docker&lt;span class="w"&gt; &lt;/span&gt;pull&lt;span class="w"&gt; &lt;/span&gt;private-registry-ip/path/to/devenv

$&lt;span class="w"&gt; &lt;/span&gt;docker&lt;span class="w"&gt; &lt;/span&gt;run&lt;span class="w"&gt; &lt;/span&gt;-itd&lt;span class="w"&gt; &lt;/span&gt;--name&lt;span class="w"&gt; &lt;/span&gt;development&lt;span class="w"&gt; &lt;/span&gt;devenv
$&lt;span class="w"&gt; &lt;/span&gt;docker&lt;span class="w"&gt; &lt;/span&gt;attach&lt;span class="w"&gt; &lt;/span&gt;development
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;When container is started it will execute the shell and the next attach command
will attach your shell's input/output to container. Now it can be used just like
normal shell to build the application.&lt;/p&gt;
&lt;p&gt;Another good thing which can be done is sharing the workspace with container so
your container can just contain the toolchain and library that is needed and all
version control, code editing and likewise can be done in the host machine. One
thing that would be needed to make sure is your UID on host and UID of the user
inside the container is same. This can be easily done by creating a separate
user in the container with UID same as your UID on host system.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="advantages"&gt;
&lt;h2&gt;Advantages&lt;/h2&gt;
&lt;p&gt;Some advantages of using docker container include&lt;/p&gt;
&lt;ol class="arabic simple"&gt;
&lt;li&gt;They are easy to setup and saves a lot of time to the team as a whole
compared to traditional approaches.&lt;/li&gt;
&lt;li&gt;Easy to throwaway and start fresh: If a developer thinks he did something
wrong with container he can prune it and create a fresh one based on the
development environment image. So this gives a lot of freedom to developer to
experiment.&lt;/li&gt;
&lt;li&gt;Uniformity: You will be sure that all your team will be using same
evnironment.&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;So you might ask what about other container technologies like systemd-nspawn or
lxc etc. Of course they can also be used in the similar fashion, infact before
experimenting with Docker I was a vivid user of &lt;em&gt;systemd-nspawn&lt;/em&gt; container. You
might have also seen my previous &lt;a class="reference external" href="https://copyninja.info/tags/systemd-nspawn.html"&gt;blog posts&lt;/a&gt; on &lt;em&gt;systemd-nspawn&lt;/em&gt; too.
Only reason I switched to Docker is its easy to setup unlike systemd-nspawn
which needs so many tweaking and tuning of things besides it does not have a
Dockerfile like approach which makes things more time consuming. So for me
Docker won the war and I shifted to using Docker more.&lt;/p&gt;
&lt;p&gt;This entire post was based on my experiment and experience with Docker. If you
feel something can be done in a better way please feel free to write to me.&lt;/p&gt;
&lt;/div&gt;
</content><category term="devops"/><category term="docker"/><category term="container"/></entry><entry><title>My personal Email setup - Notmuch, mbsync, postfix and dovecot</title><link href="https://copyninja.in/blog/email_setup.html" rel="alternate"/><published>2017-12-23T16:43:00+05:30</published><updated>2017-12-23T16:43:00+05:30</updated><author><name>copyninja</name></author><id>tag:copyninja.in,2017-12-23:/blog/email_setup.html</id><summary type="html">&lt;p class="first last"&gt;Brief description of my email setup.&lt;/p&gt;
</summary><content type="html">&lt;p&gt;I've been using personal email setup for quite long and have not documented it
anywhere. Recently when I changed my laptop (a post is pending about it) I got
lost trying to recreate my local mail setup. So this post is a self
documentation so that I don't have to struggle again to get it right.&lt;/p&gt;
&lt;div class="section" id="server-side"&gt;
&lt;h2&gt;Server Side&lt;/h2&gt;
&lt;p&gt;I run my own mail server and I use &lt;em&gt;postfix&lt;/em&gt; as SMTP server and &lt;em&gt;Dovecot&lt;/em&gt; for
the IMAP purpose. I'm not going into detail of setting those up as my setup was
mostly done by using scripts created by Jonas for &lt;em&gt;Redpill&lt;/em&gt; infrastructure. What
redpill is?. (In jonas's own words)&lt;/p&gt;
&lt;blockquote&gt;
&amp;lt;jonas&amp;gt; Redpill is a concept - a way to setup Debian hosts to collaborate
across organisations
&amp;lt;jonas&amp;gt; I develop the concept, and use it for the first ever Redpill
network-of-networks redpill.dk, involving my own network (jones.dk), my main
client's network (homebase.dk), a network in Germany including Skolelinux
Germany (free-owl.de), and Vasudev's network (copyninja.info)&lt;/blockquote&gt;
&lt;p&gt;Along with that I have a dovecot sieve filtering to classify on high level mails
into various folders depending on from where they originate. All the rules live
in the &lt;cite&gt;~/dovecot.sieve&lt;/cite&gt; file under every account which has a mail address.&lt;/p&gt;
&lt;p&gt;Again I'm not going into detail of how to set these things up, as its not goal
of my this post.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="on-my-laptop"&gt;
&lt;h2&gt;On my Laptop&lt;/h2&gt;
&lt;p&gt;On my laptop I've following 4 parts setup&lt;/p&gt;
&lt;ol class="arabic simple"&gt;
&lt;li&gt;Mail syncing : Done using mbsync command&lt;/li&gt;
&lt;li&gt;Classification: Done using notmuch&lt;/li&gt;
&lt;li&gt;Reading: Done using notmuch-emacs&lt;/li&gt;
&lt;li&gt;Mail sending: Done using postfix running as relay server and SMTP client.&lt;/li&gt;
&lt;/ol&gt;
&lt;/div&gt;
&lt;div class="section" id="mail-syncing"&gt;
&lt;h2&gt;Mail Syncing&lt;/h2&gt;
&lt;p&gt;Mail syncing is done using &lt;cite&gt;mbsync&lt;/cite&gt; tool, I was previously user of offlineimap
and recently switched to &lt;cite&gt;mbsync&lt;/cite&gt; as I felt it more lighter and simpler to
configure than &lt;cite&gt;offlineimap&lt;/cite&gt;. &lt;cite&gt;mbsync&lt;/cite&gt; command is provided by package &lt;cite&gt;isync&lt;/cite&gt;.&lt;/p&gt;
&lt;p&gt;Configuration file is &lt;em&gt;~/.mbsyncrc&lt;/em&gt;. Below is my sample content with some
private things redacted.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="na"&gt;IMAPAccount  copyninja&lt;/span&gt;
&lt;span class="na"&gt;Host imap.copyninja.info&lt;/span&gt;
&lt;span class="na"&gt;User vasudev&lt;/span&gt;
&lt;span class="na"&gt;PassCmd      &amp;quot;gpg -q --for-your-eyes-only --no-tty --exit-on-status-write-error --batch --passphrase-file ~/path/to/passphrase.txt -d ~/path/to/mailpass.gpg&amp;quot;&lt;/span&gt;
&lt;span class="na"&gt;SSLType IMAPS&lt;/span&gt;
&lt;span class="na"&gt;SSLVersion TLSv1.2&lt;/span&gt;
&lt;span class="na"&gt;CertificateFile /etc/ssl/certs/ca-certificates.crt&lt;/span&gt;


&lt;span class="na"&gt;IMAPAccount gmail-kamathvasudev&lt;/span&gt;
&lt;span class="na"&gt;Host imap.gmail.com&lt;/span&gt;
&lt;span class="na"&gt;User kamathvasudev@gmail.com&lt;/span&gt;
&lt;span class="na"&gt;PassCmd &amp;quot;gpg -q --for-your-eyes-only --no-tty --exit-on-status-write-error --batch --passphrase-file ~/path/to/passphrase.txt -d ~/path/to/mailpass.gpg&amp;quot;&lt;/span&gt;
&lt;span class="na"&gt;SSLType IMAPS&lt;/span&gt;
&lt;span class="na"&gt;SSLVersion TLSv1.2&lt;/span&gt;
&lt;span class="na"&gt;CertificateFile /etc/ssl/certs/ca-certificates.crt&lt;/span&gt;

&lt;span class="na"&gt;IMAPStore copyninja-remote&lt;/span&gt;
&lt;span class="na"&gt;Account copyninja&lt;/span&gt;

&lt;span class="na"&gt;IMAPStore gmail-kamathvasudev-remote&lt;/span&gt;
&lt;span class="na"&gt;Account gmail-kamathvasudev&lt;/span&gt;

&lt;span class="na"&gt;MaildirStore copyninja-local&lt;/span&gt;
&lt;span class="na"&gt;Path ~/Mail/vasudev-copyninja.info/&lt;/span&gt;
&lt;span class="na"&gt;Inbox ~/Mail/vasudev-copyninja.info/INBOX&lt;/span&gt;

&lt;span class="na"&gt;MaildirStore gmail-kamathvasudev-local&lt;/span&gt;
&lt;span class="na"&gt;Path ~/Mail/Gmail-1/&lt;/span&gt;
&lt;span class="na"&gt;Inbox ~/Mail/Gmail-1/INBOX&lt;/span&gt;

&lt;span class="na"&gt;Channel copyninja&lt;/span&gt;
&lt;span class="na"&gt;Master&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt;&lt;span class="s"&gt;copyninja-remote:&lt;/span&gt;
&lt;span class="na"&gt;Slave&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt;&lt;span class="s"&gt;copyninja-local:&lt;/span&gt;
&lt;span class="na"&gt;Patterns *&lt;/span&gt;
&lt;span class="na"&gt;Create Both&lt;/span&gt;
&lt;span class="na"&gt;SyncState *&lt;/span&gt;
&lt;span class="na"&gt;Sync All&lt;/span&gt;

&lt;span class="na"&gt;Channel gmail-kamathvasudev&lt;/span&gt;
&lt;span class="na"&gt;Master&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt;&lt;span class="s"&gt;gmail-kamathvasudev-remote:&lt;/span&gt;
&lt;span class="na"&gt;Slave&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt;&lt;span class="s"&gt;gmail-kamathvasudev-local:&lt;/span&gt;
&lt;span class="c1"&gt;# Exclude everything under the internal [Gmail] folder, except the interesting folders&lt;/span&gt;
&lt;span class="na"&gt;Patterns * ![Gmail]*&lt;/span&gt;
&lt;span class="na"&gt;Create Both&lt;/span&gt;
&lt;span class="na"&gt;SyncState *&lt;/span&gt;
&lt;span class="na"&gt;Sync All&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Explanation for some interesting part in above configuration. One is the
&lt;em&gt;PassCmd&lt;/em&gt; which allows you to provide shell command to obtain the password for
the account. This avoids filling in the password in configuration file. I'm
using symmetric encryption with gpg and storing password some where on my disk.
Which is of course just safe guarded by Unix ACL.&lt;/p&gt;
&lt;p&gt;I actually wanted to use my public key to encrypt the file but unlocking the
file when script is run in background or via systemd looks difficult (or looked
nearly impossible). If you have better suggestion I'm all ears :-).&lt;/p&gt;
&lt;p&gt;Next instruction part is &lt;em&gt;Patterns&lt;/em&gt;. This allows you to selectively sync mail
from your mail server. This was really helpful for me to exclude all crappy
&lt;em&gt;[Gmail]/&lt;/em&gt; folders.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="mail-classification"&gt;
&lt;h2&gt;Mail Classification&lt;/h2&gt;
&lt;p&gt;Once mail is locally on your device, we need a way to read the mails easily in a
mail reader. My original setup was serving synced &lt;em&gt;Maildir&lt;/em&gt; using local dovecot
instance and read it in &lt;em&gt;Gnus&lt;/em&gt;. This setup was bit of a over kill with all
server software setups but inability of Gnus to not cope well with &lt;em&gt;Maildir&lt;/em&gt;
format this was best way to do it. This setup also has a disadvantage, that is
searching a mail quickly when you have huge pile of mail to go through. This is
where &lt;em&gt;notmuch&lt;/em&gt; comes into picture.&lt;/p&gt;
&lt;p&gt;&lt;em&gt;notmuch&lt;/em&gt; allows me to easily index through Gigabytes of my mail archives and
get what I need very easily. I've created a small script which combines
executing of &lt;cite&gt;mbsync&lt;/cite&gt; and &lt;cite&gt;notmuch&lt;/cite&gt; execution. I tag mails based on the Maildirs
which are actually created on server side using dovecot sieve. Below is my full
shell script which is doing task of syncing classification and deleting of
spams.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="ch"&gt;#!/bin/sh&lt;/span&gt;

&lt;span class="nv"&gt;MBSYNC&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="k"&gt;$(&lt;/span&gt;pgrep&lt;span class="w"&gt; &lt;/span&gt;mbsync&lt;span class="k"&gt;)&lt;/span&gt;
&lt;span class="nv"&gt;NOTMUCH&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="k"&gt;$(&lt;/span&gt;pgrep&lt;span class="w"&gt; &lt;/span&gt;notmuch&lt;span class="k"&gt;)&lt;/span&gt;

&lt;span class="k"&gt;if&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;[&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;-n&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;&lt;/span&gt;&lt;span class="nv"&gt;$MBSYNC&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;-o&lt;span class="w"&gt; &lt;/span&gt;-n&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;&lt;/span&gt;&lt;span class="nv"&gt;$NOTMUCH&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;]&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="k"&gt;then&lt;/span&gt;
&lt;span class="w"&gt;   &lt;/span&gt;&lt;span class="nb"&gt;echo&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;Already running one instance of mail-sync. Exiting...&amp;quot;&lt;/span&gt;
&lt;span class="w"&gt;         &lt;/span&gt;&lt;span class="nb"&gt;exit&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;0&lt;/span&gt;
&lt;span class="k"&gt;fi&lt;/span&gt;

&lt;span class="nb"&gt;echo&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;Deleting messages tagged as *deleted*&amp;quot;&lt;/span&gt;
notmuch&lt;span class="w"&gt; &lt;/span&gt;search&lt;span class="w"&gt; &lt;/span&gt;--format&lt;span class="o"&gt;=&lt;/span&gt;text0&lt;span class="w"&gt; &lt;/span&gt;--output&lt;span class="o"&gt;=&lt;/span&gt;files&lt;span class="w"&gt; &lt;/span&gt;tag:deleted&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;|&lt;/span&gt;xargs&lt;span class="w"&gt; &lt;/span&gt;-0&lt;span class="w"&gt; &lt;/span&gt;--no-run-if-empty&lt;span class="w"&gt; &lt;/span&gt;rm&lt;span class="w"&gt; &lt;/span&gt;-v

&lt;span class="nb"&gt;echo&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;Moving spam to Spam folder&amp;quot;&lt;/span&gt;
notmuch&lt;span class="w"&gt; &lt;/span&gt;search&lt;span class="w"&gt; &lt;/span&gt;--format&lt;span class="o"&gt;=&lt;/span&gt;text0&lt;span class="w"&gt; &lt;/span&gt;--output&lt;span class="o"&gt;=&lt;/span&gt;files&lt;span class="w"&gt; &lt;/span&gt;tag:Spam&lt;span class="w"&gt; &lt;/span&gt;and&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="se"&gt;\&lt;/span&gt;
&lt;span class="w"&gt;  &lt;/span&gt;to:vasudev@copyninja.info&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;|&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="se"&gt;\&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;xargs&lt;span class="w"&gt; &lt;/span&gt;-0&lt;span class="w"&gt; &lt;/span&gt;-I&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;{}&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;--no-run-if-empty&lt;span class="w"&gt; &lt;/span&gt;mv&lt;span class="w"&gt; &lt;/span&gt;-v&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;{}&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;~/Mail/vasudev-copyninja.info/Spam/cur
notmuch&lt;span class="w"&gt; &lt;/span&gt;search&lt;span class="w"&gt; &lt;/span&gt;--format&lt;span class="o"&gt;=&lt;/span&gt;text0&lt;span class="w"&gt; &lt;/span&gt;--output&lt;span class="o"&gt;=&lt;/span&gt;files&lt;span class="w"&gt; &lt;/span&gt;tag:Spam&lt;span class="w"&gt; &lt;/span&gt;and
&lt;span class="w"&gt;  &lt;/span&gt;to:vasudev-debian@copyninja.info&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;|&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="se"&gt;\&lt;/span&gt;
&lt;span class="w"&gt;     &lt;/span&gt;xargs&lt;span class="w"&gt; &lt;/span&gt;-0&lt;span class="w"&gt; &lt;/span&gt;-I&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;{}&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;--no-run-if-empty&lt;span class="w"&gt; &lt;/span&gt;mv&lt;span class="w"&gt; &lt;/span&gt;-v&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;{}&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;~/Mail/vasudev-copyninja.info/Spam/cur


&lt;span class="nv"&gt;MDIR&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;vasudev-copyninja.info vasudev-debian Gmail-1&amp;quot;&lt;/span&gt;
mbsync&lt;span class="w"&gt; &lt;/span&gt;-Va
notmuch&lt;span class="w"&gt; &lt;/span&gt;new

&lt;span class="k"&gt;for&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;mdir&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="k"&gt;in&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nv"&gt;$MDIR&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="k"&gt;do&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="nb"&gt;echo&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;Processing &lt;/span&gt;&lt;span class="nv"&gt;$mdir&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="k"&gt;for&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;fdir&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="k"&gt;in&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="k"&gt;$(&lt;/span&gt;ls&lt;span class="w"&gt; &lt;/span&gt;-d&lt;span class="w"&gt; &lt;/span&gt;/home/vasudev/Mail/&lt;span class="nv"&gt;$mdir&lt;/span&gt;/*&lt;span class="k"&gt;)&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="k"&gt;do&lt;/span&gt;
&lt;span class="w"&gt;      &lt;/span&gt;&lt;span class="k"&gt;if&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;[&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="k"&gt;$(&lt;/span&gt;basename&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nv"&gt;$fdir&lt;/span&gt;&lt;span class="k"&gt;)&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;!&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;INBOX&amp;quot;&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;]&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="k"&gt;then&lt;/span&gt;
&lt;span class="w"&gt;          &lt;/span&gt;&lt;span class="nb"&gt;echo&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;Tagging for &lt;/span&gt;&lt;span class="k"&gt;$(&lt;/span&gt;basename&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nv"&gt;$fdir&lt;/span&gt;&lt;span class="k"&gt;)&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;&lt;/span&gt;
&lt;span class="w"&gt;          &lt;/span&gt;notmuch&lt;span class="w"&gt; &lt;/span&gt;tag&lt;span class="w"&gt; &lt;/span&gt;+&lt;span class="k"&gt;$(&lt;/span&gt;basename&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nv"&gt;$fdir&lt;/span&gt;&lt;span class="k"&gt;)&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;-inbox&lt;span class="w"&gt; &lt;/span&gt;--&lt;span class="w"&gt; &lt;/span&gt;folder:&lt;span class="nv"&gt;$mdir&lt;/span&gt;/&lt;span class="k"&gt;$(&lt;/span&gt;basename&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nv"&gt;$fdir&lt;/span&gt;&lt;span class="k"&gt;)&lt;/span&gt;
&lt;span class="w"&gt;      &lt;/span&gt;&lt;span class="k"&gt;fi&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="k"&gt;done&lt;/span&gt;
&lt;span class="k"&gt;done&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;So before running mbsync I search for all mails tagged as &lt;em&gt;deleted&lt;/em&gt; and delete
them from system. Next I look for mails tagged as &lt;em&gt;Spam&lt;/em&gt; on both my accounts and
move it to Spam folder. Yeah you got it right these are mails escaping the spam
filter and landing in my inbox and personally marked as Spam.&lt;/p&gt;
&lt;p&gt;After running mbsync I tag mails based on their folder (searching string
&lt;em&gt;folder:&lt;/em&gt;). This allows me easily get contents of lets say a mailing list
without remembering the list address.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="reading-mails"&gt;
&lt;h2&gt;Reading Mails&lt;/h2&gt;
&lt;p&gt;Now that we have synced and classified mail its time to setup the reading part.
I use notmuch-emacs interface to read the mails. I use &lt;em&gt;Spacemacs&lt;/em&gt; flavor of
emacs so I took some time to write down the a private layer which brings
together all my keybindings and classification in one place and does not clutter
my entire &lt;em&gt;.spacemacs&lt;/em&gt; file. You can find the code for my private layer in
&lt;a class="reference external" href="https://source.copyninja.info/notmuch-emacs-layer.git/"&gt;notmuch-emacs-layer repository&lt;/a&gt;&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="sending-mails"&gt;
&lt;h2&gt;Sending Mails&lt;/h2&gt;
&lt;p&gt;Well its not sufficient that if we can read mails, we need to be able to reply
to mail. And this was the slightly tricky part where I recently got lost and had
to write this post so that I don't forget it again. (And of course don't have to
refer some outdated posts on web).&lt;/p&gt;
&lt;p&gt;My setup to send mails is using &lt;em&gt;postfix&lt;/em&gt; as SMTP client with my own SMTP server
as relayhost for it. The problem of relaying is it's not for the hosts with
dynamic IP. There are couple of ways to allow hosts with dynamic IP to use relay
servers, one is put the IP address from where mail will originate into
&lt;em&gt;my_network&lt;/em&gt; or second use SASL authentication.&lt;/p&gt;
&lt;p&gt;My preferred way is use of SASL authentication. For this I first had to create a
separate account one for each machine which is going to relay the mails to my
main server. Idea is to not use my primary account for SASL authentication.
(Originally I was using primary account, but Jonas gave this idea of account per
road runner).&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;adduser&lt;span class="w"&gt; &lt;/span&gt;&amp;lt;hostname&amp;gt;_relay
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Here replace &amp;lt;hostname&amp;gt; with name of your laptop/desktop or whatever you are
using. Now we need to adjust postfix to act as relaying server. So add following
lines to postfix configuration&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="c1"&gt;# SASL authentication&lt;/span&gt;
&lt;span class="na"&gt;smtp_sasl_auth_enable&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;yes&lt;/span&gt;
&lt;span class="na"&gt;smtp_tls_security_level&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;encrypt&lt;/span&gt;
&lt;span class="na"&gt;smtp_sasl_tls_security_options&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;noanonymous&lt;/span&gt;
&lt;span class="na"&gt;relayhost&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;[smtp.copyninja.info]:submission&lt;/span&gt;
&lt;span class="na"&gt;smtp_sasl_password_maps&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;hash:/etc/postfix/sasl_passwd&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;So here relayhost is the server name which your postfix instance will be using
to relay mails forward into internet. &lt;em&gt;:submission&lt;/em&gt; part tells postfix to
forward mail on to port 587 (secure). &lt;em&gt;smtp_sasl_tls_security_options&lt;/em&gt; is set to
disallow anonymous connection. This is must so that relay server trusts your
mobile host and agrees to forward the mail for you.&lt;/p&gt;
&lt;p&gt;&lt;em&gt;/etc/postfix/sasl_passwd&lt;/em&gt; is the file where you need to store password for
account to be used for SASL authentication with server. Put following content
into it.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;[smtp.example.com]:submission    user:password
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Replace smtp.example.com with your SMTP server name which you have put in
&lt;em&gt;relayhost&lt;/em&gt; configuration. Replace user with &amp;lt;hostname&amp;gt;_relay user you created
and its password.&lt;/p&gt;
&lt;p&gt;To secure the sasl_passwd file and create a hash of it for postfix use following
command.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;chown&lt;span class="w"&gt; &lt;/span&gt;root:root&lt;span class="w"&gt; &lt;/span&gt;/etc/postfix/sasl_passwd
chmod&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;0600&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;/etc/postfix/sasl_passwd
postmap&lt;span class="w"&gt; &lt;/span&gt;/etc/postfix/sasl_passwd
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;The last command will create /etc/postfix/sasl_passwd.db file which is hash of
your file /etc/postfix/sasl_passwd with same owner and permission. Now reload
the postfix and check if mail makes out of your system using mail command.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="bonus-part"&gt;
&lt;h2&gt;Bonus Part&lt;/h2&gt;
&lt;p&gt;Well since I've a script created above bringing together mail syncing and
classification. I went ahead and created a systemd timer to periodically sync
mails in the background. In my case every 10 minutes. Below is &lt;em&gt;mailsync.timer&lt;/em&gt;
file.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="k"&gt;[Unit]&lt;/span&gt;
&lt;span class="na"&gt;Description&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s"&gt;Check Mail Every 10 minutes&lt;/span&gt;
&lt;span class="na"&gt;RefuseManualStart&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s"&gt;no&lt;/span&gt;
&lt;span class="na"&gt;RefuseManualStop&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s"&gt;no&lt;/span&gt;

&lt;span class="k"&gt;[Timer]&lt;/span&gt;
&lt;span class="na"&gt;Persistent&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s"&gt;false&lt;/span&gt;
&lt;span class="na"&gt;OnBootSec&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s"&gt;5min&lt;/span&gt;
&lt;span class="na"&gt;OnUnitActiveSec&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s"&gt;10min&lt;/span&gt;
&lt;span class="na"&gt;Unit&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s"&gt;mailsync.service&lt;/span&gt;

&lt;span class="k"&gt;[Install]&lt;/span&gt;
&lt;span class="na"&gt;WantedBy&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s"&gt;default.target&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Below is &lt;em&gt;mailsync.service&lt;/em&gt; which is needed by mailsync.timer to execute our
scripts.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="k"&gt;[Unit]&lt;/span&gt;
&lt;span class="na"&gt;Description&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s"&gt;Check Mail&lt;/span&gt;
&lt;span class="na"&gt;RefuseManualStart&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s"&gt;no&lt;/span&gt;
&lt;span class="na"&gt;RefuseManualStop&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s"&gt;yes&lt;/span&gt;

&lt;span class="k"&gt;[Service]&lt;/span&gt;
&lt;span class="na"&gt;Type&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s"&gt;oneshot&lt;/span&gt;
&lt;span class="na"&gt;ExecStart&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s"&gt;/usr/local/bin/mail-sync&lt;/span&gt;
&lt;span class="na"&gt;StandardOutput&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s"&gt;syslog&lt;/span&gt;
&lt;span class="na"&gt;StandardError&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s"&gt;syslog&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Put these files under /etc/systemd/user and run below command to enable them.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;systemctl&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nb"&gt;enable&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;--user&lt;span class="w"&gt; &lt;/span&gt;mailsync.timer
systemctl&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nb"&gt;enable&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;--user&lt;span class="w"&gt; &lt;/span&gt;mailsync.service
systemctl&lt;span class="w"&gt; &lt;/span&gt;start&lt;span class="w"&gt; &lt;/span&gt;--user&lt;span class="w"&gt; &lt;/span&gt;mailsync.timer
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;So that's how I've sync and send mail from my system. I came to know about
&lt;em&gt;afew&lt;/em&gt; from Jonas Smedegaard who also proof read this post. So next step I will
try to improve my notmuch configuration using afew and of course a post will
follow after that :-).&lt;/p&gt;
&lt;/div&gt;
</content><category term="devops"/><category term="email"/><category term="notmuch"/><category term="mbsync"/></entry><entry><title>Switching from approx to apt-cacher-ng</title><link href="https://copyninja.in/blog/approx_to_acng.html" rel="alternate"/><published>2016-07-17T16:30:00+05:30</published><updated>2016-07-17T16:30:00+05:30</updated><author><name>copyninja</name></author><id>tag:copyninja.in,2016-07-17:/blog/approx_to_acng.html</id><summary type="html">&lt;p class="first last"&gt;Brief notes on my switch from approx to apt-cacher-ng&lt;/p&gt;
</summary><content type="html">&lt;p&gt;After a long ~5 years (from 2011) journey with approx I finally wanted
to switch to something new like apt-cacher-ng. And after a bit of
changes I finally managed to get apt-cacher-ng into my work flow.&lt;/p&gt;
&lt;div class="section" id="bit-of-history"&gt;
&lt;h2&gt;Bit of History&lt;/h2&gt;
&lt;p&gt;I should first give you a brief on how I started using approx. It all
started in MiniDebconf 2011 which I organized at my Alma-mater. I met
Jonas Smedegaard here and from him I learned about approx. Jonas has a
bunch of machines at his home and he was active user of approx and he
showed it to me while explaining the &lt;em&gt;Boxer&lt;/em&gt; project. I was quite
impressed with approx. Back then I was using a 230kbps slow INTERNET
connection and I was also maintaining a couple of packages in
Debian. Updating the pbuilder chroots was time consuming task for me
as I had to download multiple times over slow net. And approx largely
solved this problem and I started using it.&lt;/p&gt;
&lt;p&gt;5 years fast forward I now have quite fast INTERNET with good
FUP. (About 50GB a month), but I still tend to use approx which makes
building packages quite faster. I also use couple of containers on my
laptop which all use my laptop as approx cache.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="why-switch"&gt;
&lt;h2&gt;Why switch?&lt;/h2&gt;
&lt;p&gt;So why change to apt-cacher-ng?. Approx is a simple tool, it runs
mainly with inetd and sits between apt and the repository on
INTERNET. Where as apt-cacher-ng provides a lot of features. Below are
some listed from the apt-cacher-ng manual.&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;use of TLS/SSL repositories (may be possible with approx but I'm notsure how to do it)&lt;/li&gt;
&lt;li&gt;Access control of who can access caching server&lt;/li&gt;
&lt;li&gt;Integration with debdelta (I've not tried, approx also supports
debdelta)&lt;/li&gt;
&lt;li&gt;Avoiding use of apt-cacher-ng for some hosts&lt;/li&gt;
&lt;li&gt;Avoiding caching of some file types&lt;/li&gt;
&lt;li&gt;Partial mirroring for offline usage.&lt;/li&gt;
&lt;li&gt;Selection of ipv4 or ipv6 for connections.&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;The biggest change I see is the speed difference between approx and
apt-cacher-ng. I think this is mainly because apt-cacher-ng is threaded where as approx
runs using inetd.&lt;/p&gt;
&lt;p&gt;I do not want all features of apt-cacher-ng at the moment, but who knows in
future I might need some features and hence I decided to switch to
apt-cacher-ng over approx.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="transition"&gt;
&lt;h2&gt;Transition&lt;/h2&gt;
&lt;p&gt;Transition from approx to apt-cacher-ng was smoother than I
expected. There are 2 approaches you can use one is explicit routing
another is transparent routing. I prefer transparent routing and I
only had to change my /etc/apt/sources.list to use the actual
repository URL.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="k"&gt;deb&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;http://deb.debian.org/debian&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="kp"&gt;unstable&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="kp"&gt;main&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="kp"&gt;contrib&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="kp"&gt;non-free&lt;/span&gt;
&lt;span class="k"&gt;deb-src&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;http://deb.debian.org/debian&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="kp"&gt;unstable&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="kp"&gt;main&lt;/span&gt;

&lt;span class="k"&gt;deb&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;http://deb.debian.org/debian&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="kp"&gt;experimental&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="kp"&gt;main&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="kp"&gt;contrib&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="kp"&gt;non-free&lt;/span&gt;
&lt;span class="k"&gt;deb-src&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;http://deb.debian.org/debian&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="kp"&gt;experimental&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="kp"&gt;main&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;After above change I had to add a &lt;em&gt;01proxy&lt;/em&gt; configuration file to
&lt;em&gt;/etc/apt/apt.conf.d/&lt;/em&gt; with following content.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;Acquire::http::Proxy &amp;quot;http://localhost:3142/&amp;quot;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;I use explicit routing only when using apt-cacher-ng with pbuilder and
debootstrap. Following snippet shows explicit routing through &lt;em&gt;/etc/apt/sources.list&lt;/em&gt;.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="k"&gt;deb&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;http://localhost:3142/deb.debian.org/debian&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="kp"&gt;unstable&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="kp"&gt;main&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;div class="section" id="usage-with-pbuilder-and-friends"&gt;
&lt;h3&gt;Usage with pbuilder and friends&lt;/h3&gt;
&lt;p&gt;To use apt-cacher-ng with pbuilder you need to modify /etc/pbuilderrc
to contain following line&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="nv"&gt;MIRRORSITE&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;http://localhost:3142/deb.debian.org/debian
&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;div class="section" id="usage-with-debootstrap"&gt;
&lt;h3&gt;Usage with debootstrap&lt;/h3&gt;
&lt;p&gt;To use apt-cacher-ng with debootstrap, pass MIRROR argument of
debootstrap as &lt;cite&gt;http://localhost:3142/deb.debian.org/debian&lt;/cite&gt;.&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class="section" id="conclusion"&gt;
&lt;h2&gt;Conclusion&lt;/h2&gt;
&lt;p&gt;I've now completed full transition of my work flow to apt-cacher-ng
and purged approx and its cache.&lt;/p&gt;
&lt;div class="strike docutils container"&gt;
Though it works fine I feel that there will be 2 caches created when
you use transparent and explicit proxy using localhost:3142 URL. I'm
sure it is possible to configure this to avoid duplication, but I've
not yet figured it. If you know how to fix this do let me know.&lt;/div&gt;
&lt;div class="section" id="update"&gt;
&lt;h3&gt;Update&lt;/h3&gt;
&lt;p&gt;Jonas told me that its not 2 caches but 2 routing paths, one for
transparent routing and another for explicit routing. So I guess there
is nothing here to fix :-).&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
</content><category term="devops"/><category term="apt"/><category term="approx"/><category term="apt-cacher-ng"/><category term="debian"/></entry><entry><title>Managing Virtual Network Devices with systemd-networkd</title><link href="https://copyninja.in/blog/systemd-networkd-networking.html" rel="alternate"/><published>2016-01-10T22:26:00+05:30</published><updated>2016-01-10T22:26:00+05:30</updated><author><name>copyninja</name></author><id>tag:copyninja.in,2016-01-10:/blog/systemd-networkd-networking.html</id><summary type="html">&lt;p class="first last"&gt;Using systemd-networkd to manage virtual network devices in
Linux&lt;/p&gt;
</summary><content type="html">&lt;p&gt;I've been using bridge networking and tap networking for containers
and virtual machines on my system. Configuration for bridge network
which I use to connect containers was configured using
&lt;em&gt;/etc/network/interfaces&lt;/em&gt; file as shown below.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;auto natbr0
iface natbr0 inet static
   address 172.16.10.1
   netmask 255.255.255.0
   pre-up brctl addbr natbr0
   post-down brctl delbr natbr0
   post-down sysctl net.ipv4.ip_forward=0
   post-down sysctl net.ipv6.conf.all.forwarding=0
   post-up sysctl net.ipv4.ip_forward=1
   post-up sysctl net.ipv6.conf.all.forwarding=1
   post-up iptables -A POSTROUTING -t mangle -p udp --dport bootpc -s 172.16.0.0/16 -j CHECKSUM --checksum-fill
   pre-down iptables -D POSTROUTING -t mangle -p udp --dport bootpc -s 172.16.0.0/16 -j CHECKSUM --checksum-fill
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Basically I setup masquerading and IP forwarding when network comes up
using this, so all my containers and virtual machines can access
internet.&lt;/p&gt;
&lt;p&gt;This can be simply done using systemd-networkd with couple of lines,
yes couple of lines. For this to work first you need to enable
systemd-networkd.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;systemctl&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nb"&gt;enable&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;systemd-networkd.service
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Now I need to write 2 configuration file for the above bridge
interface under &lt;em&gt;/etc/systemd/network&lt;/em&gt;. One file is &lt;em&gt;natbr0.netdev&lt;/em&gt;
which configures the bridge and the &lt;em&gt;natbr0.network&lt;/em&gt; which configures
IP address and other stuff for the bridge interface.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="c1"&gt;#natbr0.netdev&lt;/span&gt;
&lt;span class="k"&gt;[NetDev]&lt;/span&gt;
&lt;span class="na"&gt;Description&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s"&gt;Bridge interface for containers/vms&lt;/span&gt;
&lt;span class="na"&gt;Name&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s"&gt;natbr0&lt;/span&gt;
&lt;span class="na"&gt;Kind&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s"&gt;bridge&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="c1"&gt;#natbr0.network&lt;/span&gt;
&lt;span class="k"&gt;[Match]&lt;/span&gt;
&lt;span class="na"&gt;Name&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s"&gt;natbr0&lt;/span&gt;

&lt;span class="k"&gt;[Network]&lt;/span&gt;
&lt;span class="na"&gt;Description&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s"&gt;IP configuration for natbr0&lt;/span&gt;
&lt;span class="na"&gt;Address&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s"&gt;172.16.10.1/16&lt;/span&gt;
&lt;span class="na"&gt;IPForward&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s"&gt;yes&lt;/span&gt;
&lt;span class="na"&gt;IPMasquerade&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s"&gt;yes&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;The &lt;em&gt;IPForward&lt;/em&gt; in above configuration is actually redundant, when I
set &lt;em&gt;IPMasquerade&lt;/em&gt; it automatically enables IPForward. So these
configuration is equivalent of what I did in my &lt;em&gt;interfaces&lt;/em&gt; file. It
also avoids me doing additional &lt;em&gt;iptables&lt;/em&gt; usage to add masquerading
rules. This pretty much simplifies handling of virtual network
devices.&lt;/p&gt;
&lt;p&gt;There are many other things which can you do with systemd-networkd,
like running a DHCPServer on the interface and many other things. I
suggest you to read manual pages on &lt;em&gt;systemd.network(5)&lt;/em&gt; and
&lt;em&gt;systemd.netdev(5)&lt;/em&gt;.&lt;/p&gt;
&lt;p&gt;systemd-networkd allows you configure all type of virtual networking
devices and actual network interfaces. I've not myself used it to
handle actual network interfaces yet.&lt;/p&gt;
</content><category term="devops"/><category term="systemd-networkd"/><category term="systemd"/><category term="networking"/></entry><entry><title>Persisting resource control options for systemd-nspawn containers</title><link href="https://copyninja.in/blog/persist_resource_control.html" rel="alternate"/><published>2015-12-15T20:30:00+05:30</published><updated>2015-12-15T20:30:00+05:30</updated><author><name>copyninja</name></author><id>tag:copyninja.in,2015-12-15:/blog/persist_resource_control.html</id><summary type="html">&lt;p class="first last"&gt;Steps to persist the resource control options for
systemd-nspawn containers.&lt;/p&gt;
</summary><content type="html">&lt;p&gt;In my previous &lt;a class="reference external" href="https://copyninja.info/blog/taming_systemd_nsapwn.html"&gt;post on systemd-nspawn&lt;/a&gt; I
mentioned, I was unclear on how to persist resource control options
for a container.  Today I accidentally discovered how can the property
be persisted across boot without modifying service file or writing
custom service file for container. It is done using &lt;em&gt;systemctl
set-property&lt;/em&gt;&lt;/p&gt;
&lt;p&gt;To set &lt;em&gt;CPUAccounting&lt;/em&gt; and &lt;em&gt;CPUShares&lt;/em&gt; for a container we need to run
following command.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;systemctl&lt;span class="w"&gt; &lt;/span&gt;set-property&lt;span class="w"&gt; &lt;/span&gt;systemd-nspawn@container.service&lt;span class="w"&gt;  &lt;/span&gt;&lt;span class="nv"&gt;CPUACCounting&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="m"&gt;1&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nv"&gt;CPUShares&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="m"&gt;200&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;This actually persists these settings at location,
&lt;em&gt;/etc/systemd/systemd-nspawn&amp;#64;container.service.d/&lt;/em&gt; folder. So in our
case there will be 2 files created under above location by name
&lt;em&gt;50-CPUAccounting.conf&lt;/em&gt; and &lt;em&gt;50-CPUShares.conf&lt;/em&gt; with following
contents.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="c1"&gt;# 50-CPUAccounting.conf&lt;/span&gt;
&lt;span class="k"&gt;[Service]&lt;/span&gt;
&lt;span class="na"&gt;CPUAccounting&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s"&gt;yes&lt;/span&gt;

&lt;span class="c1"&gt;# 50-CPUShares.conf&lt;/span&gt;
&lt;span class="k"&gt;[Service]&lt;/span&gt;
&lt;span class="na"&gt;CPUShares&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s"&gt;200&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Today when I discovered this folder and saw the file contents, I
became curious and started to wonder who created this folder. The look
at systemctl man page made showed me this.&lt;/p&gt;
&lt;blockquote&gt;
&lt;dl class="docutils"&gt;
&lt;dt&gt;set-property NAME ASSIGNMENT...&lt;/dt&gt;
&lt;dd&gt;&lt;p class="first"&gt;Set the specified unit properties at runtime where this is
supported. This allows changing configuration parameter
properties such as resource control settings at
runtime. Not all properties may be changed at runtime, but
many resource control settings (primarily those in
systemd.resource-control(5)) may. The changes are applied
instantly, and stored on disk for future boots,
unless --runtime is passed, in which case the settings only
apply until the next reboot. The syntax of the property
assignment follows closely the syntax of assignments in
unit files.&lt;/p&gt;
&lt;p&gt;Example: systemctl set-property foobar.service CPUShares=777&lt;/p&gt;
&lt;p class="last"&gt;Note that this command allows changing multiple properties
at the same time, which is preferable over setting them
individually. Like unit file configuration settings,
assigning the empty list to list parameters will reset the
list.&lt;/p&gt;
&lt;/dd&gt;
&lt;/dl&gt;
&lt;/blockquote&gt;
&lt;p&gt;I did remember doing this for my container and hence it became clear
these files are actually written by &lt;em&gt;systemctl set-property&lt;/em&gt;.&lt;/p&gt;
&lt;p&gt;In case you don't want to persist the properties across boot you can
simply pass &lt;em&gt;--runtime&lt;/em&gt; switch.&lt;/p&gt;
&lt;p&gt;Basically this is not just for container, resource control can be thus
applied to any running service on the system. This is actually cool.&lt;/p&gt;
</content><category term="devops"/><category term="systemd"/><category term="systemd-nspawn"/><category term="resource-control"/><category term="containers"/></entry><entry><title>Ordering mount points in Jessie (systemd &lt; 220)</title><link href="https://copyninja.in/blog/ordering_mount_in_jessie.html" rel="alternate"/><published>2015-12-14T22:26:00+05:30</published><updated>2015-12-14T22:26:00+05:30</updated><author><name>copyninja</name></author><id>tag:copyninja.in,2015-12-14:/blog/ordering_mount_in_jessie.html</id><summary type="html">&lt;p class="first last"&gt;Describes on how to achieve mount ordering in Jessie where
x-systemd.requires is not present.&lt;/p&gt;
</summary><content type="html">&lt;p&gt;In the previous &lt;a class="reference external" href="https://copyninja.info/blog/systemd_automount_entry.html"&gt;post&lt;/a&gt; I had
mentioned that I didn't figure out how to add dependency on mount
points so as to achieve correct ordering of mount points. After a lot
of search today I finally figured it out thanks to the &lt;a class="reference external" href="https://bugzilla.redhat.com/show_bug.cgi?id=812826"&gt;bug report&lt;/a&gt; and the &lt;a class="reference external" href="http://lists.freedesktop.org/archives/systemd-devel/2015-May/031932.html"&gt;patch&lt;/a&gt;
which adds &lt;em&gt;x-systemd.requires&lt;/em&gt; and other option to systemd.&lt;/p&gt;
&lt;p&gt;So basically you can add additional ordering information to the
&lt;em&gt;.mount&lt;/em&gt; files generated by &lt;em&gt;systemd-fstab-generator&lt;/em&gt; by adding a
&lt;em&gt;ordering.conf&lt;/em&gt; file to path
&lt;em&gt;/etc/systemd/system/usr-local-bin.mount.d/&lt;/em&gt; path with following
contents.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="k"&gt;[Unit]&lt;/span&gt;
&lt;span class="na"&gt;After&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s"&gt;home.mount&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;And that is it, now &lt;em&gt;usr-local-bin.mount&lt;/em&gt; will be mounted after
&lt;em&gt;home.mount&lt;/em&gt; is activated.&lt;/p&gt;
&lt;p&gt;I couldn't find this information directly in related manpages like
&lt;em&gt;systemd.mount&lt;/em&gt; or &lt;em&gt;systemd.automount&lt;/em&gt;. Also this information is not
directly available in search results!.&lt;/p&gt;
</content><category term="devops"/><category term="debian"/><category term="systemd"/><category term="mount"/><category term="fstab"/></entry><entry><title>Mount ordering and automount options in systemd</title><link href="https://copyninja.in/blog/systemd_automount_entry.html" rel="alternate"/><published>2015-12-13T15:13:00+05:30</published><updated>2015-12-13T15:13:00+05:30</updated><author><name>copyninja</name></author><id>tag:copyninja.in,2015-12-13:/blog/systemd_automount_entry.html</id><summary type="html">&lt;p class="first last"&gt;Brief notes on systemd.mount and systemd.autmount features.&lt;/p&gt;
</summary><content type="html">&lt;p&gt;Just to give a brief recap of why I'm writing this post, I've to
describe a brief encounter I had with systemd which rendered my system
unbootable. I first felt its systemd's problem but later figured out
it was my mistake. So below is brief story divided into 2 sections
&lt;em&gt;Problem&lt;/em&gt; and &lt;em&gt;Solution&lt;/em&gt;. Here &lt;em&gt;Problem&lt;/em&gt; describes issue I faced with
systemd and &lt;em&gt;Solution&lt;/em&gt; discusses the &lt;em&gt;.mount&lt;/em&gt; and &lt;em&gt;.automount&lt;/em&gt; suffix
files used by systemd.&lt;/p&gt;
&lt;div class="section" id="problem"&gt;
&lt;h2&gt;Problem&lt;/h2&gt;
&lt;p&gt;I have several local bin folders and I don't want to modify &lt;em&gt;PATH&lt;/em&gt;
environment variable adding every other folder path. I first started
using &lt;em&gt;aufs&lt;/em&gt; as alternative to symlinks or modifying &lt;em&gt;PATH&lt;/em&gt;
variable. Recently I learnt about much more light weight union fs which is
in kernel, &lt;em&gt;overlayfs&lt;/em&gt;. And Google led me to Arch wiki article which
showed me a fstab entry like below&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;overlay        /usr/local/bin        overlay noauto,x-systemd.automount,lowerdir=/home/vasudev/Documents/utilities/bin,upperdir=/home/vasudev/Documents/utilities/jonas-bin,workdir=/home/vasudev/Documents/utilities/bin-overlay    0       0
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;And after adding this entry, on next reboot systemd is not able to
mount my LVM home and swap partition. It does however mount root
partition. It gives me emergency target but login never returns. So
without any alternative I had to reinstall the system. But funnily
enough I started encountering the same issue (yeah after I had added
above entry into fstab). Yeah that time I never thought that its
culprit. My friend Ritesh finally got my system booting after the
weird x-systemd.automount option. I never investigated further that
time on why this problem occurred.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="solution"&gt;
&lt;h2&gt;Solution&lt;/h2&gt;
&lt;p&gt;After re-encounter with similar problem and some other project I read
the manual on &lt;em&gt;systemd.mount&lt;/em&gt;, &lt;em&gt;systemd-fstab-generator&lt;/em&gt; and
&lt;em&gt;systemd.automount&lt;/em&gt; and I had some understanding of what really went
wrong in my case above.&lt;/p&gt;
&lt;p&gt;So now let us see what really is happening. All the above happened
because, &lt;em&gt;systemd translates the /etc/fstab into .mount units at run
time using systemd-fstab-generator&lt;/em&gt;. Every entry in fstab translates
into a file named after the mount point. The &lt;em&gt;/&lt;/em&gt; in the path of the
mount point is replaced by a &lt;em&gt;-&lt;/em&gt;. So &lt;em&gt;/&lt;/em&gt; mount point is named as
&lt;em&gt;-.mount&lt;/em&gt; and &lt;em&gt;/home&lt;/em&gt; is named as &lt;em&gt;home.mount&lt;/em&gt; and &lt;em&gt;/boot&lt;/em&gt; becomes
&lt;em&gt;boot.mount&lt;/em&gt;. All these files can be seen in directory
&lt;em&gt;/run/systemd/generator&lt;/em&gt;. And all these mount points are needed by
&lt;em&gt;local-fs.target&lt;/em&gt; , if any of these mount points fail,
&lt;em&gt;local-fs.target&lt;/em&gt; fails. And if &lt;em&gt;local-fs.target&lt;/em&gt; fails it will invoke
&lt;em&gt;emergency.target&lt;/em&gt;.&lt;/p&gt;
&lt;p&gt;&lt;em&gt;systemd-fstab-generator&lt;/em&gt; manual suggests the ordering information in
&lt;em&gt;/etc/fstab&lt;/em&gt; is discarded. That means if you have union mounts, bind
mounts or fuse mounts in the fstab which is normally at end of fstab
and uses path from /home or some other device mount points it will
fail to get mounted. This happens because &lt;em&gt;systemd-fstab-generator&lt;/em&gt;
didn't  consider the ordering in fstab. This is what happened in my
case my &lt;em&gt;overlay&lt;/em&gt; mount point which is &lt;em&gt;usr-local-bin.mount&lt;/em&gt; was some
how happened to be tried before &lt;em&gt;home.mount&lt;/em&gt; because there is no
explicit dependency like &lt;em&gt;Requires=&lt;/em&gt; or &lt;em&gt;After=&lt;/em&gt; was declared. When
systemd tried to mount it the path required under /home were not
really present hence failed which in return invoked &lt;em&gt;emergency.target&lt;/em&gt;
as &lt;em&gt;usr-local-bin.mount&lt;/em&gt; is &lt;em&gt;Requires=&lt;/em&gt; dependency for
&lt;em&gt;local-fs.target&lt;/em&gt;.&lt;/p&gt;
&lt;p&gt;Now what I didn't understand is why &lt;em&gt;emregency.target&lt;/em&gt; never gave me
the root shell after entering login information. I feel that this part
is unrelated to the problem I described above and is some other bug.&lt;/p&gt;
&lt;p&gt;To over come this what we can do is provided &lt;em&gt;systemd-fstab-generator&lt;/em&gt;
some information on dependency of each mount point. &lt;em&gt;systemd.mount&lt;/em&gt;
manual page suggests several such options. One which I used in my case
is &lt;em&gt;x-systemd.requires&lt;/em&gt; which should be placed in options column of
fstab and specify the mount point which is needed before it has to be
mounted. So my overlay fs entry translates to something like below&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;overlay        /usr/local/bin        overlay noauto,x-systemd.requires=/home,x-systemd.automount,lowerdir=/home/vasudev/Documents/utilities/bin,upperdir=/home/vasudev/Documents/utilities/jonas-bin,workdir=/home/vasudev/Documents/utilities/bin-overlay   0       0
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;There is another special option called &lt;em&gt;x-systemd.automount&lt;/em&gt; this will
make systemd-fstab-generator to create a &lt;em&gt;.automount&lt;/em&gt; file for this
mount point. What does &lt;em&gt;systemd.automount&lt;/em&gt; do? It achieves on-demand
file mounting and parallelized file system mounting. Something similar
to &lt;em&gt;systemd.socket&lt;/em&gt; the file system will be mounted when you access
the mount point for first time.&lt;/p&gt;
&lt;p&gt;So now if you try to see dependency of usr-local-bin.mount you will
see following.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;systemctl&lt;span class="w"&gt; &lt;/span&gt;show&lt;span class="w"&gt; &lt;/span&gt;-p&lt;span class="w"&gt; &lt;/span&gt;After&lt;span class="w"&gt; &lt;/span&gt;usr-local-bin.mount
&lt;span class="nv"&gt;After&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;-.mount&lt;span class="w"&gt; &lt;/span&gt;systemd-journald.socket&lt;span class="w"&gt; &lt;/span&gt;local-fs-pre.target&lt;span class="w"&gt; &lt;/span&gt;system.slice&lt;span class="w"&gt; &lt;/span&gt;usr-local-bin.automount
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;This means now &lt;em&gt;usr-local-bin.mount&lt;/em&gt; depends on
&lt;em&gt;usr-local-bin.automount&lt;/em&gt;. And let us see what usr-local-bin.automount
needs.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;systemctl&lt;span class="w"&gt; &lt;/span&gt;show&lt;span class="w"&gt; &lt;/span&gt;-p&lt;span class="w"&gt; &lt;/span&gt;Requires&lt;span class="w"&gt; &lt;/span&gt;usr-local-bin.automount
&lt;span class="nv"&gt;Requires&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;-.mount&lt;span class="w"&gt; &lt;/span&gt;home.mount

systemctl&lt;span class="w"&gt; &lt;/span&gt;show&lt;span class="w"&gt; &lt;/span&gt;-p&lt;span class="w"&gt; &lt;/span&gt;After&lt;span class="w"&gt; &lt;/span&gt;usr-local-bin.automount
&lt;span class="nv"&gt;After&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;-.mount&lt;span class="w"&gt; &lt;/span&gt;home.mount
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;So clearly &lt;em&gt;usr-local-bin.automount&lt;/em&gt; is activated after &lt;em&gt;-.mount&lt;/em&gt; and
&lt;em&gt;home.mount&lt;/em&gt; is activated. Similar can be done for any bind mounts or
fuse mounts which require other mount points before it can be
mounted. Also note that &lt;em&gt;x-systemd.autmount&lt;/em&gt; is not mandatory option
for declaring dependencies, I used it just to make sure
&lt;em&gt;/usr/local/bin&lt;/em&gt; is mounted only when its really needed.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="conclusion"&gt;
&lt;h2&gt;Conclusion&lt;/h2&gt;
&lt;p&gt;A lot of traditional way has been changed by systemd. I never
understood why my system failed to boot in first place this happened
because I was not really aware of how systemd works and was trying to
debug the problem with traditional approach. So there is really a
learning curve involved for every sysadmin out there who is going to
use systemd. Most of them will read documentation before hand but
others like me will learn after having a situation like above. :-).&lt;/p&gt;
&lt;p&gt;So systemd interfering into /etc/fstab is good?. I don't know but
since systemd parallelizes  the boot procedure something like this is
really needed. Is there a way to make systemd not touch
/etc/fstab?. Yes there is you need to pass &lt;em&gt;fstab=0&lt;/em&gt; option in kernel
command line and systemd-fstab-generator doesn't create any .mount or
.swap files from your /etc/fstab.&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;!NB Also it looks like x-systemd.requires option was introduced
recently and is not available in systemd &amp;lt;= 215 which is default in
Jessie. So how do you declare dependencies in Jessie system?. I don't
have any answer!. I did read that x-systemd.automount which is
available in those versions of systemd can be used, but I'm yet to
experiment this. If it succeeds I will write a post on it.&lt;/strong&gt;&lt;/p&gt;
&lt;/div&gt;
</content><category term="devops"/><category term="systemd"/><category term="fstab"/><category term="automount"/></entry><entry><title>Forwarding host port to service in container</title><link href="https://copyninja.in/blog/port_forward_container.html" rel="alternate"/><published>2015-11-09T17:06:00+05:30</published><updated>2015-11-09T17:06:00+05:30</updated><author><name>copyninja</name></author><id>tag:copyninja.in,2015-11-09:/blog/port_forward_container.html</id><summary type="html">&lt;p class="first last"&gt;Brief notes on forwarding specific ports to service running
in container.&lt;/p&gt;
</summary><content type="html">&lt;div class="section" id="problem"&gt;
&lt;h2&gt;Problem&lt;/h2&gt;
&lt;p&gt;I've lxc container running distcc daemon and I would like to forward
the distcc traffic coming to my host system to container.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="solution"&gt;
&lt;h2&gt;Solution&lt;/h2&gt;
&lt;p&gt;Following simple script which uses iptable did the job.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="c1"&gt;#!/bin/sh&lt;/span&gt;
&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nb"&gt;set&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;-e


usage&lt;span class="o"&gt;()&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;{&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;cat&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;&amp;lt;&amp;lt;EOF&lt;/span&gt;
&lt;span class="s"&gt;    $(basename $0) [options] &amp;lt;in-interface&amp;gt; &amp;lt;out-interface&amp;gt; &amp;lt;port&amp;gt; &amp;lt;destination&amp;gt;&lt;/span&gt;

&lt;span class="s"&gt;    --clear           Clear the previous rules before inserting new&lt;/span&gt;
&lt;span class="s"&gt;                      ones&lt;/span&gt;

&lt;span class="s"&gt;    --protocol        Protocol for the rules to use.&lt;/span&gt;

&lt;span class="s"&gt;    in-interface      Interface on which incoming traffic is expected&lt;/span&gt;
&lt;span class="s"&gt;    out-interface     Interface to which incoming traffic is to be&lt;/span&gt;
&lt;span class="s"&gt;                      forwarded.&lt;/span&gt;

&lt;span class="s"&gt;    port              Port to be forwarded. Can be integer or string&lt;/span&gt;
&lt;span class="s"&gt;                      from /etc/services.&lt;/span&gt;
&lt;span class="s"&gt;    destination       IP and port of the destination system to which&lt;/span&gt;
&lt;span class="s"&gt;                      traffic needs to be forwarded. This should be in&lt;/span&gt;
&lt;span class="s"&gt;                      form &amp;lt;destination_ip:port&amp;gt;&lt;/span&gt;

&lt;span class="s"&gt;(C) 2015 Vasudev Kamath - This program comes with ABSOLUTELY NO&lt;/span&gt;
&lt;span class="s"&gt;WARRANTY. This is free software, and you are welcome to redistribute&lt;/span&gt;
&lt;span class="s"&gt;it under the GNU GPL Version 3 (or later) License&lt;/span&gt;

&lt;span class="s"&gt;EOF&lt;/span&gt;
&lt;span class="o"&gt;}&lt;/span&gt;

setup_portforwarding&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;()&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;{&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="nb"&gt;local&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nv"&gt;protocol&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;&lt;/span&gt;&lt;span class="nv"&gt;$1&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;iptables&lt;span class="w"&gt; &lt;/span&gt;-t&lt;span class="w"&gt; &lt;/span&gt;nat&lt;span class="w"&gt; &lt;/span&gt;-A&lt;span class="w"&gt; &lt;/span&gt;PREROUTING&lt;span class="w"&gt; &lt;/span&gt;-i&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nv"&gt;$IN_INTERFACE&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;-p&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;&lt;/span&gt;&lt;span class="nv"&gt;$protocol&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;--dport&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nv"&gt;$PORT&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="se"&gt;\&lt;/span&gt;
&lt;span class="w"&gt;           &lt;/span&gt;-j&lt;span class="w"&gt; &lt;/span&gt;DNAT&lt;span class="w"&gt; &lt;/span&gt;--to&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nv"&gt;$DESTINATION&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;iptables&lt;span class="w"&gt; &lt;/span&gt;-A&lt;span class="w"&gt; &lt;/span&gt;FORWARD&lt;span class="w"&gt; &lt;/span&gt;-p&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;&lt;/span&gt;&lt;span class="nv"&gt;$protocol&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;-d&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="si"&gt;${&lt;/span&gt;&lt;span class="nv"&gt;DESTINATION&lt;/span&gt;&lt;span class="p"&gt;%%&lt;/span&gt;&lt;span class="se"&gt;\:&lt;/span&gt;&lt;span class="p"&gt;*&lt;/span&gt;&lt;span class="si"&gt;}&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;--dport&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nv"&gt;$PORT&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;-j&lt;span class="w"&gt; &lt;/span&gt;ACCEPT

&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="c1"&gt;# Returning packet should have gateway IP&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;iptables&lt;span class="w"&gt; &lt;/span&gt;-t&lt;span class="w"&gt; &lt;/span&gt;nat&lt;span class="w"&gt; &lt;/span&gt;-A&lt;span class="w"&gt; &lt;/span&gt;POSTROUTING&lt;span class="w"&gt; &lt;/span&gt;-s&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="si"&gt;${&lt;/span&gt;&lt;span class="nv"&gt;DESTINATION&lt;/span&gt;&lt;span class="p"&gt;%%&lt;/span&gt;&lt;span class="se"&gt;\:&lt;/span&gt;&lt;span class="p"&gt;*&lt;/span&gt;&lt;span class="si"&gt;}&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;-o&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="se"&gt;\&lt;/span&gt;
&lt;span class="w"&gt;           &lt;/span&gt;&lt;span class="nv"&gt;$IN_INTERFACE&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;-j&lt;span class="w"&gt; &lt;/span&gt;SNAT&lt;span class="w"&gt; &lt;/span&gt;--to&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="si"&gt;${&lt;/span&gt;&lt;span class="nv"&gt;IN_IP&lt;/span&gt;&lt;span class="p"&gt;%%&lt;/span&gt;&lt;span class="se"&gt;\/&lt;/span&gt;&lt;span class="p"&gt;*&lt;/span&gt;&lt;span class="si"&gt;}&lt;/span&gt;

&lt;span class="o"&gt;}&lt;/span&gt;

&lt;span class="k"&gt;if&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;[&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="k"&gt;$(&lt;/span&gt;id&lt;span class="w"&gt; &lt;/span&gt;-u&lt;span class="k"&gt;)&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;-ne&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;0&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;]&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="k"&gt;then&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="nb"&gt;echo&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;You need to be root to run this script&amp;quot;&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="nb"&gt;exit&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;1&lt;/span&gt;
&lt;span class="k"&gt;fi&lt;/span&gt;

&lt;span class="k"&gt;while&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;true&lt;span class="p"&gt;;&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="k"&gt;do&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="k"&gt;case&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;&lt;/span&gt;&lt;span class="nv"&gt;$1&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="k"&gt;in&lt;/span&gt;
&lt;span class="w"&gt;      &lt;/span&gt;--clear&lt;span class="o"&gt;)&lt;/span&gt;
&lt;span class="w"&gt;          &lt;/span&gt;&lt;span class="nv"&gt;CLEAR_RULES&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="m"&gt;1&lt;/span&gt;
&lt;span class="w"&gt;          &lt;/span&gt;&lt;span class="nb"&gt;shift&lt;/span&gt;
&lt;span class="w"&gt;          &lt;/span&gt;&lt;span class="p"&gt;;;&lt;/span&gt;
&lt;span class="w"&gt;      &lt;/span&gt;--protocol&lt;span class="p"&gt;|&lt;/span&gt;--protocol&lt;span class="o"&gt;=&lt;/span&gt;*?&lt;span class="o"&gt;)&lt;/span&gt;
&lt;span class="w"&gt;      &lt;/span&gt;&lt;span class="k"&gt;if&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;[&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;&lt;/span&gt;&lt;span class="nv"&gt;$1&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;--protocol&amp;quot;&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;-a&lt;span class="w"&gt; &lt;/span&gt;-n&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;&lt;/span&gt;&lt;span class="nv"&gt;$2&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;]&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;&lt;span class="k"&gt;then&lt;/span&gt;
&lt;span class="w"&gt;          &lt;/span&gt;&lt;span class="nv"&gt;PROTOCOL&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;&lt;/span&gt;&lt;span class="nv"&gt;$2&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;&lt;/span&gt;
&lt;span class="w"&gt;          &lt;/span&gt;&lt;span class="nb"&gt;shift&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;2&lt;/span&gt;
&lt;span class="w"&gt;      &lt;/span&gt;&lt;span class="k"&gt;elif&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;[&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;&lt;/span&gt;&lt;span class="si"&gt;${&lt;/span&gt;&lt;span class="nv"&gt;1&lt;/span&gt;&lt;span class="p"&gt;#--protocol=&lt;/span&gt;&lt;span class="si"&gt;}&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;!&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;&lt;/span&gt;&lt;span class="nv"&gt;$1&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;]&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="k"&gt;then&lt;/span&gt;
&lt;span class="w"&gt;          &lt;/span&gt;&lt;span class="nv"&gt;PROTOCOL&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;&lt;/span&gt;&lt;span class="si"&gt;${&lt;/span&gt;&lt;span class="nv"&gt;1$-&lt;/span&gt;&lt;span class="p"&gt;-protocol=&lt;/span&gt;&lt;span class="si"&gt;}&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;&lt;/span&gt;
&lt;span class="w"&gt;          &lt;/span&gt;&lt;span class="nb"&gt;shift&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;1&lt;/span&gt;
&lt;span class="w"&gt;      &lt;/span&gt;&lt;span class="k"&gt;else&lt;/span&gt;
&lt;span class="w"&gt;          &lt;/span&gt;&lt;span class="nb"&gt;echo&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;You need to specify protocl (tcp|udp)&amp;quot;&lt;/span&gt;
&lt;span class="w"&gt;          &lt;/span&gt;&lt;span class="nb"&gt;exit&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;2&lt;/span&gt;
&lt;span class="w"&gt;      &lt;/span&gt;&lt;span class="k"&gt;fi&lt;/span&gt;
&lt;span class="w"&gt;      &lt;/span&gt;&lt;span class="p"&gt;;;&lt;/span&gt;

&lt;span class="w"&gt;      &lt;/span&gt;*&lt;span class="o"&gt;)&lt;/span&gt;
&lt;span class="w"&gt;          &lt;/span&gt;&lt;span class="k"&gt;break&lt;/span&gt;
&lt;span class="w"&gt;          &lt;/span&gt;&lt;span class="p"&gt;;;&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="k"&gt;esac&lt;/span&gt;
&lt;span class="k"&gt;done&lt;/span&gt;

&lt;span class="k"&gt;if&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;[&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nv"&gt;$#&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;-ne&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;4&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;]&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="k"&gt;then&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;usage&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nv"&gt;$0&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="nb"&gt;exit&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;2&lt;/span&gt;
&lt;span class="k"&gt;fi&lt;/span&gt;

&lt;span class="nv"&gt;IN_INTERFACE&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;&lt;/span&gt;&lt;span class="nv"&gt;$1&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;&lt;/span&gt;
&lt;span class="nv"&gt;OUT_INTERFACE&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;&lt;/span&gt;&lt;span class="nv"&gt;$2&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;&lt;/span&gt;
&lt;span class="nv"&gt;PORT&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;&lt;/span&gt;&lt;span class="nv"&gt;$3&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;&lt;/span&gt;
&lt;span class="nv"&gt;DESTINATION&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;&lt;/span&gt;&lt;span class="nv"&gt;$4&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;&lt;/span&gt;

&lt;span class="c1"&gt;# Get the incoming interface IP. This is used for SNAT.&lt;/span&gt;
&lt;span class="nv"&gt;IN_IP&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="k"&gt;$(&lt;/span&gt;ip&lt;span class="w"&gt; &lt;/span&gt;addr&lt;span class="w"&gt; &lt;/span&gt;show&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nv"&gt;$IN_INTERFACE&lt;/span&gt;&lt;span class="p"&gt;|&lt;/span&gt;&lt;span class="se"&gt;\&lt;/span&gt;
&lt;span class="w"&gt;             &lt;/span&gt;perl&lt;span class="w"&gt; &lt;/span&gt;-nE&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;/inet\s(.*)\sbrd/ and print $1&amp;#39;&lt;/span&gt;&lt;span class="k"&gt;)&lt;/span&gt;


&lt;span class="k"&gt;if&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;[&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;-n&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;&lt;/span&gt;&lt;span class="nv"&gt;$CLEAR_RULES&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;]&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="k"&gt;then&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;iptables&lt;span class="w"&gt; &lt;/span&gt;-t&lt;span class="w"&gt; &lt;/span&gt;nat&lt;span class="w"&gt; &lt;/span&gt;-X
&lt;span class="w"&gt;    &lt;/span&gt;iptables&lt;span class="w"&gt; &lt;/span&gt;-t&lt;span class="w"&gt; &lt;/span&gt;nat&lt;span class="w"&gt; &lt;/span&gt;-F
&lt;span class="w"&gt;    &lt;/span&gt;iptables&lt;span class="w"&gt; &lt;/span&gt;-F
&lt;span class="k"&gt;fi&lt;/span&gt;

&lt;span class="k"&gt;if&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;[&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;-n&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;&lt;/span&gt;&lt;span class="nv"&gt;$PROTOCOL&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;]&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="k"&gt;then&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;setup_portforwarding&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nv"&gt;$PROTOCOL&lt;/span&gt;
&lt;span class="k"&gt;else&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;setup_portforwarding&lt;span class="w"&gt; &lt;/span&gt;tcp
&lt;span class="w"&gt;    &lt;/span&gt;setup_portforwarding&lt;span class="w"&gt; &lt;/span&gt;udp
&lt;span class="k"&gt;fi&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Coming to systemd-nspawn I see there is &lt;em&gt;--port&lt;/em&gt; option which takes
argument in form &lt;em&gt;proto:hostport:destport&lt;/em&gt; where proto can be either
&lt;em&gt;tcp&lt;/em&gt; or &lt;em&gt;udp&lt;/em&gt;, &lt;em&gt;hostport&lt;/em&gt; and &lt;em&gt;destport&lt;/em&gt; are number from
1-65535. This option assumes private networking enabled in the
container. I've not tried this option yet but that simplifies quite a
lot of thing, its like -p switch used by &lt;em&gt;docker&lt;/em&gt;.&lt;/p&gt;
&lt;/div&gt;
</content><category term="devops"/><category term="iptables"/><category term="firewall"/><category term="container"/></entry><entry><title>Taming systemd-nspawn for running containers</title><link href="https://copyninja.in/blog/taming_systemd_nsapwn.html" rel="alternate"/><published>2015-11-09T12:52:00+05:30</published><updated>2015-11-09T12:52:00+05:30</updated><author><name>copyninja</name></author><id>tag:copyninja.in,2015-11-09:/blog/taming_systemd_nsapwn.html</id><summary type="html">&lt;p class="first last"&gt;Brief notes on maintaining container using systemd-nspawn&lt;/p&gt;
</summary><content type="html">&lt;p&gt;I've been trying to run containers using systemd-nspawn for quite some
time. I was always bumping to one or other dead end. This is not
systemd-nspawn's fault, rather my impatience stopping me from reading
manual pages properly lack of good tutorial like article available
online. Compared to this LXC has a quite a lot of good tutorials and
howto's available online.&lt;/p&gt;
&lt;p&gt;This article is my effort to create a notes putting all required
information in one place.&lt;/p&gt;
&lt;div class="section" id="creating-a-debian-base-install"&gt;
&lt;h2&gt;Creating a Debian Base Install&lt;/h2&gt;
&lt;p&gt;First step is to have a minimal Debian system some where on your hard
disk. This can be easily done using &lt;em&gt;debootsrap&lt;/em&gt;. I wrote a custom
script to avoid reading manual every time I want to run
debootstrap. Parts of this script (mostly packages and the root
password generation) is stolen from &lt;em&gt;lxc-debian&lt;/em&gt; template provided by
lxc package.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="ch"&gt;#!/bin/sh&lt;/span&gt;

&lt;span class="nb"&gt;set&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;-e
&lt;span class="nb"&gt;set&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;-x

usage&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;()&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;{&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="nb"&gt;echo&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;&lt;/span&gt;&lt;span class="si"&gt;${&lt;/span&gt;&lt;span class="nv"&gt;0&lt;/span&gt;&lt;span class="p"&gt;##/*&lt;/span&gt;&lt;span class="si"&gt;}&lt;/span&gt;&lt;span class="s2"&gt; [options] &amp;lt;suite&amp;gt; &amp;lt;target&amp;gt; [&amp;lt;mirror&amp;gt;]&amp;quot;&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="nb"&gt;echo&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;Bootstrap rootfs for Debian&amp;quot;&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="nb"&gt;echo&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;cat&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;&amp;lt;&amp;lt;EOF&lt;/span&gt;
&lt;span class="s"&gt;    --arch         set the architecture to install&lt;/span&gt;
&lt;span class="s"&gt;    --root-passwd  set the root password for bootstrapped rootfs&lt;/span&gt;
&lt;span class="s"&gt;    EOF&lt;/span&gt;
&lt;span class="o"&gt;}&lt;/span&gt;

&lt;span class="c1"&gt;# copied from the lxc-debian template&lt;/span&gt;
&lt;span class="nv"&gt;packages&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;ifupdown,&lt;span class="se"&gt;\&lt;/span&gt;
locales,&lt;span class="se"&gt;\&lt;/span&gt;
libui-dialog-perl,&lt;span class="se"&gt;\&lt;/span&gt;
dialog,&lt;span class="se"&gt;\&lt;/span&gt;
isc-dhcp-client,&lt;span class="se"&gt;\&lt;/span&gt;
netbase,&lt;span class="se"&gt;\&lt;/span&gt;
net-tools,&lt;span class="se"&gt;\&lt;/span&gt;
iproute,&lt;span class="se"&gt;\&lt;/span&gt;
openssh-server,&lt;span class="se"&gt;\&lt;/span&gt;
dbus

&lt;span class="k"&gt;if&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;[&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="k"&gt;$(&lt;/span&gt;id&lt;span class="w"&gt; &lt;/span&gt;-u&lt;span class="k"&gt;)&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;-ne&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;0&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;]&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="k"&gt;then&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="nb"&gt;echo&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;You must be root to execute this command&amp;quot;&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="nb"&gt;exit&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;2&lt;/span&gt;
&lt;span class="k"&gt;fi&lt;/span&gt;

&lt;span class="k"&gt;if&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;[&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nv"&gt;$#&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;-lt&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;2&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;]&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="k"&gt;then&lt;/span&gt;
&lt;span class="w"&gt;   &lt;/span&gt;usage&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nv"&gt;$0&lt;/span&gt;
&lt;span class="k"&gt;fi&lt;/span&gt;

&lt;span class="k"&gt;while&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;true&lt;span class="p"&gt;;&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="k"&gt;do&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="k"&gt;case&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;&lt;/span&gt;&lt;span class="nv"&gt;$1&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="k"&gt;in&lt;/span&gt;
&lt;span class="w"&gt;        &lt;/span&gt;--root-passwd&lt;span class="p"&gt;|&lt;/span&gt;--root-passwd&lt;span class="o"&gt;=&lt;/span&gt;?*&lt;span class="o"&gt;)&lt;/span&gt;
&lt;span class="w"&gt;            &lt;/span&gt;&lt;span class="k"&gt;if&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;[&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;&lt;/span&gt;&lt;span class="nv"&gt;$1&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;--root-passwd&amp;quot;&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;-a&lt;span class="w"&gt; &lt;/span&gt;-n&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;&lt;/span&gt;&lt;span class="nv"&gt;$2&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;]&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="k"&gt;then&lt;/span&gt;
&lt;span class="w"&gt;                &lt;/span&gt;&lt;span class="nv"&gt;ROOT_PASSWD&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;&lt;/span&gt;&lt;span class="nv"&gt;$2&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;&lt;/span&gt;
&lt;span class="w"&gt;                &lt;/span&gt;&lt;span class="nb"&gt;shift&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;2&lt;/span&gt;
&lt;span class="w"&gt;            &lt;/span&gt;&lt;span class="k"&gt;elif&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;[&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;&lt;/span&gt;&lt;span class="nv"&gt;$1&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;!&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;&lt;/span&gt;&lt;span class="si"&gt;${&lt;/span&gt;&lt;span class="nv"&gt;1&lt;/span&gt;&lt;span class="p"&gt;#--root-passwd=&lt;/span&gt;&lt;span class="si"&gt;}&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;]&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="k"&gt;then&lt;/span&gt;
&lt;span class="w"&gt;                &lt;/span&gt;&lt;span class="nv"&gt;ROOT_PASSWD&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;&lt;/span&gt;&lt;span class="si"&gt;${&lt;/span&gt;&lt;span class="nv"&gt;1&lt;/span&gt;&lt;span class="p"&gt;#--root-passwd=&lt;/span&gt;&lt;span class="si"&gt;}&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;&lt;/span&gt;
&lt;span class="w"&gt;                &lt;/span&gt;&lt;span class="nb"&gt;shift&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;1&lt;/span&gt;
&lt;span class="w"&gt;            &lt;/span&gt;&lt;span class="k"&gt;else&lt;/span&gt;
&lt;span class="w"&gt;                &lt;/span&gt;&lt;span class="c1"&gt;# copied from lxc-debian template&lt;/span&gt;
&lt;span class="w"&gt;                &lt;/span&gt;&lt;span class="nv"&gt;ROOT_PASSWD&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;&lt;/span&gt;&lt;span class="k"&gt;$(&lt;/span&gt;dd&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="k"&gt;if&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;/dev/urandom&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nv"&gt;bs&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="m"&gt;6&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nv"&gt;count&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="m"&gt;1&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;2&lt;/span&gt;&amp;gt;/dev/null&lt;span class="p"&gt;|&lt;/span&gt;base64&lt;span class="k"&gt;)&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;&lt;/span&gt;
&lt;span class="w"&gt;                &lt;/span&gt;&lt;span class="nv"&gt;ECHO_PASSWD&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;yes&amp;quot;&lt;/span&gt;
&lt;span class="w"&gt;            &lt;/span&gt;&lt;span class="k"&gt;fi&lt;/span&gt;
&lt;span class="w"&gt;            &lt;/span&gt;&lt;span class="p"&gt;;;&lt;/span&gt;
&lt;span class="w"&gt;        &lt;/span&gt;--arch&lt;span class="p"&gt;|&lt;/span&gt;--arch&lt;span class="o"&gt;=&lt;/span&gt;?*&lt;span class="o"&gt;)&lt;/span&gt;
&lt;span class="w"&gt;            &lt;/span&gt;&lt;span class="k"&gt;if&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;[&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;&lt;/span&gt;&lt;span class="nv"&gt;$1&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;--arch&amp;quot;&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;-a&lt;span class="w"&gt; &lt;/span&gt;-n&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;&lt;/span&gt;&lt;span class="nv"&gt;$2&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;]&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="k"&gt;then&lt;/span&gt;
&lt;span class="w"&gt;                &lt;/span&gt;&lt;span class="nv"&gt;ARCHITECTURE&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;&lt;/span&gt;&lt;span class="nv"&gt;$2&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;&lt;/span&gt;
&lt;span class="w"&gt;                &lt;/span&gt;&lt;span class="nb"&gt;shift&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;2&lt;/span&gt;
&lt;span class="w"&gt;            &lt;/span&gt;&lt;span class="k"&gt;elif&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;[&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;&lt;/span&gt;&lt;span class="nv"&gt;$1&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;!&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;&lt;/span&gt;&lt;span class="si"&gt;${&lt;/span&gt;&lt;span class="nv"&gt;1&lt;/span&gt;&lt;span class="p"&gt;#--arch=&lt;/span&gt;&lt;span class="si"&gt;}&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;]&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="k"&gt;then&lt;/span&gt;
&lt;span class="w"&gt;                &lt;/span&gt;&lt;span class="nv"&gt;ARCHITECTURE&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;&lt;/span&gt;&lt;span class="si"&gt;${&lt;/span&gt;&lt;span class="nv"&gt;1&lt;/span&gt;&lt;span class="p"&gt;#--arch=&lt;/span&gt;&lt;span class="si"&gt;}&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;&lt;/span&gt;
&lt;span class="w"&gt;                &lt;/span&gt;&lt;span class="nb"&gt;shift&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;1&lt;/span&gt;
&lt;span class="w"&gt;            &lt;/span&gt;&lt;span class="k"&gt;else&lt;/span&gt;
&lt;span class="w"&gt;                &lt;/span&gt;&lt;span class="nv"&gt;ARCHITECTURE&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;&lt;/span&gt;&lt;span class="k"&gt;$(&lt;/span&gt;dpkg-architecture&lt;span class="w"&gt; &lt;/span&gt;-q&lt;span class="w"&gt; &lt;/span&gt;DEB_HOST_ARCH&lt;span class="k"&gt;)&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;&lt;/span&gt;
&lt;span class="w"&gt;            &lt;/span&gt;&lt;span class="k"&gt;fi&lt;/span&gt;
&lt;span class="w"&gt;            &lt;/span&gt;&lt;span class="p"&gt;;;&lt;/span&gt;
&lt;span class="w"&gt;        &lt;/span&gt;*&lt;span class="o"&gt;)&lt;/span&gt;
&lt;span class="w"&gt;            &lt;/span&gt;&lt;span class="k"&gt;break&lt;/span&gt;
&lt;span class="w"&gt;            &lt;/span&gt;&lt;span class="p"&gt;;;&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="k"&gt;esac&lt;/span&gt;
&lt;span class="k"&gt;done&lt;/span&gt;



&lt;span class="nv"&gt;release&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;&lt;/span&gt;&lt;span class="nv"&gt;$1&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;&lt;/span&gt;
&lt;span class="nv"&gt;target&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;&lt;/span&gt;&lt;span class="nv"&gt;$2&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;&lt;/span&gt;

&lt;span class="k"&gt;if&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;[&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;-z&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;&lt;/span&gt;&lt;span class="nv"&gt;$1&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;]&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;||&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;[&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;-z&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;&lt;/span&gt;&lt;span class="nv"&gt;$2&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;]&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="k"&gt;then&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="nb"&gt;echo&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;You must specify suite and target&amp;quot;&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="nb"&gt;exit&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;1&lt;/span&gt;
&lt;span class="k"&gt;fi&lt;/span&gt;

&lt;span class="k"&gt;if&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;[&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;-n&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;&lt;/span&gt;&lt;span class="nv"&gt;$3&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;]&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="k"&gt;then&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="nv"&gt;MIRROR&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;&lt;/span&gt;&lt;span class="nv"&gt;$3&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;&lt;/span&gt;
&lt;span class="k"&gt;fi&lt;/span&gt;

&lt;span class="nv"&gt;MIRROR&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="si"&gt;${&lt;/span&gt;&lt;span class="nv"&gt;MIRROR&lt;/span&gt;&lt;span class="k"&gt;:-&lt;/span&gt;&lt;span class="nv"&gt;http&lt;/span&gt;&lt;span class="p"&gt;://httpredir.debian.org/debian&lt;/span&gt;&lt;span class="si"&gt;}&lt;/span&gt;

&lt;span class="nb"&gt;echo&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;Downloading Debian &lt;/span&gt;&lt;span class="nv"&gt;$release&lt;/span&gt;&lt;span class="s2"&gt; ...&amp;quot;&lt;/span&gt;
debootstrap&lt;span class="w"&gt; &lt;/span&gt;--verbose&lt;span class="w"&gt; &lt;/span&gt;--variant&lt;span class="o"&gt;=&lt;/span&gt;minbase&lt;span class="w"&gt; &lt;/span&gt;--arch&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="nv"&gt;$ARCHITECTURE&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="se"&gt;\&lt;/span&gt;
&lt;span class="w"&gt;             &lt;/span&gt;--include&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="nv"&gt;$packages&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="se"&gt;\&lt;/span&gt;
&lt;span class="w"&gt;             &lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;&lt;/span&gt;&lt;span class="nv"&gt;$release&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;&lt;/span&gt;&lt;span class="nv"&gt;$target&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;&lt;/span&gt;&lt;span class="nv"&gt;$MIRROR&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;&lt;/span&gt;

&lt;span class="k"&gt;if&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;[&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;-n&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;&lt;/span&gt;&lt;span class="nv"&gt;$ROOT_PASSWD&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;]&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="k"&gt;then&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="nb"&gt;echo&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;root:&lt;/span&gt;&lt;span class="nv"&gt;$ROOT_PASSWD&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;|&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;chroot&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;&lt;/span&gt;&lt;span class="nv"&gt;$target&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;chpasswd
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="nb"&gt;echo&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;Root password is &amp;#39;&lt;/span&gt;&lt;span class="nv"&gt;$ROOT_PASSWRD&lt;/span&gt;&lt;span class="s2"&gt;&amp;#39;, please change!&amp;quot;&lt;/span&gt;
&lt;span class="k"&gt;fi&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;It just gets my needs done, if you don't like it feel free to modify
or use debootstrap directly.&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;!NB Please install dbus package in the minimal base install,
otherwise you will not be able to control the container using
machinectl&lt;/strong&gt;&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="manually-running-container-and-then-persisting-it"&gt;
&lt;h2&gt;Manually Running Container and then persisting it&lt;/h2&gt;
&lt;p&gt;Next we need to run the container manually. This is done by using
following command.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;systemd-nspawn&lt;span class="w"&gt; &lt;/span&gt;-bD&lt;span class="w"&gt;   &lt;/span&gt;/path/to/container&lt;span class="w"&gt; &lt;/span&gt;--network-veth&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="se"&gt;\&lt;/span&gt;
&lt;span class="w"&gt;     &lt;/span&gt;--network-bridge&lt;span class="o"&gt;=&lt;/span&gt;natbr0&lt;span class="w"&gt; &lt;/span&gt;--machine&lt;span class="o"&gt;=&lt;/span&gt;Machinename
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;em&gt;--machine&lt;/em&gt; option is not mandatory, if not specified systemd-nspawn
will take the directory name as machine name, and if you have
characters like - in the directory name it translates to hexcode x2d
and controlling container with name becomes difficult.&lt;/p&gt;
&lt;p&gt;&lt;em&gt;--network-veth&lt;/em&gt; specifies the systemd-nspawn to enable virtual
ethernet based networking and &lt;em&gt;--network-bridge&lt;/em&gt; tells the bridge
interface on host system to be used by systemd-nspawn. These options
together constitutes &lt;em&gt;private networking&lt;/em&gt; for container. If not
specified container can use host systems interface there by removing
network isolation of container.&lt;/p&gt;
&lt;p&gt;Once you run this command container comes up. You can now run
machinectl to control the container. Container can be persisted using
following command&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;machinectl&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nb"&gt;enable&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;container-name
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;This will create a symbolic link of
&lt;em&gt;/lib/systemd/system/systemd-nspawn&amp;#64;service&lt;/em&gt; to
&lt;em&gt;/etc/systemd/system/machine.target.wants/&lt;/em&gt;. This allows you to start
or stop container using &lt;em&gt;machinectl&lt;/em&gt; or &lt;em&gt;systemctl&lt;/em&gt; command. Only
catch here is your base install should be in
&lt;em&gt;/var/lib/machines/&lt;/em&gt;. What I do in my case is create a symbolic link
from my base container to &lt;em&gt;/var/lib/machines/container-name&lt;/em&gt;.&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;!NB Note that symbolic link name under /var/lib/machines should be
same as the container name you gave using --machine switch or the
directory name if you didn't specify --machine&lt;/strong&gt;&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="persisting-container-networking"&gt;
&lt;h2&gt;Persisting Container Networking&lt;/h2&gt;
&lt;p&gt;We did persist the container in above step, but this doesn't persist
the networking options we provided in command
line. systemd-nspawn&amp;#64;.service provides following command to invoke
container.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="na"&gt;ExecStart&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s"&gt;/usr/bin/systemd-nspawn --quiet --keep-unit --boot --link-journal=try-guest --network-veth --settings=override --machine=%I&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;To persist the bridge networking configuration we did in command line,
we need the help of systemd-networkd. So first we need to enable the
systemd-networkd.service on both container and the host system.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;systemctl&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nb"&gt;enable&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;systemd-networkd.service
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Now inside the container, interfaces will be named as
&lt;em&gt;hostN&lt;/em&gt;. Depending on how many interfaces we have N increments. In our
example case we had single interface, hence it will named as
&lt;em&gt;host0&lt;/em&gt;. By default network interfaces will be down inside container,
hence systemd-networkd is needed to put it up.&lt;/p&gt;
&lt;p&gt;We put the following in /etc/systemd/network/host0.network file inside
the container.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="k"&gt;[Match]&lt;/span&gt;
&lt;span class="na"&gt;Name&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s"&gt;host0&lt;/span&gt;

&lt;span class="k"&gt;[Network]&lt;/span&gt;
&lt;span class="na"&gt;Description&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s"&gt;Container wired interface host0&lt;/span&gt;
&lt;span class="na"&gt;DHCP&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s"&gt;yes&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;And in the host system we just configure the bridge interface using
systemd-nspawn. I put following in &lt;em&gt;natbr0.netdev&lt;/em&gt; in
/etc/systemd/network/&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="k"&gt;[NetDev]&lt;/span&gt;
&lt;span class="na"&gt;Description&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s"&gt;Bridge natbr0&lt;/span&gt;
&lt;span class="na"&gt;Name&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s"&gt;natbr0&lt;/span&gt;
&lt;span class="na"&gt;Kind&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s"&gt;bridge&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;In my case I already had configured the bridge using
&lt;em&gt;/etc/network/interfaces&lt;/em&gt; file for lxc. I think its not really needed
to use systemd-networkd in this case. Since systemd-networkd doesn't
do anything if network / virtual device is already present I safely
put above configuration and enabled systemd-networkd.&lt;/p&gt;
&lt;p&gt;Just for the notes here is my natbr0 configuration in &lt;em&gt;interfaces&lt;/em&gt;
file.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;auto natbr0
iface natbr0 inet static
   address 172.16.10.1
   netmask 255.255.255.0
   pre-up brctl addbr natbr0
   post-down brctl delbr natbr0
   post-down sysctl net.ipv4.ip_forward=0
   post-down sysctl net.ipv6.conf.all.forwarding=0
   post-up sysctl net.ipv4.ip_forward=1
   post-up sysctl net.ipv6.conf.all.forwarding=1
   post-up iptables -A POSTROUTING -t mangle -p udp --dport bootpc -s 172.16.0.0/16 -j CHECKSUM --checksum-fill
   pre-down iptables -D POSTROUTING -t mangle -p udp --dport bootpc -s 172.16.0.0/16 -j CHECKSUM --checksum-fill
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Once this is done just reload the &lt;em&gt;systemd-networkd&lt;/em&gt; and make sure you
have dnsmasq or any other DHCP server running in your system.&lt;/p&gt;
&lt;p&gt;Now the last part is to tell systemd-nspawn to use the bridge
networking interface we have defined. This is done using
&lt;em&gt;container-name.nspawn&lt;/em&gt; file. Put this file under
&lt;em&gt;/etc/systemd/nspawn&lt;/em&gt; folder.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="k"&gt;[Exec]&lt;/span&gt;
&lt;span class="na"&gt;Boot&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s"&gt;on&lt;/span&gt;

&lt;span class="k"&gt;[Files]&lt;/span&gt;
&lt;span class="na"&gt;Bind&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s"&gt;/home/vasudev/Documents/Python/upstream/apt-offline/&lt;/span&gt;

&lt;span class="k"&gt;[Network]&lt;/span&gt;
&lt;span class="na"&gt;VirtualEthernet&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s"&gt;yes&lt;/span&gt;
&lt;span class="na"&gt;Bridge&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s"&gt;natbr0&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Here you can specify networking, and files mounting section of the
container. For full list please refer the &lt;em&gt;systemd.nspawn&lt;/em&gt; manual
page.&lt;/p&gt;
&lt;p&gt;Now all this is done you can happily do&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;machinectl&lt;span class="w"&gt; &lt;/span&gt;start&lt;span class="w"&gt; &lt;/span&gt;container-name
&lt;span class="c1"&gt;#or&lt;/span&gt;
systemctl&lt;span class="w"&gt; &lt;/span&gt;start&lt;span class="w"&gt; &lt;/span&gt;systemd-nspawn@container-name
&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;div class="section" id="resource-control"&gt;
&lt;h2&gt;Resource Control&lt;/h2&gt;
&lt;p&gt;Now all things said and done, one last part remains. Yes what is the
point if we can't control how much resource does the container
use. Atleast it is more important for me, because I use old and bit
low powered laptop.&lt;/p&gt;
&lt;p&gt;Systemd provides way to control the resource using Control
interface. To see all the the interfaces exposed by systemd please
refer &lt;em&gt;systemd.resource-control&lt;/em&gt; manual page.&lt;/p&gt;
&lt;p&gt;The way to control the resource is using &lt;em&gt;systemctl&lt;/em&gt;. Once container
starts running we can run following command.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;systemctl&lt;span class="w"&gt; &lt;/span&gt;set-property&lt;span class="w"&gt; &lt;/span&gt;container-name&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nv"&gt;CPUShares&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="m"&gt;200&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nv"&gt;CPUQuota&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="m"&gt;30&lt;/span&gt;%&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nv"&gt;MemoryLimit&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;500M
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;The manual page does say that these things can be put under [Slice]
section of unit files. Now I don't have clear idea if this can be put
under .nspawn files or not. For the sake of persisting the container I
manually wrote the service file for container by copying
systemd-nspawn&amp;#64;.service and adding [Slice]  section. But if I don't
know how to find out if this had any effect or not.&lt;/p&gt;
&lt;p&gt;If some one knows about this please share your suggestions to me and I
will update this section with your provided information.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="conclusion"&gt;
&lt;h2&gt;Conclusion&lt;/h2&gt;
&lt;p&gt;All in all I like systemd-nspawn a lot. I use it to run container for
development of &lt;em&gt;apt-offline&lt;/em&gt;. I previously used lxc where all can be
controlled using a single config file. But I feel systemd-nspawn is
more tightly integrated with system than lxc.&lt;/p&gt;
&lt;p&gt;There is definitely more in systemd-nspawn than I've currently figured
out. Only thing is its not as popular as other alternatives and
definitely lacks good howto documentation.For now only way out is dig
the manual pages, scratch your head, pull your hair out and figure out
new possibilities in systemd-nspawn. ;-)&lt;/p&gt;
&lt;/div&gt;
</content><category term="devops"/><category term="systemd-nspawn"/><category term="containers"/><category term="debian"/></entry><entry><title>Notes: LXC How-To</title><link href="https://copyninja.in/blog/lxc_howto.html" rel="alternate"/><published>2014-12-26T08:11:00+05:30</published><updated>2014-12-26T08:11:00+05:30</updated><author><name>copyninja</name></author><id>tag:copyninja.in,2014-12-26:/blog/lxc_howto.html</id><summary type="html">&lt;p class="first last"&gt;A short how to on LXC basics&lt;/p&gt;
</summary><content type="html">&lt;p&gt;LXC - Linux Containers allows us to run multiple isolated Linux system
under same control host. This will be useful for testing application
without changing our existing system.&lt;/p&gt;
&lt;p&gt;To create an LXC container we use the &lt;cite&gt;lxc-create&lt;/cite&gt; command, it can
accepts the template option, with which we can choose the OS we would
like to run under the virtual isolated environment. On a Debian system
I see following templates supported&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="o"&gt;[&lt;/span&gt;vasudev@rudra:&lt;span class="w"&gt; &lt;/span&gt;~/&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;]&lt;/span&gt;%&lt;span class="w"&gt; &lt;/span&gt;ls&lt;span class="w"&gt; &lt;/span&gt;/usr/share/lxc/templates
lxc-alpine*&lt;span class="w"&gt;    &lt;/span&gt;lxc-archlinux*&lt;span class="w"&gt;  &lt;/span&gt;lxc-centos*&lt;span class="w"&gt;  &lt;/span&gt;lxc-debian*&lt;span class="w"&gt;    &lt;/span&gt;lxc-fedora*&lt;span class="w"&gt;  &lt;/span&gt;lxc-openmandriva*&lt;span class="w"&gt;  &lt;/span&gt;lxc-oracle*&lt;span class="w"&gt;  &lt;/span&gt;lxc-sshd*&lt;span class="w"&gt;    &lt;/span&gt;lxc-ubuntu-cloud*
lxc-altlinux*&lt;span class="w"&gt;  &lt;/span&gt;lxc-busybox*&lt;span class="w"&gt;    &lt;/span&gt;lxc-cirros*&lt;span class="w"&gt;  &lt;/span&gt;lxc-download*&lt;span class="w"&gt;  &lt;/span&gt;lxc-gentoo*&lt;span class="w"&gt;  &lt;/span&gt;lxc-opensuse*&lt;span class="w"&gt;      &lt;/span&gt;lxc-plamo*&lt;span class="w"&gt;   &lt;/span&gt;lxc-ubuntu*
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;For my application testing I wanted to create a Debian container for
my By default the template provided by lxc package creates Debian
stable container. This can be changed by passing the option to
debootstrap after &lt;cite&gt;--&lt;/cite&gt; as shown below.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nv"&gt;MIRROR&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;http://localhost:9999/debian&lt;span class="w"&gt; &lt;/span&gt;lxc-create&lt;span class="w"&gt; &lt;/span&gt;-t&lt;span class="w"&gt; &lt;/span&gt;debian&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="se"&gt;\&lt;/span&gt;
&lt;span class="w"&gt;     &lt;/span&gt;-f&lt;span class="w"&gt;   &lt;/span&gt;container.conf&lt;span class="w"&gt; &lt;/span&gt;-n&lt;span class="w"&gt; &lt;/span&gt;container-name&lt;span class="w"&gt; &lt;/span&gt;--&lt;span class="w"&gt; &lt;/span&gt;-r&lt;span class="w"&gt; &lt;/span&gt;sid
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;cite&gt;-r&lt;/cite&gt; switch is used to specify the release, MIRROR environment
variable is used to choose the required Debian mirror. I wanted to use
my own local &lt;em&gt;approx&lt;/em&gt; installation, so I can save some bandwidth.&lt;/p&gt;
&lt;p&gt;&lt;cite&gt;container.conf&lt;/cite&gt; is the configuration file used for creating the LXC,
in my case it contains basic information on how container networking
should b setup. The configuration is basically taken from &lt;a class="reference external" href="https://wiki.debian.org/LXC"&gt;LXC Debian
wiki&lt;/a&gt;&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="na"&gt;lxc.utsname&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;aptoffline-dev&lt;/span&gt;
&lt;span class="na"&gt;lxc.network.type&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;veth&lt;/span&gt;
&lt;span class="na"&gt;lxc.network.flags&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;up&lt;/span&gt;
&lt;span class="na"&gt;lxc.network.link&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;br0.1&lt;/span&gt;
&lt;span class="na"&gt;lxc.network.name&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;eth0&lt;/span&gt;
&lt;span class="na"&gt;lxc.network.ipv4&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;192.168.3.2/24&lt;/span&gt;
&lt;span class="na"&gt;lxc.network.veth.pair&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;vethvm1&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;I'm using VLAN setup described in &lt;a class="reference external" href="https://wiki.debian.org/LXC/VlanNetworking"&gt;Debian wiki: LXC VLAN Networking&lt;/a&gt; page. Below is my
&lt;cite&gt;interfaces&lt;/cite&gt; file.&lt;/p&gt;
&lt;pre class="literal-block"&gt;
iface eth0.1 inet manual

iface br0.1  inet manual
   bridge_ports eth0.1
   bridge_fd 0
   bridge_maxwait 0
&lt;/pre&gt;
&lt;p&gt;Before launching the LXC make sure you run below command&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo&lt;span class="w"&gt; &lt;/span&gt;ifup&lt;span class="w"&gt; &lt;/span&gt;eth0.1
sudo&lt;span class="w"&gt; &lt;/span&gt;ifup&lt;span class="w"&gt; &lt;/span&gt;br0.1

&lt;span class="c1"&gt;# Also give ip to bridge in same subnet as lxc.network.ipv4&lt;/span&gt;
sudo&lt;span class="w"&gt; &lt;/span&gt;ip&lt;span class="w"&gt; &lt;/span&gt;addr&lt;span class="w"&gt; &lt;/span&gt;add&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;192&lt;/span&gt;.168.3.1/24&lt;span class="w"&gt; &lt;/span&gt;dev&lt;span class="w"&gt; &lt;/span&gt;br0.1
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;I'm giving ip address to bridge so that I can communicate with
container from my control host, once it comes up.&lt;/p&gt;
&lt;p&gt;Now start the container using below command&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo&lt;span class="w"&gt; &lt;/span&gt;lxc-start&lt;span class="w"&gt; &lt;/span&gt;-n&lt;span class="w"&gt; &lt;/span&gt;container&lt;span class="w"&gt; &lt;/span&gt;-d&lt;span class="w"&gt; &lt;/span&gt;-c&lt;span class="w"&gt; &lt;/span&gt;tty8
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;We are starting lxc in daemon mode and attaching it to console
&lt;cite&gt;tty8&lt;/cite&gt;. If you want, you can drop -d and -c option to start lxc in
foreground. But its better you start it in background and attach using
&lt;cite&gt;lxc-console&lt;/cite&gt; command shown below.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo&lt;span class="w"&gt; &lt;/span&gt;lxc-console&lt;span class="w"&gt; &lt;/span&gt;-n&lt;span class="w"&gt; &lt;/span&gt;container&lt;span class="w"&gt; &lt;/span&gt;-t&lt;span class="w"&gt; &lt;/span&gt;tty8
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;You can detach from console using &lt;cite&gt;Ctrl+a q&lt;/cite&gt; combination and let lxc
execute in background.&lt;/p&gt;
&lt;p&gt;Its also possible to simply ssh into the running container since we
have enabled networking.&lt;/p&gt;
&lt;p&gt;Stopping the container should be done using &lt;cite&gt;lxc-stop&lt;/cite&gt; command, but
without &lt;cite&gt;-k&lt;/cite&gt; switch (kill) this command never returned. Even with
timeout container is not stopped.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo&lt;span class="w"&gt; &lt;/span&gt;lxc-stop&lt;span class="w"&gt; &lt;/span&gt;-n&lt;span class="w"&gt; &lt;/span&gt;container
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;cite&gt;-r&lt;/cite&gt; can be used for reboot of container. Since I couldn't get clean
shutdown I normally attach the console and issue a &lt;cite&gt;halt&lt;/cite&gt; command in
container itself. Not sure if this is the right way, but it gets the
thing done.&lt;/p&gt;
&lt;p&gt;I consider Linux container as a better alternative for spawning a
virtual Linux environment instead of running a full blown VM like
Virtualbox or VMware.&lt;/p&gt;
</content><category term="devops"/><category term="lxc"/><category term="container"/><category term="debian"/></entry><entry><title>Note to Self: LVM Shrink Resize HowTo</title><link href="https://copyninja.in/blog/lvm-shrink-resize.html" rel="alternate"/><published>2014-10-05T12:00:00+05:30</published><updated>2014-10-05T12:00:00+05:30</updated><author><name>copyninja</name></author><id>tag:copyninja.in,2014-10-05:/blog/lvm-shrink-resize.html</id><summary type="html">&lt;p class="first last"&gt;Post is a note to self describing LVM shrink and resize of
partition&lt;/p&gt;
</summary><content type="html">&lt;p&gt;Recently I had to reinstall a system at office with Debian Wheezy and
I thought I should use this opportunity to experiment with LVM. Yeah
I've not used LVM till date, even though I'm using Linux for more than
5 years now. I know many DD friends who use LVM with LUKS encryption
and I always wanted to experiment, but since my laptop is only thing
I've and its currently perfectly in shape I didn't dare to experiment
it there. This reinstall was golden opportunity for me to experiment
and learn something new.&lt;/p&gt;
&lt;p&gt;I used Wheezy CD ISO downloaded using &lt;em&gt;jigdo&lt;/em&gt; for installation. Now I
will just go bit off topic and want to share the USB stick
preparation. I have to say this because I had not done installation
for quite a while now. Last I did was during Squeeze time so like
usual I blindly executed following command.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;cat&lt;span class="w"&gt; &lt;/span&gt;debian-wheezy.iso&lt;span class="w"&gt; &lt;/span&gt;&amp;gt;&lt;span class="w"&gt; &lt;/span&gt;/dev/sdb
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Surprisingly USB stick didn't boot! I was getting &lt;strong&gt;Corrupt or missing
ISO.bin&lt;/strong&gt;. So next I tried using &lt;cite&gt;dd&lt;/cite&gt; for preparing.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;dd&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="k"&gt;if&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;debian-wheezy.iso&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nv"&gt;of&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;/dev/sdb
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Surprisingly this also didn't work and I get same error message as
above. This is when I went back to debian manual and looked for
installation step and there I found new way!&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;cp&lt;span class="w"&gt; &lt;/span&gt;debian-wheezy.iso&lt;span class="w"&gt; &lt;/span&gt;/dev/sdb
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Look at destination, its a device and voilà this worked! This is
something new I learnt and I'm surprised how easy it is now to prepare
USB stick. But I still didn't get why first 2 methods failed!. If you
guys know please do share.&lt;/p&gt;
&lt;p&gt;Now coming back to LVM. I used default LVM when disk partitioning was
asked, and I used guided partitioning method provided by
&lt;cite&gt;debian-installer&lt;/cite&gt; and ended up with following layout&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;$&lt;span class="w"&gt; &lt;/span&gt;lvs
&lt;span class="w"&gt;  &lt;/span&gt;LV&lt;span class="w"&gt;     &lt;/span&gt;VG&lt;span class="w"&gt;        &lt;/span&gt;Attr&lt;span class="w"&gt;     &lt;/span&gt;LSize&lt;span class="w"&gt;  &lt;/span&gt;Pool&lt;span class="w"&gt; &lt;/span&gt;Origin&lt;span class="w"&gt; &lt;/span&gt;Data%&lt;span class="w"&gt;  &lt;/span&gt;Move&lt;span class="w"&gt; &lt;/span&gt;Log&lt;span class="w"&gt; &lt;/span&gt;Copy%&lt;span class="w"&gt;  &lt;/span&gt;Convert
home&lt;span class="w"&gt;   &lt;/span&gt;system-disk&lt;span class="w"&gt; &lt;/span&gt;-wi-ao--&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;62&lt;/span&gt;.34g
root&lt;span class="w"&gt;   &lt;/span&gt;system-disk&lt;span class="w"&gt; &lt;/span&gt;-wi-ao--&lt;span class="w"&gt;  &lt;/span&gt;&lt;span class="m"&gt;9&lt;/span&gt;.31g
swap_1&lt;span class="w"&gt; &lt;/span&gt;system-disk&lt;span class="w"&gt; &lt;/span&gt;-wi-ao--&lt;span class="w"&gt;  &lt;/span&gt;&lt;span class="m"&gt;2&lt;/span&gt;.64g
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;So guided partitioning of &lt;cite&gt;debian-installer&lt;/cite&gt; allocates 10G for root
and rest to home and swap. This is not a problem but when I started
installing required software, I could see root running out of space
quickly so I wanted to resize root and give it 10G more, for this I
need to reduce the home by 10G for which I need to first unmount the
home partition. Unmounting home from running system isn't possible so
I booted into recovery assuming I can unmount home there but I
couldn't. &lt;cite&gt;lsof&lt;/cite&gt; didn't show any one using /home after searching a bit
I found &lt;cite&gt;fuser&lt;/cite&gt; command and it looks like kernel is using /home which
is mounted by it.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;$&lt;span class="w"&gt; &lt;/span&gt;fuser&lt;span class="w"&gt; &lt;/span&gt;-vm&lt;span class="w"&gt; &lt;/span&gt;/home
&lt;span class="w"&gt;                     &lt;/span&gt;USER&lt;span class="w"&gt;        &lt;/span&gt;PID&lt;span class="w"&gt; &lt;/span&gt;ACCESS&lt;span class="w"&gt; &lt;/span&gt;COMMAND
/home:&lt;span class="w"&gt;               &lt;/span&gt;root&lt;span class="w"&gt;     &lt;/span&gt;kernel&lt;span class="w"&gt; &lt;/span&gt;mount&lt;span class="w"&gt; &lt;/span&gt;/home
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;So it isn't possible to unmount /home in recovery mode also. Online
materials told me to use live-cd for doing this but I didn't have
patience to do that so I just went ahead commented /home mounting in
/etc/fstab and rebooted!. This time it worked and /home is not mounted
on recovery mode. Now comes the hard part resizing home, thanks to
&lt;a class="reference external" href="http://tldp.org/HOWTO/LVM-HOWTO/reducelv.html"&gt;TLDP doc on reducing&lt;/a&gt; I coud do this with
following step&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="c1"&gt;# e2fsck -f /dev/volume-name/home&lt;/span&gt;
&lt;span class="c1"&gt;# resize2fs /dev/volume-name/home 52G&lt;/span&gt;
&lt;span class="c1"&gt;# lvreduce -L-10G /dev/volume-name/home&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;And now the next part live extending the root partition again thanks
to &lt;a class="reference external" href="http://tldp.org/HOWTO/LVM-HOWTO/extendlv.html"&gt;TLDP doc on extending&lt;/a&gt; following command
did it.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="c1"&gt;# lvextend -L+10G /dev/volume-name/root&lt;/span&gt;
&lt;span class="c1"&gt;# resize2fs /dev/volumne-name/root&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;And now important part! &lt;strong&gt;Uncomment /home line in /etc/fstab so it
will be mounted normally in next boot&lt;/strong&gt; and reboot! On login I can see
my partitions updated.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="c1"&gt;# lvs&lt;/span&gt;
&lt;span class="w"&gt;  &lt;/span&gt;LV&lt;span class="w"&gt;     &lt;/span&gt;VG&lt;span class="w"&gt;        &lt;/span&gt;Attr&lt;span class="w"&gt;     &lt;/span&gt;LSize&lt;span class="w"&gt;  &lt;/span&gt;Pool&lt;span class="w"&gt; &lt;/span&gt;Origin&lt;span class="w"&gt; &lt;/span&gt;Data%&lt;span class="w"&gt;  &lt;/span&gt;Move&lt;span class="w"&gt; &lt;/span&gt;Log&lt;span class="w"&gt; &lt;/span&gt;Copy%&lt;span class="w"&gt;  &lt;/span&gt;Convert
home&lt;span class="w"&gt;   &lt;/span&gt;system-disk&lt;span class="w"&gt; &lt;/span&gt;-wi-ao--&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;52&lt;/span&gt;.34g
root&lt;span class="w"&gt;   &lt;/span&gt;system-disk&lt;span class="w"&gt; &lt;/span&gt;-wi-ao--&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;19&lt;/span&gt;.31g
swap_1&lt;span class="w"&gt; &lt;/span&gt;system-disk&lt;span class="w"&gt; &lt;/span&gt;-wi-ao--&lt;span class="w"&gt;  &lt;/span&gt;&lt;span class="m"&gt;2&lt;/span&gt;.64g
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;I've started liking LVM more now! :)&lt;/p&gt;
</content><category term="devops"/><category term="lvm"/><category term="debian-installer"/><category term="partition"/><category term="debian"/></entry><entry><title>Enabling DNSSEC for copyninja.info</title><link href="https://copyninja.in/blog/dnssec-copyninja-dot-info.html" rel="alternate"/><published>2014-05-13T20:30:00+05:30</published><updated>2014-05-13T20:30:00+05:30</updated><author><name>copyninja</name></author><id>tag:copyninja.in,2014-05-13:/blog/dnssec-copyninja-dot-info.html</id><summary type="html">&lt;p class="first last"&gt;Post describes how I moved copyninja.info domain name
records to DNSSEC.&lt;/p&gt;
</summary><content type="html">&lt;p&gt;Recently I've been seeing lot of posts about DNSSEC on Internet and I
thought  I should configure my domain to be secured by DNSSEC.&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;copyninja.info&lt;/strong&gt; domain is now secured with DNSSEC you can verify
this by &lt;a class="reference external" href="http://dnssec-debugger.verisignlabs.com/copyninja.info"&gt;DNSSEC analyzer by Verisign&lt;/a&gt; and &lt;a class="reference external" href="http://dnsviz.net/d/copyninja.info/dnssec/"&gt;DNSViz&lt;/a&gt; online tool or by
installing &lt;a class="reference external" href="http://dnssec-validator.cz/"&gt;DNSSEC validator addon&lt;/a&gt; for
your browser.&lt;/p&gt;
&lt;p&gt;There are good amount of tutorials and guides available to enable
DNSSEC for your domain, still I want to note down steps I followed to
here for the record (of course it will be helpful for me if I forget
it ;-))&lt;/p&gt;
&lt;p&gt;First step will be installing &lt;cite&gt;bind9&lt;/cite&gt; and &lt;cite&gt;dnssec-tools&lt;/cite&gt; package, if
you use aptitude installing &lt;cite&gt;dnssec-tools&lt;/cite&gt; will pull down the &lt;cite&gt;bind9&lt;/cite&gt;
unless you have configured aptitude to not install the &lt;strong&gt;Recommends&lt;/strong&gt;.&lt;/p&gt;
&lt;p&gt;Next setting up the zone file for your domain, for this first make a
copy of /etc/bind/db.local as /etc/bind/db.example.com, replace
example.com with your domain name. Now you need to add your zone
records to the zone file.&lt;/p&gt;
&lt;p&gt;Next edit the /etc/bind/named.conf.local file and add following lines&lt;/p&gt;
&lt;pre class="literal-block"&gt;
zone &amp;quot;example.com&amp;quot; {
    type master;
    file &amp;quot;/etc/bind/db.copyninja.info&amp;quot;;
    allow-transfer {secondary;};
};
&lt;/pre&gt;
&lt;p&gt;Here replace secondary with your secondary DNS servers, if you don't
have one you can ommit this but its always recommended to have
secondary DNS servers for a zone, in cases when primary fails. After
this we need to enable DNSSEC on bind, this is done by editing the
file /etc/bind/named.conf.options. Add following lines into
&lt;strong&gt;options&lt;/strong&gt; section.&lt;/p&gt;
&lt;pre class="literal-block"&gt;
dnssec-validation yes;
dnssec-enable yes;
dnssec-lookaside auto;
&lt;/pre&gt;
&lt;p&gt;A more explanation on this can be found on &lt;a class="reference external" href="http://www.linuxjournal.com/content/dnssec-part-ii-implementation"&gt;Linux Journal article&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;Now its time to create DNSSEC keys and sign your zone, more about
different DNSSEC keys and records can be found in the &lt;a class="reference external" href="http://www.linuxjournal.com/content/dnssec-part-i-concepts"&gt;Linux Journal
Article on implementation&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;I used &lt;cite&gt;zonesigner&lt;/cite&gt; utility from dnssec-tools which does job of
signing and including KSK and ZSK keys into bind configuration which
otherwise should be done manually. Here is the command line I used for
generating keys, thanks to &lt;a class="reference external" href="http://dr.jones.dk"&gt;Jonas&lt;/a&gt; for this.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;mkdir&lt;span class="w"&gt; &lt;/span&gt;-p&lt;span class="w"&gt; &lt;/span&gt;/etc/bind/keys
zonesigner&lt;span class="w"&gt; &lt;/span&gt;-algorithm&lt;span class="w"&gt; &lt;/span&gt;RSASHA256&lt;span class="w"&gt; &lt;/span&gt;-keydirectory&lt;span class="w"&gt; &lt;/span&gt;/etc/bind/keys&lt;span class="se"&gt;\&lt;/span&gt;
&lt;span class="w"&gt;       &lt;/span&gt;-dsdir&lt;span class="w"&gt; &lt;/span&gt;/etc/bind/keys&lt;span class="w"&gt; &lt;/span&gt;-archivedir&lt;span class="w"&gt; &lt;/span&gt;/etc/bind/keys/archive&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="se"&gt;\&lt;/span&gt;
&lt;span class="w"&gt;       &lt;/span&gt;/etc/bind/db.example.com
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Here we store our keys into /etc/bind/keys directory, and use
&lt;strong&gt;RSASHA256&lt;/strong&gt; algorithm for key generation which is more stronger than
the default used RSASHA1 (atleast thats what Jonas told me). This will
create ZSK and KSK for the signing zone and creates a signed zone file
db.example.com.signed in same directory as original zone file. Now all
you need to do is replace the zone file from db.example.com to
db.example.com.signed in &lt;em&gt;file&lt;/em&gt; directive with your &lt;cite&gt;named.conf.local&lt;/cite&gt;
file.&lt;/p&gt;
&lt;blockquote&gt;
Note that this keys expire after 30 days so you need to resign your
zone before 30 days. For resigning just run zonesigner from
/etc/bind/keys. You can setup cron job to do this periodically.&lt;/blockquote&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;zonesigner&lt;span class="w"&gt; &lt;/span&gt;-zone&lt;span class="w"&gt; &lt;/span&gt;example.com&lt;span class="w"&gt; &lt;/span&gt;/path/to/db.example.com
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Our signed zone is ready but we are not done yet! For DNSSEC to work
others should trust your signed record for this you need to register
your public keys with registrar for your domain and this can be done
via your domain provider (in my case this is Gandi).&lt;/p&gt;
&lt;p&gt;You need to check your domain name providers documentation on how to
do this. For Gandi users there is a nice &lt;a class="reference external" href="http://wiki.gandi.net/en/domains/dnssec"&gt;documentation&lt;/a&gt;.&lt;/p&gt;
&lt;div class="section" id="reference"&gt;
&lt;h2&gt;Reference&lt;/h2&gt;
&lt;ol class="arabic simple"&gt;
&lt;li&gt;&lt;a class="reference external" href="http://www.linuxjournal.com/content/dnssec-part-i-concepts"&gt;Linux  Journal - DNSSEC concepts&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a class="reference external" href="http://www.linux-journal.com/content/dnssec-part-ii-implementation"&gt;Linux Journal - DNSSEC implementation&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a class="reference external" href="https://www.dnssec-tools.org/wiki/index.php/Sign_Your_Zone"&gt;Signing your zone&lt;/a&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;/div&gt;
</content><category term="devops"/><category term="dnssec"/><category term="sysadmin"/><category term="technology"/></entry></feed>